(()=>{var __require=(x=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(x,{get:(a,b2)=>(typeof require!=="undefined"?require:a)[b2]}):x)(function(x){if(typeof require!=="undefined")return require.apply(this,arguments);throw new Error('Dynamic require of "'+x+'" is not supported')});var __create=Object.create;var __defProp=Object.defineProperty;var __getOwnPropDesc=Object.getOwnPropertyDescriptor;var __getOwnPropNames=Object.getOwnPropertyNames;var __getProtoOf=Object.getPrototypeOf;var __hasOwnProp=Object.prototype.hasOwnProperty;var __require2=(x=>typeof __require!=="undefined"?__require:typeof Proxy!=="undefined"?new Proxy(x,{get:(a,b2)=>(typeof __require!=="undefined"?__require:a)[b2]}):x)(function(x){if(typeof __require!=="undefined")return __require.apply(this,arguments);throw new Error('Dynamic require of "'+x+'" is not supported')});var __commonJS=(cb,mod)=>function __require22(){return mod||(0,cb[__getOwnPropNames(cb)[0]])((mod={exports:{}}).exports,mod),mod.exports};var __copyProps=(to,from,except,desc)=>{if(from&&typeof from==="object"||typeof from==="function"){for(let key of __getOwnPropNames(from))if(!__hasOwnProp.call(to,key)&&key!==except)__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable})}return to};var __toESM=(mod,isNodeMode,target)=>(target=mod!=null?__create(__getProtoOf(mod)):{},__copyProps(isNodeMode||!mod||!mod.__esModule?__defProp(target,"default",{value:mod,enumerable:true}):target,mod));var require_sjcl=__commonJS({"services/e2ee/sjcl.js"(exports,module){"use strict";var sjcl2={cipher:{},hash:{},keyexchange:{},mode:{},misc:{},codec:{},exception:{corrupt:function(a){this.toString=function(){return"CORRUPT: "+this.message};this.message=a},invalid:function(a){this.toString=function(){return"INVALID: "+this.message};this.message=a},bug:function(a){this.toString=function(){return"BUG: "+this.message};this.message=a},notReady:function(a){this.toString=function(){return"NOT READY: "+this.message};this.message=a}}};sjcl2.cipher.aes=function(a){this.s[0][0][0]||this.O();var b2,c,d2,e,f2=this.s[0][4],g2=this.s[1];b2=a.length;var h=1;if(4!==b2&&6!==b2&&8!==b2)throw new sjcl2.exception.invalid("invalid aes key size");this.b=[d2=a.slice(0),e=[]];for(a=b2;a<4*b2+28;a++){c=d2[a-1];if(0===a%b2||8===b2&&4===a%b2)c=f2[c>>>24]<<24^f2[c>>16&255]<<16^f2[c>>8&255]<<8^f2[c&255],0===a%b2&&(c=c<<8^c>>>24^h<<24,h=h<<1^283*(h>>7));d2[a]=d2[a-b2]^c}for(b2=0;a;b2++,a--)c=d2[b2&3?a:a-4],e[b2]=4>=a||4>b2?c:g2[0][f2[c>>>24]]^g2[1][f2[c>>16&255]]^g2[2][f2[c>>8&255]]^g2[3][f2[c&255]]};sjcl2.cipher.aes.prototype={encrypt:function(a){return t(this,a,0)},decrypt:function(a){return t(this,a,1)},s:[[[],[],[],[],[]],[[],[],[],[],[]]],O:function(){var a=this.s[0],b2=this.s[1],c=a[4],d2=b2[4],e,f2,g2,h=[],k=[],l,n,m,p2;for(e=0;256>e;e++)k[(h[e]=e<<1^283*(e>>7))^e]=e;for(f2=g2=0;!c[f2];f2^=l||1,g2=k[g2]||1)for(m=g2^g2<<1^g2<<2^g2<<3^g2<<4,m=m>>8^m&255^99,c[f2]=m,d2[m]=f2,n=h[e=h[l=h[f2]]],p2=16843009*n^65537*e^257*l^16843008*f2,n=257*h[m]^16843008*m,e=0;4>e;e++)a[e][f2]=n=n<<24^n>>>8,b2[e][m]=p2=p2<<24^p2>>>8;for(e=0;5>e;e++)a[e]=a[e].slice(0),b2[e]=b2[e].slice(0)}};function t(a,b2,c){if(4!==b2.length)throw new sjcl2.exception.invalid("invalid aes block size");var d2=a.b[c],e=b2[0]^d2[0],f2=b2[c?3:1]^d2[1],g2=b2[2]^d2[2];b2=b2[c?1:3]^d2[3];var h,k,l,n=d2.length/4-2,m,p2=4,r=[0,0,0,0];h=a.s[c];a=h[0];var q=h[1],v2=h[2],w2=h[3],x=h[4];for(m=0;m<n;m++)h=a[e>>>24]^q[f2>>16&255]^v2[g2>>8&255]^w2[b2&255]^d2[p2],k=a[f2>>>24]^q[g2>>16&255]^v2[b2>>8&255]^w2[e&255]^d2[p2+1],l=a[g2>>>24]^q[b2>>16&255]^v2[e>>8&255]^w2[f2&255]^d2[p2+2],b2=a[b2>>>24]^q[e>>16&255]^v2[f2>>8&255]^w2[g2&255]^d2[p2+3],p2+=4,e=h,f2=k,g2=l;for(m=0;4>m;m++)r[c?3&-m:m]=x[e>>>24]<<24^x[f2>>16&255]<<16^x[g2>>8&255]<<8^x[b2&255]^d2[p2++],h=e,e=f2,f2=g2,g2=b2,b2=h;return r}sjcl2.bitArray={bitSlice:function(a,b2,c){a=sjcl2.bitArray.$(a.slice(b2/32),32-(b2&31)).slice(1);return void 0===c?a:sjcl2.bitArray.clamp(a,c-b2)},extract:function(a,b2,c){var d2=Math.floor(-b2-c&31);return((b2+c-1^b2)&-32?a[b2/32|0]<<32-d2^a[b2/32+1|0]>>>d2:a[b2/32|0]>>>d2)&(1<<c)-1},concat:function(a,b2){if(0===a.length||0===b2.length)return a.concat(b2);var c=a[a.length-1],d2=sjcl2.bitArray.getPartial(c);return 32===d2?a.concat(b2):sjcl2.bitArray.$(b2,d2,c|0,a.slice(0,a.length-1))},bitLength:function(a){var b2=a.length;return 0===b2?0:32*(b2-1)+sjcl2.bitArray.getPartial(a[b2-1])},clamp:function(a,b2){if(32*a.length<b2)return a;a=a.slice(0,Math.ceil(b2/32));var c=a.length;b2=b2&31;0<c&&b2&&(a[c-1]=sjcl2.bitArray.partial(b2,a[c-1]&2147483648>>b2-1,1));return a},partial:function(a,b2,c){return 32===a?b2:(c?b2|0:b2<<32-a)+1099511627776*a},getPartial:function(a){return Math.round(a/1099511627776)||32},equal:function(a,b2){if(sjcl2.bitArray.bitLength(a)!==sjcl2.bitArray.bitLength(b2))return false;var c=0,d2;for(d2=0;d2<a.length;d2++)c|=a[d2]^b2[d2];return 0===c},$:function(a,b2,c,d2){var e;e=0;for(void 0===d2&&(d2=[]);32<=b2;b2-=32)d2.push(c),c=0;if(0===b2)return d2.concat(a);for(e=0;e<a.length;e++)d2.push(c|a[e]>>>b2),c=a[e]<<32-b2;e=a.length?a[a.length-1]:0;a=sjcl2.bitArray.getPartial(e);d2.push(sjcl2.bitArray.partial(b2+a&31,32<b2+a?c:d2.pop(),1));return d2},i:function(a,b2){return[a[0]^b2[0],a[1]^b2[1],a[2]^b2[2],a[3]^b2[3]]},byteswapM:function(a){var b2,c;for(b2=0;b2<a.length;++b2)c=a[b2],a[b2]=c>>>24|c>>>8&65280|(c&65280)<<8|c<<24;return a}};sjcl2.codec.utf8String={fromBits:function(a){var b2="",c=sjcl2.bitArray.bitLength(a),d2,e;for(d2=0;d2<c/8;d2++)0===(d2&3)&&(e=a[d2/4]),b2+=String.fromCharCode(e>>>8>>>8>>>8),e<<=8;return decodeURIComponent(escape(b2))},toBits:function(a){a=unescape(encodeURIComponent(a));var b2=[],c,d2=0;for(c=0;c<a.length;c++)d2=d2<<8|a.charCodeAt(c),3===(c&3)&&(b2.push(d2),d2=0);c&3&&b2.push(sjcl2.bitArray.partial(8*(c&3),d2));return b2}};sjcl2.codec.hex={fromBits:function(a){var b2="",c;for(c=0;c<a.length;c++)b2+=((a[c]|0)+0xf00000000000).toString(16).substr(4);return b2.substr(0,sjcl2.bitArray.bitLength(a)/4)},toBits:function(a){var b2,c=[],d2;a=a.replace(/\s|0x/g,"");d2=a.length;a=a+"00000000";for(b2=0;b2<a.length;b2+=8)c.push(parseInt(a.substr(b2,8),16)^0);return sjcl2.bitArray.clamp(c,4*d2)}};sjcl2.codec.base32={B:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",X:"0123456789ABCDEFGHIJKLMNOPQRSTUV",BITS:32,BASE:5,REMAINING:27,fromBits:function(a,b2,c){var d2=sjcl2.codec.base32.BASE,e=sjcl2.codec.base32.REMAINING,f2="",g2=0,h=sjcl2.codec.base32.B,k=0,l=sjcl2.bitArray.bitLength(a);c&&(h=sjcl2.codec.base32.X);for(c=0;f2.length*d2<l;)f2+=h.charAt((k^a[c]>>>g2)>>>e),g2<d2?(k=a[c]<<d2-g2,g2+=e,c++):(k<<=d2,g2-=d2);for(;f2.length&7&&!b2;)f2+="=";return f2},toBits:function(a,b2){a=a.replace(/\s|=/g,"").toUpperCase();var c=sjcl2.codec.base32.BITS,d2=sjcl2.codec.base32.BASE,e=sjcl2.codec.base32.REMAINING,f2=[],g2,h=0,k=sjcl2.codec.base32.B,l=0,n,m="base32";b2&&(k=sjcl2.codec.base32.X,m="base32hex");for(g2=0;g2<a.length;g2++){n=k.indexOf(a.charAt(g2));if(0>n){if(!b2)try{return sjcl2.codec.base32hex.toBits(a)}catch(p2){}throw new sjcl2.exception.invalid("this isn't "+m+"!")}h>e?(h-=e,f2.push(l^n>>>h),l=n<<c-h):(h+=d2,l^=n<<c-h)}h&56&&f2.push(sjcl2.bitArray.partial(h&56,l,1));return f2}};sjcl2.codec.base32hex={fromBits:function(a,b2){return sjcl2.codec.base32.fromBits(a,b2,1)},toBits:function(a){return sjcl2.codec.base32.toBits(a,1)}};sjcl2.codec.base64={B:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",fromBits:function(a,b2,c){var d2="",e=0,f2=sjcl2.codec.base64.B,g2=0,h=sjcl2.bitArray.bitLength(a);c&&(f2=f2.substr(0,62)+"-_");for(c=0;6*d2.length<h;)d2+=f2.charAt((g2^a[c]>>>e)>>>26),6>e?(g2=a[c]<<6-e,e+=26,c++):(g2<<=6,e-=6);for(;d2.length&3&&!b2;)d2+="=";return d2},toBits:function(a,b2){a=a.replace(/\s|=/g,"");var c=[],d2,e=0,f2=sjcl2.codec.base64.B,g2=0,h;b2&&(f2=f2.substr(0,62)+"-_");for(d2=0;d2<a.length;d2++){h=f2.indexOf(a.charAt(d2));if(0>h)throw new sjcl2.exception.invalid("this isn't base64!");26<e?(e-=26,c.push(g2^h>>>e),g2=h<<32-e):(e+=6,g2^=h<<32-e)}e&56&&c.push(sjcl2.bitArray.partial(e&56,g2,1));return c}};sjcl2.codec.base64url={fromBits:function(a){return sjcl2.codec.base64.fromBits(a,1,1)},toBits:function(a){return sjcl2.codec.base64.toBits(a,1)}};sjcl2.hash.sha256=function(a){this.b[0]||this.O();a?(this.F=a.F.slice(0),this.A=a.A.slice(0),this.l=a.l):this.reset()};sjcl2.hash.sha256.hash=function(a){return new sjcl2.hash.sha256().update(a).finalize()};sjcl2.hash.sha256.prototype={blockSize:512,reset:function(){this.F=this.Y.slice(0);this.A=[];this.l=0;return this},update:function(a){"string"===typeof a&&(a=sjcl2.codec.utf8String.toBits(a));var b2,c=this.A=sjcl2.bitArray.concat(this.A,a);b2=this.l;a=this.l=b2+sjcl2.bitArray.bitLength(a);if(9007199254740991<a)throw new sjcl2.exception.invalid("Cannot hash more than 2^53 - 1 bits");if("undefined"!==typeof Uint32Array){var d2=new Uint32Array(c),e=0;for(b2=512+b2-(512+b2&511);b2<=a;b2+=512)u(this,d2.subarray(16*e,16*(e+1))),e+=1;c.splice(0,16*e)}else for(b2=512+b2-(512+b2&511);b2<=a;b2+=512)u(this,c.splice(0,16));return this},finalize:function(){var a,b2=this.A,c=this.F,b2=sjcl2.bitArray.concat(b2,[sjcl2.bitArray.partial(1,1)]);for(a=b2.length+2;a&15;a++)b2.push(0);b2.push(Math.floor(this.l/4294967296));for(b2.push(this.l|0);b2.length;)u(this,b2.splice(0,16));this.reset();return c},Y:[],b:[],O:function(){function a(a2){return 4294967296*(a2-Math.floor(a2))|0}for(var b2=0,c=2,d2,e;64>b2;c++){e=true;for(d2=2;d2*d2<=c;d2++)if(0===c%d2){e=false;break}e&&(8>b2&&(this.Y[b2]=a(Math.pow(c,.5))),this.b[b2]=a(Math.pow(c,1/3)),b2++)}}};function u(a,b2){var c,d2,e,f2=a.F,g2=a.b,h=f2[0],k=f2[1],l=f2[2],n=f2[3],m=f2[4],p2=f2[5],r=f2[6],q=f2[7];for(c=0;64>c;c++)16>c?d2=b2[c]:(d2=b2[c+1&15],e=b2[c+14&15],d2=b2[c&15]=(d2>>>7^d2>>>18^d2>>>3^d2<<25^d2<<14)+(e>>>17^e>>>19^e>>>10^e<<15^e<<13)+b2[c&15]+b2[c+9&15]|0),d2=d2+q+(m>>>6^m>>>11^m>>>25^m<<26^m<<21^m<<7)+(r^m&(p2^r))+g2[c],q=r,r=p2,p2=m,m=n+d2|0,n=l,l=k,k=h,h=d2+(k&l^n&(k^l))+(k>>>2^k>>>13^k>>>22^k<<30^k<<19^k<<10)|0;f2[0]=f2[0]+h|0;f2[1]=f2[1]+k|0;f2[2]=f2[2]+l|0;f2[3]=f2[3]+n|0;f2[4]=f2[4]+m|0;f2[5]=f2[5]+p2|0;f2[6]=f2[6]+r|0;f2[7]=f2[7]+q|0}sjcl2.mode.ccm={name:"ccm",G:[],listenProgress:function(a){sjcl2.mode.ccm.G.push(a)},unListenProgress:function(a){a=sjcl2.mode.ccm.G.indexOf(a);-1<a&&sjcl2.mode.ccm.G.splice(a,1)},fa:function(a){var b2=sjcl2.mode.ccm.G.slice(),c;for(c=0;c<b2.length;c+=1)b2[c](a)},encrypt:function(a,b2,c,d2,e){var f2,g2=b2.slice(0),h=sjcl2.bitArray,k=h.bitLength(c)/8,l=h.bitLength(g2)/8;e=e||64;d2=d2||[];if(7>k)throw new sjcl2.exception.invalid("ccm: iv must be at least 7 bytes");for(f2=2;4>f2&&l>>>8*f2;f2++);f2<15-k&&(f2=15-k);c=h.clamp(c,8*(15-f2));b2=sjcl2.mode.ccm.V(a,b2,c,d2,e,f2);g2=sjcl2.mode.ccm.C(a,g2,c,b2,e,f2);return h.concat(g2.data,g2.tag)},decrypt:function(a,b2,c,d2,e){e=e||64;d2=d2||[];var f2=sjcl2.bitArray,g2=f2.bitLength(c)/8,h=f2.bitLength(b2),k=f2.clamp(b2,h-e),l=f2.bitSlice(b2,h-e),h=(h-e)/8;if(7>g2)throw new sjcl2.exception.invalid("ccm: iv must be at least 7 bytes");for(b2=2;4>b2&&h>>>8*b2;b2++);b2<15-g2&&(b2=15-g2);c=f2.clamp(c,8*(15-b2));k=sjcl2.mode.ccm.C(a,k,c,l,e,b2);a=sjcl2.mode.ccm.V(a,k.data,c,d2,e,b2);if(!f2.equal(k.tag,a))throw new sjcl2.exception.corrupt("ccm: tag doesn't match");return k.data},na:function(a,b2,c,d2,e,f2){var g2=[],h=sjcl2.bitArray,k=h.i;d2=[h.partial(8,(b2.length?64:0)|d2-2<<2|f2-1)];d2=h.concat(d2,c);d2[3]|=e;d2=a.encrypt(d2);if(b2.length)for(c=h.bitLength(b2)/8,65279>=c?g2=[h.partial(16,c)]:4294967295>=c&&(g2=h.concat([h.partial(16,65534)],[c])),g2=h.concat(g2,b2),b2=0;b2<g2.length;b2+=4)d2=a.encrypt(k(d2,g2.slice(b2,b2+4).concat([0,0,0])));return d2},V:function(a,b2,c,d2,e,f2){var g2=sjcl2.bitArray,h=g2.i;e/=8;if(e%2||4>e||16<e)throw new sjcl2.exception.invalid("ccm: invalid tag length");if(4294967295<d2.length||4294967295<b2.length)throw new sjcl2.exception.bug("ccm: can't deal with 4GiB or more data");c=sjcl2.mode.ccm.na(a,d2,c,e,g2.bitLength(b2)/8,f2);for(d2=0;d2<b2.length;d2+=4)c=a.encrypt(h(c,b2.slice(d2,d2+4).concat([0,0,0])));return g2.clamp(c,8*e)},C:function(a,b2,c,d2,e,f2){var g2,h=sjcl2.bitArray;g2=h.i;var k=b2.length,l=h.bitLength(b2),n=k/50,m=n;c=h.concat([h.partial(8,f2-1)],c).concat([0,0,0]).slice(0,4);d2=h.bitSlice(g2(d2,a.encrypt(c)),0,e);if(!k)return{tag:d2,data:[]};for(g2=0;g2<k;g2+=4)g2>n&&(sjcl2.mode.ccm.fa(g2/k),n+=m),c[3]++,e=a.encrypt(c),b2[g2]^=e[0],b2[g2+1]^=e[1],b2[g2+2]^=e[2],b2[g2+3]^=e[3];return{tag:d2,data:h.clamp(b2,l)}}};sjcl2.mode.ocb2={name:"ocb2",encrypt:function(a,b2,c,d2,e,f2){if(128!==sjcl2.bitArray.bitLength(c))throw new sjcl2.exception.invalid("ocb iv must be 128 bits");var g2,h=sjcl2.mode.ocb2.S,k=sjcl2.bitArray,l=k.i,n=[0,0,0,0];c=h(a.encrypt(c));var m,p2=[];d2=d2||[];e=e||64;for(g2=0;g2+4<b2.length;g2+=4)m=b2.slice(g2,g2+4),n=l(n,m),p2=p2.concat(l(c,a.encrypt(l(c,m)))),c=h(c);m=b2.slice(g2);b2=k.bitLength(m);g2=a.encrypt(l(c,[0,0,0,b2]));m=k.clamp(l(m.concat([0,0,0]),g2),b2);n=l(n,l(m.concat([0,0,0]),g2));n=a.encrypt(l(n,l(c,h(c))));d2.length&&(n=l(n,f2?d2:sjcl2.mode.ocb2.pmac(a,d2)));return p2.concat(k.concat(m,k.clamp(n,e)))},decrypt:function(a,b2,c,d2,e,f2){if(128!==sjcl2.bitArray.bitLength(c))throw new sjcl2.exception.invalid("ocb iv must be 128 bits");e=e||64;var g2=sjcl2.mode.ocb2.S,h=sjcl2.bitArray,k=h.i,l=[0,0,0,0],n=g2(a.encrypt(c)),m,p2,r=sjcl2.bitArray.bitLength(b2)-e,q=[];d2=d2||[];for(c=0;c+4<r/32;c+=4)m=k(n,a.decrypt(k(n,b2.slice(c,c+4)))),l=k(l,m),q=q.concat(m),n=g2(n);p2=r-32*c;m=a.encrypt(k(n,[0,0,0,p2]));m=k(m,h.clamp(b2.slice(c),p2).concat([0,0,0]));l=k(l,m);l=a.encrypt(k(l,k(n,g2(n))));d2.length&&(l=k(l,f2?d2:sjcl2.mode.ocb2.pmac(a,d2)));if(!h.equal(h.clamp(l,e),h.bitSlice(b2,r)))throw new sjcl2.exception.corrupt("ocb: tag doesn't match");return q.concat(h.clamp(m,p2))},pmac:function(a,b2){var c,d2=sjcl2.mode.ocb2.S,e=sjcl2.bitArray,f2=e.i,g2=[0,0,0,0],h=a.encrypt([0,0,0,0]),h=f2(h,d2(d2(h)));for(c=0;c+4<b2.length;c+=4)h=d2(h),g2=f2(g2,a.encrypt(f2(h,b2.slice(c,c+4))));c=b2.slice(c);128>e.bitLength(c)&&(h=f2(h,d2(h)),c=e.concat(c,[-2147483648,0,0,0]));g2=f2(g2,c);return a.encrypt(f2(d2(f2(h,d2(h))),g2))},S:function(a){return[a[0]<<1^a[1]>>>31,a[1]<<1^a[2]>>>31,a[2]<<1^a[3]>>>31,a[3]<<1^135*(a[0]>>>31)]}};sjcl2.mode.gcm={name:"gcm",encrypt:function(a,b2,c,d2,e){var f2=b2.slice(0);b2=sjcl2.bitArray;d2=d2||[];a=sjcl2.mode.gcm.C(true,a,f2,d2,c,e||128);return b2.concat(a.data,a.tag)},decrypt:function(a,b2,c,d2,e){var f2=b2.slice(0),g2=sjcl2.bitArray,h=g2.bitLength(f2);e=e||128;d2=d2||[];e<=h?(b2=g2.bitSlice(f2,h-e),f2=g2.bitSlice(f2,0,h-e)):(b2=f2,f2=[]);a=sjcl2.mode.gcm.C(false,a,f2,d2,c,e);if(!g2.equal(a.tag,b2))throw new sjcl2.exception.corrupt("gcm: tag doesn't match");return a.data},ka:function(a,b2){var c,d2,e,f2,g2,h=sjcl2.bitArray.i;e=[0,0,0,0];f2=b2.slice(0);for(c=0;128>c;c++){(d2=0!==(a[Math.floor(c/32)]&1<<31-c%32))&&(e=h(e,f2));g2=0!==(f2[3]&1);for(d2=3;0<d2;d2--)f2[d2]=f2[d2]>>>1|(f2[d2-1]&1)<<31;f2[0]>>>=1;g2&&(f2[0]^=-520093696)}return e},j:function(a,b2,c){var d2,e=c.length;b2=b2.slice(0);for(d2=0;d2<e;d2+=4)b2[0]^=4294967295&c[d2],b2[1]^=4294967295&c[d2+1],b2[2]^=4294967295&c[d2+2],b2[3]^=4294967295&c[d2+3],b2=sjcl2.mode.gcm.ka(b2,a);return b2},C:function(a,b2,c,d2,e,f2){var g2,h,k,l,n,m,p2,r,q=sjcl2.bitArray;m=c.length;p2=q.bitLength(c);r=q.bitLength(d2);h=q.bitLength(e);g2=b2.encrypt([0,0,0,0]);96===h?(e=e.slice(0),e=q.concat(e,[1])):(e=sjcl2.mode.gcm.j(g2,[0,0,0,0],e),e=sjcl2.mode.gcm.j(g2,e,[0,0,Math.floor(h/4294967296),h&4294967295]));h=sjcl2.mode.gcm.j(g2,[0,0,0,0],d2);n=e.slice(0);d2=h.slice(0);a||(d2=sjcl2.mode.gcm.j(g2,h,c));for(l=0;l<m;l+=4)n[3]++,k=b2.encrypt(n),c[l]^=k[0],c[l+1]^=k[1],c[l+2]^=k[2],c[l+3]^=k[3];c=q.clamp(c,p2);a&&(d2=sjcl2.mode.gcm.j(g2,h,c));a=[Math.floor(r/4294967296),r&4294967295,Math.floor(p2/4294967296),p2&4294967295];d2=sjcl2.mode.gcm.j(g2,d2,a);k=b2.encrypt(e);d2[0]^=k[0];d2[1]^=k[1];d2[2]^=k[2];d2[3]^=k[3];return{tag:q.bitSlice(d2,0,f2),data:c}}};sjcl2.misc.hmac=function(a,b2){this.W=b2=b2||sjcl2.hash.sha256;var c=[[],[]],d2,e=b2.prototype.blockSize/32;this.w=[new b2,new b2];a.length>e&&(a=b2.hash(a));for(d2=0;d2<e;d2++)c[0][d2]=a[d2]^909522486,c[1][d2]=a[d2]^1549556828;this.w[0].update(c[0]);this.w[1].update(c[1]);this.R=new b2(this.w[0])};sjcl2.misc.hmac.prototype.encrypt=sjcl2.misc.hmac.prototype.mac=function(a){if(this.aa)throw new sjcl2.exception.invalid("encrypt on already updated hmac called!");this.update(a);return this.digest(a)};sjcl2.misc.hmac.prototype.reset=function(){this.R=new this.W(this.w[0]);this.aa=false};sjcl2.misc.hmac.prototype.update=function(a){this.aa=true;this.R.update(a)};sjcl2.misc.hmac.prototype.digest=function(){var a=this.R.finalize(),a=new this.W(this.w[1]).update(a).finalize();this.reset();return a};sjcl2.misc.pbkdf2=function(a,b2,c,d2,e){c=c||1e4;if(0>d2||0>c)throw new sjcl2.exception.invalid("invalid params to pbkdf2");"string"===typeof a&&(a=sjcl2.codec.utf8String.toBits(a));"string"===typeof b2&&(b2=sjcl2.codec.utf8String.toBits(b2));e=e||sjcl2.misc.hmac;a=new e(a);var f2,g2,h,k,l=[],n=sjcl2.bitArray;for(k=1;32*l.length<(d2||1);k++){e=f2=a.encrypt(n.concat(b2,[k]));for(g2=1;g2<c;g2++)for(f2=a.encrypt(f2),h=0;h<f2.length;h++)e[h]^=f2[h];l=l.concat(e)}d2&&(l=n.clamp(l,d2));return l};sjcl2.prng=function(a){this.c=[new sjcl2.hash.sha256];this.m=[0];this.P=0;this.H={};this.N=0;this.U={};this.Z=this.f=this.o=this.ha=0;this.b=[0,0,0,0,0,0,0,0];this.h=[0,0,0,0];this.L=void 0;this.M=a;this.D=false;this.K={progress:{},seeded:{}};this.u=this.ga=0;this.I=1;this.J=2;this.ca=65536;this.T=[0,48,64,96,128,192,256,384,512,768,1024];this.da=3e4;this.ba=80};sjcl2.prng.prototype={randomWords:function(a,b2){var c=[],d2;d2=this.isReady(b2);var e;if(d2===this.u)throw new sjcl2.exception.notReady("generator isn't seeded");if(d2&this.J){d2=!(d2&this.I);e=[];var f2=0,g2;this.Z=e[0]=new Date().valueOf()+this.da;for(g2=0;16>g2;g2++)e.push(4294967296*Math.random()|0);for(g2=0;g2<this.c.length&&(e=e.concat(this.c[g2].finalize()),f2+=this.m[g2],this.m[g2]=0,d2||!(this.P&1<<g2));g2++);this.P>=1<<this.c.length&&(this.c.push(new sjcl2.hash.sha256),this.m.push(0));this.f-=f2;f2>this.o&&(this.o=f2);this.P++;this.b=sjcl2.hash.sha256.hash(this.b.concat(e));this.L=new sjcl2.cipher.aes(this.b);for(d2=0;4>d2&&(this.h[d2]=this.h[d2]+1|0,!this.h[d2]);d2++);}for(d2=0;d2<a;d2+=4)0===(d2+1)%this.ca&&y2(this),e=z(this),c.push(e[0],e[1],e[2],e[3]);y2(this);return c.slice(0,a)},setDefaultParanoia:function(a,b2){if(0===a&&"Setting paranoia=0 will ruin your security; use it only for testing"!==b2)throw new sjcl2.exception.invalid("Setting paranoia=0 will ruin your security; use it only for testing");this.M=a},addEntropy:function(a,b2,c){c=c||"user";var d2,e,f2=new Date().valueOf(),g2=this.H[c],h=this.isReady(),k=0;d2=this.U[c];void 0===d2&&(d2=this.U[c]=this.ha++);void 0===g2&&(g2=this.H[c]=0);this.H[c]=(this.H[c]+1)%this.c.length;switch(typeof a){case"number":void 0===b2&&(b2=1);this.c[g2].update([d2,this.N++,1,b2,f2,1,a|0]);break;case"object":c=Object.prototype.toString.call(a);if("[object Uint32Array]"===c){e=[];for(c=0;c<a.length;c++)e.push(a[c]);a=e}else for("[object Array]"!==c&&(k=1),c=0;c<a.length&&!k;c++)"number"!==typeof a[c]&&(k=1);if(!k){if(void 0===b2)for(c=b2=0;c<a.length;c++)for(e=a[c];0<e;)b2++,e=e>>>1;this.c[g2].update([d2,this.N++,2,b2,f2,a.length].concat(a))}break;case"string":void 0===b2&&(b2=a.length);this.c[g2].update([d2,this.N++,3,b2,f2,a.length]);this.c[g2].update(a);break;default:k=1}if(k)throw new sjcl2.exception.bug("random: addEntropy only supports number, array of numbers or string");this.m[g2]+=b2;this.f+=b2;h===this.u&&(this.isReady()!==this.u&&A2("seeded",Math.max(this.o,this.f)),A2("progress",this.getProgress()))},isReady:function(a){a=this.T[void 0!==a?a:this.M];return this.o&&this.o>=a?this.m[0]>this.ba&&new Date().valueOf()>this.Z?this.J|this.I:this.I:this.f>=a?this.J|this.u:this.u},getProgress:function(a){a=this.T[a?a:this.M];return this.o>=a?1:this.f>a?1:this.f/a},startCollectors:function(){if(!this.D){this.a={loadTimeCollector:B(this,this.ma),mouseCollector:B(this,this.oa),keyboardCollector:B(this,this.la),accelerometerCollector:B(this,this.ea),touchCollector:B(this,this.qa)};if(window.addEventListener)window.addEventListener("load",this.a.loadTimeCollector,false),window.addEventListener("mousemove",this.a.mouseCollector,false),window.addEventListener("keypress",this.a.keyboardCollector,false),window.addEventListener("devicemotion",this.a.accelerometerCollector,false),window.addEventListener("touchmove",this.a.touchCollector,false);else if(document.attachEvent)document.attachEvent("onload",this.a.loadTimeCollector),document.attachEvent("onmousemove",this.a.mouseCollector),document.attachEvent("keypress",this.a.keyboardCollector);else throw new sjcl2.exception.bug("can't attach event");this.D=true}},stopCollectors:function(){this.D&&(window.removeEventListener?(window.removeEventListener("load",this.a.loadTimeCollector,false),window.removeEventListener("mousemove",this.a.mouseCollector,false),window.removeEventListener("keypress",this.a.keyboardCollector,false),window.removeEventListener("devicemotion",this.a.accelerometerCollector,false),window.removeEventListener("touchmove",this.a.touchCollector,false)):document.detachEvent&&(document.detachEvent("onload",this.a.loadTimeCollector),document.detachEvent("onmousemove",this.a.mouseCollector),document.detachEvent("keypress",this.a.keyboardCollector)),this.D=false)},addEventListener:function(a,b2){this.K[a][this.ga++]=b2},removeEventListener:function(a,b2){var c,d2,e=this.K[a],f2=[];for(d2 in e)e.hasOwnProperty(d2)&&e[d2]===b2&&f2.push(d2);for(c=0;c<f2.length;c++)d2=f2[c],delete e[d2]},la:function(){C2(this,1)},oa:function(a){var b2,c;try{b2=a.x||a.clientX||a.offsetX||0,c=a.y||a.clientY||a.offsetY||0}catch(d2){c=b2=0}0!=b2&&0!=c&&this.addEntropy([b2,c],2,"mouse");C2(this,0)},qa:function(a){a=a.touches[0]||a.changedTouches[0];this.addEntropy([a.pageX||a.clientX,a.pageY||a.clientY],1,"touch");C2(this,0)},ma:function(){C2(this,2)},ea:function(a){a=a.accelerationIncludingGravity.x||a.accelerationIncludingGravity.y||a.accelerationIncludingGravity.z;if(window.orientation){var b2=window.orientation;"number"===typeof b2&&this.addEntropy(b2,1,"accelerometer")}a&&this.addEntropy(a,2,"accelerometer");C2(this,0)}};function A2(a,b2){var c,d2=sjcl2.random.K[a],e=[];for(c in d2)d2.hasOwnProperty(c)&&e.push(d2[c]);for(c=0;c<e.length;c++)e[c](b2)}function C2(a,b2){"undefined"!==typeof window&&window.performance&&"function"===typeof window.performance.now?a.addEntropy(window.performance.now(),b2,"loadtime"):a.addEntropy(new Date().valueOf(),b2,"loadtime")}function y2(a){a.b=z(a).concat(z(a));a.L=new sjcl2.cipher.aes(a.b)}function z(a){for(var b2=0;4>b2&&(a.h[b2]=a.h[b2]+1|0,!a.h[b2]);b2++);return a.L.encrypt(a.h)}function B(a,b2){return function(){b2.apply(a,arguments)}}sjcl2.random=new sjcl2.prng(6);a:try{if(G="undefined"!==typeof module&&module.exports){try{H=__require2("crypto")}catch(a){H=null}G=E=H}if(G&&E.randomBytes)D=E.randomBytes(128),D=new Uint32Array(new Uint8Array(D).buffer),sjcl2.random.addEntropy(D,1024,"crypto['randomBytes']");else if("undefined"!==typeof window&&"undefined"!==typeof Uint32Array){F=new Uint32Array(32);if(window.crypto&&window.crypto.getRandomValues)window.crypto.getRandomValues(F);else if(window.msCrypto&&window.msCrypto.getRandomValues)window.msCrypto.getRandomValues(F);else break a;sjcl2.random.addEntropy(F,1024,"crypto['getRandomValues']")}}catch(a){"undefined"!==typeof window&&window.console&&(console.log("There was an error collecting entropy from the browser:"),console.log(a))}var D;var E;var F;var G;var H;sjcl2.json={defaults:{v:1,iter:1e4,ks:128,ts:64,mode:"ccm",adata:"",cipher:"aes"},ja:function(a,b2,c,d2){c=c||{};d2=d2||{};var e=sjcl2.json,f2=e.g({iv:sjcl2.random.randomWords(4,0)},e.defaults),g2;e.g(f2,c);c=f2.adata;"string"===typeof f2.salt&&(f2.salt=sjcl2.codec.base64.toBits(f2.salt));"string"===typeof f2.iv&&(f2.iv=sjcl2.codec.base64.toBits(f2.iv));if(!sjcl2.mode[f2.mode]||!sjcl2.cipher[f2.cipher]||"string"===typeof a&&100>=f2.iter||64!==f2.ts&&96!==f2.ts&&128!==f2.ts||128!==f2.ks&&192!==f2.ks&&256!==f2.ks||2>f2.iv.length||4<f2.iv.length)throw new sjcl2.exception.invalid("json encrypt: invalid parameters");"string"===typeof a?(g2=sjcl2.misc.cachedPbkdf2(a,f2),a=g2.key.slice(0,f2.ks/32),f2.salt=g2.salt):sjcl2.ecc&&a instanceof sjcl2.ecc.elGamal.publicKey&&(g2=a.kem(),f2.kemtag=g2.tag,a=g2.key.slice(0,f2.ks/32));"string"===typeof b2&&(b2=sjcl2.codec.utf8String.toBits(b2));"string"===typeof c&&(f2.adata=c=sjcl2.codec.utf8String.toBits(c));g2=new sjcl2.cipher[f2.cipher](a);e.g(d2,f2);d2.key=a;f2.ct="ccm"===f2.mode&&sjcl2.arrayBuffer&&sjcl2.arrayBuffer.ccm&&b2 instanceof ArrayBuffer?sjcl2.arrayBuffer.ccm.encrypt(g2,b2,f2.iv,c,f2.ts):sjcl2.mode[f2.mode].encrypt(g2,b2,f2.iv,c,f2.ts);return f2},encrypt:function(a,b2,c,d2){var e=sjcl2.json,f2=e.ja.apply(e,arguments);return e.encode(f2)},ia:function(a,b2,c,d2){c=c||{};d2=d2||{};var e=sjcl2.json;b2=e.g(e.g(e.g({},e.defaults),b2),c,true);var f2,g2;f2=b2.adata;"string"===typeof b2.salt&&(b2.salt=sjcl2.codec.base64.toBits(b2.salt));"string"===typeof b2.iv&&(b2.iv=sjcl2.codec.base64.toBits(b2.iv));if(!sjcl2.mode[b2.mode]||!sjcl2.cipher[b2.cipher]||"string"===typeof a&&100>=b2.iter||64!==b2.ts&&96!==b2.ts&&128!==b2.ts||128!==b2.ks&&192!==b2.ks&&256!==b2.ks||!b2.iv||2>b2.iv.length||4<b2.iv.length)throw new sjcl2.exception.invalid("json decrypt: invalid parameters");"string"===typeof a?(g2=sjcl2.misc.cachedPbkdf2(a,b2),a=g2.key.slice(0,b2.ks/32),b2.salt=g2.salt):sjcl2.ecc&&a instanceof sjcl2.ecc.elGamal.secretKey&&(a=a.unkem(sjcl2.codec.base64.toBits(b2.kemtag)).slice(0,b2.ks/32));"string"===typeof f2&&(f2=sjcl2.codec.utf8String.toBits(f2));g2=new sjcl2.cipher[b2.cipher](a);f2="ccm"===b2.mode&&sjcl2.arrayBuffer&&sjcl2.arrayBuffer.ccm&&b2.ct instanceof ArrayBuffer?sjcl2.arrayBuffer.ccm.decrypt(g2,b2.ct,b2.iv,b2.tag,f2,b2.ts):sjcl2.mode[b2.mode].decrypt(g2,b2.ct,b2.iv,f2,b2.ts);e.g(d2,b2);d2.key=a;return 1===c.raw?f2:sjcl2.codec.utf8String.fromBits(f2)},decrypt:function(a,b2,c,d2){var e=sjcl2.json;return e.ia(a,e.decode(b2),c,d2)},encode:function(a){var b2,c="{",d2="";for(b2 in a)if(a.hasOwnProperty(b2)){if(!b2.match(/^[a-z0-9]+$/i))throw new sjcl2.exception.invalid("json encode: invalid property name");c+=d2+'"'+b2+'":';d2=",";switch(typeof a[b2]){case"number":case"boolean":c+=a[b2];break;case"string":c+='"'+escape(a[b2])+'"';break;case"object":c+='"'+sjcl2.codec.base64.fromBits(a[b2],0)+'"';break;default:throw new sjcl2.exception.bug("json encode: unsupported type")}}return c+"}"},decode:function(a){a=a.replace(/\s/g,"");if(!a.match(/^\{.*\}$/))throw new sjcl2.exception.invalid("json decode: this isn't json!");a=a.replace(/^\{|\}$/g,"").split(/,/);var b2={},c,d2;for(c=0;c<a.length;c++){if(!(d2=a[c].match(/^\s*(?:(["']?)([a-z][a-z0-9]*)\1)\s*:\s*(?:(-?\d+)|"([a-z0-9+\/%*_.@=\-]*)"|(true|false))$/i)))throw new sjcl2.exception.invalid("json decode: this isn't json!");null!=d2[3]?b2[d2[2]]=parseInt(d2[3],10):null!=d2[4]?b2[d2[2]]=d2[2].match(/^(ct|adata|salt|iv)$/)?sjcl2.codec.base64.toBits(d2[4]):unescape(d2[4]):null!=d2[5]&&(b2[d2[2]]="true"===d2[5])}return b2},g:function(a,b2,c){void 0===a&&(a={});if(void 0===b2)return a;for(var d2 in b2)if(b2.hasOwnProperty(d2)){if(c&&void 0!==a[d2]&&a[d2]!==b2[d2])throw new sjcl2.exception.invalid("required parameter overridden");a[d2]=b2[d2]}return a},sa:function(a,b2){var c={},d2;for(d2 in a)a.hasOwnProperty(d2)&&a[d2]!==b2[d2]&&(c[d2]=a[d2]);return c},ra:function(a,b2){var c={},d2;for(d2=0;d2<b2.length;d2++)void 0!==a[b2[d2]]&&(c[b2[d2]]=a[b2[d2]]);return c}};sjcl2.encrypt=sjcl2.json.encrypt;sjcl2.decrypt=sjcl2.json.decrypt;sjcl2.misc.pa={};sjcl2.misc.cachedPbkdf2=function(a,b2){var c=sjcl2.misc.pa,d2;b2=b2||{};d2=b2.iter||1e3;c=c[a]=c[a]||{};d2=c[d2]=c[d2]||{firstSalt:b2.salt&&b2.salt.length?b2.salt.slice(0):sjcl2.random.randomWords(2,0)};c=void 0===b2.salt?d2.firstSalt:b2.salt;d2[c]=d2[c]||sjcl2.misc.pbkdf2(a,c,b2.iter);return{key:d2[c].slice(0),salt:c.slice(0)}};"undefined"!==typeof module&&module.exports&&(module.exports=sjcl2);"function"===typeof define&&define([],function(){return sjcl2})}});var require_browser=__commonJS({"node_modules/web-worker/cjs/browser.js"(exports,module){module.exports=Worker}});var ARGUMENT_NAMES=/([^,]*)/g;function getFnParamInfo(fn){var fstr=fn.toString();const openPar=fstr.indexOf("(");const closePar=fstr.indexOf(")");const getFirstBracket=(str2,offset=0)=>{const fb=offset+str2.indexOf("{");if(fb<closePar&&fb>openPar){return getFirstBracket(str2.slice(fb),offset+fb)}else return fb};const firstBracket=getFirstBracket(fstr);let innerMatch;if(firstBracket===-1||closePar<firstBracket)innerMatch=fstr.slice(fstr.indexOf("(")+1,fstr.indexOf(")"));else innerMatch=fstr.match(/([a-zA-Z]\w*|\([a-zA-Z]\w*(,\s*[a-zA-Z]\w*)*\)) =>/)?.[1];if(!innerMatch)return void 0;const matches=innerMatch.match(ARGUMENT_NAMES).filter(e=>!!e);const info=new Map;matches.forEach(v2=>{let[name,value]=v2.split("=");name=name.trim();name=name.replace(/\d+$/,"");const spread=name.includes("...");name=name.replace("...","");try{if(name)info.set(name,{state:(0,eval)(`(${value})`),spread})}catch(e){info.set(name,{})}});return info}function parseFunctionFromText(method=""){let getFunctionBody=methodString=>{return methodString.replace(/^\W*(function[^{]+\{([\s\S]*)\}|[^=]+=>[^{]*\{([\s\S]*)\}|[^=]+=>(.+))/i,"$2$3$4")};let getFunctionHead=methodString=>{let startindex=methodString.indexOf("=>")+1;if(startindex<=0){startindex=methodString.indexOf("){")}if(startindex<=0){startindex=methodString.indexOf(") {")}return methodString.slice(0,methodString.indexOf("{",startindex)+1)};let newFuncHead=getFunctionHead(method);let newFuncBody=getFunctionBody(method);let newFunc;if(newFuncHead.includes("function")){let varName=newFuncHead.split("(")[1].split(")")[0];newFunc=new Function(varName,newFuncBody)}else{if(newFuncHead.substring(0,6)===newFuncBody.substring(0,6)){let varName=newFuncHead.split("(")[1].split(")")[0];newFunc=new Function(varName,newFuncBody.substring(newFuncBody.indexOf("{")+1,newFuncBody.length-1))}else{try{newFunc=(0,eval)(newFuncHead+newFuncBody+"}")}catch{}}}return newFunc}var state={pushToState:{},data:{},triggers:{},setState(updateObj){Object.assign(state.data,updateObj);for(const prop of Object.getOwnPropertyNames(updateObj)){if(state.triggers[prop])state.triggers[prop].forEach(obj=>obj.onchange(state.data[prop]))}return state.data},subscribeTrigger(key,onchange){if(key){if(!state.triggers[key]){state.triggers[key]=[]}let l=state.triggers[key].length;state.triggers[key].push({idx:l,onchange});return state.triggers[key].length-1}else return void 0},unsubscribeTrigger(key,sub){let idx=void 0;let triggers=state.triggers[key];if(triggers){if(!sub)delete state.triggers[key];else{let obj=triggers.find(o=>{if(o.idx===sub){return true}});if(obj)triggers.splice(idx,1);return true}}},subscribeTriggerOnce(key,onchange){let sub;let changed=value=>{onchange(value);state.unsubscribeTrigger(key,sub)};sub=state.subscribeTrigger(key,changed)}};var GraphNode=class{constructor(properties={},parentNode,graph){this.nodes=new Map;this._initial={};this.state=state;this.isLooping=false;this.isAnimating=false;this.looper=void 0;this.animation=void 0;this.forward=true;this.backward=false;this.runSync=false;this.firstRun=true;this.DEBUGNODE=false;this.operator=(self2=this,origin,...args)=>{return args};this.runOp=(node=this,origin=this,...args)=>{if(node.DEBUGNODE)console.time(node.tag);let result=node.operator(node,origin,...args);if(result instanceof Promise){result.then(res=>{if(res!==void 0)this.setState({[node.tag]:res});if(node.DEBUGNODE){console.timeEnd(node.tag);if(result!==void 0)console.log(`${node.tag} result:`,result)};return res})}else{if(result!==void 0)this.setState({[node.tag]:result});if(node.DEBUGNODE){console.timeEnd(node.tag);if(result!==void 0)console.log(`${node.tag} result:`,result)};}return result};this.setOperator=operator=>{if(typeof operator!=="function")return operator;let params=getFnParamInfo(operator);let pass=false;if(params){const keys=params.keys();const paramOne=keys.next().value;const paramTwo=keys.next().value;const restrictedOne=["self","node"];const restrictedTwo=["origin","parent","graph","router"];if(paramOne)restrictedOne.forEach(a=>{if(paramOne.includes(a))pass=true});if(paramTwo)restrictedTwo.forEach(a=>{if(paramTwo.includes(a))pass=true})}if(!pass){let fn=operator;operator=(self2,origin,...args)=>{return fn(...args)}}this.operator=operator;return operator};this.run=(...args)=>{return this._run(this,void 0,...args)};this.runAsync=(...args)=>{return new Promise((res,rej)=>{res(this._run(this,void 0,...args))})};this.transformArgs=(args=[])=>args;this._run=(node=this,origin,...args)=>{if(typeof this.transformArgs==="function")args=this.transformArgs(args,node);if(!(typeof node==="object")){if(typeof node==="string"){let fnd=void 0;if(this.graph)fnd=this.graph.nodes.get(node);if(!fnd)fnd=this.nodes.get(node);node=fnd}if(!node)return void 0}if(node.firstRun){node.firstRun=false;if(!(node.children&&node.forward||node.parent&&node.backward||node.repeat||node.delay||node.frame||node.recursive||node.branch))node.runSync=true;if(node.animate&&!node.isAnimating){node.runAnimation(node.animation,args,node,origin)}if(node.loop&&typeof node.loop==="number"&&!node.isLooping){node.runLoop(node.looper,args,node,origin)}if(node.loop||node.animate)return}if(node.runSync){let res=node.runOp(node,origin,...args);return res}return new Promise(async resolve=>{if(node){let run=(node2,tick=0,...input)=>{return new Promise(async r=>{tick++;let res=await node2.runOp(node2,origin,...input);if(node2.repeat){while(tick<node2.repeat){if(node2.delay){setTimeout(async()=>{r(await run(node2,tick,...input))},node2.delay);break}else if(node2.frame&&window?.requestAnimationFrame){requestAnimationFrame(async()=>{r(await run(node2,tick,...input))});break}else res=await node2.runOp(node2,origin,...input);tick++}if(tick===node2.repeat){r(res);return}}else if(node2.recursive){while(tick<node2.recursive){if(node2.delay){setTimeout(async()=>{r(await run(node2,tick,...res))},node2.delay);break}else if(node2.frame&&window?.requestAnimationFrame){requestAnimationFrame(async()=>{r(await run(node2,tick,...res))});break}else res=await node2.runOp(node2,origin,...res);tick++}if(tick===node2.recursive){r(res);return}}else{r(res);return}})};let runnode=async()=>{let res=await run(node,void 0,...args);if(res!==void 0){if(node.backward&&node.parent instanceof GraphNode){if(Array.isArray(res))await this.runParent(node,...res);else await this.runParent(node,res)}if(node.children&&node.forward){if(Array.isArray(res))await this.runChildren(node,...res);else await this.runChildren(node,res)}if(node.branch){this.runBranch(node,res)}}return res};if(node.delay){setTimeout(async()=>{resolve(await runnode())},node.delay)}else if(node.frame&&window?.requestAnimationFrame){requestAnimationFrame(async()=>{resolve(await runnode())})}else{resolve(await runnode())}}else resolve(void 0)})};this.runParent=async(node,...args)=>{if(node.backward&&node.parent){if(typeof node.parent==="string"){if(node.graph&&node.graph?.get(node.parent)){node.parent=node.graph;if(node.parent)this.nodes.set(node.parent.tag,node.parent)}else node.parent=this.nodes.get(node.parent)}if(node.parent instanceof GraphNode)await node.parent._run(node.parent,this,...args)}};this.runChildren=async(node,...args)=>{if(typeof node.children==="object"){for(const key in node.children){if(typeof node.children[key]==="string"){if(node.graph&&node.graph?.get(node.children[key])){node.children[key]=node.graph.get(node.children[key]);if(!node.nodes.get(node.children[key].tag))node.nodes.set(node.children[key].tag,node.children[key])}if(!node.children[key]&&node.nodes.get(node.children[key]))node.children[key]=node.nodes.get(node.children[key])}else if(typeof node.children[key]==="undefined"||node.children[key]===true){if(node.graph&&node.graph?.get(key)){node.children[key]=node.graph.get(key);if(!node.nodes.get(node.children[key].tag))node.nodes.set(node.children[key].tag,node.children[key])}if(!node.children[key]&&node.nodes.get(key))node.children[key]=node.nodes.get(key)}if(node.children[key]?.runOp)await node.children[key]._run(node.children[key],node,...args)}}};this.runBranch=async(node,output)=>{if(node.branch){let keys=Object.keys(node.branch);await Promise.all(keys.map(async k=>{if(typeof node.branch[k].if==="object")node.branch[k].if=stringifyFast(node.branch[k].if);let pass=false;if(typeof node.branch[k].if==="function"){pass=node.branch[k].if(output)}else{if(typeof output==="object"){if(stringifyFast(output)===node.branch[k].if)pass=true}else if(output===node.branch[k].if)pass=true}if(pass){if(node.branch[k].then instanceof GraphNode){if(Array.isArray(output))await node.branch[k].then._run(node.branch[k].then,node,...output);else await node.branch[k].then._run(node.branch[k].then,node,...output)}else if(typeof node.branch[k].then==="function"){if(Array.isArray(output))await node.branch[k].then(...output);else await node.branch[k].then(output)}else if(typeof node.branch[k].then==="string"){if(node.graph)node.branch[k].then=node.graph.nodes.get(node.branch[k].then);else node.branch[k].then=node.nodes.get(node.branch[k].then);if(node.branch[k].then instanceof GraphNode){if(Array.isArray(output))await node.branch[k].then._run(node.branch[k].then,node,...output);else await node.branch[k].then._run(node.branch[k].then,node,...output)}}}return pass}))}};this.runAnimation=(animation=this.animation,args=[],node=this,origin)=>{this.animation=animation;if(!animation)this.animation=this.operator;if(node.animate&&!node.isAnimating&&"requestAnimationFrame"in window){node.isAnimating=true;let anim=async()=>{if(node.isAnimating){if(node.DEBUGNODE)console.time(node.tag);let result=this.animation(node,origin,...args);if(result instanceof Promise){result=await result}if(node.DEBUGNODE){console.timeEnd(node.tag);if(result!==void 0)console.log(`${node.tag} result:`,result)};if(result!==void 0){if(this.tag)this.setState({[this.tag]:result});if(node.backward&&node.parent?._run){if(Array.isArray(result))await this.runParent(node,...result);else await this.runParent(node,result)}if(node.children&&node.forward){if(Array.isArray(result))await this.runChildren(node,...result);else await this.runChildren(node,result)}if(node.branch){this.runBranch(node,result)}this.setState({[node.tag]:result})}requestAnimationFrame(anim)}};requestAnimationFrame(anim)}};this.runLoop=(loop=this.looper,args=[],node=this,origin,timeout=node.loop)=>{node.looper=loop;if(!loop)node.looper=node.operator;if(typeof timeout==="number"&&!node.isLooping){node.isLooping=true;let looping=async()=>{if(node.isLooping){if(node.DEBUGNODE)console.time(node.tag);let result=node.looper(node,origin,...args);if(result instanceof Promise){result=await result}if(node.DEBUGNODE){console.timeEnd(node.tag);if(result!==void 0)console.log(`${node.tag} result:`,result)};if(result!==void 0){if(node.tag)node.setState({[node.tag]:result});if(node.backward&&node.parent?._run){if(Array.isArray(result))await this.runParent(node,...result);else await this.runParent(node,result)}if(node.children&&node.forward){if(Array.isArray(result))await this.runChildren(node,...result);else await this.runChildren(node,result)}if(node.branch){this.runBranch(node,result)}node.setState({[node.tag]:result})}setTimeout(async()=>{await looping()},timeout)}};looping()}};this.setParent=parent=>{this.parent=parent;if(this.backward)this.runSync=false};this.setChildren=children=>{this.children=children;if(this.forward)this.runSync=false};this.add=(node={})=>{if(typeof node==="function")node={operator:node};if(!(node instanceof GraphNode))node=new GraphNode(node,this,this.graph);this.nodes.set(node.tag,node);if(this.graph){this.graph.nodes.set(node.tag,node);this.graph.nNodes=this.graph.nodes.size}return node};this.remove=node=>{if(typeof node==="string")node=this.nodes.get(node);if(node instanceof GraphNode){this.nodes.delete(node.tag);if(this.children[node.tag])delete this.children[node.tag];if(this.graph){this.graph.nodes.delete(node.tag);this.graph.nNodes=this.graph.nodes.size}this.nodes.forEach(n=>{if(n.nodes.get(node.tag)){n.nodes.delete(node.tag);if(n.children[node.tag])delete n.children[node.tag];if(n.parent?.tag===node.tag)delete n.parent}});if(node.ondelete)node.ondelete(node)}};this.append=(node,parentNode2=this)=>{if(typeof node==="string")node=this.nodes.get(node);if(node instanceof GraphNode){parentNode2.addChildren(node);if(node.forward)node.runSync=false}};this.subscribe=(callback,tag=this.tag)=>{if(callback instanceof GraphNode){return this.subscribeNode(callback)}else return this.state.subscribeTrigger(tag,callback)};this.unsubscribe=(sub,tag=this.tag)=>{this.state.unsubscribeTrigger(tag,sub)};this.addChildren=children=>{if(!this.children)this.children={};if(typeof children==="object"){Object.assign(this.children,children)}this.convertChildrenToNodes();if(this.forward)this.runSync=false};this.callParent=(...args)=>{const origin=this;if(typeof this.parent==="string"){if(this.graph&&this.graph?.get(this.parent)){this.parent=this.graph;if(this.parent)this.nodes.set(this.parent.tag,this.parent)}else this.parent=this.nodes.get(this.parent)}if(typeof this.parent?.operator==="function")return this.parent.runOp(this.parent,origin,...args)};this.callChildren=(idx,...args)=>{const origin=this;let result;if(typeof this.children==="object"){for(const key in this.children){if(this.children[key]?.runOp)this.children[key].runOp(this.children[key],origin,...args)}}return result};this.getProps=(node=this)=>{return{tag:node.tag,operator:node.operator,graph:node.graph,children:node.children,parent:node.parent,forward:node.forward,backward:node.bacward,loop:node.loop,animate:node.animate,frame:node.frame,delay:node.delay,recursive:node.recursive,repeat:node.repeat,branch:node.branch,oncreate:node.oncreate,DEBUGNODE:node.DEBUGNODE,...this._initial}};this.setProps=(props={})=>{let tmp=Object.assign({},props);if(tmp.children){this.addChildren(props.children);delete tmp.children}if(tmp.operator){this.setOperator(props.operator);delete tmp.operator}Object.assign(tmp,props);if(!(this.children&&this.forward||this.parent&&this.backward||this.repeat||this.delay||this.frame||this.recursive))this.runSync=true};this.removeTree=node=>{if(node){if(typeof node==="string")node=this.nodes.get(node)}if(node instanceof GraphNode){let checked={};const recursivelyRemove=node2=>{if(typeof node2.children==="object"&&!checked[node2.tag]){checked[node2.tag]=true;for(const key in node2.children){if(node2.children[key].stopNode)node2.children[key].stopNode();if(node2.children[key].tag){if(this.nodes.get(node2.children[key].tag))this.nodes.delete(node2.children[key].tag);this.nodes.forEach(n=>{if(n.nodes.get(node2.children[key].tag))n.nodes.delete(node2.children[key].tag);if(n.children[key]instanceof GraphNode)delete n.children[key]});recursivelyRemove(node2.children[key])}}}};if(node.stopNode)node.stopNode();if(node.tag){this.nodes.delete(node.tag);if(this.children[node.tag])delete this.children[node.tag];if(this.parent?.tag===node.tag)delete this.parent;if(this[node.tag]instanceof GraphNode)delete this[node.tag];this.nodes.forEach(n=>{if(node?.tag){if(n.nodes.get(node.tag))n.nodes.delete(node.tag);if(n.children[node.tag]instanceof GraphNode)delete n.children[node.tag]}});recursivelyRemove(node);if(this.graph)this.graph.removeTree(node,checked);else if(node.ondelete)node.ondelete(node)}}};this.checkNodesHaveChildMapped=(node,child,checked={})=>{let tag=node.tag;if(!tag)tag=node.name;if(!checked[tag]){checked[tag]=true;if(node.children){if(child.tag in node.children){if(node.children[child.tag]instanceof GraphNode){if(!node.nodes.get(child.tag))node.nodes.set(child.tag,child);node.children[child.tag]=child;if(!node.firstRun)node.firstRun=true}}}if(node.parent instanceof GraphNode){if(node.nodes.get(child.tag)&&!node.parent.nodes.get(child.tag))node.parent.nodes.set(child.tag,child);if(node.parent.children){this.checkNodesHaveChildMapped(node.parent,child,checked)}else if(node.nodes){node.nodes.forEach(n=>{if(!checked[n.tag]){this.checkNodesHaveChildMapped(n,child,checked)}})}}if(node.graph){if(node.parent&&node.parent.name!==node.graph.name){node.graph.nodes.forEach(n=>{if(!checked[n.tag]){this.checkNodesHaveChildMapped(n,child,checked)}})}}}};this.convertChildrenToNodes=(n=this)=>{if(n?.children){for(const key in n.children){if(!(n.children[key]instanceof GraphNode)){if(typeof n.children[key]==="object"){if(!n.children[key].tag)n.children[key].tag=key;if(!n.nodes.get(n.children[key].tag)){n.children[key]=new GraphNode(n.children[key],n,n.graph);this.checkNodesHaveChildMapped(n,n.children[key])}}else{if(typeof n.children[key]==="undefined"||n.children[key]==true){n.children[key]=n.graph.get(key);if(!n.children[key])n.children[key]=n.nodes.get(key)}else if(typeof n.children[key]==="string"){let k=n.children[key];n.children[key]=n.graph.get(k);if(!n.children[key])n.children[key]=n.nodes.get(key)}if(n.children[key]instanceof GraphNode){if(n.graph){let props=n.children[key].getProps();delete props.parent;delete props.graph;if(n.source instanceof Graph){n.children[key]=new GraphNode(props,n,n.source)}else{n.children[key]=new GraphNode(props,n,n.graph)}}n.nodes.set(n.children[key].tag,n.children[key]);this.checkNodesHaveChildMapped(n,n.children[key]);if(!(n.children[key].tag in n))n[n.children[key].tag]=n.children[key]}}}}}return n.children};this.stopLooping=(node=this)=>{node.isLooping=false};this.stopAnimating=(node=this)=>{node.isAnimating=false};this.stopNode=(node=this)=>{node.stopAnimating(node);node.stopLooping(node)};this.subscribeNode=node=>{if(node.tag)this.nodes.set(node.tag,node);return this.state.subscribeTrigger(this.tag,res=>{node._run(node,this,res)})};this.print=(node=this,printChildren=true,nodesPrinted=[])=>{let dummyNode=new GraphNode;if(typeof node==="string")node=this.nodes.get(node);if(node instanceof GraphNode){nodesPrinted.push(node.tag);let jsonToPrint={tag:node.tag,operator:node.operator.toString()};if(node.parent)jsonToPrint.parent=node.parent.tag;if(typeof node.children==="object"){for(const key in node.children){if(typeof node.children[key]==="string")return node.children[key];if(nodesPrinted.includes(node.children[key].tag))return node.children[key].tag;else if(!printChildren){return node.children[key].tag}else return node.children[key].print(node.children[key],printChildren,nodesPrinted)}}for(const prop in node){if(prop==="parent"||prop==="children")continue;if(typeof dummyNode[prop]==="undefined"){if(typeof node[prop]==="function"){jsonToPrint[prop]=node[prop].toString()}else if(typeof node[prop]==="object"){jsonToPrint[prop]=JSON.stringifyWithCircularRefs(node[prop])}else{jsonToPrint[prop]=node[prop]}}}return JSON.stringify(jsonToPrint)}};this.reconstruct=json=>{let parsed=reconstructObject(json);if(parsed)return this.add(parsed)};this.setState=this.state.setState;this.DEBUGNODES=(debugging=true)=>{this.DEBUGNODE=debugging;this.nodes.forEach(n=>{if(debugging)n.DEBUGNODE=true;else n.DEBUGNODE=false})};if(typeof properties==="function"){properties={operator:properties}}if(typeof properties==="object"){if(properties instanceof GraphNode&&properties._initial)Object.assign(properties,properties._initial);if(properties instanceof Graph){let source=properties;properties={source,operator:input=>{if(typeof input==="object"){let result={};for(const key in input){if(typeof source[key]==="function"){if(Array.isArray(input[key]))result[key]=source[key](...input[key]);else result[key]=source[key](input[key])}else{source[key]=input[key];result[key]=source[key]}}return result}return source}};if(source.operator)properties.operator=source.operator;if(source.children)properties.children=source.children;if(source.forward)properties.forward=source.forward;if(source.backward)properties.backward=source.backward;if(source.repeat)properties.repeat=source.repeat;if(source.recursive)properties.recursive=source.recursive;if(source.loop)properties.loop=source.loop;if(source.animate)properties.animate=source.animate;if(source.looper)properties.looper=source.looper;if(source.animation)properties.animation=source.animation;if(source.delay)properties.delay=source.delay;if(source.tag)properties.tag=source.tag;if(source.oncreate)properties.oncreate=source.oncreate;if(source.node){if(source.node._initial)Object.assign(properties,source.node._initial)}if(source._initial)Object.assign(properties,source._initial);this.nodes=source.nodes;source.node=this;if(graph){source.nodes.forEach(n=>{if(!graph.nodes.get(n.tag)){graph.nodes.set(n.tag,n);graph.nNodes++}})}}if(properties.tag&&(graph||parentNode)){let hasnode;if(graph?.nodes){hasnode=graph.nodes.get(properties.tag)}if(!hasnode&&parentNode?.nodes){hasnode=parentNode.nodes.get(properties.tag)}if(hasnode){Object.assign(this,hasnode);if(!this.source)this.source=hasnode;let props=hasnode.getProps();delete props.graph;delete props.parent;Object.assign(properties,props)}}if(properties?.operator){properties.operator=this.setOperator(properties.operator)}if(!properties.tag&&graph){properties.tag=`node${graph.nNodes}`}else if(!properties.tag){properties.tag=`node${Math.floor(Math.random()*1e10)}`}let keys=Object.getOwnPropertyNames(this);for(const key in properties){if(!keys.includes(key))this._initial[key]=properties[key]}if(properties.children)this._initial.children=Object.assign({},properties.children);Object.assign(this,properties);if(!this.tag){if(graph){this.tag=`node${graph.nNodes}`}else{this.tag=`node${Math.floor(Math.random()*1e10)}`}}if(graph){this.graph=graph;if(graph.nodes.get(this.tag)){this.tag=`${this.tag}${graph.nNodes+1}`}graph.nodes.set(this.tag,this);graph.nNodes++}if(parentNode){this.parent=parentNode;if(parentNode instanceof GraphNode||parentNode instanceof Graph)parentNode.nodes.set(this.tag,this)}if(typeof properties.tree==="object"){for(const key in properties.tree){if(typeof properties.tree[key]==="object"){if((!properties.tree[key]).tag){properties.tree[key].tag=key}}let node=new GraphNode(properties.tree[key],this,graph);this.nodes.set(node.tag,node)}}if(this.children)this.convertChildrenToNodes(this);if(this.parent instanceof GraphNode||this.parent instanceof Graph)this.checkNodesHaveChildMapped(this.parent,this);if(typeof this.oncreate==="function")this.oncreate(this);if(!this.firstRun)this.firstRun=true}else return properties}};var Graph=class{constructor(tree,tag,props){this.nNodes=0;this.nodes=new Map;this.state=state;this.tree={};this.add=(node={})=>{let props2=node;if(!(node instanceof GraphNode))node=new GraphNode(props2,this,this);else{this.nNodes=this.nodes.size;if(node.tag){this.tree[node.tag]=props2;this.nodes.set(node.tag,node)}}return node};this.setTree=(tree2=this.tree)=>{if(!tree2)return;for(const node in tree2){if(!this.nodes.get(node)){if(typeof tree2[node]==="function"){this.add({tag:node,operator:tree2[node]})}else if(typeof tree2[node]==="object"&&!Array.isArray(tree2[node])){if(!tree2[node].tag)tree2[node].tag=node;let newNode=this.add(tree2[node]);if(tree2[node].aliases){tree2[node].aliases.forEach(a=>{this.nodes.set(a,newNode)})}}else{this.add({tag:node,operator:(self2,origin,...args)=>{return tree2[node]}})}}else{let n=this.nodes.get(node);if(typeof tree2[node]==="function"){n.setOperator(tree2[node])}else if(typeof tree2[node]==="object"){if(tree2[node]instanceof GraphNode){this.add(tree2[node])}else if(tree2[node]instanceof Graph){let source=tree2[node];let properties={};if(source.operator)properties.operator=source.operator;if(source.children)properties.children=source.children;if(source.forward)properties.forward=source.forward;if(source.backward)properties.backward=source.backward;if(source.repeat)properties.repeat=source.repeat;if(source.recursive)properties.recursive=source.recursive;if(source.loop)properties.loop=source.loop;if(source.animate)properties.animate=source.animate;if(source.looper)properties.looper=source.looper;if(source.animation)properties.animation=source.animation;if(source.delay)properties.delay=source.delay;if(source.tag)properties.tag=source.tag;if(source.oncreate)properties.oncreate=source.oncreate;if(source.node?._initial)Object.assign(properties,source.node._initial);properties.nodes=source.nodes;properties.source=source;n.setProps(properties)}else{n.setProps(tree2[node])}}}}this.nodes.forEach(node=>{if(typeof node.children==="object"){for(const key in node.children){if(typeof node.children[key]==="string"){if(this.nodes.get(node.children[key])){node.children[key]=this.nodes.get(node.children[key])}}else if(node.children[key]===true||typeof node.children[key]==="undefined"){if(this.nodes.get(key)){node.children[key]=this.nodes.get(key)}}if(node.children[key]instanceof GraphNode){node.checkNodesHaveChildMapped(node,node.children[key])}}}if(typeof node.parent==="string"){if(this.nodes.get(node.parent)){node.parent=this.nodes.get(node.parent);node.nodes.set(node.parent.tag,node.parent)}}})};this.get=tag2=>{return this.nodes.get(tag2)};this.set=node=>{return this.nodes.set(node.tag,node)};this.run=(node,...args)=>{if(typeof node==="string")node=this.nodes.get(node);if(node instanceof GraphNode)return node._run(node,this,...args);else return void 0};this.runAsync=(node,...args)=>{if(typeof node==="string")node=this.nodes.get(node);if(node instanceof GraphNode)return new Promise((res,rej)=>{res(node._run(node,this,...args))});else return new Promise((res,rej)=>{res(void 0)})};this._run=(node,origin=this,...args)=>{if(typeof node==="string")node=this.nodes.get(node);if(node instanceof GraphNode)return node._run(node,origin,...args);else return void 0};this.removeTree=(node,checked)=>{if(typeof node==="string")node=this.nodes.get(node);if(node instanceof GraphNode){if(!checked)checked={};const recursivelyRemove=node2=>{if(node2.children&&!checked[node2.tag]){checked[node2.tag]=true;if(Array.isArray(node2.children)){node2.children.forEach(c=>{if(c.stopNode)c.stopNode();if(c.tag){if(this.nodes.get(c.tag))this.nodes.delete(c.tag)}this.nodes.forEach(n=>{if(n.nodes.get(c.tag))n.nodes.delete(c.tag)});recursivelyRemove(c)})}else if(typeof node2.children==="object"){if(node2.stopNode)node2.stopNode();if(node2.tag){if(this.nodes.get(node2.tag))this.nodes.delete(node2.tag)}this.nodes.forEach(n=>{if(n.nodes.get(node2.tag))n.nodes.delete(node2.tag)});recursivelyRemove(node2)}}};if(node.stopNode)node.stopNode();if(node.tag){this.nodes.delete(node.tag);this.nodes.forEach(n=>{if(n.nodes.get(node.tag))n.nodes.delete(node.tag)});this.nNodes=this.nodes.size;recursivelyRemove(node)}if(node.ondelete)node.ondelete(node)}return node};this.remove=node=>{if(typeof node==="string")node=this.nodes.get(node);if(node instanceof GraphNode){node.stopNode();if(node?.tag){if(this.nodes.get(node.tag)){this.nodes.delete(node.tag);this.nodes.forEach(n=>{if(n.nodes.get(node.tag))n.nodes.delete(node.tag)})}}if(node.ondelete)node.ondelete(node)}return node};this.append=(node,parentNode)=>{parentNode.addChildren(node)};this.callParent=async(node,origin=node,...args)=>{if(node?.parent){return await node.callParent(node,origin,...args)}};this.callChildren=async(node,idx,...args)=>{if(node?.children){return await node.callChildren(idx,...args)}};this.subscribe=(node,callback)=>{if(!callback)return;if(node instanceof GraphNode){return node.subscribe(callback)}else if(typeof node=="string")return this.state.subscribeTrigger(node,callback)};this.unsubscribe=(tag2,sub)=>{this.state.unsubscribeTrigger(tag2,sub)};this.subscribeNode=(inputNode,outputNode)=>{let tag2;if(inputNode?.tag)tag2=inputNode.tag;else if(typeof inputNode==="string")tag2=inputNode;return this.state.subscribeTrigger(tag2,res=>{this.run(outputNode,inputNode,...res)})};this.stopNode=node=>{if(typeof node==="string"){node=this.nodes.get(node)}if(node instanceof GraphNode){node.stopNode()}};this.print=(node=void 0,printChildren=true)=>{if(node instanceof GraphNode)return node.print(node,printChildren);else{let printed=`{`;this.nodes.forEach(n=>{printed+=`
"${n.tag}:${n.print(n,printChildren)}"`});return printed}};this.reconstruct=json=>{let parsed=reconstructObject(json);if(parsed)return this.add(parsed)};this.create=(operator,parentNode,props2)=>{return createNode(operator,parentNode,props2,this)};this.setState=this.state.setState;this.DEBUGNODES=(debugging=true)=>{this.nodes.forEach(n=>{if(debugging)n.DEBUGNODE=true;else n.DEBUGNODE=false})};this.tag=tag?tag:`graph${Math.floor(Math.random()*1e11)}`;if(props){Object.assign(this,props);this._initial=props}if(tree||Object.keys(this.tree).length>0)this.setTree(tree)}};function reconstructObject(json="{}"){try{let parsed=typeof json==="string"?JSON.parse(json):json;const parseObj=obj=>{for(const prop in obj){if(typeof obj[prop]==="string"){let funcParsed=parseFunctionFromText(obj[prop]);if(typeof funcParsed==="function"){obj[prop]=funcParsed}}else if(typeof obj[prop]==="object"){parseObj(obj[prop])}}return obj};return parseObj(parsed)}catch(err){console.error(err);return void 0}}var stringifyWithCircularRefs=function(){const refs=new Map;const parents=[];const path=["this"];function clear(){refs.clear();parents.length=0;path.length=1}function updateParents(key,value){var idx=parents.length-1;var prev=parents[idx];if(typeof prev==="object"){if(prev[key]===value||idx===0){path.push(key);parents.push(value.pushed)}else{while(idx-->=0){prev=parents[idx];if(typeof prev==="object"){if(prev[key]===value){idx+=2;parents.length=idx;path.length=idx;--idx;parents[idx]=value;path[idx]=key;break}}idx--}}}}function checkCircular(key,value){if(value!=null){if(typeof value==="object"){if(key){updateParents(key,value)}let other=refs.get(value);if(other){return"[Circular Reference]"+other}else{refs.set(value,path.join("."))}}}return value}return function stringifyWithCircularRefs2(obj,space){try{parents.push(obj);return JSON.stringify(obj,checkCircular,space)}finally{clear()}}}();if(JSON.stringifyWithCircularRefs===void 0){JSON.stringifyWithCircularRefs=stringifyWithCircularRefs}var stringifyFast=function(){const refs=new Map;const parents=[];const path=["this"];function clear(){refs.clear();parents.length=0;path.length=1}function updateParents(key,value){var idx=parents.length-1;if(parents[idx]){var prev=parents[idx];if(typeof prev==="object"){if(prev[key]===value||idx===0){path.push(key);parents.push(value.pushed)}else{while(idx-->=0){prev=parents[idx];if(typeof prev==="object"){if(prev[key]===value){idx+=2;parents.length=idx;path.length=idx;--idx;parents[idx]=value;path[idx]=key;break}}idx++}}}}}function checkValues(key,value){let val;if(value!=null){if(typeof value==="object"){let c=value.constructor.name;if(key&&c==="Object"){updateParents(key,value)}let other=refs.get(value);if(other){return"[Circular Reference]"+other}else{refs.set(value,path.join("."))}if(c==="Array"){if(value.length>20){val=value.slice(value.length-20)}else val=value}else if(c.includes("Set")){val=Array.from(value)}else if(c!=="Object"&&c!=="Number"&&c!=="String"&&c!=="Boolean"){val="instanceof_"+c}else if(c==="Object"){let obj={};for(const prop in value){if(value[prop]==null){obj[prop]=value[prop]}else if(Array.isArray(value[prop])){if(value[prop].length>20)obj[prop]=value[prop].slice(value[prop].length-20);else obj[prop]=value[prop]}else if(value[prop].constructor.name==="Object"){obj[prop]={};for(const p2 in value[prop]){if(Array.isArray(value[prop][p2])){if(value[prop][p2].length>20)obj[prop][p2]=value[prop][p2].slice(value[prop][p2].length-20);else obj[prop][p2]=value[prop][p2]}else{if(value[prop][p2]!=null){let con=value[prop][p2].constructor.name;if(con.includes("Set")){obj[prop][p2]=Array.from(value[prop][p2])}else if(con!=="Number"&&con!=="String"&&con!=="Boolean"){obj[prop][p2]="instanceof_"+con}else{obj[prop][p2]=value[prop][p2]}}else{obj[prop][p2]=value[prop][p2]}}}}else{let con=value[prop].constructor.name;if(con.includes("Set")){obj[prop]=Array.from(value[prop])}else if(con!=="Number"&&con!=="String"&&con!=="Boolean"){obj[prop]="instanceof_"+con}else{obj[prop]=value[prop]}}}val=obj}else{val=value}}else{val=value}}return val}return function stringifyFast2(obj,space){parents.push(obj);let res=JSON.stringify(obj,checkValues,space);clear();return res}}();if(JSON.stringifyFast===void 0){JSON.stringifyFast=stringifyFast}function createNode(operator,parentNode,props,graph){if(typeof props==="object"){props.operator=operator;return new GraphNode(props,parentNode,graph)}return new GraphNode({operator},parentNode,graph)}var Service=class extends Graph{constructor(options={}){super(void 0,options.name?options.name:`service${Math.floor(Math.random()*1e14)}`,options.props);this.routes={};this.loadDefaultRoutes=false;this.keepState=true;this.firstLoad=true;this.init=options2=>{if(options2)options2=Object.assign({},options2);else options2={};if(options2.customRoutes)Object.assign(options2.customRoutes,this.customRoutes);else options2.customRoutes=this.customRoutes;if(options2.customChildren)Object.assign(options2.customChildren,this.customChildren);else options2.customChildren=this.customChildren;if(Array.isArray(options2.routes)){options2.routes.forEach(r=>{this.load(r,options2.includeClassName,options2.routeFormat,options2.customRoutes,options2.customChildren)})}else if(options2.routes||(Object.keys(this.routes).length>0||this.loadDefaultRoutes)&&this.firstLoad)this.load(options2.routes,options2.includeClassName,options2.routeFormat,options2.customRoutes,options2.customChildren)};this.load=(routes,includeClassName=true,routeFormat=".",customRoutes,customChildren)=>{if(!routes&&!this.loadDefaultRoutes&&(Object.keys(this.routes).length>0||this.firstLoad))return;if(this.firstLoad)this.firstLoad=false;if(customRoutes)customRoutes=Object.assign(this.customRoutes,customRoutes);else customRoutes=this.customRoutes;if(customChildren)customChildren=Object.assign(this.customChildren,customChildren);let service;let allRoutes={};if(routes){if(!(routes instanceof Graph)&&routes?.name){if(routes.module){let mod=routes;routes={};Object.getOwnPropertyNames(routes.module).forEach(prop=>{if(includeClassName)routes[mod.name+routeFormat+prop]=routes.module[prop];else routes[prop]=routes.module[prop]})}else if(typeof routes==="function"){service=new routes({loadDefaultRoutes:this.loadDefaultRoutes});service.load();routes=service.routes}}else if(routes instanceof Graph||routes.source instanceof Graph){service=routes;routes={};let name;if(includeClassName){name=service.name;if(!name){name=service.tag;service.name=name}if(!name){name=`graph${Math.floor(Math.random()*1e15)}`;service.name=name;service.tag=name}}if(service.customRoutes&&!this.customRoutes)this.customRoutes=service.customRoutes;else if(service.customRoutes&&this.customRoutes)Object.assign(this.customRoutes,service.customRoutes);if(service.customChildren&&!this.customChildren)this.customChildren=service.customChildren;else if(service.customChildren&&this.customChildren)Object.assign(this.customChildren,service.customChildren);service.nodes.forEach(node=>{routes[node.tag]=node;let checked={};let checkChildGraphNodes=(nd,par)=>{if(!checked[nd.tag]||par&&includeClassName&&!checked[par?.tag+routeFormat+nd.tag]){if(!par)checked[nd.tag]=true;else checked[par.tag+routeFormat+nd.tag]=true;if(nd instanceof Graph||nd.source instanceof Graph){if(includeClassName){let nm=nd.name;if(!nm){nm=nd.tag;nd.name=nm}if(!nm){nm=`graph${Math.floor(Math.random()*1e15)}`;nd.name=nm;nd.tag=nm}}nd.nodes.forEach(n=>{if(includeClassName&&!routes[nd.tag+routeFormat+n.tag])routes[nd.tag+routeFormat+n.tag]=n;else if(!routes[n.tag])routes[n.tag]=n;checkChildGraphNodes(n,nd)})}}};checkChildGraphNodes(node)})}else if(typeof routes==="object"){let name=routes.constructor.name;if(name==="Object"){name=Object.prototype.toString.call(routes);if(name)name=name.split(" ")[1];if(name)name=name.split("]")[0]}if(name&&name!=="Object"){let module=routes;routes={};Object.getOwnPropertyNames(module).forEach(route=>{if(includeClassName)routes[name+routeFormat+route]=module[route];else routes[route]=module[route]})}}if(service instanceof Graph&&service.name&&includeClassName){routes=Object.assign({},routes);for(const prop in routes){let route=routes[prop];delete routes[prop];routes[service.name+routeFormat+prop]=route}}}if(this.loadDefaultRoutes){let rts2=Object.assign({},this.defaultRoutes);if(routes){Object.assign(rts2,this.routes);routes=Object.assign(rts2,routes)}else routes=Object.assign(rts2,this.routes);this.loadDefaultRoutes=false}if(!routes)routes=this.routes;let incr=0;for(const tag in routes){incr++;let childrenIter=(route,routeKey)=>{if(typeof route==="object"){if(!route.tag)route.tag=routeKey;if(typeof route?.children==="object"){nested:for(const key in route.children){incr++;if(typeof route.children[key]==="object"){let rt=route.children[key];if(rt.tag&&allRoutes[rt.tag])continue;if(customChildren){for(const k2 in customChildren){rt=customChildren[k2](rt,key,route,routes,allRoutes);if(!rt)continue nested}}if(rt.id&&!rt.tag){rt.tag=rt.id}let k;if(rt.tag){if(allRoutes[rt.tag]){let randkey=`${rt.tag}${incr}`;allRoutes[randkey]=rt;rt.tag=randkey;childrenIter(allRoutes[randkey],key);k=randkey}else{allRoutes[rt.tag]=rt;childrenIter(allRoutes[rt.tag],key);k=rt.tag}}else{if(allRoutes[key]){let randkey=`${key}${incr}`;allRoutes[randkey]=rt;rt.tag=randkey;childrenIter(allRoutes[randkey],key);k=randkey}else{allRoutes[key]=rt;childrenIter(allRoutes[key],key);k=key}}if(service?.name&&includeClassName){allRoutes[service.name+routeFormat+k]=rt;delete allRoutes[k]}else allRoutes[k]=rt}}}}};allRoutes[tag]=routes[tag];childrenIter(routes[tag],tag)}top:for(const route in allRoutes){if(typeof allRoutes[route]==="object"){let r=allRoutes[route];if(typeof r==="object"){if(customRoutes){for(const key in customRoutes){r=customRoutes[key](r,route,allRoutes);if(!r)continue top}}if(r.get){if(typeof r.get=="object"){}}if(r.post){}if(r.delete){}if(r.put){}if(r.head){}if(r.patch){}if(r.options){}if(r.connect){}if(r.trace){}if(r.post&&!r.operator){allRoutes[route].operator=r.post}else if(!r.operator&&typeof r.get=="function"){allRoutes[route].operator=r.get}}}}for(const route in routes){if(typeof routes[route]==="object"){if(this.routes[route]){if(typeof this.routes[route]==="object")Object.assign(this.routes[route],routes[route]);else this.routes[route]=routes[route]}else this.routes[route]=routes[route]}else if(this.routes[route]){if(typeof this.routes[route]==="object")Object.assign(this.routes[route],routes[route]);else this.routes[route]=routes[route]}else this.routes[route]=routes[route]}if(service){for(const key in this.routes){if(this.routes[key]instanceof GraphNode){this.nodes.set(key,this.routes[key]);this.nNodes=this.nodes.size}}}else this.setTree(this.routes);for(const prop in this.routes){if(this.routes[prop]?.aliases){let aliases=this.routes[prop].aliases;aliases.forEach(a=>{if(service?.name&&includeClassName)routes[service.name+routeFormat+a]=this.routes[prop];else routes[a]=this.routes[prop]})}}return this.routes};this.unload=(routes=this.routes)=>{if(!routes)return;let service;if(!(routes instanceof Service)&&typeof routes==="function"){service=new Service;routes=service.routes}else if(routes instanceof Service){routes=routes.routes}for(const r in routes){delete this.routes[r];if(this.nodes.get(r))this.remove(r)}return this.routes};this.handleMethod=(route,method,args,origin)=>{let m=method.toLowerCase();if(m==="get"&&this.routes[route]?.get?.transform instanceof Function){if(Array.isArray(args))return this.routes[route].get.transform(...args);else return this.routes[route].get.transform(args)}if(this.routes[route]?.[m]){if(!(this.routes[route][m]instanceof Function)){if(args)this.routes[route][m]=args;return this.routes[route][m]}else return this.routes[route][m](args)}else return this.handleServiceMessage({route,args,method,origin})};this.transmit=(...args)=>{if(typeof args[0]==="object"){if(args[0].method){return this.handleMethod(args[0].route,args[0].method,args[0].args)}else if(args[0].route){return this.handleServiceMessage(args[0])}else if(args[0].node){return this.handleGraphNodeCall(args[0].node,args[0].args,args[0].origin)}else if(this.keepState){if(args[0].route)this.setState({[args[0].route]:args[0].args});if(args[0].node)this.setState({[args[0].node]:args[0].args})}return args}else return args};this.receive=(...args)=>{if(args[0]){if(typeof args[0]==="string"){let substr=args[0].substring(0,8);if(substr.includes("{")||substr.includes("[")){if(substr.includes("\\"))args[0]=args[0].replace(/\\/g,"");if(args[0][0]==='"'){args[0]=args[0].substring(1,args[0].length-1)};args[0]=JSON.parse(args[0])}}}if(typeof args[0]==="object"){if(args[0].method){return this.handleMethod(args[0].route,args[0].method,args[0].args)}else if(args[0].route){return this.handleServiceMessage(args[0])}else if(args[0].node){return this.handleGraphNodeCall(args[0].node,args[0].args,args[0].origin)}else if(this.keepState){if(args[0].route)this.setState({[args[0].route]:args[0].args});if(args[0].node)this.setState({[args[0].node]:args[0].args})}return args}else return args};this.pipe=(source,destination,endpoint,origin,method,callback)=>{if(source instanceof GraphNode){if(callback)return source.subscribe(res=>{let mod=callback(res);if(mod!==void 0)this.transmit({route:destination,args:mod,origin,method});else this.transmit({route:destination,args:res,origin,method},endpoint)});else return this.subscribe(source,res=>{this.transmit({route:destination,args:res,origin,method},endpoint)})}else if(typeof source==="string")return this.subscribe(source,res=>{this.transmit({route:destination,args:res,origin,method},endpoint)})};this.pipeOnce=(source,destination,endpoint,origin,method,callback)=>{if(source instanceof GraphNode){if(callback)return source.state.subscribeTriggerOnce(source.tag,res=>{let mod=callback(res);if(mod!==void 0)this.transmit({route:destination,args:mod,origin,method});else this.transmit({route:destination,args:res,origin,method},endpoint)});else return this.state.subscribeTriggerOnce(source.tag,res=>{this.transmit({route:destination,args:res,origin,method},endpoint)})}else if(typeof source==="string")return this.state.subscribeTriggerOnce(source,res=>{this.transmit({route:destination,args:res,origin,method},endpoint)})};this.terminate=(...args)=>{this.nodes.forEach(n=>{n.stopNode()})};this.recursivelyAssign=(target,obj)=>{for(const key in obj){if(typeof obj[key]==="object"){if(typeof target[key]==="object")this.recursivelyAssign(target[key],obj[key]);else target[key]=this.recursivelyAssign({},obj[key])}else target[key]=obj[key]}return target};this.defaultRoutes={"/":{get:()=>{return this.print()},aliases:[""]},ping:()=>{console.log("ping");return"pong"},echo:(...args)=>{this.transmit(...args);return args},assign:source=>{if(typeof source==="object"){Object.assign(this,source);return true}return false},recursivelyAssign:source=>{if(typeof source==="object"){this.recursivelyAssign(this,source);return true}return false},log:{post:(...args)=>{console.log("Log: ",...args)},aliases:["info"]},error:message=>{let er=new Error(message);console.error(message);return er},state:key=>{if(key){return this.state.data[key]}else return this.state.data},printState:key=>{if(key){return stringifyWithCircularRefs(this.state.data[key])}else return stringifyWithCircularRefs(this.state.data)},transmit:this.transmit,receive:this.receive,load:this.load,unload:this.unload,pipe:this.pipe,terminate:this.terminate,run:this.run,_run:this._run,subscribe:this.subscribe,unsubscribe:this.unsubscribe,stopNode:this.stopNode,get:this.get,add:this.add,remove:this.remove,setTree:this.setTree,setState:this.setState,print:this.print,reconstruct:this.reconstruct,handleMethod:this.handleMethod,handleServiceMessage:this.handleServiceMessage,handleGraphNodeCall:this.handleGraphNodeCall};if(options.name)this.name=options.name;else options.name=this.tag;if("loadDefaultRoutes"in options){this.loadDefaultRoutes=options.loadDefaultRoutes;this.routes=Object.assign(this.defaultRoutes,this.routes)}if(options||Object.keys(this.routes).length>0)this.init(options)}handleServiceMessage(message){let call;if(typeof message==="object"){if(message.route)call=message.route;else if(message.node)call=message.node}if(call){if(message.origin){if(Array.isArray(message.args))return this._run(call,message.origin,...message.args);else return this._run(call,message.origin,message.args)}else{if(Array.isArray(message.args))return this.run(call,...message.args);else return this.run(call,message.args)}}else return message}handleGraphNodeCall(route,args,origin){if(!route)return args;if(args?.args){this.handleServiceMessage(args)}else if(origin){if(Array.isArray(args))return this._run(route,origin,...args);else return this._run(route,origin,args)}else if(Array.isArray(args))return this.run(route,...args);else return this.run(route,args)}isTypedArray(x){return ArrayBuffer.isView(x)&&Object.prototype.toString.call(x)!=="[object DataView]"}};var unsafeRoutes={setRoute:(self2,origin,fn,fnName)=>{if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;if(self2.graph.get(fnName)){self2.graph.get(fnName).setOperator(fn)}else self2.graph.load({[fnName]:{operator:fn}});return true}return false},setNode:(self2,origin,fn,fnName)=>{if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;if(self2.graph.get(fnName)){self2.graph.get(fnName).setOperator(fn)}else self2.graph.add({tag:fnName,operator:fn});return true}return false},setMethod:(self2,origin,route,fn,fnName)=>{if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;if(self2.graph.get(route)){self2.graph.get(route)[fnName]=fn}else self2.graph.add({tag:fnName,[fnName]:fn});return true}return false},assignRoute:(self2,origin,route,source)=>{if(self2.graph.get(route)&&typeof source==="object"){Object.assign(self2.graph.get(route),source)}},transferClass:(classObj,className)=>{if(typeof classObj==="object"){let str2=classObj.toString();let message={route:"receiveClass",args:[str2,className]};return message}return false},receiveClass:(self2,origin,stringified,className)=>{if(typeof stringified==="string"){if(stringified.indexOf("class")===0){let cls=(0,eval)("("+stringified+")");let name=className;if(!name)name=cls.name;self2.graph[name]=cls;return true}}return false},setValue:(self2,origin,key,value)=>{globalThis[key]=value;return true},assignObject:(self2,origin,target,source)=>{if(!globalThis[target])return false;if(typeof source==="object")Object.assign(globalThis[target],source);return true},setFunction:(self2,origin,fn,fnName)=>{if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;globalThis[fnName]=fn;return true}return false},assignFunctionToObject:(self2,origin,globalObjectName,fn,fnName)=>{if(!globalThis[globalObjectName])return false;if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;globalThis[globalObjectName][fnName]=fn;return true}return false}};var Systems={collision:{setupEntities:(self2,entities)=>{for(const key in entities){const entity=entities[key];if(entity.components){if(!entity.components[self2.tag])continue}Systems.collision.setEntity(entity)}},setEntity:entity=>{if(!("collisionEnabled"in entity))entity.collisionEnabled=true;if(!entity.collisionType)entity.collisionType="sphere";if(!entity.collisionRadius)entity.collisionRadius=1;if(!entity.collisionBoundsScale)entity.collisionBoundsScale={x:1,y:1,z:1};if(!entity.colliding)entity.colliding={};if(!entity.position)entity.position={x:0,y:0,z:0}},operator:(self2,origin,entities)=>{for(const key in entities){const entity1=entities[key];if(entity1.components){if(!entity1.components[self2.tag]||!entity1.collisionEnabled)continue}if(!entity1.collisionEnabled)continue;for(const key2 in entities){const entity2=entities[key2];if(entity2.components){if(!entity2.components[self2.tag])continue}if(!entity2.collisionEnabled)continue;let colliding=Systems.collision.collisionCheck(entity1,entity2);if(colliding!==false){entity1.colliding[entity2.tag]=colliding;entity2.colliding[entity1.tag]=colliding}}}return entities},collisionCheck:(body1,body2)=>{if(body1.collisionEnabled===false||body2.collisionEnabled===false)return false;const dist=Systems.collision.distance(body1.position,body2.position);if(dist<Math.max(...Object.values(body1.collisionBoundsScale))*body1.collisionRadius+Math.max(...Object.values(body2.collisionBoundsScale))*body2.collisionRadius){let isColliding=false;if(body1.collisionType==="sphere"){if(body2.collisionType==="sphere"){isColliding=Systems.collision.sphereCollisionCheck(body1,body2,dist)}else if(body2.collisionType==="box"){isColliding=Systems.collision.sphereBoxCollisionCheck(body1,body2,dist)}else if(body2.collisionType==="point"){isColliding=Systems.collision.isPointInsideSphere(body2.position,body1,dist)}}else if(body1.collisionType==="box"){if(body2.collisionType==="sphere"){isColliding=Systems.collision.sphereBoxCollisionCheck(body2,body1,dist)}else if(body2.collisionType==="box"){isColliding=Systems.collision.boxCollisionCheck(body1,body2)}else if(body2.collisionType==="point"){isColliding=Systems.collision.isPointInsideBox(body1.position,body1)}}else if(body1.collisionType==="point"){if(body2.collisionType==="sphere"){isColliding=Systems.collision.isPointInsideSphere(body1.position,body2,dist)}else if(body2.collisionType==="box"){isColliding=Systems.collision.isPointInsideBox(body1.position,body2)}}if(isColliding)return dist}return false},sphereCollisionCheck:(body1,body2,dist)=>{if(dist===void 0)dist=Systems.collision.distance(body1.position,body2.position);return dist<body1.collisionRadius+body2.collisionRadius},boxCollisionCheck:(body1,body2)=>{let body1minX=(body1.position.x-body1.collisionRadius)*body1.collisionBoundsScale.x;let body1maxX=(body1.position.x+body1.collisionRadius)*body1.collisionBoundsScale.x;let body1minY=(body1.position.y-body1.collisionRadius)*body1.collisionBoundsScale.y;let body1maxY=(body1.position.y+body1.collisionRadius)*body1.collisionBoundsScale.y;let body1minZ=(body1.position.z-body1.collisionRadius)*body1.collisionBoundsScale.z;let body1maxZ=(body1.position.z+body1.collisionRadius)*body1.collisionBoundsScale.z;let body2minX=(body2.position.x-body2.collisionRadius)*body1.collisionBoundsScale.x;let body2maxX=(body2.position.x+body2.collisionRadius)*body1.collisionBoundsScale.x;let body2minY=(body2.position.y-body2.collisionRadius)*body1.collisionBoundsScale.y;let body2maxY=(body2.position.y+body2.collisionRadius)*body1.collisionBoundsScale.y;let body2minZ=(body2.position.z-body2.collisionRadius)*body1.collisionBoundsScale.z;let body2maxZ=(body2.position.z+body2.collisionRadius)*body1.collisionBoundsScale.z;return(body1maxX<=body2maxX&&body1maxX>=body2minX||body1minX<=body2maxX&&body1minX>=body2minX)&&(body1maxY<=body2maxY&&body1maxY>=body2minY||body1minY<=body2maxY&&body1minY>=body2minY)&&(body1maxZ<=body2maxZ&&body1maxZ>=body2minZ||body1minZ<=body2maxZ&&body1minZ>=body2minZ)},sphereBoxCollisionCheck:(sphere,box,dist)=>{let boxMinX=(box.position.x-box.collisionRadius)*box.collisionBoundsScale.x;let boxMaxX=(box.position.x+box.collisionRadius)*box.collisionBoundsScale.x;let boxMinY=(box.position.y-box.collisionRadius)*box.collisionBoundsScale.y;let boxMaxY=(box.position.y+box.collisionRadius)*box.collisionBoundsScale.y;let boxMinZ=(box.position.z-box.collisionRadius)*box.collisionBoundsScale.z;let boxMaxZ=(box.position.z+box.collisionRadius)*box.collisionBoundsScale.z;let clamp={x:Math.max(boxMinX,Math.min(sphere.position.x,boxMaxX)),y:Math.max(boxMinY,Math.min(sphere.position.y,boxMaxY)),z:Math.max(boxMinZ,Math.min(sphere.position.z,boxMaxZ))};if(dist===void 0)dist=Systems.collision.distance(sphere.position,clamp);return dist>sphere.collisionRadius},isPointInsideSphere:(point,sphere,dist)=>{if(dist===void 0)dist=Systems.collision.distance(point,sphere.position);return dist<sphere.collisionRadius},isPointInsideBox:(point,box)=>{let boxminX=(box.position.x-box.collisionRadius)*box.collisionBoundsScale.x;let boxmaxX=(box.position.x+box.collisionRadius)*box.collisionBoundsScale.x;let boxminY=(box.position.y-box.collisionRadius)*box.collisionBoundsScale.x;let boxmaxY=(box.position.y+box.collisionRadius)*box.collisionBoundsScale.x;let boxminZ=(box.position.z-box.collisionRadius)*box.collisionBoundsScale.x;let boxmaxZ=(box.position.z+box.collisionRadius)*box.collisionBoundsScale.x;return point.x>=boxminX&&point.x<=boxmaxX&&(point.y>=boxminY&&point.y<=boxmaxY)&&(point.z>=boxminZ&&point.z<=boxmaxZ)},closestPointOnLine:(point,lineStart,lineEnd)=>{let a={x:lineEnd.x-lineStart.x,y:lineEnd.y-lineStart.y,z:lineEnd.z-lineStart.z};let b2={x:lineStart.x-point.x,y:lineStart.y-point.y,z:lineStart.z-point.z};let c={x:lineEnd.x-point.x,y:lineEnd.y-point.y,z:lineEnd.z-point.z};let bdota=Systems.collision.dot(b2,a);if(bdota<=0)return lineStart;let cdota=Systems.collision.dot(c,a);if(cdota<=0)return lineEnd;let _bdotapluscdota=1/(bdota+cdota);return{x:lineStart.x+(lineEnd.x-lineStart.x)*bdota*_bdotapluscdota,y:lineStart.y+(lineEnd.y-lineStart.y)*bdota*_bdotapluscdota,z:lineStart.z+(lineEnd.z-lineStart.z)*bdota*_bdotapluscdota}},closestPointOnPolygon:(point,t0,t1,t2)=>{let n=Systems.collision.calcNormal(t0,t1,t2);let dist=Systems.collision.dot(point,n)-Systems.collision.dot(t0,n);let projection=Systems.collision.vecadd(point,Systems.collision.vecscale(n,-dist));let v0x=t2[0]-t0[0];let v0y=t2[1]-t0[1];let v0z=t2[2]-t0[2];let v1x=t1[0]-t0[0];let v1y=t1[1]-t0[1];let v1z=t1[2]-t0[2];let v2x=projection[0]-t0[0];let v2y=projection[1]-t0[1];let v2z=projection[2]-t0[2];let dot00=v0x*v0x+v0y*v0y+v0z*v0z;let dot01=v0x*v1x+v0y*v1y+v0z*v1z;let dot02=v0x*v2x+v0y*v2y+v0z*v2z;let dot11=v1x*v1x+v1y*v1y+v1z*v1z;let dot12=v1x*v2x+v1y*v2y+v1z*v2z;let denom=dot00*dot11-dot01*dot01;if(Math.abs(denom)<1e-30){return void 0}let _denom=1/denom;let u=(dot11*dot02-dot01*dot12)*_denom;let v2=(dot00*dot12-dot01*dot02)*_denom;if(u>=0&&v2>=0&&u+v2<1){return projection}else return void 0},calcNormal:(t0,t1,t2,positive=true)=>{var QR=Systems.collision.makeVec(t0,t1);var QS=Systems.collision.makeVec(t0,t2);if(positive===true){return Systems.collision.normalize(Systems.collision.cross3D(QR,QS))}else{return Systems.collision.normalize(Systems.collision.cross3D(QS,QR))}},dot:(v1,v2)=>{let dot=0;for(const key in v1){dot+=v1[key]*v2[key]}return dot},makeVec(p1,p2){return{x:p2.x-p1.x,y:p2.y-p1.y,z:p2.z-p1.z}},vecadd:(v1,v2)=>{let result=Object.assign({},v1);for(const key in result){result[key]+=v2[key]}return result},vecsub:(v1,v2)=>{let result=Object.assign({},v1);for(const key in result){result[key]-=v2[key]}return result},vecmul:(v1,v2)=>{let result=Object.assign({},v1);for(const key in result){result[key]*=v2[key]}return result},vecdiv:(v1,v2)=>{let result=Object.assign({},v1);for(const key in result){result[key]/=v2[key]}return result},vecscale:(v1,scalar)=>{let result=Object.assign({},v1);for(const key in result){result[key]*=scalar}return result},distance:(v1,v2)=>{let distance=0;for(const key in v1){distance+=Math.pow(v1[key]-v2[key],2)}return Math.sqrt(distance)},magnitude:v2=>{let magnitude=0;for(const key in v2){magnitude+=v2[key]*v2[key]}return Math.sqrt(magnitude)},normalize:v2=>{let magnitude=Systems.collision.magnitude(v2);let _mag=1/magnitude;let vn={};for(const key in v2){vn[key]=v2[key]*_mag}return vn},cross3D(v1,v2){return{x:v1.y*v2.z-v1.z*v2.y,y:v1.z*v2.x-v1.x*v2.z,z:v1.x*v2.y-v1.y*v2.x}},nearestNeighborSearch(entities,isWithinRadius=1e15){var tree={};;for(const key in entities){let newnode={tag:key,position:void 0,neighbors:[]};newnode.position=entities[key].position;tree[key]=newnode}for(const i in tree){for(const j in tree){var dist=Systems.collision.distance(tree[i].position,tree[j].position);if(dist<isWithinRadius){var newNeighbori={tag:j,position:entities[j].position,dist};tree[i].neighbors.push(newNeighbori);var newNeighborj={tag:j,position:entities[i].position,dist};tree[j].neighbors.push(newNeighborj)}}tree[i].neighbors.sort(function(a,b2){return a.dist-b2.dist})}return tree},generateBoundingVolumeTree(entities,mode="octree",withinRadius=1e15,minEntities=3){let dynamicBoundingVolumeTree={proto:{parent:void 0,children:{},entities:{},collisionType:"box",collisionRadius:1,collisionBoundsScale:{x:1,y:1,z:1},position:{x:0,y:0,z:0}},tree:{}};let maxX,maxY,maxZ;let minX=0,minY=0,minZ=0;let positions={};let minRadius=withinRadius;for(const key in entities){const body=entities[key];let xx=body.position.x+body.collisionRadius*body.collisionBoundsScale.x;let yy=body.position.y+body.collisionRadius*body.collisionBoundsScale.y;let zz=body.position.z+body.collisionRadius*body.collisionBoundsScale.z;if(maxX<xx)maxX=xx;if(minX>xx)minX=xx;if(maxY<yy)maxY=yy;if(minY>yy)minY=yy;if(maxZ<zz)maxZ=zz;if(minZ>zz)minZ=zz;if(minRadius>body.collisionRadius)minRadius=body.collisionRadius;positions[key]=body.position};let head=JSON.parse(JSON.stringify(dynamicBoundingVolumeTree.proto));let boxpos={x:(maxX+minX)*.5,y:(maxY+minY)*.5,z:(maxZ+minZ)*.5};let boxbounds={x:maxX-boxpos.x,y:maxY-boxpos.y,z:maxZ-boxpos.z};head.position=boxpos;head.collisionBoundsScale=boxbounds;head.entities=entities;dynamicBoundingVolumeTree.tree=head;minRadius*=2;if(mode==="octree"){let genOct=function(parentPos,halfbounds){let oct1={x:parentPos.x+halfbounds.x,y:parentPos.y+halfbounds.y,z:parentPos.z+halfbounds.z};let oct2={x:parentPos.x-halfbounds.x,y:parentPos.y+halfbounds.y,z:parentPos.z+halfbounds.z};let oct3={x:parentPos.x+halfbounds.x,y:parentPos.y-halfbounds.y,z:parentPos.z+halfbounds.z};let oct4={x:parentPos.x+halfbounds.x,y:parentPos.y+halfbounds.y,z:parentPos.z-halfbounds.z};let oct5={x:parentPos.x-halfbounds.x,y:parentPos.y-halfbounds.y,z:parentPos.z+halfbounds.z};let oct6={x:parentPos.x-halfbounds.x,y:parentPos.y+halfbounds.y,z:parentPos.z-halfbounds.z};let oct7={x:parentPos.x+halfbounds.x,y:parentPos.y-halfbounds.y,z:parentPos.z-halfbounds.z};let oct8={x:parentPos.x-halfbounds.x,y:parentPos.y-halfbounds.y,z:parentPos.z-halfbounds.z};return[oct1,oct2,oct3,oct4,oct5,oct6,oct7,oct8]},genOctTree=function(head2){let halfbounds={x:head2.collisionBoundsScale.x*.5,y:head2.collisionBoundsScale.y*.5,z:head2.collisionBoundsScale.z*.5};let octPos=genOct(head2.position,halfbounds);let check=Object.assign({},head2.bodies);for(let i=0;i<8;i++){let octquadrant=Object.assign(JSON.parse(JSON.stringify(dynamicBoundingVolumeTree.proto)),{position:octPos[i],collisionBoundsScale:halfbounds});octquadrant.parent=head2;for(const j in check){let collided=Systems.collision.collisionCheck(check[j],octquadrant);if(collided){octquadrant.entities[j]=check[j];delete check[j]}}if(Object.keys(octquadrant.entities).length>minEntities-1){head2.children[i]=octquadrant;octquadrant.parent=head2;if(Object.keys(octquadrant.entities).length>minEntities&&octquadrant.collisionRadius*.5>minRadius){genOctTree(octquadrant)}}}};genOctTree(head);return head}else{let tree=Systems.collision.nearestNeighborSearch(positions,withinRadius);let keys=Object.keys(tree);let tag=keys[Math.floor(Math.random()*keys.length)];let searching=true;let count=0;let genBoundingBoxLevel=(tree2,volumes)=>{let newVolumes={};let foundidxs={};let treekeys=Object.keys(tree2);while(searching&&count<treekeys.length){let node=tree2[tag];let i=0;let j=0;let ux=positions[node.tag].x-volumes[node.tag].collisionBoundsScale.x,uy=positions[node.tag].y-volumes[node.tag].collisionBoundsScale.y,uz=positions[node.tag].z-volumes[node.tag].collisionBoundsScale.z,mx=positions[node.tag].x+volumes[node.tag].collisionBoundsScale.x,my=positions[node.tag].y+volumes[node.tag].collisionBoundsScale.y,mz=positions[node.tag].z+volumes[node.tag].collisionBoundsScale.z;let newvolume=JSON.parse(JSON.stringify(dynamicBoundingVolumeTree.proto));newvolume.tag=`bound${Math.floor(Math.random()*1e15)}`;newvolume.children[node.tag]=volumes[node.tag];newvolume.bodies[node.tag]=entities[node.tag];volumes[node.tag].parent=newvolume;foundidxs[node.tag]=true;i++;j++;let nkeys=Object.keys(node.neighbors);while(i<nkeys.length&&j<3){if(foundidxs[node.neighbors[i].tag]){i++;continue}let uxn=positions[node.neighbors[i].tag].x-volumes[node.neighbors[i].tag].collisionBoundsScale.x,uyn=positions[node.neighbors[i].tag].y-volumes[node.neighbors[i].tag].collisionBoundsScale.y,uzn=positions[node.neighbors[i].tag].z-volumes[node.neighbors[i].tag].collisionBoundsScale.z,mxn=positions[node.neighbors[i].tag].x+volumes[node.neighbors[i].tag].collisionBoundsScale.x,myn=positions[node.neighbors[i].tag].y+volumes[node.neighbors[i].tag].collisionBoundsScale.y,mzn=positions[node.neighbors[i].tag].z+volumes[node.neighbors[i].tag].collisionBoundsScale.z;if(ux>uxn)ux=uxn;if(mx<mxn)mx=mxn;if(uy>uyn)uy=uyn;if(my<myn)my=myn;if(uz>uzn)uz=uzn;if(mz<mzn)mz=mzn;newvolume.children[node.neighbors[i].tag]=volumes[node.neighbors[i].tag];newvolume.entities[node.neighbors[i].tag]=entities[node.neighbors[i].tag];volumes[node.neighbors[i].tag].parent=newvolume;foundidxs[node.neighbors[i].tag]=true;i++;j++}let pos={x:(mx+ux)*.5,y:(my+uy)*.5,z:(mz+uz)*.5};let bounds={x:mx-pos.x,y:my-pos.y,z:mz-pos.z};newvolume.position=pos;newvolume.collisionBoundsScale=bounds;if(newvolume.bodies.length===1)newvolume=node;newVolumes[newvolume.tag]=newvolume;while(i<node.neighbors.length){if(!foundidxs[node.neighbors[i].tag])break;i++}if(i<node.neighbors.length){tag=node.neighbors[i].tag}else if(Object.keys(foundidxs).length<Object.keys(tree2).length){tag=keys[0]}else searching=false;count++}return newVolumes};let result=genBoundingBoxLevel(tree,entities);while(Object.keys(result).length>2){let nextTree=Systems.collision.nearestNeighborSearch(result,withinRadius);result=genBoundingBoxLevel(nextTree,result)}head.children=result;head.children.forEach(n=>{n.parent=head});return head}}},collider:{lastTime:performance.now(),useBoundingBox:true,collisionBounds:{bot:0,top:100,left:0,right:100,front:0,back:100},setupEntities:(self2,entities)=>{for(const key in entities){const entity=entities[key];if(entity.components){if(!entity.components[self2.tag])continue}self2.setEntity(entity)}},setEntity:entity=>{Systems.collision.setEntity(entity);Systems.movement.setEntity(entity);if(!("restitution"in entity))entity.restitution=1},operator:(self2,origin,entities)=>{for(const key in entities){const entity1=entities[key];if(entity1.components){if(!entity1.components[self2.tag]||!entity1.collisionEnabled)continue}if(!entity1.collisionEnabled)continue;for(const key2 in entity1.colliding){const entity2=entities[key2];if(entity1.colliding[key2]===false){delete entity1.colliding[key2];delete entity2.colliding[entity1.tag];continue}if(!entity2.collisionEnabled)continue;if(entity2.collisionType==="box"){self2.resolveBoxCollision(entity1,entity2,entity1.colliding[key2])}else{if(entity1.collisionType==="box"){entity1.fixed=true;self2.resolveSphereCollisions(entity1,entity2,entity1.colliding[key2]);entity1.fixed=false}else{self2.resolveSphereCollisions(entity1,entity2,entity1.colliding[key2]);delete entity2.colliding[entity1.tag]}}delete entity1.colliding[entity2.tag]}if(self2.useBoundingBox)self2.checkBoundingBox(self2,entity1)}return entities},checkBoundingBox:(self2,entity)=>{const ysize=entity.collisionRadius*entity.collisionBoundsScale.y;const xsize=entity.collisionRadius*entity.collisionBoundsScale.x;const zsize=entity.collisionRadius*entity.collisionBoundsScale.z;if(entity.position.y-ysize<=self2.collisionBounds.top){entity.velocity.y*=entity.restitution;entity.position.y=self2.collisionBounds.top+ysize}if(entity.position.y+ysize>=self2.collisionBounds.bot){entity.velocity.y*=entity.restitution;entity.position.y=self2.collisionBounds.bot-ysize}if(entity.position.x-xsize<=self2.collisionBounds.left){entity.velocity.x*=entity.restitution;entity.position.x=self2.collisionBounds.left+xsize}if(entity.position.x+xsize>=self2.collisionBounds.right){entity.velocity.x*=entity.restitution;entity.position.x=self2.collisionBounds.right-xsize}if(entity.position.z-zsize<=self2.collisionBounds.front){entity.velocity.z*=entity.restitution;entity.position.z=self2.collisionBounds.front+zsize}if(entity.position.z+zsize>=self2.collisionBounds.back){entity.velocity.z*=entity.restitution;entity.position.z=self2.collisionBounds.back-zsize}},resolveBoxCollision:(body1,box,negate)=>{let positionVec=Systems.collision.makeVec(body1.position,box.position);var directionVec=Object.values(positionVec);let closestSide;let closestDist=Infinity;let mul=-1;if(directionVec[idx]<0)mul=1;if(negate)mul=-mul;for(const key in body1.position){let dist=Math.abs(box.position[key]-body1.position[key]);if(dist<closestDist&&Math.abs(box.position[key]-body1.position[key]+body1.velocity[key]*1e-17)<dist){closestSide=key;closestDist=dist}}var idx=directionVec.indexOf(closestSide);if(idx===0)idx="x";if(idx===1)idx="y";if(idx===2)idx="z";if(idx===3)idx="w";let boxEdgeAxisPosition=box.position[idx]+box.collisionRadius*box.collisionBoundsScale[idx]*mul;if(negate){let body1Offset=boxEdgeAxisPosition-body1.collisionRadius*body1.collisionBoundsScale[idx]*mul;body1.position[idx]=body1Offset}else{let body1Offset=boxEdgeAxisPosition+body1.collisionRadius*body1.collisionBoundsScale[idx]*mul;body1.position[idx]=body1Offset}body1.velocity[idx]=-body1.velocity[idx]*body1.restitution;if(negate)body1.force[idx]=-body1.velocity[idx];var body2AccelMag=Systems.collision.magnitude(box.acceleration);var body2AccelNormal=Systems.collision.normalize(box.acceleration);body1.force[idx]=-body2AccelNormal[idx]*body2AccelMag*box.mass;if(negate)body1.force[idx]=-body1.force[idx]},resolveSphereCollisions:(entity1,entity2,dist)=>{if(dist===void 0)dist=Systems.collision.distance(entity1.position,entity2.position);let vecn=Systems.collision.normalize(Systems.collision.makeVec(entity1.position,entity2.position));let sumMass=entity1.mass+entity2.mass;let ratio=entity1.mass/sumMass;let rmin=1-ratio;if(entity1.fixed===false){entity1.position.x+=vecn.x*rmin*1.01;entity1.position.y+=vecn.y*rmin*1.01;entity1.position.z+=vecn.z*rmin*1.001}else{entity2.position.x-=vecn.x*1.01;entity2.position.y-=vecn.y*1.01;entity2.position.z-=vecn.z*1.01}if(entity2.fixed===false){entity2.position.x+=vecn.x*ratio*1.01;entity2.position.y+=vecn.y*ratio*1.01;entity2.position.z+=vecn.z*ratio*1.01}else{entity1.position.x+=vecn.x*1.01;entity1.position.y+=vecn.y*1.01;entity1.position.z+=vecn.z*1.01}dist=Systems.collision.distance(entity1.position,entity2.position);let vrel={x:entity1.velocity.x-entity2.velocity.x,y:entity1.velocity.y-entity2.velocity.y,z:entity1.velocity.z-entity2.velocity.z};let speed=vrel.x*vecn.x+vrel.y*vecn.y+vrel.z*vecn.z;if(speed>0){let impulse=2*speed/sumMass;if(entity1.fixed===false){entity1.velocity.x-=impulse*vecn.x*entity2.mass*entity1.restitution;entity1.velocity.y-=impulse*vecn.y*entity2.mass*entity1.restitution;entity1.velocity.z-=impulse*vecn.z*entity2.mass*entity1.restitution}if(entity2.fixed===false){entity2.velocity.x+=impulse*vecn.x*entity2.mass*entity2.restitution/entity2.mass;entity2.velocity.y+=impulse*vecn.y*entity2.mass*entity2.restitution/entity2.mass;entity2.velocity.z+=impulse*vecn.z*entity2.mass*entity2.restitution/entity2.mass}}}},nbody:{lastTime:performance.now(),G:6674e-14,setupEntities:(self2,entities)=>{for(const key in entities){const entity=entities[key];if(entity.components){if(!entity.components[self2.tag])continue}Systems.nbody.setEntity(entity)}},setEntity:entity=>{Systems.collision.setEntity(entity);Systems.movement.setEntity(entity);entity.isAttractor=true},operator:(self2,origin,entities)=>{for(const key in entities){const entity=entities[key];if(entity.components){if(!entity.components[self2.tag])continue}if(!entity.mass)continue;for(const key2 in entities){const entity2=entities[key2];if(entity2.components){if(!entity2.components[self2.tag])continue}if(!entity2.mass||!entity2.isAttractor)continue;Systems.nbody.attract(entity,entity2)}}return entities},attract:(body1,body2,dist,vecn)=>{if(dist===void 0)dist=Systems.collision.distance(body1.position,body2.position);if(vecn===void 0)vecn=Systems.collision.normalize(Systems.collision.makeVec(body1.position,body2.position));let Fg=6674e-14*body1.mass*body2.mass/(dist*dist);body1.force.x+=vecn.x*Fg;body1.force.y+=vecn.y*Fg;body1.force.z+=vecn.z*Fg;body2.force.x-=vecn.x*Fg;body2.force.y-=vecn.y*Fg;body2.force.z-=vecn.z*Fg}},boid:{lastTime:performance.now(),setupEntities:entities=>{for(const key in entities){const entity=entities[key];Systems.collision.setEntity(entity);Systems.movement.setEntity(entity);if(!entity.boid){entity.boid={cohesion:1e-5,separation:1e-4,alignment:.006,swirl:{x:.5,y:.5,z:.5,mul:.006},attractor:{x:.5,y:.5,z:.5,mul:.002},useCohesion:true,useSeparation:true,useAlignment:true,useSwirl:true,useAttractor:true,useAttraction:false,groupRadius:200,groupSize:10,searchLimit:10}}}},operator:(self2,origin,entities)=>{let now=performance.now();let timeStep=now-self2.lastTime;self2.lastTime=now;let keys=Object.keys(entities);let length=Object.keys(entities).length;let _timeStep=1/timeStep;outer:for(const i in entities){let p0=entities[i];const inRange=[];const distances=[];const boidVelocities=[p0.position.x,p0.position.y,p0.position.z,0,0,0,p0.velocity.x,p0.velocity.y,p0.velocity.z,0,0,0,0,0,0,0,0,0];let groupCount=1;nested:for(const j in entities){let p2=entities[j];if(distances.length>p0.boid.groupSize||j>=p0.boid.searchLimit){break nested}let randj=keys[Math.floor(Math.random()*length)];if(j===i||entities[randj].tag===entities[i].tag||inRange.indexOf(randj)>-1){}else{let pr=entities[randj];let disttemp=Systems.collision.distance(p0.position,pr.position);if(disttemp>p0.boid.groupRadius){}else{distances.push(disttemp);inRange.push(randj);let distInv;if(p0.boid.useSeparation||p0.boid.useAlignment){distInv=p0.boid.groupRadius/(disttemp*disttemp);if(distInv==Infinity)distInv=p2.maxSpeed;else if(distInv==-Infinity)distInv=-p2.maxSpeed}if(p0.boid.useCohesion){boidVelocities[0]+=(pr.position.x-p0.position.x)*.5*disttemp*_timeStep;boidVelocities[1]+=(pr.position.y-p0.position.y)*.5*disttemp*_timeStep;boidVelocities[2]+=(pr.position.z-p0.position.z)*.5*disttemp*_timeStep}if(isNaN(disttemp)||isNaN(boidVelocities[0])||isNaN(pr.position.x)){console.log(disttemp,i,randj,p0.position,pr.position,boidVelocities);p0.position.x=NaN;return}if(p0.boid.useSeparation){boidVelocities[3]=boidVelocities[3]+(p0.position.x-pr.position.x)*distInv;boidVelocities[4]=boidVelocities[4]+(p0.position.y-pr.position.y)*distInv;boidVelocities[5]=boidVelocities[5]+(p0.position.z-pr.position.z)*distInv}if(p0.boid.useAttraction&&pr.boid.useAttraction){Systems.nbody.attract(p0,pr,disttemp)}if(p0.boid.useAlignment){boidVelocities[6]=boidVelocities[6]+pr.velocity.x*distInv;boidVelocities[7]=boidVelocities[7]+pr.velocity.y*distInv;boidVelocities[8]=boidVelocities[8]+pr.velocity.z*distInv}groupCount++}}}let _groupCount=1/groupCount;if(p0.boid.useCohesion){boidVelocities[0]=p0.boid.cohesion*(boidVelocities[0]*_groupCount);boidVelocities[1]=p0.boid.cohesion*(boidVelocities[1]*_groupCount);boidVelocities[2]=p0.boid.cohesion*(boidVelocities[2]*_groupCount)}else{boidVelocities[0]=0;boidVelocities[1]=0;boidVelocities[2]=0}if(p0.boid.useSeparation){boidVelocities[3]=p0.boid.separation*boidVelocities[3];boidVelocities[4]=p0.boid.separation*boidVelocities[4];boidVelocities[5]=p0.boid.separation*boidVelocities[5]}else{boidVelocities[3]=0;boidVelocities[4]=0;boidVelocities[5]=0}if(p0.boid.useAlignment){boidVelocities[6]=-(p0.boid.alignment*boidVelocities[6]*_groupCount);boidVelocities[7]=p0.boid.alignment*boidVelocities[7]*_groupCount;boidVelocities[8]=p0.boid.alignment*boidVelocities[8]*_groupCount}else{boidVelocities[6]=0;boidVelocities[7]=0;boidVelocities[8]=0}const swirlVec=[0,0,0];if(p0.boid.useSwirl==true){boidVelocities[9]=-(p0.position.y-p0.boid.swirl.y)*p0.boid.swirl.mul;boidVelocities[10]=(p0.position.z-p0.boid.swirl.z)*p0.boid.swirl.mul;boidVelocities[11]=(p0.position.x-p0.boid.swirl.x)*p0.boid.swirl.mul}const attractorVec=[0,0,0];if(p0.boid.useAttractor==true){boidVelocities[12]=(p0.boid.attractor.x-p0.position.x)*p0.boid.attractor.mul;if(p0.position.x>p0.boid.boundingBox.left||p0.position.x<p0.boid.boundingBox.right){boidVelocities[12]*=3}boidVelocities[13]=(p0.boid.attractor.y-p0.position.y)*p0.boid.attractor.mul;if(p0.position.y>p0.boid.boundingBox.top||p0.position.y<p0.boid.boundingBox.bottom){boidVelocities[13]*=3}boidVelocities[14]=(p0.boid.attractor.z-p0.position.z)*p0.boid.attractor.mul;if(p0.position.z>p0.boid.boundingBox.front||p0.position.z<p0.boid.boundingBox.back){boidVelocities[14]*=3}}entities[i].velocity.x=p0.velocity.x*p0.drag+boidVelocities[0]+boidVelocities[3]+boidVelocities[6]+boidVelocities[9]+boidVelocities[12]+boidVelocities[15],entities[i].velocity.y=p0.velocity.y*p0.drag+boidVelocities[1]+boidVelocities[4]+boidVelocities[7]+boidVelocities[10]+boidVelocities[13]+boidVelocities[16],entities[i].velocity.z=p0.velocity.z*p0.drag+boidVelocities[2]+boidVelocities[5]+boidVelocities[8]+boidVelocities[11]+boidVelocities[14]+boidVelocities[17];if(isNaN(entities[i].velocity.x))console.error(p0,i,groupCount,p0.position,p0.velocity,swirlVec,attractorVec)}return entities}},movement:{lastTime:performance.now(),setupEntities:(self2,entities)=>{for(const key in entities){const entity=entities[key];if(entity.components){if(!entity.components[self2.tag])continue}Systems.movement.setEntity(entity)}},setEntity:entity=>{if(!("mass"in entity))entity.mass=1;if(!("fixed"in entity))entity.fixed=false;if(!entity.force)entity.force={x:0,y:0,z:0};if(!("mass"in entity))entity.mass=1;if(!("gravity"in entity))entity.gravity=-9.81;if(!entity.acceleration)entity.acceleration={x:0,y:0,z:0};if(!entity.velocity)entity.velocity={x:0,y:0,z:0};if(!entity.position)entity.position={x:0,y:0,z:0}},operator:(self2,origin,entities)=>{let now=performance.now();let timeStep=(now-self2.lastTime)*.001;self2.lastTime=now;for(const key in entities){const entity=entities[key];if(entity.components){if(!entity.components[self2.tag])continue}if(entity.fixed)continue;if(typeof entity.force==="object"&&entity.mass){if(entity.force.x){entity.accleration.x+=entity.force.x/entity.mass;entity.force.x=0}if(entity.force.y){entity.accleration.y+=entity.force.y/entity.mass;entity.force.y=0}if(entity.force.z){entity.accleration.z+=entity.force.z/entity.mass+entity.gravity;entity.force.z=0}}if(typeof entity.acceleration==="object"){if(entity.drag){if(entity.accleration.x)entity.acceleration.x-=entity.acceleration.x*entity.drag*timeStep;if(entity.accleration.y)entity.acceleration.y-=entity.acceleration.y*entity.drag*timeStep;if(entity.accleration.z)entity.acceleration.z-=entity.acceleration.z*entity.drag*timeStep}if(entity.accleration.x)entity.velocity.x+=entity.accleration.x*timeStep;if(entity.accleration.y)entity.velocity.y+=entity.accleration.y*timeStep;if(entity.accleration.z)entity.velocity.z+=entity.accleration.z*timeStep}if(typeof entity.velocity==="object"){if(entity.velocity.x)entity.position.x+=entity.velocity.x*timeStep;if(entity.velocity.y)entity.position.y+=entity.velocity.y*timeStep;if(entity.velocity.z)entity.position.z+=entity.velocity.z*timeStep}}return entities}}};var import_sjcl=__toESM(require_sjcl());var import_web_worker=__toESM(require_browser());var WorkerService=class extends Service{constructor(options){super(options);this.name="worker";this.workers={};this.threadRot=0;this.customRoutes={"worker":(route,routeKey,routes)=>{let rt=route;if(rt?.worker||rt?.workerId){if(rt.workerUrl)rt.url=rt.workerUrl;if(rt.workerId)rt.tag=rt.workerId;if(!rt.tag)rt.tag=routeKey;rt._id=rt.tag;let worker;if(this.workers[rt._id])worker=this.workers[rt._id];if(!worker)worker=this.addWorker(rt);rt.worker=worker;if(rt.transferFunctions){for(const prop in rt.transferFunctions){this.transferFunction(worker,rt.transferFunctions[prop],prop)}}if(rt.transferClasses){for(const prop in rt.transferClasses){this.transferClass(worker,rt.transferClasses[prop],prop)}}if(worker){if(!rt.operator){rt.operator=(...args)=>{if(rt.callback){if(!this.nodes.get(rt.tag)?.children)worker.post(rt.callback,args);else return worker.run(rt.callback,args)}else{if(!this.nodes.get(rt.tag)?.children)worker.send(args);else return worker.request(args)}}}}}return rt}};this.customChildren={"worker":(child,childRouteKey,parent,routes,checked)=>{let worker;if(child?.worker||child?.workerId){if(child.workerUrl)child.url=child.workerUrl;if(child.workerId)child.tag=child.workerId;if(!child.tag)child.tag=childRouteKey;child._id=child.tag;if(this.workers[child._id])worker=this.workers[child._id];if(!worker)worker=this.addWorker(child);child.worker=worker;if(child.transferFunctions){for(const prop in child.transferFunctions){this.transferFunction(worker,child.transferFunctions[prop],prop)}}if(child.transferClasses){for(const prop in child.transferClasses){this.transferClass(worker,child.transferClasses[prop],prop)}}if(worker){if(!child.operator){child.operator=(...args)=>{if(child.callback){if(!this.nodes.get(child.tag)?.children)worker.post(child.callback,args);else return worker.run(child.callback,args)}else{if(!this.nodes.get(child.tag)?.children)worker.send(args);else return worker.request(args)}}}}}if(child.parentRoute&&(parent?.worker||parent?.workerId)){if(worker){let portId=this.establishMessageChannel(worker,parent.worker.worker);worker.post("subscribeToWorker",child.parentRoute,portId,child.callback)}else{parent.worker.subscribe(child.parentRoute,result=>{this.nodes.get(child.tag?child.tag:childRouteKey).run(result)})}}}};this.addWorker=options2=>{let worker;if(!options2._id)options2._id=`worker${Math.floor(Math.random()*1e15)}`;if(options2.url)worker=new import_web_worker.default(options2.url);else if(options2.port){worker=options2.port}else if(this.workers[options2._id]){if(this.workers[options2._id].port)worker=this.workers[options2._id].port;else worker=this.workers[options2._id].worker}if(!worker)return;let send=(message,transfer)=>{return this.transmit(message,worker,transfer)};let post=(route,args,transfer,origin,method)=>{let message={route,args};if(origin)message.origin=origin;if(method)message.method=method;return this.transmit(message,worker,transfer)};let run=(route,args,transfer,origin,method)=>{return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[{route,args},options2._id,callbackId]};if(origin)req.args[0].origin=origin;if(method)req.args[0].method=method;let onmessage=ev=>{if(typeof ev.data==="object"){if(ev.data.callbackId===callbackId){worker.removeEventListener("message",onmessage);res(ev.data.args)}}};worker.addEventListener("message",onmessage);this.transmit(req,worker,transfer)})};let request=(message,transfer,origin,method)=>{return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[message,options2._id,callbackId]};if(origin)req.origin=origin;if(method)req.method=method;let onmessage=ev=>{if(typeof ev.data==="object"){if(ev.data.callbackId===callbackId){worker.removeEventListener("message",onmessage);res(ev.data.args)}}};worker.addEventListener("message",onmessage);this.transmit(req,worker,transfer)})};let subscribe=(route,callback)=>{return this.subscribeToWorker(route,options2._id,callback)};let unsubscribe=(route,sub)=>{return run("unsubscribe",[route,sub])};if(!options2.onmessage)options2.onmessage=ev=>{this.receive(ev.data);this.setState({[options2._id]:ev.data})};if(!options2.onerror){options2.onerror=ev=>{console.error(ev.data)}}worker.onmessage=options2.onmessage;worker.onerror=options2.onerror;this.workers[options2._id]={worker,send,post,run,request,subscribe,unsubscribe,...options2};return this.workers[options2._id]};this.toObjectURL=scriptTemplate=>{let blob=new Blob([scriptTemplate],{type:"text/javascript"});return URL.createObjectURL(blob)};this.transmit=(message,worker,transfer)=>{if(worker instanceof import_web_worker.default||worker instanceof MessagePort){worker.postMessage(message,transfer)}else if(typeof worker==="string"){if(this.workers[worker]){if(this.workers[worker].port)this.workers[worker].port.postMessage(message,transfer);else if(this.workers[worker].worker)this.workers[worker].worker.postMessage(message,transfer)}}else{let keys=Object.keys(this.workers);this.workers[keys[this.threadRot]].worker.postMessage(message,transfer);this.threadRot++;if(this.threadRot===keys.length)this.threadRot=0}return message};this.terminate=worker=>{if(typeof worker==="string"){let obj=this.workers[worker];if(obj)delete this.workers[worker];worker=obj.worker}if(worker instanceof import_web_worker.default){worker.terminate();return true}if(worker instanceof MessagePort){worker.close();return true}return false};this.establishMessageChannel=(worker,worker2)=>{let workerId;if(typeof worker==="string"){workerId=worker;if(this.workers[worker]){if(this.workers[worker].port)worker=this.workers[worker].port;else worker2=this.workers[worker].worker}}if(typeof worker2==="string"){if(this.workers[worker2]){if(this.workers[worker2].port)worker2=this.workers[worker2].port;else worker2=this.workers[worker2].worker}}if(worker instanceof import_web_worker.default||worker instanceof MessagePort){let channel=new MessageChannel;let portId=`port${Math.floor(Math.random()*1e15)}`;worker.postMessage({route:"addWorker",args:{port:channel.port1,_id:portId}},[channel.port1]);if(worker2 instanceof import_web_worker.default||worker2 instanceof MessagePort){worker2.postMessage({route:"addWorker",args:{port:channel.port2,_id:portId}},[channel.port2])}else if(workerId&&this.workers[workerId])this.workers[workerId].port=channel.port2;return portId}return false};this.request=(message,workerId,transfer,origin,method)=>{let worker=this.workers[workerId].worker;return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[message,callbackId]};if(origin)req.origin=origin;if(method)req.method=method;let onmessage=ev=>{if(typeof ev.data==="object"){if(ev.data.callbackId===callbackId){worker.removeEventListener("message",onmessage);res(ev.data.args)}}};worker.addEventListener("message",onmessage);this.transmit(req,worker,transfer)})};this.runRequest=(message,worker,callbackId)=>{let res=this.receive(message);if(typeof worker==="string"&&this.workers[worker]){if(this.workers[worker].port)worker=this.workers[worker].port;else worker=this.workers[worker].worker}if(res instanceof Promise){res.then(r=>{if(worker instanceof import_web_worker.default||worker instanceof MessagePort)worker.postMessage({args:r,callbackId});else if(typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope)globalThis.postMessage({args:r,callbackId})})}else{if(worker instanceof import_web_worker.default||worker instanceof MessagePort)worker.postMessage({args:res,callbackId});else if(typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope)globalThis.postMessage({args:res,callbackId})}return res};this.subscribeWorker=(route,worker)=>{if(typeof worker==="string"&&this.workers[worker]){if(this.workers[worker].port)worker=this.workers[worker].port;else worker=this.workers[worker].worker}return this.subscribe(route,res=>{if(res instanceof Promise){res.then(r=>{if(worker?.postMessage)worker.postMessage({args:r,route});else if(globalThis.postMessage)globalThis.postMessage({args:r,callbackId:route})})}else{if(worker?.postMessage)worker.postMessage({args:res,route});else if(globalThis.postMessage)globalThis.postMessage({args:res,callbackId:route})}})};this.subscribeToWorker=(route,workerId,callback)=>{if(typeof workerId==="string"&&this.workers[workerId]){this.subscribe(workerId,res=>{if(res?.callbackId===route){if(!callback)this.setState({[workerId]:res.args});else if(typeof callback==="string"){this.run(callback,res.args)}else callback(res.args)}});return this.workers[workerId].run("subscribeWorker",[route,workerId])}};this.routes={addWorker:this.addWorker,toObjectURL:this.toObjectURL,request:this.request,runRequest:this.runRequest,establishMessageChannel:this.establishMessageChannel,subscribeWorker:this.subscribeWorker,subscribeToWorker:this.subscribeToWorker,unsubscribe:this.unsubscribe};this.load(this.routes);if(typeof WorkerGlobalScope!=="undefined"&&globalThis instanceof WorkerGlobalScope){globalThis.onmessage=ev=>{let result=this.receive(ev.data);if(this.keepState)this.setState({[ev.data.origin?ev.data.origin:"worker"]:result})}}}transferFunction(worker,fn,fnName){if(!fnName)fnName=fn.name;return worker.request({route:"setRoute",args:[fn.toString(),fnName]})}transferClass(worker,cls,className){if(!className)className=cls.name;return worker.request({route:"receiveClass",args:[cls.toString(),className]})}};var mouseEventHandler=makeSendPropertiesHandler(["ctrlKey","metaKey","shiftKey","button","pointerType","clientX","clientY","pageX","pageY"]);var wheelEventHandlerImpl=makeSendPropertiesHandler(["deltaX","deltaY"]);var keydownEventHandler=makeSendPropertiesHandler(["ctrlKey","metaKey","shiftKey","keyCode"]);function wheelEventHandler(event,sendFn){event.preventDefault();wheelEventHandlerImpl(event,sendFn)}function preventDefaultHandler(event){event.preventDefault()}function copyProperties(src,properties,dst){for(const name of properties){dst[name]=src[name]}}function makeSendPropertiesHandler(properties){return function sendProperties(event,sendFn){const data={type:event.type};copyProperties(event,properties,data);sendFn(data)}}function touchEventHandler(event,sendFn){const touches=[];const data={type:event.type,touches};for(let i=0;i<event.touches.length;++i){const touch=event.touches[i];touches.push({pageX:touch.pageX,pageY:touch.pageY})}sendFn(data)}var orbitKeys={"37":true,"38":true,"39":true,"40":true};function filteredKeydownEventHandler(event,sendFn){const{keyCode}=event;if(orbitKeys[keyCode]){event.preventDefault();keydownEventHandler(event,sendFn)}}var eventHandlers={contextmenu:preventDefaultHandler,mousedown:mouseEventHandler,mousemove:mouseEventHandler,mouseup:mouseEventHandler,pointerdown:mouseEventHandler,pointermove:mouseEventHandler,pointerup:mouseEventHandler,touchstart:touchEventHandler,touchmove:touchEventHandler,touchend:touchEventHandler,wheel:wheelEventHandler,keydown:filteredKeydownEventHandler};function initProxyElement(element,worker,id){if(!id)id="proxy"+Math.floor(Math.random()*1e15);const sendEvent=data=>{worker.postMessage({route:"handleProxyEvent",args:[data,id]})};let entries=Object.entries(eventHandlers);for(const[eventName,handler]of entries){element.addEventListener(eventName,function(event){handler(event,sendEvent)})}const sendSize=()=>{const rect=element.getBoundingClientRect();sendEvent({type:"size",left:rect.left,top:rect.top,width:element.clientWidth,height:element.clientHeight})};sendSize();globalThis.addEventListener("resize",sendSize);return id}var EventDispatcher=class{addEventListener(type,listener){if(this._listeners===void 0)this._listeners={};const listeners=this._listeners;if(listeners[type]===void 0){listeners[type]=[]}if(listeners[type].indexOf(listener)===-1){listeners[type].push(listener)}}hasEventListener(type,listener){if(this._listeners===void 0)return false;const listeners=this._listeners;return listeners[type]!==void 0&&listeners[type].indexOf(listener)!==-1}removeEventListener(type,listener){if(this._listeners===void 0)return;const listeners=this._listeners;const listenerArray=listeners[type];if(listenerArray!==void 0){const index=listenerArray.indexOf(listener);if(index!==-1){listenerArray.splice(index,1)}}}dispatchEvent(event,target){if(this._listeners===void 0)return;const listeners=this._listeners;const listenerArray=listeners[event.type];if(listenerArray!==void 0){if(!target)event.target=this;else event.target=target;const array=listenerArray.slice(0);for(let i=0,l=array.length;i<l;i++){array[i].call(this,event)}event.target=null}}};function noop(){}var ElementProxyReceiver=class extends EventDispatcher{constructor(){super();this._listeners={};this.style={};this.setPointerCapture=()=>{};this.releasePointerCapture=()=>{};this.getBoundingClientRect=()=>{return{left:this.left,top:this.top,width:this.width,height:this.height,right:this.left+this.width,bottom:this.top+this.height}};this.handleEvent=data=>{if(data.type==="size"){this.left=data.left;this.top=data.top;this.width=data.width;this.height=data.height;if(typeof this.proxied==="object"){this.proxied.width=this.width;this.proxied.height=this.height}return}data.preventDefault=noop;data.stopPropagation=noop;this.dispatchEvent(data,this.proxied)};this.style={}}get clientWidth(){return this.width}get clientHeight(){return this.height}focus(){}};var ProxyManager=class{constructor(){this.targets={};this.makeProxy=(id,addTo)=>{if(!id)id=`proxyReceiver${Math.floor(Math.random()*1e15)}`;let proxy;if(this.targets[id])proxy=this.targets[id];else{proxy=new ElementProxyReceiver;this.targets[id]=proxy}if(typeof addTo==="object"){addTo.proxy=proxy;proxy.proxied=addTo;addTo.addEventListener=proxy.addEventListener.bind(proxy);addTo.removeEventListener=proxy.removeEventListener.bind(proxy);addTo.handleEvent=proxy.handleEvent.bind(proxy);addTo.dispatchEvent=proxy.dispatchEvent.bind(proxy)}};this.getProxy=id=>{return this.targets[id]};this.handleEvent=(data,id)=>{if(this.targets[id]){this.targets[id].handleEvent(data);return true}return void 0};if(!globalThis.document)globalThis.document={}}};var proxyElementWorkerRoutes={initProxyElement,makeProxy:(self2,origin,id,elm)=>{if(!self2.graph.ProxyManager)self2.graph.ProxyManager=new ProxyManager;self2.graph.ProxyManager.makeProxy(id,elm);return id},handleProxyEvent:(self2,origin,data,id)=>{if(!self2.graph.ProxyManager)self2.graph.ProxyManager=new ProxyManager;if(self2.graph.ProxyManager.handleEvent(data,id))return data}};var workerCanvasRoutes={...proxyElementWorkerRoutes,transferCanvas:(self2,origin,worker,options)=>{if(!options)return void 0;if(!options._id)options._id=`canvas${Math.floor(Math.random()*1e15)}`;let offscreen=options.canvas.transferControlToOffscreen();let message={route:"receiveCanvas",args:{canvas:offscreen,context:options.context,_id:options._id}};self2.graph.run("initProxyElement",options.canvas,worker,options._id);if(options.draw){if(typeof options.draw==="function")message.args.draw=options.draw.toString();else message.args.draw=options.draw}if(options.update){if(typeof options.update==="function")message.args.update=options.update.toString();else message.args.update=options.update}if(options.init){if(typeof options.init==="function")message.args.init=options.init.toString();else message.args.init=options.init}if(options.clear){if(typeof options.clear==="function")message.args.clear=options.clear.toString();else message.args.clear=options.clear}worker.postMessage(message,[offscreen]);return options._id},receiveCanvas:(self2,origin,options)=>{if(!self2.graph.CANVASES)self2.graph.CANVASES={};let canvasOptions={_id:options._id?options._id:`canvas${Math.floor(Math.random()*1e15)}`,canvas:options.canvas,context:options.context?options.canvas.getContext(options.context):void 0,init:options.init,update:options.update,clear:options.clear,draw:options.draw,animating:"animating"in options?options.animating:true};if(self2.graph.CANVASES[canvasOptions._id]){self2.graph.run("setDraw",canvasOptions)}else{self2.graph.CANVASES[canvasOptions._id]=canvasOptions;self2.graph.run("makeProxy",canvasOptions._id,canvasOptions.canvas);if(options.width)canvasOptions.canvas.width=options.width;if(options.height)canvasOptions.canvas.height=options.height;if(typeof canvasOptions.draw==="string"){canvasOptions.draw=parseFunctionFromText(canvasOptions.draw)}if(typeof canvasOptions.update==="string"){canvasOptions.update=parseFunctionFromText(canvasOptions.update)}if(typeof canvasOptions.init==="string"){canvasOptions.init=parseFunctionFromText(canvasOptions.init)}if(typeof canvasOptions.clear==="string"){canvasOptions.clear=parseFunctionFromText(canvasOptions.clear)}if(typeof canvasOptions.draw==="function"){let draw=(s,canvas,context)=>{if(s.animating){s.draw(s,canvas,context);requestAnimationFrame(()=>{draw(s,canvas,context)})}};if(typeof canvasOptions.init==="function")canvasOptions.init(canvasOptions,canvasOptions.canvas,canvasOptions.context);draw(canvasOptions,canvasOptions.canvas,canvasOptions.context)}}return canvasOptions._id},setDraw:(self2,origin,settings)=>{let canvasopts;if(settings._id)canvasopts=self2.graph.CANVASES?.[settings._id];else canvasopts=self2.graph.CANVASES?.[Object.keys(self2.graph.CANVASES)[0]];if(canvasopts){if(settings.canvas){canvasopts.canvas=settings.canvas;self2.graph.run("makeProxy",canvasopts._id,canvasopts.canvas)}if(settings.context)canvasopts.context=canvasopts.canvas.getContext(settings.context);if(settings.width)canvasopts.canvas.width=settings.width;if(settings.height)canvasopts.canvas.height=settings.height;if(typeof settings.draw==="string")settings.draw=parseFunctionFromText(settings.draw);if(typeof settings.draw==="function"){canvasopts.draw=settings.draw}if(typeof settings.update==="string")settings.update=parseFunctionFromText(settings.update);if(typeof settings.update==="function"){canvasopts.update=settings.update}if(typeof settings.init==="string")settings.init=parseFunctionFromText(settings.init);if(typeof settings.init==="function"){canvasopts.init=settings.init}if(typeof settings.clear==="string")settings.clear=parseFunctionFromText(settings.clear);if(typeof settings.clear==="function"){canvasopts.clear=settings.clear}return settings._id}return void 0},drawFrame:(self2,origin,_id,props)=>{let canvasopts;if(!_id)canvasopts=self2.graph.CANVASES?.[Object.keys(self2.graph.CANVASES)[0]];else canvasopts=self2.graph.CANVASES?.[_id];if(canvasopts){if(props)Object.assign(canvasopts,props);if(canvasopts.draw){canvasopts.draw(canvasopts,canvasopts.canvas,canvasopts.context);return _id}}return void 0},clearFrame:(self2,origin,_id,input)=>{let canvasopts;if(!_id)canvasopts=self2.graph.CANVASES?.[Object.keys(self2.graph.CANVASES)[0]];else canvasopts=self2.graph.CANVASES?.[_id];if(canvasopts?.clear){canvasopts.clear(canvasopts,canvasopts.canvas,canvasopts.context,input);return _id}return void 0},runUpdate:(self2,origin,_id,input)=>{let canvasopts;if(!_id)canvasopts=self2.graph.CANVASES?.[Object.keys(self2.graph.CANVASES)[0]];else canvasopts=self2.graph.CANVASES?.[_id];if(canvasopts?.update){canvasopts.update(canvasopts,canvasopts.canvas,canvasopts.context,input);return _id}return void 0},setProps:(self2,origin,_id,props)=>{let canvasopts;if(!_id)canvasopts=self2.graph.CANVASES?.[Object.keys(self2.graph.CANVASES)[0]];else canvasopts=self2.graph.CANVASES?.[_id];if(canvasopts){Object.assign(canvasopts,props);if(props.width)canvasopts.canvas.width=props.width;if(props.height)canvasopts.canvas.height=props.height;return _id}return void 0},startAnim:(self2,origin,_id,draw)=>{let canvasopts;if(!_id)canvasopts=self2.graph.CANVASES?.[Object.keys(self2.graph.CANVASES)[0]];else canvasopts=self2.graph.CANVASES?.[_id];canvasopts.animating=true;if(canvasopts&&draw){if(typeof draw==="string")draw=parseFunctionFromText(draw);if(typeof draw==="function"){canvasopts.draw=draw}return _id}if(typeof canvasopts?.draw==="function"){let draw2=(s,canvas,context)=>{if(s.animating){s.draw(s,canvas,context);requestAnimationFrame(()=>{draw2(s,canvas,context)})}};if(typeof canvasopts.clear==="function")canvasopts.clear(canvasopts,canvasopts.canvas,canvasopts.context);if(typeof canvasopts.init==="function")canvasopts.init(canvasopts,canvasopts.canvas,canvasopts.context);draw2(canvasopts,canvasopts.canvas,canvasopts.context);return _id}return void 0},stopAnim:(self2,origin,_id)=>{let canvasopts;if(!_id)canvasopts=self2.graph.CANVASES?.[Object.keys(self2.graph.CANVASES)[0]];else canvasopts=self2.graph.CANVASES?.[_id];if(canvasopts){canvasopts.animating=false;if(typeof canvasopts.clear==="function")canvasopts.clear(canvasopts,canvasopts.canvas,canvasopts.context);return _id}return void 0}};var rechk=/^([<>])?(([1-9]\d*)?([xcbB?hHiIfdsp]))*$/;var refmt=/([1-9]\d*)?([xcbB?hHiIfdsp])/g;var str=(v2,o,c)=>String.fromCharCode(...new Uint8Array(v2.buffer,v2.byteOffset+o,c));var rts=(v2,o,c,s)=>new Uint8Array(v2.buffer,v2.byteOffset+o,c).set(s.split("").map(str2=>str2.charCodeAt(0)));var pst=(v2,o,c)=>str(v2,o+1,Math.min(v2.getUint8(o),c-1));var tsp=(v2,o,c,s)=>{v2.setUint8(o,s.length);rts(v2,o+1,c-1,s)};var lut=le=>({x:c=>[1,c,0],c:c=>[c,1,o=>({u:v2=>str(v2,o,1),p:(v2,c2)=>rts(v2,o,1,c2)})],"?":c=>[c,1,o=>({u:v2=>Boolean(v2.getUint8(o)),p:(v2,B)=>v2.setUint8(o,B)})],b:c=>[c,1,o=>({u:v2=>v2.getInt8(o),p:(v2,b2)=>v2.setInt8(o,b2)})],B:c=>[c,1,o=>({u:v2=>v2.getUint8(o),p:(v2,B)=>v2.setUint8(o,B)})],h:c=>[c,2,o=>({u:v2=>v2.getInt16(o,le),p:(v2,h)=>v2.setInt16(o,h,le)})],H:c=>[c,2,o=>({u:v2=>v2.getUint16(o,le),p:(v2,H)=>v2.setUint16(o,H,le)})],i:c=>[c,4,o=>({u:v2=>v2.getInt32(o,le),p:(v2,i)=>v2.setInt32(o,i,le)})],I:c=>[c,4,o=>({u:v2=>v2.getUint32(o,le),p:(v2,I)=>v2.setUint32(o,I,le)})],f:c=>[c,4,o=>({u:v2=>v2.getFloat32(o,le),p:(v2,f2)=>v2.setFloat32(o,f2,le)})],d:c=>[c,8,o=>({u:v2=>v2.getFloat64(o,le),p:(v2,d2)=>v2.setFloat64(o,d2,le)})],s:c=>[1,c,o=>({u:v2=>str(v2,o,c),p:(v2,s)=>rts(v2,o,c,s.slice(0,c))})],p:c=>[1,c,o=>({u:v2=>pst(v2,o,c),p:(v2,s)=>tsp(v2,o,c,s.slice(0,c-1))})]});var errbuf=new RangeError("Structure larger than remaining buffer");var errval=new RangeError("Not enough values for structure");var _bitflippin=class{static toDataView(value){if(!(value instanceof DataView)){if(typeof value==="string"&&parseInt(value))value=parseInt(value);if(typeof value==="string"){let enc=new TextEncoder;let hascodes={};for(const code in _bitflippin.codes){while(value.indexOf(code)>-1){let idx=value.indexOf(code);value=value.replace(code,"");hascodes[idx]=code}}let encoded=Array.from(enc.encode(value));for(const key in hascodes){encoded.splice(parseInt(key),0,_bitflippin.codes[hascodes[key]])}value=new DataView(new Uint8Array(encoded).buffer)}else if(typeof value==="number"){let tmp=value;if(value<256){value=new DataView(new ArrayBuffer(1));value.setUint8(0,tmp)}else if(value<65536){value=new DataView(new ArrayBuffer(2));value.setInt16(0,tmp)}else{value=new DataView(new ArrayBuffer(4));value.setUint32(0,tmp)}}else if(value instanceof ArrayBuffer||typeof SharedArrayBuffer!=="undefined"&&value instanceof SharedArrayBuffer){value=new DataView(value)}else if(Array.isArray(value)){value=new DataView(Uint8Array.from(value).buffer)}else if(typeof value==="object"){value=new TextEncoder().encode(JSON.stringify(value))}}return value}static searchBuffer(buffer,searchString,limit){var needle=searchString;var haystack=buffer;var search=_bitflippin.boyerMoore(needle);var skip=search.byteLength;var indices=[];for(var i=search(haystack);i!==-1;i=search(haystack,i+skip)){indices.push(i);if(limit){if(indices.length>=limit)break}}return indices}static bytesToInt16(x0,x1){let int16=(255&x0)<<8|255&x1;if((int16&32768)>0){int16|=4294901760}else{int16&=65535}return int16}static bytesToUInt16(x0,x1){return x0*256+x1}static Uint16ToBytes(y2){return[y2&255,y2>>8&255]}static bytesToInt24(x0,x1,x2){let int24=(255&x0)<<16|(255&x1)<<8|255&x2;if((int24&8388608)>0){int24|=4278190080}else{int24&=16777215}return int24}static bytesToUInt24(x0,x1,x2){return x0*65536+x1*256+x2}static Uint24ToBytes(y2){return[y2&255,y2>>8&255,y2>>16&255]}static bytesToInt32(x0,x1,x2,x3){let int32=(255&x0)<<24|(255&x1)<<16|(255&x2)<<8|255&x3;if((int32&2147483648)>0){int32|=0}else{int32&=4294967295}return int32}static bytesToUInt32(x0,x1,x2,x3){return x0*16777216+x1*65536+x2*256+x3}static Uint32ToBytes(y2){return[y2&255,y2>>8&255,y2>>16&255,y2>>24&255]}static get2sCompliment(val,nbits){if(val>4294967296)return null;return val<<32-nbits>>32-nbits}static getSignedInt(...args){let pos=0;function getInt(size){var value=0;var first=true;while(size--){if(first){let byte=args[pos++];value+=byte&127;if(byte&128){value-=128}first=false}else{value*=256;value+=args[pos++]}}return value}return getInt(args.length)}static asUint8Array(input){if(input instanceof Uint8Array){return input}else if(typeof input==="string"){var arr=new Uint8Array(input.length);for(var i=0;i<input.length;i++){var c=input.charCodeAt(i);if(c>127){throw new TypeError("Only ASCII patterns are supported")}arr[i]=c}return arr}else{return new Uint8Array(input)}}static boyerMoore(patternBuffer){var pattern=_bitflippin.asUint8Array(patternBuffer);var M2=pattern.length;if(M2===0){throw new TypeError("patternBuffer must be at least 1 byte long")}var R2=256;var rightmost_positions=new Int32Array(R2);for(var c=0;c<R2;c++){rightmost_positions[c]=-1}for(var j=0;j<M2;j++){rightmost_positions[pattern[j]]=j}var boyerMooreSearch=(txtBuffer,start,end)=>{var txt=_bitflippin.asUint8Array(txtBuffer);if(start===void 0)start=0;if(end===void 0)end=txt.length;var pat=pattern;var right=rightmost_positions;var lastIndex=end-pat.length;var lastPatIndex=pat.length-1;var skip;for(var i=start;i<=lastIndex;i+=skip){skip=0;for(var j2=lastPatIndex;j2>=0;j2--){var c2=txt[i+j2];if(pat[j2]!==c2){skip=Math.max(1,j2-right[c2]);break}}if(skip===0){return i}}return-1};boyerMooreSearch.byteLength=pattern.byteLength;return boyerMooreSearch}static struct(format){let fns=[],size=0,m=rechk.exec(format);if(!m){throw new RangeError("Invalid format string")}const t=lut("<"===m[1]),lu=(n,c)=>t[c](n?parseInt(n,10):1);while(m=refmt.exec(format)){((r,s,f2)=>{for(let i=0;i<r;++i,size+=s){if(f2){fns.push(f2(size))}}})(...lu(...m.slice(1)))}const unpack_from=(arrb,offs)=>{if(arrb.byteLength<(offs|0)+size){throw errbuf}let v2=new DataView(arrb,offs|0);return fns.map(f2=>f2.u(v2))};const pack_into=(arrb,offs,...values)=>{if(values.length<fns.length){throw errval}if(arrb.byteLength<offs+size){throw errbuf}const v2=new DataView(arrb,offs);new Uint8Array(arrb,offs,size).fill(0);fns.forEach((f2,i)=>f2.p(v2,values[i]))};const pack=(...values)=>{let b2=new ArrayBuffer(size);pack_into(b2,0,...values);return b2};const unpack=arrb=>unpack_from(arrb,0);function*iter_unpack(arrb){for(let offs=0;offs+size<=arrb.byteLength;offs+=size){yield unpack_from(arrb,offs)}}return Object.freeze({unpack,pack,unpack_from,pack_into,iter_unpack,format,size})}};var bitflippin=_bitflippin;bitflippin.codes={"\\n":10,"\\r":13,"\\t":9,"\\s":32,"\\b":8,"\\f":12,"\\":92};var WebSerial=class extends bitflippin{constructor(){super(...arguments);this.streams={};this.createStream=options=>{let stream={_id:options._id?options._id:`stream${Math.floor(Math.random()*1e15)}`,info:options.port.getInfo(),running:false,...options};if(options.port?.readable){if(options.transforms){stream.reader=WebSerial.setStreamTransforms(options.port.readable,options.transforms).getReader()}else{stream.reader=options.port.readable.getReader()}}this.streams[stream._id]=stream;return stream}}getPorts(){return navigator.serial.getPorts()}requestPort(usbVendorId,usbProductId){let options={};if(usbVendorId){options.usbVendorId=usbVendorId}if(usbProductId){options.usbProductId=usbProductId}if(options.usbVendorId)return navigator.serial.requestPort({filters:[options]});else return navigator.serial.requestPort()}openPort(port,options){if(options)options=Object.assign({},options);if(options?.ondisconnect){port.ondisconnect=options.ondisconnect;delete options.ondisconnect}return port.open(options).then(()=>{if(options?.onconnect)options.onconnect(port)})}async readWithTimeout(port,timeout){const reader=port.readable.getReader();const timer=setTimeout(()=>{reader.releaseLock()},timeout);const result=await reader.read();clearTimeout(timer);reader.releaseLock();return result}async writePort(port,message){const writer=port.writable.getWriter();await writer.write(WebSerial.toDataView(message));writer.releaseLock();return true}getSignals(port){return port.getSignals()}setSignals(port,signals){return port.setSignals(signals)}readStream(stream){if(stream.reader&&!stream.running){let reader=stream.reader;if(stream.buffering){if(typeof stream.buffering!=="object")stream.buffering={};if(!stream.buffering.buffer){stream.buffering.buffer=[]}if(!stream.buffering.searchBytes)stream.buffering.searchBytes=new Uint8Array([13,10])}let readLoop=()=>{if(stream.port.readable&&stream.running){reader.read().then(result=>{if(result.done)reader.releaseLock();else{if(stream.buffering){stream.buffering.buffer.push(...result.value);const needle=stream.buffering.searchBytes;const haystack=stream.buffering.buffer;const search=WebSerial.boyerMoore(needle);const skip=search.byteLength;let nextIndex=-1;for(var i=search(haystack);i!==-1;i=search(haystack,i+skip)){if(!stream.buffering.locked&&!("lockIdx"in stream.buffering))stream.buffering.lockIdx=i;else{nextIndex=i;if(nextIndex>=0){if(!stream.buffering.locked){stream.ondata(new Uint8Array(stream.buffering.buffer.splice(stream.buffering.lockIdx+stream.buffering.searchBytes.length,nextIndex+stream.buffering.searchBytes.length)));stream.buffering.buffer.splice(0,stream.buffering.searchBytes.length);stream.buffering.locked=true}else if(nextIndex>0){stream.ondata(new Uint8Array(stream.buffering.buffer.splice(stream.buffering.searchBytes.length,nextIndex)))}}}}}else stream.ondata(result.value);setTimeout(()=>{readLoop()},stream.frequency)}})}else if(!stream.running&&stream.port.readable){try{reader.releaseLock()}catch(er){console.error(er)}}};stream.running=true;readLoop();return stream}return void 0}writeStream(stream,message){if(typeof stream==="string")stream=this.streams[stream];if(stream.port.writable){let writer=stream.port.writable.getWriter();writer.write(WebSerial.toDataView(message));writer.releaseLock();return true}return void 0}closeStream(stream,onclose){if(typeof stream==="string")stream=this.streams[stream];stream.running=false;return new Promise((res,rej)=>{setTimeout(async()=>{if(stream.port.readable&&stream.reader){try{stream.reader.releaseLock();try{await stream.reader.cancel()}catch(err){}}catch(er){console.error(er)}}try{await stream.port.close().then(()=>{if(onclose)onclose(this.streams[stream._id])})}catch(er){rej(er)}delete this.streams[stream._id];res(true)},300)})}static setStreamTransforms(stream,transforms){let transform=[];Object.keys(transforms).forEach(t=>{let opt=transforms[t];if(opt instanceof TransformStream){transform.push(opt)}else{if(!opt.start)opt.start=function start(){};if(!opt.flush)opt.flush=function flush(){};let transformer=new TransformStream({start:opt.start,transform:opt.transform,flush:opt.flush},opt.writableStrategy,opt.readableStrategy);transform.push(transformer)}});let str2=stream;transform.forEach(transform2=>{str2=str2.pipeThrough(transform2)});return str2}};function ads131m08codec(data){let arr;if(data.getInt8)arr=new Uint8Array(data.buffer);else if(!data.buffer)arr=new Uint8Array(data);else arr=data;let output={0:new Array(9),1:new Array(9),2:new Array(9),3:new Array(9),4:new Array(9),5:new Array(9),6:new Array(9),7:new Array(9)};for(let i=0;i<9;i++){let j=i*25;output[0][i]=bitflippin.bytesToUInt24(arr[j],arr[j+1],arr[j+2]);output[1][i]=bitflippin.bytesToUInt24(arr[j+3],arr[j+4],arr[j+5]);output[2][i]=bitflippin.bytesToUInt24(arr[j+6],arr[j+7],arr[j+8]);output[3][i]=bitflippin.bytesToUInt24(arr[j+9],arr[j+10],arr[j+11]);output[4][i]=bitflippin.bytesToUInt24(arr[j+12],arr[j+13],arr[j+14]);output[5][i]=bitflippin.bytesToUInt24(arr[j+15],arr[j+16],arr[j+17]);output[6][i]=bitflippin.bytesToUInt24(arr[j+18],arr[j+19],arr[j+20]);output[7][i]=bitflippin.bytesToUInt24(arr[j+21],arr[j+22],arr[j+23])}return output}var defaultsetting={sps:250,useDCBlock:false,useBandpass:false,bandpassLower:3,bandpassUpper:45,useScaling:true,scalar:1.2/(32*(Math.pow(2,24)-1))};var ads131m08FilterSettings={"0":JSON.parse(JSON.stringify(defaultsetting)),"1":JSON.parse(JSON.stringify(defaultsetting)),"2":JSON.parse(JSON.stringify(defaultsetting)),"3":JSON.parse(JSON.stringify(defaultsetting)),"4":JSON.parse(JSON.stringify(defaultsetting)),"5":JSON.parse(JSON.stringify(defaultsetting)),"6":JSON.parse(JSON.stringify(defaultsetting)),"7":JSON.parse(JSON.stringify(defaultsetting))};function cytoncodec(data){let arr;if(!data.buffer)arr=new Uint8Array(data);else arr=data;let output={};for(let i=0;i<8;i++){let idx=1+3*i;output[i]=bitflippin.bytesToInt24(arr[idx],arr[idx+1],arr[idx+2])}let accIdx=25;output.ax=bitflippin.bytesToInt16(arr[accIdx],arr[accIdx+1]);output.ay=bitflippin.bytesToInt16(arr[accIdx+2],arr[accIdx+3]);output.az=bitflippin.bytesToInt16(arr[accIdx+4],arr[accIdx+5]);output.gx=bitflippin.bytesToInt16(arr[accIdx+6],arr[accIdx+7]);output.gy=bitflippin.bytesToInt16(arr[accIdx+8],arr[accIdx+9]);output.gz=bitflippin.bytesToInt16(arr[accIdx+10],arr[accIdx+11]);return output}var defaultsetting2={sps:250,useDCBlock:true,useBandpass:true,bandpassLower:3,bandpassUpper:45,useScaling:true,scalar:4.5/(24*(Math.pow(2,23)-1))};var cytonFilterSettings={"0":JSON.parse(JSON.stringify(defaultsetting2)),"1":JSON.parse(JSON.stringify(defaultsetting2)),"2":JSON.parse(JSON.stringify(defaultsetting2)),"3":JSON.parse(JSON.stringify(defaultsetting2)),"4":JSON.parse(JSON.stringify(defaultsetting2)),"5":JSON.parse(JSON.stringify(defaultsetting2)),"6":JSON.parse(JSON.stringify(defaultsetting2)),"7":JSON.parse(JSON.stringify(defaultsetting2)),"8":JSON.parse(JSON.stringify(defaultsetting2)),"9":JSON.parse(JSON.stringify(defaultsetting2)),"10":JSON.parse(JSON.stringify(defaultsetting2)),"11":JSON.parse(JSON.stringify(defaultsetting2)),"12":JSON.parse(JSON.stringify(defaultsetting2)),"13":JSON.parse(JSON.stringify(defaultsetting2)),"14":JSON.parse(JSON.stringify(defaultsetting2)),"15":JSON.parse(JSON.stringify(defaultsetting2))};function freeeeg128codec(data){let arr;if(data.getInt8)arr=new Uint8Array(data.buffer);else if(!data.buffer)arr=new Uint8Array(data);else arr=data;let output={};for(let i=0;i<128;i++){let idx=i*3+1;output[i]=bitflippin.bytesToUInt24(arr[idx],arr[idx+1],arr[idx+2])}let accIdx=385;output["ax"]=bitflippin.bytesToInt16(arr[accIdx],arr[accIdx+1]);output["ay"]=bitflippin.bytesToInt16(arr[accIdx+2],arr[accIdx+3]);output["az"]=bitflippin.bytesToInt16(arr[accIdx+4],arr[accIdx+5]);output["gx"]=bitflippin.bytesToInt16(arr[accIdx+6],arr[accIdx+7]);output["gy"]=bitflippin.bytesToInt16(arr[accIdx+8],arr[accIdx+9]);output["gz"]=bitflippin.bytesToInt16(arr[accIdx+10],arr[accIdx+11]);return output}var freeeeg128ChartSettings={lines:{"ax":{nSec:10,sps:500},"ay":{nSec:10,sps:500},"az":{nSec:10,sps:500},"gx":{nSec:10,sps:500},"gy":{nSec:10,sps:500},"gz":{nSec:10,sps:500}}};var freeeeg128FilterSettings={};for(let i=0;i<128;i++){freeeeg128ChartSettings.lines[i]={sps:250,nSec:10};freeeeg128FilterSettings[i]={sps:250,useDCBlock:true,useBandpass:true,bandpassLower:3,bandpassUpper:45,scalar:2.5/(32*(Math.pow(2,24)-1))}}function freeeeg32codec(data){let arr;if(data.getInt8)arr=new Uint8Array(data.buffer);else if(!data.buffer)arr=new Uint8Array(data);else arr=data;let output={};for(let i=0;i<32;i++){let idx=i*3+1;output[i]=bitflippin.bytesToUInt24(arr[idx],arr[idx+1],arr[idx+2])}let accIdx=97;output["ax"]=bitflippin.bytesToInt16(arr[accIdx],arr[accIdx+1]);output["ay"]=bitflippin.bytesToInt16(arr[accIdx+2],arr[accIdx+3]);output["az"]=bitflippin.bytesToInt16(arr[accIdx+4],arr[accIdx+5]);output["gx"]=bitflippin.bytesToInt16(arr[accIdx+6],arr[accIdx+7]);output["gy"]=bitflippin.bytesToInt16(arr[accIdx+8],arr[accIdx+9]);output["gz"]=bitflippin.bytesToInt16(arr[accIdx+10],arr[accIdx+11]);return output}var freeeeg32ChartSettings={lines:{"ax":{nSec:10,sps:500},"ay":{nSec:10,sps:500},"az":{nSec:10,sps:500},"gx":{nSec:10,sps:500},"gy":{nSec:10,sps:500},"gz":{nSec:10,sps:500}}};var freeeeg32FilterSettings={};for(let i=0;i<32;i++){freeeeg32ChartSettings.lines[i]={sps:500,nSec:10};freeeeg32FilterSettings[i]={sps:500,useDCBlock:true,useBandpass:true,bandpassLower:3,bandpassUpper:45,useScaling:true,scalar:2.5/(8*(Math.pow(2,24)-1))}}var textdecoder=new TextDecoder;function hegduinocodec(value){let output={timestamp:0,red:0,infrared:0,heg:0,ambient:0,temperature:0};let txt=textdecoder.decode(value);let line=txt.split("|");if(line.length===3){output.timestamp=Date.now();output.red=parseInt(line[0]);output.infrared=parseInt(line[1]);output.heg=parseFloat(line[2])}else if(line.length>=5){output.timestamp=parseInt(line[0]);output.red=parseInt(line[1]);output.infrared=parseInt(line[2]);output.heg=parseFloat(line[3]);output.ambient=parseFloat(line[4]);output.temperature=parseFloat(line[5]);return output}else return txt}var hegduinoBLESettings={services:{["6E400001-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{"6e400002-b5a3-f393-e0a9-e50e24dcca9e":{write:"t"},"6e400003-b5a3-f393-e0a9-e50e24dcca9e":{notify:true,notifyCallback:void 0,codec:hegduinocodec}},["6E400004-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{["6E400005-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{read:true},["6E400006-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{write:void 0,notify:true,notifyCallback:void 0},["6E400007-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{read:true}}},androidWebBLE:"o"};function max3010xcodec(data){let arr;if(data.getInt8)arr=new Uint8Array(data.buffer);else if(!data.buffer)arr=new Uint8Array(data);else arr=data;const output={red:new Array(32),ir:new Array(32),dt:0};let i=0;while(i<32){let idx=i*6;if(i%2===0){output["ir"][i]=(arr[idx+1]<<16|arr[idx+2]<<8|arr[idx+3])&524287;output["ir"][i+1]=(arr[idx+4]<<16|arr[idx+5]<<8|arr[idx+6])&524287}else{output["red"][i-1]=(arr[idx+1]<<16|arr[idx+2]<<8|arr[idx+3])&524287;output["red"][i]=(arr[idx+4]<<16|arr[idx+5]<<8|arr[idx+6])&524287}i++}output["dt"]=bitflippin.get2sCompliment(arr[193],8)+.0625*arr[194];return output}function mpu6050codec(data){let arr;if(data.getInt8)arr=new Uint8Array(data.buffer);else if(!data.buffer)arr=new Uint8Array(data);else arr=data;let output={"ax":new Array(20),"ay":new Array(20),"az":new Array(20),"gx":new Array(20),"gy":new Array(20),"gz":new Array(20),"temp":(bitflippin.bytesToInt16(arr[241],arr[242])+521)/340+35};for(let i=0;i<20;i++){let idx=i*12;output.ax[i]=bitflippin.bytesToInt16(arr[idx+1],arr[idx+2]);output.ay[i]=bitflippin.bytesToInt16(arr[idx+3],arr[idx+4]);output.az[i]=bitflippin.bytesToInt16(arr[idx+5],arr[idx+6]);output.gx[i]=bitflippin.bytesToInt16(arr[idx+7],arr[idx+8]);output.gy[i]=bitflippin.bytesToInt16(arr[idx+9],arr[idx+10]);output.gz[i]=bitflippin.bytesToInt16(arr[idx+11],arr[idx+12])}return output}function cognixionONE_EEG_codec(data){let arr;if(data.getInt8)arr=new Uint8Array(data.buffer);else if(!data.buffer)arr=new Uint8Array(data);else arr=data;let output={0:new Array,1:new Array,2:new Array,3:new Array,4:new Array,5:new Array,6:new Array,7:new Array};for(let i=0;i<7;i++){let j=i*26+1;if(!arr[j+23])break;output[0][i]=bitflippin.bytesToUInt24(arr[j],arr[j+1],arr[j+2]);output[1][i]=bitflippin.bytesToUInt24(arr[j+3],arr[j+4],arr[j+5]);output[2][i]=bitflippin.bytesToUInt24(arr[j+6],arr[j+7],arr[j+8]);output[3][i]=bitflippin.bytesToUInt24(arr[j+9],arr[j+10],arr[j+11]);output[4][i]=bitflippin.bytesToUInt24(arr[j+12],arr[j+13],arr[j+14]);output[5][i]=bitflippin.bytesToUInt24(arr[j+15],arr[j+16],arr[j+17]);output[6][i]=bitflippin.bytesToUInt24(arr[j+18],arr[j+19],arr[j+20]);output[7][i]=bitflippin.bytesToUInt24(arr[j+21],arr[j+22],arr[j+23])}return output}var cognixionONEBLESettings={services:{["82046698-6313-4BB1-9645-6BA28BF86DF5".toLowerCase()]:{["8204669A-6313-4BB1-9645-6BA28BF86DF5".toLowerCase()]:{notify:true,notifyCallback:void 0,codec:cognixionONE_EEG_codec}},["82E12914-9AFA-4648-BD1B-8E2B3DC6DAAF".toLowerCase()]:{["82E12915-9AFA-4648-BD1B-8E2B3DC6DAAF".toLowerCase()]:{write:void 0},["82E12916-9AFA-4648-BD1B-8E2B3DC6DAAF".toLowerCase()]:{read:true}}}};var PeanutCodes={2:{type:"POOR_SIGNAL",format:"<B",byteLength:1},144:{type:"unfilteredHEG",format:"<i",byteLength:4},145:{type:"heg",format:"<i",byteLength:4},147:{type:"rawdata4",format:"<iiii",byteLength:4*4},148:{type:"rawdata6",format:"<iiiiii",byteLength:4*6},160:{type:"sampleNumber",format:"<i",byteLength:4},176:{type:"debug0",format:"<i",byteLength:4},177:{type:"debug1",format:"<i",byteLength:4},178:{type:"debug2",format:"<i",byteLength:4},179:{type:"debug3",format:"<i",byteLength:4},180:{type:"debug4",format:"<iiiiii",byteLength:4*6},181:{type:"debug4",format:"<iiiiii",byteLength:4*6},182:{type:"rawdata27",format:"<B"+"i".repeat(26),byteLength:1+4*26}};function peanutcodec(data){let result={};let i=0;while(i<data.length){if(PeanutCodes[data[i]]&&i+1+PeanutCodes[data[i]].byteLength<=data.length){let slice=data.slice(i+1,i+1+PeanutCodes[data[i]].byteLength).buffer;let unpacked=bitflippin.struct(PeanutCodes[data[i]].format).unpack(slice);let code=PeanutCodes[data[i]].type;if(code==="unfilteredHEG"||code==="heg")unpacked=unpacked[0]/256;else if(code==="POOR_SIGNAL"||code==="sampleNumber"||code==="debug0"||code==="debug1"||code==="debug2"||code==="debug3")unpacked=unpacked[0];if(!result[PeanutCodes[data[i]].type]){if(Array.isArray(unpacked))result[PeanutCodes[data[i]].type]=unpacked;else result[PeanutCodes[data[i]].type]=[unpacked]}else{if(Array.isArray(unpacked))result[PeanutCodes[data[i]].type].push(...unpacked);else result[PeanutCodes[data[i]].type].push(unpacked)}i+=PeanutCodes[data[i]].byteLength+1}else i++}return result}var peanutSerialSettings={baudRate:38400,bufferSize:500,write:"protocol 3\n",buffering:{searchBytes:new Uint8Array([170,170])},codec:peanutcodec};function nrf5x_usbcodec(data){let arr;if(data.getInt8)arr=new Uint8Array(data.buffer);else if(!data.buffer)arr=new Uint8Array(data);else arr=data;const output={};if(arr[0]===2){Object.assign(output,ads131m08codec(arr.subarray(2)))}else if(arr[0]===3){let result=ads131m08codec(arr.subarray(2));Object.keys(result).forEach((key,i)=>{output[i+8]=result[key]})}else if(arr[0]===4){Object.assign(output,mpu6050codec(arr.subarray(2)))}else if(arr[0]===5){Object.assign(output,max3010xcodec(arr.subarray(2)))}else{Object.assign(output,ads131m08codec(arr))}return output}var nrf5xSerialSettings={baudRate:115200,buffering:{searchBytes:new Uint8Array([240,240])},codec:nrf5x_usbcodec};var defaultsetting3={sps:250,useDCBlock:false,useBandpass:false,bandpassLower:3,bandpassUpper:45,useScaling:true,scalar:1.2/(32*(Math.pow(2,24)-1))};var nrf5x_usbFilterSettings={"0":JSON.parse(JSON.stringify(defaultsetting3)),"1":JSON.parse(JSON.stringify(defaultsetting3)),"2":JSON.parse(JSON.stringify(defaultsetting3)),"3":JSON.parse(JSON.stringify(defaultsetting3)),"4":JSON.parse(JSON.stringify(defaultsetting3)),"5":JSON.parse(JSON.stringify(defaultsetting3)),"6":JSON.parse(JSON.stringify(defaultsetting3)),"7":JSON.parse(JSON.stringify(defaultsetting3)),"8":JSON.parse(JSON.stringify(defaultsetting3)),"9":JSON.parse(JSON.stringify(defaultsetting3)),"10":JSON.parse(JSON.stringify(defaultsetting3)),"11":JSON.parse(JSON.stringify(defaultsetting3)),"12":JSON.parse(JSON.stringify(defaultsetting3)),"13":JSON.parse(JSON.stringify(defaultsetting3)),"14":JSON.parse(JSON.stringify(defaultsetting3)),"15":JSON.parse(JSON.stringify(defaultsetting3))};var textdecoder2=new TextDecoder;function statechangercodec(value){let output={timestamp:0,left_red:0,left_infrared:0,left_heg:0,center_red:0,center_infrared:0,center_heg:0,right_red:0,right_infrared:0,right_heg:0};let txt=textdecoder2.decode(value);let line=txt.split("|");if(line.length>=5){output.timestamp=parseInt(line[0]);output.left_red=parseInt(line[1]);output.left_infrared=parseInt(line[2]);output.left_heg=parseFloat(line[3]);output.center_red=parseInt(line[4]);output.center_infrared=parseInt(line[5]);output.center_heg=parseFloat(line[6]);output.right_red=parseInt(line[7]);output.right_infrared=parseInt(line[8]);output.right_heg=parseFloat(line[9]);return output}else return txt}var statechangerBLESettings={services:{["6E400001-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{"6e400002-b5a3-f393-e0a9-e50e24dcca9e":{write:"t"},"6e400003-b5a3-f393-e0a9-e50e24dcca9e":{notify:true,notifyCallback:void 0,codec:statechangercodec}},["6E400004-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{["6E400005-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{read:true},["6E400006-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{write:void 0,notify:true,notifyCallback:void 0},["6E400007-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{read:true}}},androidWebBLE:"o"};var defaultsetting4={sps:250,useDCBlock:true,useBandpass:true,bandpassLower:3,bandpassUpper:45};var museFilterSettings={"0":JSON.parse(JSON.stringify(defaultsetting4)),"1":JSON.parse(JSON.stringify(defaultsetting4)),"2":JSON.parse(JSON.stringify(defaultsetting4)),"3":JSON.parse(JSON.stringify(defaultsetting4)),"4":JSON.parse(JSON.stringify(defaultsetting4))};function blueberrycodec(value){let output={red:value.getInt32(2),ir:value.getInt32(6),ir2:value.getInt32(10)};return output}var textdecoder3=new TextDecoder;var decoders={"raw":data=>{if(data?.buffer)return Array.from(new Uint8Array(data));else return data},"utf8":data=>{return textdecoder3.decode(data)},"console-f12":data=>{if(data?.buffer)data=Array.from(new Uint8Array(data));console.log(data);return data},"debug":(data,debugmessage)=>{if(data?.buffer)data=Array.from(new Uint8Array(data));console.log(debugmessage,data);return data},"ads131m08":ads131m08codec,"max3010x":max3010xcodec,"mpu6050":mpu6050codec,"freeeeg32":freeeeg32codec,"freeeeg128":freeeeg128codec,"cyton":cytoncodec,"cognixionONE_BLE":cognixionONE_EEG_codec,"hegduino":hegduinocodec,"nrf5x":nrf5x_usbcodec,"peanut":peanutcodec,"statechanger":statechangercodec,"blueberry":blueberrycodec};var g=class{constructor(e,t,s,l){this.r=e,this.g=t,this.b=s,this.a=l}};var d=class{constructor(){this.scaleX=1,this.scaleY=1,this.offsetX=0,this.offsetY=0,this.loop=false,this._vbuffer=0,this._coord=0,this.visible=true,this.intensity=1,this.xy=new Float32Array([]),this.numPoints=0,this.color=new g(0,0,0,1),this.webglNumPoints=0}};var y=class extends d{constructor(e,t){super(),this.currentIndex=0,this.webglNumPoints=t,this.numPoints=t,this.color=e,this.xy=new Float32Array(2*this.webglNumPoints)}setX(e,t){this.xy[e*2]=t}setY(e,t){this.xy[e*2+1]=t}getX(e){return this.xy[e*2]}getY(e){return this.xy[e*2+1]}lineSpaceX(e,t){for(let s=0;s<this.numPoints;s++)this.setX(s,e+t*s)}arrangeX(){this.lineSpaceX(-1,2/this.numPoints)}constY(e){for(let t=0;t<this.numPoints;t++)this.setY(t,e)}shiftAdd(e){let t=e.length;for(let s=0;s<this.numPoints-t;s++)this.setY(s,this.getY(s+t));for(let s=0;s<t;s++)this.setY(s+this.numPoints-t,e[s])}addArrayY(e){if(this.currentIndex+e.length<=this.numPoints)for(let t=0;t<e.length;t++)this.setY(this.currentIndex,e[t]),this.currentIndex++}replaceArrayY(e){if(e.length==this.numPoints)for(let t=0;t<this.numPoints;t++)this.setY(t,e[t])}};var A=(u,e,t)=>{let s={x:0,y:0};return s.x=u.x+e.x*t,s.y=u.y+e.y*t,s};var w=u=>L(-u.y,u.x);var b=(u,e)=>{let t=M(u,e);return t=_(t),t};var Y=(u,e)=>{let t={x:0,y:0};return t.x=u.x+e.x,t.y=u.y+e.y,t};var R=(u,e)=>u.x*e.x+u.y*e.y;var _=u=>{let e={x:0,y:0},t=u.x*u.x+u.y*u.y;return t>0&&(t=1/Math.sqrt(t),e.x=u.x*t,e.y=u.y*t),e};var L=(u,e)=>{let t={x:0,y:0};return t.x=u,t.y=e,t};var M=(u,e)=>{let t={x:0,y:0};return t.x=u.x-e.x,t.y=u.y-e.y,t};var S=u=>{let e,t={x:0,y:0},s={x:0,y:0},l=[],r=(i,a)=>{l.push({vec2:i,miterLength:a})},n=i=>({x:u[i*2],y:u[i*2+1]});t=b(n(1),n(0)),e=w(t),r(e,1);let o=u.length/2;for(let i=1;i<o-1;i++){let a=n(i-1),h=n(i),c=n(i+1);t=b(h,a),e=w(t),s=b(c,h);let m=T(t,s),x=C(t,m,1);r(m,x)}return t=b(n(o-1),n(o-2)),e=w(t),r(e,1),l};var T=(u,e)=>{let t=Y(u,e);return t=_(t),L(-t.y,t.x)};var C=(u,e,t)=>{let s=L(-u.y,u.x);return t/R(e,s)};var v=class extends d{constructor(e,t,s){super(),this.currentIndex=0,this._thicknessRequested=0,this._actualThickness=0,this.webglNumPoints=t*2,this.numPoints=t,this.color=e,this._thicknessRequested=s,this._linePoints=new Float32Array(t*2),this.xy=new Float32Array(2*this.webglNumPoints)}convertToTriPoints(){let e=this._actualThickness/2,t=S(this._linePoints);for(let s=0;s<this.numPoints;s++){let l=this._linePoints[2*s],r=this._linePoints[2*s+1],n={x:l,y:r},o=A(n,t[s].vec2,t[s].miterLength*e),i=A(n,t[s].vec2,-t[s].miterLength*e);this.xy[s*4]=o.x,this.xy[s*4+1]=o.y,this.xy[s*4+2]=i.x,this.xy[s*4+3]=i.y}}setX(e,t){this._linePoints[e*2]=t}setY(e,t){this._linePoints[e*2+1]=t}lineSpaceX(e,t){for(let s=0;s<this.numPoints;s++)this.setX(s,e+t*s)}setThickness(e){this._thicknessRequested=e}getThickness(){return this._thicknessRequested}setActualThickness(e){this._actualThickness=e}};var p=class{constructor(e,t){this.debug=false,this.addLine=this.addDataLine,t==null?this.webgl=e.getContext("webgl",{antialias:true,transparent:false}):(this.webgl=e.getContext("webgl",{antialias:t.antialias,transparent:t.transparent,desynchronized:t.deSync,powerPerformance:t.powerPerformance,preserveDrawing:t.preserveDrawing}),this.debug=t.debug==null?false:t.debug),this.log("canvas type is: "+e.constructor.name),this.log(`[webgl-plot]:width=${e.width}, height=${e.height}`),this._linesData=[],this._linesAux=[],this._thickLines=[],this._surfaces=[],this.gScaleX=1,this.gScaleY=1,this.gXYratio=1,this.gOffsetX=0,this.gOffsetY=0,this.gLog10X=false,this.gLog10Y=false,this.webgl.clear(this.webgl.COLOR_BUFFER_BIT),this.webgl.viewport(0,0,e.width,e.height),this._progLine=this.webgl.createProgram(),this.initThinLineProgram(),this.webgl.enable(this.webgl.BLEND),this.webgl.blendFunc(this.webgl.SRC_ALPHA,this.webgl.ONE_MINUS_SRC_ALPHA)}get linesData(){return this._linesData}get linesAux(){return this._linesAux}get thickLines(){return this._thickLines}get surfaces(){return this._surfaces}_drawLines(e){let t=this.webgl;e.forEach(s=>{if(s.visible){t.useProgram(this._progLine);let l=t.getUniformLocation(this._progLine,"uscale");t.uniformMatrix2fv(l,false,new Float32Array([s.scaleX*this.gScaleX*(this.gLog10X?1/Math.log(10):1),0,0,s.scaleY*this.gScaleY*this.gXYratio*(this.gLog10Y?1/Math.log(10):1)]));let r=t.getUniformLocation(this._progLine,"uoffset");t.uniform2fv(r,new Float32Array([s.offsetX+this.gOffsetX,s.offsetY+this.gOffsetY]));let n=t.getUniformLocation(this._progLine,"is_log");t.uniform2iv(n,new Int32Array([this.gLog10X?1:0,this.gLog10Y?1:0]));let o=t.getUniformLocation(this._progLine,"uColor");t.uniform4fv(o,[s.color.r,s.color.g,s.color.b,s.color.a]),t.bufferData(t.ARRAY_BUFFER,s.xy,t.STREAM_DRAW),t.drawArrays(s.loop?t.LINE_LOOP:t.LINE_STRIP,0,s.webglNumPoints)}})}_drawSurfaces(e){let t=this.webgl;e.forEach(s=>{if(s.visible){t.useProgram(this._progLine);let l=t.getUniformLocation(this._progLine,"uscale");t.uniformMatrix2fv(l,false,new Float32Array([s.scaleX*this.gScaleX*(this.gLog10X?1/Math.log(10):1),0,0,s.scaleY*this.gScaleY*this.gXYratio*(this.gLog10Y?1/Math.log(10):1)]));let r=t.getUniformLocation(this._progLine,"uoffset");t.uniform2fv(r,new Float32Array([s.offsetX+this.gOffsetX,s.offsetY+this.gOffsetY]));let n=t.getUniformLocation(this._progLine,"is_log");t.uniform2iv(n,new Int32Array([this.gLog10X?1:0,this.gLog10Y?1:0]));let o=t.getUniformLocation(this._progLine,"uColor");t.uniform4fv(o,[s.color.r,s.color.g,s.color.b,s.color.a]),t.bufferData(t.ARRAY_BUFFER,s.xy,t.STREAM_DRAW),t.drawArrays(t.TRIANGLE_STRIP,0,s.webglNumPoints)}})}_drawTriangles(e){let t=this.webgl;t.bufferData(t.ARRAY_BUFFER,e.xy,t.STREAM_DRAW),t.useProgram(this._progLine);let s=t.getUniformLocation(this._progLine,"uscale");t.uniformMatrix2fv(s,false,new Float32Array([e.scaleX*this.gScaleX*(this.gLog10X?1/Math.log(10):1),0,0,e.scaleY*this.gScaleY*this.gXYratio*(this.gLog10Y?1/Math.log(10):1)]));let l=t.getUniformLocation(this._progLine,"uoffset");t.uniform2fv(l,new Float32Array([e.offsetX+this.gOffsetX,e.offsetY+this.gOffsetY]));let r=t.getUniformLocation(this._progLine,"is_log");t.uniform2iv(r,new Int32Array([0,0]));let n=t.getUniformLocation(this._progLine,"uColor");t.uniform4fv(n,[e.color.r,e.color.g,e.color.b,e.color.a]),t.drawArrays(t.TRIANGLE_STRIP,0,e.xy.length/2)}_drawThickLines(){this._thickLines.forEach(e=>{if(e.visible){let t=Math.min(this.gScaleX,this.gScaleY);e.setActualThickness(e.getThickness()/t),e.convertToTriPoints(),this._drawTriangles(e)}})}update(){this.clear(),this.draw()}draw(){this._drawLines(this.linesData),this._drawLines(this.linesAux),this._drawThickLines(),this._drawSurfaces(this.surfaces)}clear(){this.webgl.clear(this.webgl.COLOR_BUFFER_BIT)}_addLine(e){e._vbuffer=this.webgl.createBuffer(),this.webgl.bindBuffer(this.webgl.ARRAY_BUFFER,e._vbuffer),this.webgl.bufferData(this.webgl.ARRAY_BUFFER,e.xy,this.webgl.STREAM_DRAW),e._coord=this.webgl.getAttribLocation(this._progLine,"coordinates"),this.webgl.vertexAttribPointer(e._coord,2,this.webgl.FLOAT,false,0,0),this.webgl.enableVertexAttribArray(e._coord)}addDataLine(e){this._addLine(e),this.linesData.push(e)}addAuxLine(e){this._addLine(e),this.linesAux.push(e)}addThickLine(e){this._addLine(e),this._thickLines.push(e)}addSurface(e){this._addLine(e),this.surfaces.push(e)}initThinLineProgram(){let e=`
      attribute vec2 coordinates;
      uniform mat2 uscale;
      uniform vec2 uoffset;
      uniform ivec2 is_log;

      void main(void) {
         float x = (is_log[0]==1) ? log(coordinates.x) : coordinates.x;
         float y = (is_log[1]==1) ? log(coordinates.y) : coordinates.y;
         vec2 line = vec2(x, y);
         gl_Position = vec4(uscale*line + uoffset, 0.0, 1.0);
      }`,t=this.webgl.createShader(this.webgl.VERTEX_SHADER);this.webgl.shaderSource(t,e),this.webgl.compileShader(t);let s=`
         precision mediump float;
         uniform highp vec4 uColor;
         void main(void) {
            gl_FragColor =  uColor;
         }`,l=this.webgl.createShader(this.webgl.FRAGMENT_SHADER);this.webgl.shaderSource(l,s),this.webgl.compileShader(l),this._progLine=this.webgl.createProgram(),this.webgl.attachShader(this._progLine,t),this.webgl.attachShader(this._progLine,l),this.webgl.linkProgram(this._progLine)}popDataLine(){this.linesData.pop()}removeAllLines(){this._linesData=[],this._linesAux=[],this._thickLines=[],this._surfaces=[]}removeDataLines(){this._linesData=[]}removeAuxLines(){this._linesAux=[]}viewport(e,t,s,l){this.webgl.viewport(e,t,s,l)}log(e){this.debug&&console.log("[webgl-plot]:"+e)}};var f=class{constructor(){this.plots={}}initPlot(e,t){if(t||(t=new p(e.canvas,e.webglOptions)),!e._id)e._id=`plot${Math.floor(Math.random()*1e15)}`;else if(this.plots[e._id]){let o=this.plots[e._id].initial;e=Object.assign(o,e)}e.overlay&&(typeof e.overlay!="object"&&(e.overlay=document.createElement("canvas"),e.overlay.style.position="absolute",e.overlay.width=e.canvas.width,e.overlay.height=e.canvas.height,e.canvas.appendChild(e.overlay)),e.overlayCtx||(e.overlayCtx=e.overlay.getContext("2d"))),e.width&&(e.canvas.width=e.width,e.canvas.style&&(e.canvas.style.width=e.width+"px"),typeof e.overlay=="object"&&(e.overlay.width=e.width,e.overlay.style&&(e.overlay.style.width=e.width+"px"))),e.height&&(e.canvas.height=e.height,e.canvas.style&&(e.canvas.style.height=e.height+"px"),typeof e.overlay=="object"&&(e.overlay.height=e.height,e.overlay.style&&(e.overlay.style.height=e.height+"px")));let s={};for(let o in e.lines)Array.isArray(e.lines[o])||(s[o]=Object.assign({},s[o]),"viewing"in e.lines[o]||(e.lines[o].viewing=true),s[o].viewing=e.lines[o].viewing,s[o].sps=e.lines[o].sps,s[o].nSec=e.lines[o].nSec,s[o].nPoints=e.lines[o].nPoints);let l={plot:t,settings:e,initial:Object.assign(Object.assign({},e),{lines:s}),anim:()=>{t.update()}};this.plots[e._id]=l;let r=0,n=0;Object.keys(e.lines).forEach(o=>{e.lines[o]?.viewing!==false&&n++}),e.nLines=n;for(let o in e.lines){let i=e.lines[o];if(Array.isArray(i)&&(i={values:i},e.lines[o]=i),"viewing"in i||(i.viewing=true),i.color)Array.isArray(i.color)&&(i.color=new g(...i.color));else{let h=f.HSLToRGB(360*(r/n)%360,100,50,1);l.initial.lines[o].color=[...h,1],i.color=new g(...h,1)}let a;if(i.nPoints?a=i.nPoints:i.nSec&&i.sps?a=Math.ceil(i.nSec*i.sps):i.values?a=i.values.length:a||(a=1e3),!a)return;if(i.points=a,e.lines[o].viewing!==false){if(i.width?i.line=new v(i.color,a,i.width):i.line=new y(i.color,a),i.line.arrangeX(),i.values?.length===i.points){if(e.overlay){let h=Math.max(...i.values),c=Math.min(...i.values);i.ymin=c,i.ymax=h;let m=Math.abs(i.ymin);i.absmax=m>i.ymax?m:i.ymax}i.values.length!==a&&(i.interpolate?i.values.length>a?i.values=f.downsample(i.values,a):i.values.length<a&&(i.values=f.upsample(i.values,a)):i.values.length>i.points?i.values=i.values.slice(i.values.length-i.points):i.values=[...new Array(i.points-i.values.length).fill(0),...i.values])}else Array.isArray(i.values)?i.values=[...new Array(a-i.values.length).fill(0),...i.values]:i.values=new Array(i.points).fill(0);if("autoscale"in i||(i.autoscale=true),i.points>5e3&&(i.autoscale=false),i.position||(i.position=e.nLines-r-1),i.autoscale&&(i.values=f.autoscale(i.values,i.position?i.position:r,n,i.centerZero)),i.values.forEach((h,c)=>i.line.setY(c,h)),t.addDataLine(i.line),"xAxis"in i||(i.xAxis=true),i.xAxis){i.xColor?Array.isArray(i.xColor)&&(i.xColor=new g(...i.xColor)):i.xColor=new g(1,1,1,.3);let h=new y(i.xColor,2),c=(r+1)*2/n-1-1/n;i.autoscale?h.constY(c):h.constY(.5),h.arrangeX(),h.xy[2]=1,i.x=h,t.addAuxLine(h)}if(n>1&&i.autoscale&&r!==n-1){e.dividerColor?Array.isArray(e.dividerColor)&&(e.dividerColor=new g(...e.dividerColor)):e.dividerColor=new g(1,1,1,1);let h=new y(e.dividerColor,2);h.constY((r+1)*2/n-1),h.arrangeX(),h.xy[2]=1,i.divider=h,t.addAuxLine(h)}r++}}if(typeof e.overlay=="object"){let o=e.overlay,i=e.overlayCtx;i.clearRect(0,0,e.overlay.width,e.overlay.height),i.font="1em Courier",i.fillStyle="white";for(let a in e.lines){let h=e.lines[a];if(h.useOverlay||!("useOverlay"in h)){let c=e.nLines-h.position-1;i.fillText(a,20,o.height*(c+.1)/e.nLines),i.fillText(h.ymax,o.width-70,o.height*(c+.1)/e.nLines),i.fillText(h.ymin,o.width-70,o.height*(c+.9)/e.nLines)}}}return requestAnimationFrame(l.anim),this.plots[e._id]}deinitPlot(e){return typeof e=="string"&&(e=this.plots[e]),e.plot.clear(),e.plot.removeAllLines(),true}reinitPlot(e,t){if(typeof e=="string"){let s=e;e=this.plots[e],t._id||(t._id=s)}if(!!e.plot)return e.plot.clear(),e.plot.removeAllLines(),e.settings.overlayCtx&&e.settings.overlayCtx.clearRect(0,0,e.settings.overlay?.width,e.settings.overlay?.height),this.initPlot(t,e.plot)}getChartSettings(e){let t=this.plots[e];if(t){let s=Object.assign({},t.initial);return delete s.canvas,delete s.overlay,delete s.overlayCtx,s}}update(e,t,s=true){if(typeof e=="string"&&(e=this.plots[e]),!e)return false;if(t){let l=false;for(let r in t)if(e.settings.lines[r]&&e.settings.lines[r].line){if(e.settings.lines[r]?.viewing===false)continue;let n=e.settings.lines[r],o=n.values;if(Array.isArray(t[r])?n.values=t[r]:Object.assign(n,t[r]),n.values){if(e.settings.overlay){let i=Math.max(...n.values),a=Math.min(...n.values);n.ymin=a,n.ymax=i;let h=Math.abs(n.ymin);n.absmax=h>n.ymax?h:n.ymax}n.autoscale&&(n.values=f.autoscale(n.values,n.position,e.settings.nLines,n.centerZero)),n.values.length!==n.points&&(n.interpolate?n.values.length>n.points?n.values=f.downsample(n.values,n.points):n.values.length<n.points&&(n.values=f.upsample(n.values,n.points)):n.values.length>n.points?n.values=n.values.slice(n.values.length-n.points):n.values=[...o.slice(n.values.length),...n.values]),n.values.forEach((i,a)=>{!n.autoscale&&n.absmax>1?n.line.setY(a,i/n.absmax):n.line.setY(a,i)})}}else e.settings.generateNewLines&&(Array.isArray(t[r])&&(t[r]={values:t[r]}),!t[r].nSec&&!t[r].nPoints&&(t[r].nPoints=1e3),l=true);if(l)return e.settings.cleanGeneration||Object.keys(e.initial.lines).forEach(r=>{t[r]?t[r]=Object.assign(e.initial.lines[r],t[r]):t[r]=e.initial.lines[r]}),this.reinitPlot(e,{_id:e.settings._id,lines:t}),true}if(typeof e.settings.overlay=="object"){let l=e.settings.overlay,r=e.settings.overlayCtx;r.clearRect(0,0,e.settings.overlay.width,e.settings.overlay.height),r.font="1em Courier",r.fillStyle="white";for(let n in e.settings.lines){let o=e.settings.lines[n];if(o.useOverlay||!("useOverlay"in o)){let i=e.settings.nLines-o.position-1;r.fillText(n,20,l.height*(i+.1)/e.settings.nLines),r.fillText(o.ymax,l.width-70,l.height*(i+.1)/e.settings.nLines),r.fillText(o.ymin,l.width-70,l.height*(i+.9)/e.settings.nLines)}}}return s&&requestAnimationFrame(e.anim),true}updateLine(e,t,s,l,r,n,o){return e.numPoints!==t.length&&(s?e.numPoints>t.length?t=f.downsample(t,e.numPoints):e.numPoints<t.length&&(t=f.upsample(t,e.numPoints)):t.length>e.numPoints?t=t.slice(t.length-e.numPoints):t=[...new Array(t.length).fill(0),...t]),l&&(t=f.autoscale(t,r,n,o)),t.forEach((i,a)=>e.setY(a,i)),true}static autoscale(e,t=0,s=1,l=false){if(e?.length===0)return e;let r=Math.max(...e),n=Math.min(...e),o=1/s,i=1;if(l){let a=Math.max(Math.abs(n),Math.abs(r));return a!==0&&(i=o/a),e.map(h=>h*i+(o*(t+1)*2-1-o))}else return r===n?r!==0&&(i=o/r):i=o/(r-n),e.map(a=>2*((a-n)*i-1/(2*s))+(o*(t+1)*2-1-o))}static absmax(e){return Math.max(Math.abs(Math.min(...e)),Math.max(...e))}static downsample(e,t,s=1){if(e.length>t){let l=new Array(t),r=e.length/t,n=e.length-1,o=0,i=0;for(let a=r;a<e.length;a+=r){let h=Math.round(a);h>n&&(h=n);for(let c=o;c<h;c++)l[i]+=e[c];l[i]/=(h-o)*s,i++,o=h}return l}else return e}static upsample(e,t,s=1){var l=function(m,x,P){return(m+(x-m)*P)*s},r=new Array(t),n=(e.length-1)/(t-1);r[0]=e[0];for(var o=1;o<t-1;o++){var i=o*n,a=Math.floor(i),h=Math.ceil(i),c=i-a;r[o]=l(e[a],e[h],c)}return r[t-1]=e[e.length-1],r}static interpolate(e,t,s=1){return e.length>t?f.downsample(e,t,s):e.length<t?f.upsample(e,t,s):e}static HSLToRGB(e,t,s,l=255){t/=100,s/=100;let r=(1-Math.abs(2*s-1))*t,n=r*(1-Math.abs(e/60%2-1)),o=s-r/2,i=0,a=0,h=0;return 0<=e&&e<60?(i=r,a=n,h=0):60<=e&&e<120?(i=n,a=r,h=0):120<=e&&e<180?(i=0,a=r,h=n):180<=e&&e<240?(i=0,a=n,h=r):240<=e&&e<300?(i=n,a=0,h=r):300<=e&&e<360&&(i=r,a=0,h=n),i=(i+o)*l,a=(a+o)*l,h=(h+o)*l,[i,a,h]}static circularBuffer(e,t){return t.length<e.length?e.splice(0,e.length-t.length,...e.slice(t.length)).splice(t.length,e.length,...t):t.length>e.length?e.splice(0,e.length,t.slice(t.length-e.length)):e.splice(0,e.length,...t),e}static formatDataForCharts(e,t){if(Array.isArray(e)){if(Array.isArray(e[0])){let s={};if(e.forEach((l,r)=>{s[r]=l}),e=s,isNaN(e[0][0]))return}else if(t){if(e={[t]:e},isNaN(e[t][0]))return}else if(e={0:e},isNaN(e[0][0]))return}else if(typeof e=="object"){for(let s in e)if(typeof e[s]=="number"?e[s]=[e[s]]:e[s]?.values&&typeof e[s].values=="number"&&(e[s].values=[e[s].values]),isNaN(e[s][0]))return}else if(typeof e=="string"){let s;e.includes("	")?s=e.split("	"):e.includes(",")&&(s=e.split(",")),e={},s&&s.forEach((l,r)=>{if(l.includes(":")){let[n,o]=l.split(":"),i=parseFloat(o);if(i)e[n]=[i];else return}else{let n=parseFloat(l);if(n)e[r]=[n];else return}})}else typeof e=="number"&&(t?e={[t]:[e]}:e={0:[e]});return e}static padTime(e,t,s,l){let r=(e[0]-t)/s/l;return[...new Array(l-e.length).map((o,i)=>t+r*(i+1)),...e]}static interpolateForTime(e,t,s){return f.interpolate(e,Math.ceil(s*t))}};var BiquadChannelFilterer=class{constructor(options={sps:512,useSMA4:false,useNotch50:true,useNotch60:true,useLowpass:false,lowpassHz:100,useBandpass:false,bandpassLower:3,bandpassUpper:45,useDCBlock:true,DCBresonance:.995,useScaling:false,scalar:1}){this.idx=0;this.sps=options.sps;this.bandpassLower=options.bandpassLower?options.bandpassLower:3;this.bandpassUpper=options.bandpassUpper?options.bandpassUpper:45;this.useSMA4=options.useSMA4;this.last4=[];this.useNotch50=options.useNotch50;this.useNotch60=options.useNotch60;this.useLowpass=options.useLowpass;this.lowpassHz=options.lowpassHz?options.lowpassHz:100;this.useBandpass=options.useBandpass;this.useDCBlock=options.useDCBlock;this.DCBresonance=options.DCBresonance?options.DCBresonance:.995;this.useScaling=options.useScaling;this.scalar=options.scalar;let sps=this.sps;this.notch50=[makeNotchFilter(50,sps,2),makeNotchFilter(100,sps,2)];this.notch60=[makeNotchFilter(60,sps,2),makeNotchFilter(120,sps,2)];this.lp1=[new Biquad("lowpass",this.lowpassHz,sps),new Biquad("lowpass",this.lowpassHz,sps),new Biquad("lowpass",this.lowpassHz,sps),new Biquad("lowpass",this.lowpassHz,sps)];this.bp1=[makeBandpassFilter(this.bandpassLower,this.bandpassUpper,sps,1),makeBandpassFilter(this.bandpassLower,this.bandpassUpper,sps,1),makeBandpassFilter(this.bandpassLower,this.bandpassUpper,sps,1),makeBandpassFilter(this.bandpassLower,this.bandpassUpper,sps,1)];this.dcb=new DCBlocker(options.DCBresonance?options.DCBresonance:.995)}reset(sps=this.sps){this.notch50=[makeNotchFilter(50,sps,2),makeNotchFilter(100,sps,2)];this.notch60=[makeNotchFilter(60,sps,2),makeNotchFilter(120,sps,2)];this.lp1=[new Biquad("lowpass",this.lowpassHz,sps),new Biquad("lowpass",this.lowpassHz,sps),new Biquad("lowpass",this.lowpassHz,sps),new Biquad("lowpass",this.lowpassHz,sps)];this.bp1=[makeBandpassFilter(this.bandpassLower,this.bandpassUpper,sps,1),makeBandpassFilter(this.bandpassLower,this.bandpassUpper,sps,1),makeBandpassFilter(this.bandpassLower,this.bandpassUpper,sps,1),makeBandpassFilter(this.bandpassLower,this.bandpassUpper,sps,1)];this.dcb=new DCBlocker(this.DCBresonance)}setBandpass(bandpassLower=this.bandpassLower,bandpassUpper=this.bandpassUpper,sps=this.sps){this.bandpassLower=bandpassLower;this.bandpassUpper=bandpassUpper;this.bp1=[makeBandpassFilter(bandpassLower,bandpassUpper,sps),makeBandpassFilter(bandpassLower,bandpassUpper,sps),makeBandpassFilter(bandpassLower,bandpassUpper,sps),makeBandpassFilter(bandpassLower,bandpassUpper,sps)]}apply(latestData=0){let out=latestData;if(this.useDCBlock===true){out=this.dcb.applyFilter(out)}if(this.useSMA4===true){if(this.last4.length<4){this.last4.push(out)}else{out=this.last4.reduce((accumulator,currentValue)=>accumulator+currentValue)/this.last4.length;this.last4.shift();this.last4.push(out)}}if(this.useNotch50===true){this.notch50.forEach((f2,i)=>{out=f2.applyFilter(out)})}if(this.useNotch60===true){this.notch60.forEach((f2,i)=>{out=f2.applyFilter(out)})}if(this.useLowpass===true){this.lp1.forEach((f2,i)=>{out=f2.applyFilter(out)})}if(this.useBandpass===true){this.bp1.forEach((f2,i)=>{out=f2.applyFilter(out)});out*=this.bp1.length}if(this.useScaling===true){out*=this.scalar}this.idx++;return out}};var Biquad=class{constructor(type,freq,sps,Q=1/Math.sqrt(2),dbGain=0){this.a0=0;this.a1=0;this.a2=0;this.b0=0;this.b1=0;this.b2=0;this.x1=0;this.x2=0;this.y1=0;this.y2=0;let types=["lowpass","highpass","bandpass","notch","peak","lowshelf","highshelf"];if(types.indexOf(type)<0){console.error("Valid types: 'lowpass','highpass','bandpass','notch','peak','lowshelf','highshelf'");return}this.type=type;this.freq=freq;this.sps=sps;this.Q=Q;this.dbGain=dbGain;let A2=Math.pow(10,dbGain/40);let omega=2*Math.PI*freq/sps;let sn=Math.sin(omega);let cs=Math.cos(omega);let alpha=sn/(2*Q);let beta=Math.sqrt(A2+A2);this[type](A2,sn,cs,alpha,beta);this.b0/=this.a0;this.b1/=this.a0;this.b2/=this.a0;this.a1/=this.a0;this.a2/=this.a0}lowpass(A2,sn,cs,alpha,beta){this.b0=(1-cs)*.5;this.b1=1-cs;this.b2=(1-cs)*.5;this.a0=1+alpha;this.a1=-2*cs;this.a2=1-alpha}highpass(A2,sn,cs,alpha,beta){this.b0=(1+cs)*.5;this.b1=-(1+cs);this.b2=(1+cs)*.5;this.a0=1+alpha;this.a1=-2*cs;this.a2=1-alpha}bandpass(A2,sn,cs,alpha,beta){this.b0=alpha;this.b1=0;this.b2=-alpha;this.a0=1+alpha;this.a1=-2*cs;this.a2=1-alpha}notch(A2,sn,cs,alpha,beta){this.b0=1;this.b1=-2*cs;this.b2=1;this.a0=1+alpha;this.a1=-2*cs;this.a2=1-alpha}peak(A2,sn,cs,alpha,beta){this.b0=1+alpha*A2;this.b1=-2*cs;this.b2=1-alpha*A2;this.a0=1+alpha/A2;this.a1=-2*cs;this.a2=1-alpha/A2}lowshelf(A2,sn,cs,alpha,beta){this.b0=A2*(A2+1-(A2-1)*cs+beta*sn);this.b1=2*A2*(A2-1-(A2+1)*cs);this.b2=A2*(A2+1-(A2-1)*cs-beta*sn);this.a0=A2+1+(A2+1)*cs+beta*sn;this.a1=2*(A2-1+(A2+1)*cs);this.a2=A2+1+(A2-1)*cs-beta*sn}highshelf(A2,sn,cs,alpha,beta){this.b0=A2*(A2+1+(A2-1)*cs+beta*sn);this.b1=2*A2*(A2-1+(A2+1)*cs);this.b2=A2*(A2+1-(A2-1)*cs-beta*sn);this.a0=A2+1-(A2+1)*cs-beta*sn;this.a1=2*(A2-1-(A2+1)*cs);this.a2=A2+1-(A2-1)*cs-beta*sn}applyFilter(signal_step){let y2=this.b0*signal_step+this.b1*this.x1+this.b2*this.x2-this.a1*this.y1-this.a2*this.y2;this.x2=this.x1;this.x1=signal_step;this.y2=this.y1;this.y1=y2;return y2}zResult(freq){try{let phi=Math.pow(Math.sin(Math.PI*freq*2/(2*this.sps)),2);let result=(Math.pow(this.b0+this.b1+this.b2,2)-4*(this.b0*this.b1+4*this.b0*this.b2+this.b1*this.b2)*phi+16*this.b0*this.b2*phi*phi)/(Math.pow(1+this.a1+this.a2,2)-4*(this.a1+4*this.a2+this.a1*this.a2)*phi+16*this.a2*phi*phi);return result}catch(err){return-200}}static calcCenterFrequency(freqStart,freqEnd){return(freqStart+freqEnd)/2}static calcBandwidth(freqStart,freqEnd){return freqEnd-this.calcCenterFrequency(freqStart,freqEnd)}static calcBandpassQ(frequency,bandwidth,resonance=Math.pow(10,Math.floor(Math.log10(frequency)))){let Q=resonance*Math.sqrt((frequency-bandwidth)*(frequency+bandwidth))/(2*bandwidth);return Q}static calcNotchQ(frequency,bandwidth,resonance=Math.pow(10,Math.floor(Math.log10(frequency)))){let Q=resonance*frequency*bandwidth/Math.sqrt((frequency-bandwidth)*(frequency+bandwidth));return Q}};var DCBlocker=class{constructor(r=.995){this.r=r;this.y1=this.y2=this.x1=this.x2=0}applyFilter(signal_step){this.x2=this.x1;this.x1=signal_step;let y2=this.x1-this.x2+this.r*this.y1;this.y2=this.y1;this.y1=y2;return y2}};var makeNotchFilter=(frequency,sps,bandwidth)=>{return new Biquad("notch",frequency,sps,Biquad.calcNotchQ(frequency,bandwidth),0)};var makeBandpassFilter=(freqStart,freqEnd,sps,resonance=Math.pow(10,Math.floor(Math.log10(Biquad.calcCenterFrequency(freqStart,freqEnd)))))=>{return new Biquad("bandpass",Biquad.calcCenterFrequency(freqStart,freqEnd),sps,Biquad.calcBandpassQ(Biquad.calcCenterFrequency(freqStart,freqEnd),Biquad.calcBandwidth(freqStart,freqEnd),resonance),0)};if(typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope){self.SERVICE=new WorkerService({routes:[workerCanvasRoutes,unsafeRoutes],includeClassName:false});globalThis.WebSerial=WebSerial;globalThis.decoders=decoders;globalThis.decoder="raw";globalThis.bitflippin=bitflippin;globalThis.WebglLinePlotUtil=f;globalThis.runningAnim=true;globalThis.filtering=true;globalThis.filters={};globalThis.BiquadChannelFilterer=BiquadChannelFilterer}var debugger_worker_default=self;})();
