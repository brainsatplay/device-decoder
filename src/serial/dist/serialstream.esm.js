var F=class{constructor(){this.recursivelyAssign=(e,r)=>{for(let t in r)typeof r[t]=="object"?typeof e[t]=="object"?this.recursivelyAssign(e[t],r[t]):e[t]=this.recursivelyAssign({},r[t]):e[t]=r[t];return e}}static autoscale(e,r=0,t=1,n=!1,i,a,l){if(e?.length===0)return e;let s=a||Math.max(...e),f=i||Math.min(...e),c=1/t,b=1;if(n){let g=Math.max(Math.abs(f),Math.abs(s));return g!==0&&(b=c/g),e.map(u=>(l&&(u<f&&(u=f),u>s&&(u=s)),u*b+(c*(r+1)*2-1-c)))}else return s===f?s!==0?b=c/s:f!==0&&(b=c/Math.abs(f)):b=c/(s-f),e.map(g=>(l&&(g<f&&(g=f),g>s&&(g=s)),2*((g-f)*b-1/(2*t))+(c*(r+1)*2-1-c)))}static genTimestamps(e,r){let t=Date.now(),n=[t-e*1e3/r,t];return F.upsample(n,e)}static absmax(e){return Math.max(Math.abs(Math.min(...e)),Math.max(...e))}static downsample(e,r,t=1){if(e.length>r){let n=new Array(r),i=e.length/r,a=e.length-1,l=0,s=0;for(let f=i;f<e.length;f+=i){let c=Math.round(f);c>a&&(c=a);for(let b=l;b<c;b++)n[s]+=e[b];n[s]/=(c-l)*t,s++,l=c}return n}else return e}static upsample(e,r,t=1){var n=function(g,u,p){return(g+(u-g)*p)*t},i=new Array(r),a=(e.length-1)/(r-1);i[0]=e[0];for(var l=1;l<r-1;l++){var s=l*a,f=Math.floor(s),c=Math.ceil(s),b=s-f;i[l]=n(e[f],e[c],b)}return i[r-1]=e[e.length-1],i}static interpolate(e,r,t=1){return e.length>r?F.downsample(e,r,t):e.length<r?F.upsample(e,r,t):e}static HSLToRGB(e,r,t,n=255){r/=100,t/=100;let i=(1-Math.abs(2*t-1))*r,a=i*(1-Math.abs(e/60%2-1)),l=t-i/2,s=0,f=0,c=0;return 0<=e&&e<60?(s=i,f=a,c=0):60<=e&&e<120?(s=a,f=i,c=0):120<=e&&e<180?(s=0,f=i,c=a):180<=e&&e<240?(s=0,f=a,c=i):240<=e&&e<300?(s=a,f=0,c=i):300<=e&&e<360&&(s=i,f=0,c=a),s=(s+l)*n,f=(f+l)*n,c=(c+l)*n,[s,f,c]}static circularBuffer(e,r){if(r.length<e.length){let t=e.slice(r.length),n=e.length;e.splice(0,n,...t,...r)}else if(r.length>e.length){let t=e.length;e.splice(0,t,r.slice(t-r.length))}else e.splice(0,e.length,...r);return e}static reformatData(e,r){if(Array.isArray(e)){if(Array.isArray(e[0])){let t={};if(e.forEach((n,i)=>{t[i]=n}),e=t,isNaN(e[0][0]))return}else if(r){if(e={[r]:e},isNaN(e[r][0]))return}else if(e={0:e},isNaN(e[0][0]))return}else if(typeof e=="object"){for(let t in e)if(typeof e[t]=="number"?e[t]=[e[t]]:e[t]?.values&&typeof e[t].values=="number"&&(e[t].values=[e[t].values]),isNaN(e[t][0]))return}else if(typeof e=="string"){let t;if(e.includes(`\r
`)){let n=e.split(`\r
`);e={},n.forEach((i,a)=>{i.includes("	")?t=i.split("	"):i.includes(",")?t=i.split(","):i.includes("|")&&(t=i.split("|")),Array.isArray(t)&&t.forEach((l,s)=>{if(l.includes(":")){let[f,c]=l.split(":"),b=parseFloat(c);if(b)e[f]=[b];else return}else{let f=parseFloat(l);if(f)e[s]=[f];else return}})})}else e.includes("	")?t=e.split("	"):e.includes(",")?t=e.split(","):e.includes("|")&&(t=e.split("|"));e={},Array.isArray(t)&&t.forEach((n,i)=>{if(n.includes(":")){let[a,l]=n.split(":"),s=parseFloat(l);if(s)e[a]=[s];else return}else{let a=parseFloat(n);if(a)e[i]=[a];else return}})}else typeof e=="number"&&(r?e={[r]:[e]}:e={0:[e]});return e}static padTime(e,r,t,n){let i=(e[0]-r)/t/n;return[...new Array(n-e.length).map((l,s)=>r+i*(s+1)),...e]}static interpolateForTime(e,r,t){return F.interpolate(e,Math.ceil(t*r))}isTypedArray(e){return ArrayBuffer.isView(e)&&Object.prototype.toString.call(e)!=="[object DataView]"}spliceTypedArray(e,r,t){let n=e.subarray(0,r),i;t&&(i=e.subarray(t+1));let a;return(n.length>0||i?.length>0)&&(a=new e.constructor(n.length+i.length)),n.length>0&&a.set(n),i&&i.length>0&&a.set(i,n.length),a}},x=F;x.bufferValues=(e,r,t,n)=>{if(!Array.isArray(t)&&typeof t=="object"&&(t=Object.keys(t)),!n){let a=Object.keys(e);t?n=new Float32Array(a.length*t.length):typeof e[a[0]][r]=="object"?(t=Object.keys(e[a[0]][r]),n=new Float32Array(a.length*t.length)):n=new Float32Array(a.length)}let i=0;for(let a in e)if(e[a][r])if(t)for(let l=0;l<t.length;l++)n[i]=e[a][r][t[l]],i++;else n[i]=e[a][r],i++;return n};var B=/^([<>])?(([1-9]\d*)?([xcbB?hHiIfdsp]))*$/,D=/([1-9]\d*)?([xcbB?hHiIfdsp])/g,T=(y,e,r)=>String.fromCharCode(...new Uint8Array(y.buffer,y.byteOffset+e,r)),P=(y,e,r,t)=>new Uint8Array(y.buffer,y.byteOffset+e,r).set(t.split("").map(n=>n.charCodeAt(0))),M=(y,e,r)=>T(y,e+1,Math.min(y.getUint8(e),r-1)),V=(y,e,r,t)=>{y.setUint8(e,t.length),P(y,e+1,r-1,t)},O=y=>({x:e=>[1,e,0],c:e=>[e,1,r=>({u:t=>T(t,r,1),p:(t,n)=>P(t,r,1,n)})],"?":e=>[e,1,r=>({u:t=>!!t.getUint8(r),p:(t,n)=>t.setUint8(r,n)})],b:e=>[e,1,r=>({u:t=>t.getInt8(r),p:(t,n)=>t.setInt8(r,n)})],B:e=>[e,1,r=>({u:t=>t.getUint8(r),p:(t,n)=>t.setUint8(r,n)})],h:e=>[e,2,r=>({u:t=>t.getInt16(r,y),p:(t,n)=>t.setInt16(r,n,y)})],H:e=>[e,2,r=>({u:t=>t.getUint16(r,y),p:(t,n)=>t.setUint16(r,n,y)})],i:e=>[e,4,r=>({u:t=>t.getInt32(r,y),p:(t,n)=>t.setInt32(r,n,y)})],I:e=>[e,4,r=>({u:t=>t.getUint32(r,y),p:(t,n)=>t.setUint32(r,n,y)})],f:e=>[e,4,r=>({u:t=>t.getFloat32(r,y),p:(t,n)=>t.setFloat32(r,n,y)})],d:e=>[e,8,r=>({u:t=>t.getFloat64(r,y),p:(t,n)=>t.setFloat64(r,n,y)})],s:e=>[1,e,r=>({u:t=>T(t,r,e),p:(t,n)=>P(t,r,e,n.slice(0,e))})],p:e=>[1,e,r=>({u:t=>M(t,r,e),p:(t,n)=>V(t,r,e,n.slice(0,e-1))})]}),v=new RangeError("Structure larger than remaining buffer"),L=new RangeError("Not enough values for structure"),S=class extends x{static toDataView(e){if(!(e instanceof DataView))if(typeof e=="string"&&parseInt(e)&&(e=parseInt(e)),typeof e=="string"){let r=new TextEncoder,t={};for(let i in S.codes)for(;e.indexOf(i)>-1;){let a=e.indexOf(i);e=e.replace(i,""),t[a]=i}let n=Array.from(r.encode(e));for(let i in t)n.splice(parseInt(i),0,S.codes[t[i]]);e=new DataView(new Uint8Array(n).buffer)}else if(typeof e=="number"){let r=e;e<256?(e=new DataView(new ArrayBuffer(1)),e.setUint8(0,r)):e<65536?(e=new DataView(new ArrayBuffer(2)),e.setInt16(0,r)):(e=new DataView(new ArrayBuffer(4)),e.setUint32(0,r))}else e instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&e instanceof SharedArrayBuffer?e=new DataView(e):Array.isArray(e)?e=new DataView(Uint8Array.from(e).buffer):typeof e=="object"&&(e=new TextEncoder().encode(JSON.stringify(e)));return e}static searchBuffer(e,r,t){for(var n=r,i=e,a=S.boyerMoore(n),l=a.byteLength,s=[],f=a(i);f!==-1&&(s.push(f),!(t&&s.length>=t));f=a(i,f+l));return s}static bytesToInt16(e,r){let t=(255&e)<<8|255&r;return(t&32768)>0?t|=4294901760:t&=65535,t}static bytesToUInt16(e,r){return e*256+r}static Uint16ToBytes(e){return[e&255,e>>8&255]}static bytesToInt24(e,r,t){let n=(255&e)<<16|(255&r)<<8|255&t;return(n&8388608)>0?n|=4278190080:n&=16777215,n}static bytesToUInt24(e,r,t){return e*65536+r*256+t}static Uint24ToBytes(e){return[e&255,e>>8&255,e>>16&255]}static bytesToInt32(e,r,t,n){let i=(255&e)<<24|(255&r)<<16|(255&t)<<8|255&n;return(i&2147483648)>0?i|=0:i&=4294967295,i}static bytesToUInt32(e,r,t,n){return e*16777216+r*65536+t*256+n}static Uint32ToBytes(e){return[e&255,e>>8&255,e>>16&255,e>>24&255]}static get2sCompliment(e,r){return e>4294967296?null:e<<32-r>>32-r}static getSignedInt(...e){let r=0;function t(n){for(var i=0,a=!0;n--;)if(a){let l=e[r++];i+=l&127,l&128&&(i-=128),a=!1}else i*=256,i+=e[r++];return i}return t(e.length)}static asUint8Array(e){if(e instanceof Uint8Array)return e;if(typeof e=="string"){for(var r=new Uint8Array(e.length),t=0;t<e.length;t++){var n=e.charCodeAt(t);if(n>127)throw new TypeError("Only ASCII patterns are supported");r[t]=n}return r}else return new Uint8Array(e)}static boyerMoore(e){var r=S.asUint8Array(e),t=r.length;if(t===0)throw new TypeError("patternBuffer must be at least 1 byte long");for(var n=256,i=new Int32Array(n),a=0;a<n;a++)i[a]=-1;for(var l=0;l<t;l++)i[r[l]]=l;var s=(f,c,b)=>{var g=S.asUint8Array(f);c===void 0&&(c=0),b===void 0&&(b=g.length);for(var u=r,p=i,d=b-u.length,h=u.length-1,m,k=c;k<=d;k+=m){m=0;for(var I=h;I>=0;I--){var U=g[k+I];if(u[I]!==U){m=Math.max(1,I-p[U]);break}}if(m===0)return k}return-1};return s.byteLength=r.byteLength,s}static struct(e){let r=[],t=0,n=B.exec(e);if(!n)throw new RangeError("Invalid format string");let i=O(n[1]==="<"),a=(g,u)=>i[u](g?parseInt(g,10):1);for(;n=D.exec(e);)((g,u,p)=>{for(let d=0;d<g;++d,t+=u)p&&r.push(p(t))})(...a(...n.slice(1)));let l=(g,u)=>{if(g.byteLength<(u|0)+t)throw v;let p=new DataView(g,u|0);return r.map(d=>d.u(p))},s=(g,u,...p)=>{if(p.length<r.length)throw L;if(g.byteLength<u+t)throw v;let d=new DataView(g,u);new Uint8Array(g,u,t).fill(0),r.forEach((h,m)=>h.p(d,p[m]))},f=(...g)=>{let u=new ArrayBuffer(t);return s(u,0,...g),u},c=g=>l(g,0);function*b(g){for(let u=0;u+t<=g.byteLength;u+=t)yield l(g,u)}return Object.freeze({unpack:c,pack:f,unpack_from:l,pack_into:s,iter_unpack:b,format:e,size:t})}},A=S;A.codes={"\\n":10,"\\r":13,"\\t":9,"\\s":32,"\\b":8,"\\f":12,"\\":92};(function(y){var e,r={},t=console,n=Math,i="postMessage",a="HackTimer.js by turuslan: ",l="Initialisation failed",s=0,f="hasOwnProperty",c=[].slice,b=Worker;function g(){do s=2147483647>s?s+1:0;while(r[f](s));return s}if(!/MSIE 10/i.test(navigator.userAgent))try{y=URL.createObjectURL(new Blob(["var f={},p=postMessage,r='hasOwnProperty';onmessage=function(e){var d=e.data,i=d.i,t=d[r]('t')?d.t:0;switch(d.n){case'a':f[i]=setInterval(function(){p(i)},t);break;case'b':if(f[r](i)){clearInterval(f[i]);delete f[i]}break;case'c':f[i]=setTimeout(function(){p(i);if(f[r](i))delete f[i]},t);break;case'd':if(f[r](i)){clearTimeout(f[i]);delete f[i]}break}}"]))}catch{}if(typeof b<"u")try{e=new b(y),setInterval=function(u,p){var d=g();return r[d]={c:u,p:c.call(arguments,2)},e[i]({n:"a",i:d,t:p}),d},clearInterval=function(u){r[f](u)&&(delete r[u],e[i]({n:"b",i:u}))},setTimeout=function(u,p){var d=g();return r[d]={c:u,p:c.call(arguments,2),t:!0},e[i]({n:"c",i:d,t:p}),d},clearTimeout=function(u){r[f](u)&&(delete r[u],e[i]({n:"d",i:u}))},e.onmessage=function(u){var p=u.data,d,h;if(r[f](p)&&(h=r[p],d=h.c,h[f]("t")&&delete r[p]),typeof d=="string")try{d=new Function(d)}catch(m){t.log(a+"Error parsing callback code string: ",m)}typeof d=="function"&&d.apply(o,h.p)},e.onerror=function(u){t.log(u)},t.log(a+"Initialisation succeeded")}catch(u){t.log(a+l),t.error(u)}else t.log(a+l+" - HTML5 Web Worker is not supported")})("HackTimerWorker.min.js");var w=class extends A{constructor(){super(...arguments);this.streams={};this.createStream=r=>{let t={_id:r._id?r._id:`stream${Math.floor(Math.random()*1e15)}`,info:r.port.getInfo(),running:!1,...r};return r.port?.readable&&(r.transforms?t.reader=w.setStreamTransforms(r.port.readable,r.transforms).getReader():t.reader=r.port.readable.getReader()),this.streams[t._id]=t,t}}getPorts(){return navigator.serial.getPorts()}requestPort(r,t){let n={};return r&&(n.usbVendorId=r),t&&(n.usbProductId=t),n.usbVendorId?navigator.serial.requestPort({filters:[n]}):navigator.serial.requestPort()}openPort(r,t){return t&&(t=Object.assign({},t)),t?.ondisconnect&&(r.ondisconnect=t.ondisconnect,delete t.ondisconnect),r.open(t).then(()=>{t?.onconnect&&t.onconnect(r)})}async readWithTimeout(r,t){let n=r.readable.getReader(),i=setTimeout(()=>{n.releaseLock()},t),a=await n.read();return clearTimeout(i),n.releaseLock(),a}async writePort(r,t){let n=r.writable.getWriter();return await n.write(w.toDataView(t)),n.releaseLock(),!0}getSignals(r){return r.getSignals()}setSignals(r,t){return r.setSignals(t)}readStream(r){if(r.reader&&!r.running){let t=r.reader;r.buffering&&(typeof r.buffering!="object"&&(r.buffering={}),r.buffering.buffer||(r.buffering.buffer=[]),r.buffering.searchBytes||(r.buffering.searchBytes=new Uint8Array([13,10])));let n=()=>{if(r.port.readable&&r.running)t.read().then(i=>{if(i.done)t.releaseLock();else{if(r.buffering){r.buffering.buffer.push(...i.value);let l=r.buffering.searchBytes,s=r.buffering.buffer,f=w.boyerMoore(l),c=f.byteLength,b=-1,g=r.buffering.lockIdx??0;for(var a=f(s);a!==-1;a=f(s,a+c))if(!r.buffering.locked&&!("lockIdx"in r.buffering))g=r.buffering.lockIdx=a;else if(b=a,b>=0){let u=b-g;if(r.buffering.locked){if(u>0){let p=r.buffering.buffer.splice(r.buffering.lockIdx,u),d=new Uint8Array(p.slice(r.buffering.searchBytes.length));r.ondata(new Uint8Array(d))}}else{let p=r.buffering.buffer.splice(r.buffering.lockIdx,u),d=new Uint8Array(p.slice(r.buffering.searchBytes.length));r.ondata(d),r.buffering.locked=!0}g=b}}else r.ondata(i.value);setTimeout(()=>{n()},r.frequency)}}).catch(i=>{console.error(r._id," Read error:",i),(i.message.includes("overrun")||i.message.includes("framing"))&&(delete r.reader,this.reconnect(r))});else if(!r.running&&r.port.readable)try{t.releaseLock()}catch(i){console.error(i)}};return r.running=!0,n(),r}}writeStream(r,t){if(typeof r=="string"&&(r=this.streams[r]),r.port.writable){let n=r.port.writable.getWriter();return n.write(w.toDataView(t)),n.releaseLock(),!0}}closeStream(r,t){return typeof r=="string"&&(r=this.streams[r]),r.running=!1,new Promise((n,i)=>{r.settings.beforedisconnect&&r.settings.beforedisconnect(this,r.port),setTimeout(async()=>{if(r.port.readable&&r.reader){try{r.reader.releaseLock()}catch(a){console.error(a)}if(r.transforms)try{await r.reader.cancel()}catch(a){console.error(a)}}try{await r.port.close().then(()=>{t&&t(this.streams[r._id])}),delete this.streams[r._id],n(!0)}catch(a){i(a)}},300)})}reconnect(r,t){return typeof r=="string"&&(r=this.streams[r]),new Promise((n,i)=>{if(typeof r!="object"){i(void 0);return}let a=r.port.getInfo();this.closeStream(r._id).then(l=>{setTimeout(()=>{this.getPorts().then(s=>{for(let f=0;f<s.length;f++)s[f].getInfo().usbVendorId===a.usbVendorId&&s[f].getInfo().usbProductId===a.usbProductId&&(t?t._id=r._id:t=r,delete t.port,this.openPort(s[f],t.settings).then(()=>{let c=this.createStream({...t,port:s[f]});this.readStream(c),n(c)}).catch(i))}).catch(i)},100)})})}static setStreamTransforms(r,t){let n=[];Object.keys(t).forEach(a=>{let l=t[a];if(l instanceof TransformStream)n.push(l);else{l.start||(l.start=function(){}),l.flush||(l.flush=function(){});let s=new TransformStream({start:l.start,transform:l.transform,flush:l.flush},l.writableStrategy,l.readableStrategy);n.push(s)}});let i=r;return n.forEach(a=>{i=i.pipeThrough(a)}),i}};export{w as WebSerial};
