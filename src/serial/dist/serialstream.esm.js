var o=class{constructor(){}getPorts(){return navigator.serial.getPorts()}requestPort(e,r){let t={};return e&&(t.usbVendorId=e),r&&(t.usbProductId=r),t.usbVendorId?navigator.serial.requestPort({filters:[t]}):navigator.serial.requestPort()}openPort(e,r){return r&&(r=Object.assign({},r)),r?.onconnect&&(e.onconnect=r.onconnect,delete r.onconnect),r?.ondisconnect&&(e.ondisconnect=r.ondisconnect,delete r.ondisconnect),e.open(r)}async readWithTimeout(e,r){let t=e.readable.getReader(),a=setTimeout(()=>{t.releaseLock()},r),n=await t.read();return clearTimeout(a),t.releaseLock(),n}async writePort(e,r){let t=e.writable.getWriter();return await t.write(o.toDataView(r)),t.releaseLock(),!0}getSignals(e){return e.getSignals()}setSignals(e,r){return e.setSignals(r)}createStream(e){let r={_id:`stream${Math.floor(Math.random()*1e15)}`,info:e.port.getInfo(),running:!1,...e};return e.port?.readable&&(e.transforms?r.reader=o.setStreamTransforms(e.port.readable,e.transforms).getReader():r.reader=e.port.readable.getReader()),e.port?.writable&&(r.writer=e.port.writable.getWriter()),this.streams[r._id]=r,r}readStream(e){if(e.reader&&!e.running){let r=e.reader,t=()=>{if(e.port.readable&&e.running)r.read().then(a=>{a.done?r.releaseLock():(e.ondata(a.value),setTimeout(()=>{t()},e.frequency))});else if(!e.running&&e.port.readable)try{r.releaseLock()}catch(a){console.error(a)}};return e.running=!0,t(),e}}writeStream(e,r){if(e.writer)return e.writer.write(o.toDataView(r))}endStream(e,r){e.running=!1,setTimeout(async()=>{if(e.port.readable)try{e.reader.releaseLock(),await e.reader.cancel()}catch{}if(e.port.writable)try{e.writer.releaseLock(),await e.writer.close()}catch{}try{await e.port.close().then(()=>{r(this.streams[e._id])})}catch{}},e.frequency),delete this.streams[e._id]}static setStreamTransforms(e,r){let t=[];Object.keys(r).forEach(n=>{let i=r[n];if(i instanceof TransformStream)t.push(i);else{i.start||(i.start=function(){}),i.flush||(i.flush=function(){});let s=new TransformStream({start:i.start,transform:i.transform,flush:i.flush},i.writableStrategy,i.readableStrategy);t.push(s)}});let a=e;return t.forEach(n=>{a=a.pipeThrough(n)}),a}static toDataView(e){if(!(e instanceof DataView))if(typeof e=="string"){let r=new TextEncoder;e=new DataView(r.encode(e))}else if(typeof e=="number"){let r=e;e<256?(e=new DataView(new ArrayBuffer(1)),e.setUint8(0,r)):e<65536?(e=new DataView(new ArrayBuffer(2)),e.setInt16(0,r)):(e=new DataView(new ArrayBuffer(4)),e.setUint32(0,r))}else e instanceof ArrayBuffer||e instanceof SharedArrayBuffer?e=new DataView(e):Array.isArray(e)&&(e=new DataView(Uint8Array.from(e)));return e}static searchBuffer(e,r,t){for(var a=r,n=e,i=o.boyerMoore(a),s=i.byteLength,f=[],u=i(n);u!==-1&&(f.push(u),!(t&&f.length>=t));u=i(n,u+s));return f}static bytesToInt16(e,r){let t=(255&e)<<8|255&r;return(t&32768)>0?t|=4294901760:t&=65535,t}static bytesToUInt16(e,r){return e*256+r}static Uint16ToBytes(e){return[e&255,e>>8&255]}static bytesToInt24(e,r,t){let a=(255&e)<<16|(255&r)<<8|255&t;return(a&8388608)>0?a|=4278190080:a&=16777215,a}static bytesToUInt24(e,r,t){return e*65536+r*256+t}static Uint24ToBytes(e){return[e&255,e>>8&255,e>>16&255]}static bytesToInt32(e,r,t,a){let n=(255&e)<<24|(255&r)<<16|(255&t)<<8|255&a;return(n&2147483648)>0?n|=0:n&=4294967295,n}static bytesToUInt32(e,r,t,a){return e*16777216+r*65536+t*256+a}static Uint32ToBytes(e){return[e&255,e>>8&255,e>>16&255,e>>24&255]}static get2sCompliment(e,r){return e>4294967296?null:e<<32-r>>32-r}static getSignedInt(...e){let r=0;function t(a){for(var n=0,i=!0;a--;)if(i){let s=e[r++];n+=s&127,s&128&&(n-=128),i=!1}else n*=256,n+=e[r++];return n}return t(e.length)}static asUint8Array(e){if(e instanceof Uint8Array)return e;if(typeof e=="string"){for(var r=new Uint8Array(e.length),t=0;t<e.length;t++){var a=e.charCodeAt(t);if(a>127)throw new TypeError("Only ASCII patterns are supported");r[t]=a}return r}else return new Uint8Array(e)}static boyerMoore(e){var r=o.asUint8Array(e),t=r.length;if(t===0)throw new TypeError("patternBuffer must be at least 1 byte long");for(var a=256,n=new Int32Array(a),i=0;i<a;i++)n[i]=-1;for(var s=0;s<t;s++)n[r[s]]=s;var f=(u,m,b)=>{var g=o.asUint8Array(u);m===void 0&&(m=0),b===void 0&&(b=g.length);for(var d=r,F=n,h=b-d.length,S=d.length-1,c,y=m;y<=h;y+=c){c=0;for(var l=S;l>=0;l--){var w=g[y+l];if(d[l]!==w){c=Math.max(1,l-F[w]);break}}if(c===0)return y}return-1};return f.byteLength=r.byteLength,f}};export{o as WebSerial};
