var __create=Object.create;var __defProp=Object.defineProperty;var __getOwnPropDesc=Object.getOwnPropertyDescriptor;var __getOwnPropNames=Object.getOwnPropertyNames;var __getProtoOf=Object.getPrototypeOf;var __hasOwnProp=Object.prototype.hasOwnProperty;var __require=(x=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(x,{get:(a,b)=>(typeof require!=="undefined"?require:a)[b]}):x)(function(x){if(typeof require!=="undefined")return require.apply(this,arguments);throw new Error('Dynamic require of "'+x+'" is not supported')});var __esm=(fn,res)=>function __init(){return fn&&(res=(0,fn[__getOwnPropNames(fn)[0]])(fn=0)),res};var __commonJS=(cb,mod)=>function __require3(){return mod||(0,cb[__getOwnPropNames(cb)[0]])((mod={exports:{}}).exports,mod),mod.exports};var __export=(target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:true})};var __copyProps=(to,from,except,desc)=>{if(from&&typeof from==="object"||typeof from==="function"){for(let key of __getOwnPropNames(from))if(!__hasOwnProp.call(to,key)&&key!==except)__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable})}return to};var __toESM=(mod,isNodeMode,target)=>(target=mod!=null?__create(__getProtoOf(mod)):{},__copyProps(isNodeMode||!mod||!mod.__esModule?__defProp(target,"default",{value:mod,enumerable:true}):target,mod));var createCapacitorPlatforms,initPlatforms,CapacitorPlatforms,addPlatform,setPlatform,ExceptionCode,CapacitorException,getPlatformId,createCapacitor,initCapacitorGlobal,Capacitor,registerPlugin,Plugins,WebPlugin;var init_dist=__esm({"ble/node_modules/@capacitor/core/dist/index.js"(){createCapacitorPlatforms=win=>{const defaultPlatformMap=new Map;defaultPlatformMap.set("web",{name:"web"});const capPlatforms=win.CapacitorPlatforms||{currentPlatform:{name:"web"},platforms:defaultPlatformMap};const addPlatform2=(name,platform)=>{capPlatforms.platforms.set(name,platform)};const setPlatform2=name=>{if(capPlatforms.platforms.has(name)){capPlatforms.currentPlatform=capPlatforms.platforms.get(name)}};capPlatforms.addPlatform=addPlatform2;capPlatforms.setPlatform=setPlatform2;return capPlatforms};initPlatforms=win=>win.CapacitorPlatforms=createCapacitorPlatforms(win);CapacitorPlatforms=initPlatforms(typeof globalThis!=="undefined"?globalThis:typeof self!=="undefined"?self:typeof window!=="undefined"?window:typeof global!=="undefined"?global:{});addPlatform=CapacitorPlatforms.addPlatform;setPlatform=CapacitorPlatforms.setPlatform;(function(ExceptionCode2){ExceptionCode2["Unimplemented"]="UNIMPLEMENTED";ExceptionCode2["Unavailable"]="UNAVAILABLE"})(ExceptionCode||(ExceptionCode={}));CapacitorException=class extends Error{constructor(message,code){super(message);this.message=message;this.code=code}};getPlatformId=win=>{var _a,_b;if(win===null||win===void 0?void 0:win.androidBridge){return"android"}else if((_b=(_a=win===null||win===void 0?void 0:win.webkit)===null||_a===void 0?void 0:_a.messageHandlers)===null||_b===void 0?void 0:_b.bridge){return"ios"}else{return"web"}};createCapacitor=win=>{var _a,_b,_c,_d,_e;const capCustomPlatform=win.CapacitorCustomPlatform||null;const cap=win.Capacitor||{};const Plugins2=cap.Plugins=cap.Plugins||{};const capPlatforms=win.CapacitorPlatforms;const defaultGetPlatform=()=>{return capCustomPlatform!==null?capCustomPlatform.name:getPlatformId(win)};const getPlatform=((_a=capPlatforms===null||capPlatforms===void 0?void 0:capPlatforms.currentPlatform)===null||_a===void 0?void 0:_a.getPlatform)||defaultGetPlatform;const defaultIsNativePlatform=()=>getPlatform()!=="web";const isNativePlatform=((_b=capPlatforms===null||capPlatforms===void 0?void 0:capPlatforms.currentPlatform)===null||_b===void 0?void 0:_b.isNativePlatform)||defaultIsNativePlatform;const defaultIsPluginAvailable=pluginName=>{const plugin=registeredPlugins.get(pluginName);if(plugin===null||plugin===void 0?void 0:plugin.platforms.has(getPlatform())){return true}if(getPluginHeader(pluginName)){return true}return false};const isPluginAvailable=((_c=capPlatforms===null||capPlatforms===void 0?void 0:capPlatforms.currentPlatform)===null||_c===void 0?void 0:_c.isPluginAvailable)||defaultIsPluginAvailable;const defaultGetPluginHeader=pluginName=>{var _a2;return(_a2=cap.PluginHeaders)===null||_a2===void 0?void 0:_a2.find(h=>h.name===pluginName)};const getPluginHeader=((_d=capPlatforms===null||capPlatforms===void 0?void 0:capPlatforms.currentPlatform)===null||_d===void 0?void 0:_d.getPluginHeader)||defaultGetPluginHeader;const handleError=err=>win.console.error(err);const pluginMethodNoop=(_target,prop,pluginName)=>{return Promise.reject(`${pluginName} does not have an implementation of "${prop}".`)};const registeredPlugins=new Map;const defaultRegisterPlugin=(pluginName,jsImplementations={})=>{const registeredPlugin=registeredPlugins.get(pluginName);if(registeredPlugin){console.warn(`Capacitor plugin "${pluginName}" already registered. Cannot register plugins twice.`);return registeredPlugin.proxy}const platform=getPlatform();const pluginHeader=getPluginHeader(pluginName);let jsImplementation;const loadPluginImplementation=async()=>{if(!jsImplementation&&platform in jsImplementations){jsImplementation=typeof jsImplementations[platform]==="function"?jsImplementation=await jsImplementations[platform]():jsImplementation=jsImplementations[platform]}else if(capCustomPlatform!==null&&!jsImplementation&&"web"in jsImplementations){jsImplementation=typeof jsImplementations["web"]==="function"?jsImplementation=await jsImplementations["web"]():jsImplementation=jsImplementations["web"]}return jsImplementation};const createPluginMethod=(impl,prop)=>{var _a2,_b2;if(pluginHeader){const methodHeader=pluginHeader===null||pluginHeader===void 0?void 0:pluginHeader.methods.find(m=>prop===m.name);if(methodHeader){if(methodHeader.rtype==="promise"){return options=>cap.nativePromise(pluginName,prop.toString(),options)}else{return(options,callback)=>cap.nativeCallback(pluginName,prop.toString(),options,callback)}}else if(impl){return(_a2=impl[prop])===null||_a2===void 0?void 0:_a2.bind(impl)}}else if(impl){return(_b2=impl[prop])===null||_b2===void 0?void 0:_b2.bind(impl)}else{throw new CapacitorException(`"${pluginName}" plugin is not implemented on ${platform}`,ExceptionCode.Unimplemented)}};const createPluginMethodWrapper=prop=>{let remove;const wrapper=(...args)=>{const p=loadPluginImplementation().then(impl=>{const fn=createPluginMethod(impl,prop);if(fn){const p2=fn(...args);remove=p2===null||p2===void 0?void 0:p2.remove;return p2}else{throw new CapacitorException(`"${pluginName}.${prop}()" is not implemented on ${platform}`,ExceptionCode.Unimplemented)}});if(prop==="addListener"){p.remove=async()=>remove()}return p};wrapper.toString=()=>`${prop.toString()}() { [capacitor code] }`;Object.defineProperty(wrapper,"name",{value:prop,writable:false,configurable:false});return wrapper};const addListener=createPluginMethodWrapper("addListener");const removeListener=createPluginMethodWrapper("removeListener");const addListenerNative=(eventName,callback)=>{const call=addListener({eventName},callback);const remove=async()=>{const callbackId=await call;removeListener({eventName,callbackId},callback)};const p=new Promise(resolve=>call.then(()=>resolve({remove})));p.remove=async()=>{console.warn(`Using addListener() without 'await' is deprecated.`);await remove()};return p};const proxy=new Proxy({},{get(_,prop){switch(prop){case"$$typeof":return void 0;case"toJSON":return()=>({});case"addListener":return pluginHeader?addListenerNative:addListener;case"removeListener":return removeListener;default:return createPluginMethodWrapper(prop)}}});Plugins2[pluginName]=proxy;registeredPlugins.set(pluginName,{name:pluginName,proxy,platforms:new Set([...Object.keys(jsImplementations),...pluginHeader?[platform]:[]])});return proxy};const registerPlugin2=((_e=capPlatforms===null||capPlatforms===void 0?void 0:capPlatforms.currentPlatform)===null||_e===void 0?void 0:_e.registerPlugin)||defaultRegisterPlugin;if(!cap.convertFileSrc){cap.convertFileSrc=filePath=>filePath}cap.getPlatform=getPlatform;cap.handleError=handleError;cap.isNativePlatform=isNativePlatform;cap.isPluginAvailable=isPluginAvailable;cap.pluginMethodNoop=pluginMethodNoop;cap.registerPlugin=registerPlugin2;cap.Exception=CapacitorException;cap.DEBUG=!!cap.DEBUG;cap.isLoggingEnabled=!!cap.isLoggingEnabled;cap.platform=cap.getPlatform();cap.isNative=cap.isNativePlatform();return cap};initCapacitorGlobal=win=>win.Capacitor=createCapacitor(win);Capacitor=initCapacitorGlobal(typeof globalThis!=="undefined"?globalThis:typeof self!=="undefined"?self:typeof window!=="undefined"?window:typeof global!=="undefined"?global:{});registerPlugin=Capacitor.registerPlugin;Plugins=Capacitor.Plugins;WebPlugin=class{constructor(config){this.listeners={};this.windowListeners={};if(config){console.warn(`Capacitor WebPlugin "${config.name}" config object was deprecated in v3 and will be removed in v4.`);this.config=config}}addListener(eventName,listenerFunc){const listeners=this.listeners[eventName];if(!listeners){this.listeners[eventName]=[]}this.listeners[eventName].push(listenerFunc);const windowListener=this.windowListeners[eventName];if(windowListener&&!windowListener.registered){this.addWindowListener(windowListener)}const remove=async()=>this.removeListener(eventName,listenerFunc);const p=Promise.resolve({remove});Object.defineProperty(p,"remove",{value:async()=>{console.warn(`Using addListener() without 'await' is deprecated.`);await remove()}});return p}async removeAllListeners(){this.listeners={};for(const listener in this.windowListeners){this.removeWindowListener(this.windowListeners[listener])}this.windowListeners={}}notifyListeners(eventName,data){const listeners=this.listeners[eventName];if(listeners){listeners.forEach(listener=>listener(data))}}hasListeners(eventName){return!!this.listeners[eventName].length}registerWindowListener(windowEventName,pluginEventName){this.windowListeners[pluginEventName]={registered:false,windowEventName,pluginEventName,handler:event=>{this.notifyListeners(pluginEventName,event)}}}unimplemented(msg="not implemented"){return new Capacitor.Exception(msg,ExceptionCode.Unimplemented)}unavailable(msg="not available"){return new Capacitor.Exception(msg,ExceptionCode.Unavailable)}async removeListener(eventName,listenerFunc){const listeners=this.listeners[eventName];if(!listeners){return}const index=listeners.indexOf(listenerFunc);this.listeners[eventName].splice(index,1);if(!this.listeners[eventName].length){this.removeWindowListener(this.windowListeners[eventName])}}addWindowListener(handle){window.addEventListener(handle.windowEventName,handle.handler);handle.registered=true}removeWindowListener(handle){if(!handle){return}window.removeEventListener(handle.windowEventName,handle.handler);handle.registered=false}}}});function numbersToDataView(value){return new DataView(Uint8Array.from(value).buffer)}function dataViewToNumbers(value){return Array.from(new Uint8Array(value.buffer))}function numberToUUID(value){return`0000${value.toString(16).padStart(4,"0")}-0000-1000-8000-00805f9b34fb`}function hexStringToDataView(value){const numbers=value.trim().split(" ").filter(e=>e!=="").map(s=>parseInt(s,16));return numbersToDataView(numbers)}function dataViewToHexString(value){return dataViewToNumbers(value).map(n=>{let s=n.toString(16);if(s.length==1){s="0"+s}return s}).join(" ")}function webUUIDToString(uuid){if(typeof uuid==="string"){return uuid}else if(typeof uuid==="number"){return numberToUUID(uuid)}else{throw new Error("Invalid UUID")}}function mapToObject(map){const obj={};if(!map){return void 0}map.forEach((value,key)=>{obj[key.toString()]=value});return obj}var init_conversion=__esm({"ble/node_modules/@capacitor-community/bluetooth-le/dist/esm/conversion.js"(){}});async function runWithTimeout(promise,time,exception){let timer;return Promise.race([promise,new Promise((_,reject)=>{timer=setTimeout(()=>reject(exception),time)})]).finally(()=>clearTimeout(timer))}var init_timeout=__esm({"ble/node_modules/@capacitor-community/bluetooth-le/dist/esm/timeout.js"(){}});var web_exports={};__export(web_exports,{BluetoothLeWeb:()=>BluetoothLeWeb});var BluetoothLeWeb;var init_web=__esm({"ble/node_modules/@capacitor-community/bluetooth-le/dist/esm/web.js"(){init_dist();init_conversion();init_timeout();BluetoothLeWeb=class extends WebPlugin{constructor(){super(...arguments);this.deviceMap=new Map;this.discoveredDevices=new Map;this.scan=null;this.DEFAULT_CONNECTION_TIMEOUT=1e4;this.onAdvertisementReceivedCallback=this.onAdvertisementReceived.bind(this);this.onDisconnectedCallback=this.onDisconnected.bind(this);this.onCharacteristicValueChangedCallback=this.onCharacteristicValueChanged.bind(this)}async initialize(){if(typeof navigator==="undefined"||!navigator.bluetooth){throw this.unavailable("Web Bluetooth API not available in this browser.")}const isAvailable=await navigator.bluetooth.getAvailability();if(!isAvailable){throw this.unavailable("No Bluetooth radio available.")}}async isEnabled(){return{value:true}}async enable(){throw this.unavailable("enable is not available on web.")}async disable(){throw this.unavailable("disable is not available on web.")}async startEnabledNotifications(){}async stopEnabledNotifications(){}async isLocationEnabled(){throw this.unavailable("isLocationEnabled is not available on web.")}async openLocationSettings(){throw this.unavailable("openLocationSettings is not available on web.")}async openBluetoothSettings(){throw this.unavailable("openBluetoothSettings is not available on web.")}async openAppSettings(){throw this.unavailable("openAppSettings is not available on web.")}async setDisplayStrings(){}async requestDevice(options){const filters=this.getFilters(options);const device=await navigator.bluetooth.requestDevice({filters:filters.length?filters:void 0,optionalServices:options===null||options===void 0?void 0:options.optionalServices,acceptAllDevices:filters.length===0});this.deviceMap.set(device.id,device);const bleDevice=this.getBleDevice(device);return bleDevice}async requestLEScan(options){this.requestBleDeviceOptions=options;const filters=this.getFilters(options);await this.stopLEScan();this.discoveredDevices=new Map;navigator.bluetooth.removeEventListener("advertisementreceived",this.onAdvertisementReceivedCallback);navigator.bluetooth.addEventListener("advertisementreceived",this.onAdvertisementReceivedCallback);this.scan=await navigator.bluetooth.requestLEScan({filters:filters.length?filters:void 0,acceptAllAdvertisements:filters.length===0,keepRepeatedDevices:options===null||options===void 0?void 0:options.allowDuplicates})}onAdvertisementReceived(event){var _a,_b;const deviceId=event.device.id;this.deviceMap.set(deviceId,event.device);const isNew=!this.discoveredDevices.has(deviceId);if(isNew||((_a=this.requestBleDeviceOptions)===null||_a===void 0?void 0:_a.allowDuplicates)){this.discoveredDevices.set(deviceId,true);const device=this.getBleDevice(event.device);const result={device,localName:device.name,rssi:event.rssi,txPower:event.txPower,manufacturerData:mapToObject(event.manufacturerData),serviceData:mapToObject(event.serviceData),uuids:(_b=event.uuids)===null||_b===void 0?void 0:_b.map(webUUIDToString)};this.notifyListeners("onScanResult",result)}}async stopLEScan(){var _a;if((_a=this.scan)===null||_a===void 0?void 0:_a.active){this.scan.stop()}this.scan=null}async getDevices(_options){const devices=await navigator.bluetooth.getDevices();const bleDevices=devices.map(device=>{this.deviceMap.set(device.id,device);const bleDevice=this.getBleDevice(device);return bleDevice});return{devices:bleDevices}}async getConnectedDevices(_options){const devices=await navigator.bluetooth.getDevices();const bleDevices=devices.filter(device=>{var _a;return(_a=device.gatt)===null||_a===void 0?void 0:_a.connected}).map(device=>{this.deviceMap.set(device.id,device);const bleDevice=this.getBleDevice(device);return bleDevice});return{devices:bleDevices}}async connect(options){var _a,_b;const device=this.getDeviceFromMap(options.deviceId);device.removeEventListener("gattserverdisconnected",this.onDisconnectedCallback);device.addEventListener("gattserverdisconnected",this.onDisconnectedCallback);const timeoutError=Symbol();if(device.gatt===void 0){throw new Error("No gatt server available.")}try{const timeout=(_a=options.timeout)!==null&&_a!==void 0?_a:this.DEFAULT_CONNECTION_TIMEOUT;await runWithTimeout(device.gatt.connect(),timeout,timeoutError)}catch(error){await((_b=device.gatt)===null||_b===void 0?void 0:_b.disconnect());if(error===timeoutError){throw new Error("Connection timeout")}else{throw error}}}onDisconnected(event){const deviceId=event.target.id;const key=`disconnected|${deviceId}`;this.notifyListeners(key,null)}async createBond(_options){throw this.unavailable("createBond is not available on web.")}async isBonded(_options){throw this.unavailable("isBonded is not available on web.")}async disconnect(options){var _a;(_a=this.getDeviceFromMap(options.deviceId).gatt)===null||_a===void 0?void 0:_a.disconnect()}async getServices(options){var _a,_b;const services=(_b=await((_a=this.getDeviceFromMap(options.deviceId).gatt)===null||_a===void 0?void 0:_a.getPrimaryServices()))!==null&&_b!==void 0?_b:[];const bleServices=[];for(const service of services){const characteristics=await service.getCharacteristics();const bleCharacteristics=[];for(const characteristic of characteristics){bleCharacteristics.push({uuid:characteristic.uuid,properties:this.getProperties(characteristic),descriptors:await this.getDescriptors(characteristic)})}bleServices.push({uuid:service.uuid,characteristics:bleCharacteristics})}return{services:bleServices}}async getDescriptors(characteristic){try{const descriptors=await characteristic.getDescriptors();return descriptors.map(descriptor=>({uuid:descriptor.uuid}))}catch(_a){return[]}}getProperties(characteristic){return{broadcast:characteristic.properties.broadcast,read:characteristic.properties.read,writeWithoutResponse:characteristic.properties.writeWithoutResponse,write:characteristic.properties.write,notify:characteristic.properties.notify,indicate:characteristic.properties.indicate,authenticatedSignedWrites:characteristic.properties.authenticatedSignedWrites,reliableWrite:characteristic.properties.reliableWrite,writableAuxiliaries:characteristic.properties.writableAuxiliaries}}async getCharacteristic(options){var _a;const service=await((_a=this.getDeviceFromMap(options.deviceId).gatt)===null||_a===void 0?void 0:_a.getPrimaryService(options===null||options===void 0?void 0:options.service));return service===null||service===void 0?void 0:service.getCharacteristic(options===null||options===void 0?void 0:options.characteristic)}async getDescriptor(options){const characteristic=await this.getCharacteristic(options);return characteristic===null||characteristic===void 0?void 0:characteristic.getDescriptor(options===null||options===void 0?void 0:options.descriptor)}async readRssi(_options){throw this.unavailable("readRssi is not available on web.")}async read(options){const characteristic=await this.getCharacteristic(options);const value=await(characteristic===null||characteristic===void 0?void 0:characteristic.readValue());return{value}}async write(options){const characteristic=await this.getCharacteristic(options);let dataView;if(typeof options.value==="string"){dataView=hexStringToDataView(options.value)}else{dataView=options.value}await(characteristic===null||characteristic===void 0?void 0:characteristic.writeValueWithResponse(dataView))}async writeWithoutResponse(options){const characteristic=await this.getCharacteristic(options);let dataView;if(typeof options.value==="string"){dataView=hexStringToDataView(options.value)}else{dataView=options.value}await(characteristic===null||characteristic===void 0?void 0:characteristic.writeValueWithoutResponse(dataView))}async readDescriptor(options){const descriptor=await this.getDescriptor(options);const value=await(descriptor===null||descriptor===void 0?void 0:descriptor.readValue());return{value}}async writeDescriptor(options){const descriptor=await this.getDescriptor(options);let dataView;if(typeof options.value==="string"){dataView=hexStringToDataView(options.value)}else{dataView=options.value}await(descriptor===null||descriptor===void 0?void 0:descriptor.writeValue(dataView))}async startNotifications(options){const characteristic=await this.getCharacteristic(options);characteristic===null||characteristic===void 0?void 0:characteristic.removeEventListener("characteristicvaluechanged",this.onCharacteristicValueChangedCallback);characteristic===null||characteristic===void 0?void 0:characteristic.addEventListener("characteristicvaluechanged",this.onCharacteristicValueChangedCallback);await(characteristic===null||characteristic===void 0?void 0:characteristic.startNotifications())}onCharacteristicValueChanged(event){var _a,_b;const characteristic=event.target;const key=`notification|${(_a=characteristic.service)===null||_a===void 0?void 0:_a.device.id}|${(_b=characteristic.service)===null||_b===void 0?void 0:_b.uuid}|${characteristic.uuid}`;this.notifyListeners(key,{value:characteristic.value})}async stopNotifications(options){const characteristic=await this.getCharacteristic(options);await(characteristic===null||characteristic===void 0?void 0:characteristic.stopNotifications())}getFilters(options){var _a;const filters=[];for(const service of(_a=options===null||options===void 0?void 0:options.services)!==null&&_a!==void 0?_a:[]){filters.push({services:[service],name:options===null||options===void 0?void 0:options.name,namePrefix:options===null||options===void 0?void 0:options.namePrefix})}if(((options===null||options===void 0?void 0:options.name)||(options===null||options===void 0?void 0:options.namePrefix))&&filters.length===0){filters.push({name:options.name,namePrefix:options.namePrefix})}return filters}getDeviceFromMap(deviceId){const device=this.deviceMap.get(deviceId);if(device===void 0){throw new Error('Device not found. Call "requestDevice", "requestLEScan" or "getDevices" first.')}return device}getBleDevice(device){var _a;const bleDevice={deviceId:device.id,name:(_a=device.name)!==null&&_a!==void 0?_a:void 0,uuids:device.uuids};return bleDevice}}}});var require_throat=__commonJS({"ble/node_modules/throat/index.js"(exports,module){"use strict";function throatInternal(size){var queue=new Queue;var s=size|0;function run(fn,self2,args){if((s|0)!==0){s=(s|0)-1;return new Promise(function(resolve){resolve(fn.apply(self2,args))}).then(onFulfill,onReject)}return new Promise(function(resolve){queue.push(new Delayed(resolve,fn,self2,args))}).then(runDelayed)}function runDelayed(d){try{return Promise.resolve(d.fn.apply(d.self,d.args)).then(onFulfill,onReject)}catch(ex){onReject(ex)}}function onFulfill(result){release();return result}function onReject(error){release();throw error}function release(){var next=queue.shift();if(next){next.resolve(next)}else{s=(s|0)+1}}return run}function earlyBound(size,fn){const run=throatInternal(size|0);return function(){var args=new Array(arguments.length);for(var i=0;i<arguments.length;i++){args[i]=arguments[i]}return run(fn,this,args)}}function lateBound(size){const run=throatInternal(size|0);return function(fn){if(typeof fn!=="function"){throw new TypeError("Expected throat fn to be a function but got "+typeof fn)}var args=new Array(arguments.length-1);for(var i=1;i<arguments.length;i++){args[i-1]=arguments[i]}return run(fn,this,args)}}module.exports=function throat2(size,fn){if(typeof size==="function"){var temp=fn;fn=size;size=temp}if(typeof size!=="number"){throw new TypeError("Expected throat size to be a number but got "+typeof size)}if(fn!==void 0&&typeof fn!=="function"){throw new TypeError("Expected throat fn to be a function but got "+typeof fn)}if(typeof fn==="function"){return earlyBound(size|0,fn)}else{return lateBound(size|0)}};module.exports.default=module.exports;function Delayed(resolve,fn,self2,args){this.resolve=resolve;this.fn=fn;this.self=self2||null;this.args=args}var blockSize=64;function Queue(){this._s1=[];this._s2=[];this._shiftBlock=this._pushBlock=new Array(blockSize);this._pushIndex=0;this._shiftIndex=0}Queue.prototype.push=function(value){if(this._pushIndex===blockSize){this._pushIndex=0;this._s1[this._s1.length]=this._pushBlock=new Array(blockSize)}this._pushBlock[this._pushIndex++]=value};Queue.prototype.shift=function(){if(this._shiftIndex===blockSize){this._shiftIndex=0;var s2=this._s2;if(s2.length===0){var s1=this._s1;if(s1.length===0){return void 0}this._s1=s2;s2=this._s2=s1.reverse()}this._shiftBlock=s2.pop()}if(this._pushBlock===this._shiftBlock&&this._pushIndex===this._shiftIndex){return void 0}var result=this._shiftBlock[this._shiftIndex];this._shiftBlock[this._shiftIndex++]=null;return result}}});var __create2=Object.create;var __defProp2=Object.defineProperty;var __getOwnPropDesc2=Object.getOwnPropertyDescriptor;var __getOwnPropNames2=Object.getOwnPropertyNames;var __getProtoOf2=Object.getPrototypeOf;var __hasOwnProp2=Object.prototype.hasOwnProperty;var __require2=(x=>typeof __require!=="undefined"?__require:typeof Proxy!=="undefined"?new Proxy(x,{get:(a,b)=>(typeof __require!=="undefined"?__require:a)[b]}):x)(function(x){if(typeof __require!=="undefined")return __require.apply(this,arguments);throw new Error('Dynamic require of "'+x+'" is not supported')});var __commonJS2=(cb,mod)=>function __require22(){return mod||(0,cb[__getOwnPropNames2(cb)[0]])((mod={exports:{}}).exports,mod),mod.exports};var __copyProps2=(to,from,except,desc)=>{if(from&&typeof from==="object"||typeof from==="function"){for(let key of __getOwnPropNames2(from))if(!__hasOwnProp2.call(to,key)&&key!==except)__defProp2(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc2(from,key))||desc.enumerable})}return to};var __toESM2=(mod,isNodeMode,target)=>(target=mod!=null?__create2(__getProtoOf2(mod)):{},__copyProps2(isNodeMode||!mod||!mod.__esModule?__defProp2(target,"default",{value:mod,enumerable:true}):target,mod));var require_sjcl=__commonJS2({"services/e2ee/sjcl.js"(exports,module){"use strict";var sjcl2={cipher:{},hash:{},keyexchange:{},mode:{},misc:{},codec:{},exception:{corrupt:function(a){this.toString=function(){return"CORRUPT: "+this.message};this.message=a},invalid:function(a){this.toString=function(){return"INVALID: "+this.message};this.message=a},bug:function(a){this.toString=function(){return"BUG: "+this.message};this.message=a},notReady:function(a){this.toString=function(){return"NOT READY: "+this.message};this.message=a}}};sjcl2.cipher.aes=function(a){this.s[0][0][0]||this.O();var b,c,d,e,f=this.s[0][4],g=this.s[1];b=a.length;var h=1;if(4!==b&&6!==b&&8!==b)throw new sjcl2.exception.invalid("invalid aes key size");this.b=[d=a.slice(0),e=[]];for(a=b;a<4*b+28;a++){c=d[a-1];if(0===a%b||8===b&&4===a%b)c=f[c>>>24]<<24^f[c>>16&255]<<16^f[c>>8&255]<<8^f[c&255],0===a%b&&(c=c<<8^c>>>24^h<<24,h=h<<1^283*(h>>7));d[a]=d[a-b]^c}for(b=0;a;b++,a--)c=d[b&3?a:a-4],e[b]=4>=a||4>b?c:g[0][f[c>>>24]]^g[1][f[c>>16&255]]^g[2][f[c>>8&255]]^g[3][f[c&255]]};sjcl2.cipher.aes.prototype={encrypt:function(a){return t(this,a,0)},decrypt:function(a){return t(this,a,1)},s:[[[],[],[],[],[]],[[],[],[],[],[]]],O:function(){var a=this.s[0],b=this.s[1],c=a[4],d=b[4],e,f,g,h=[],k=[],l,n,m,p;for(e=0;256>e;e++)k[(h[e]=e<<1^283*(e>>7))^e]=e;for(f=g=0;!c[f];f^=l||1,g=k[g]||1)for(m=g^g<<1^g<<2^g<<3^g<<4,m=m>>8^m&255^99,c[f]=m,d[m]=f,n=h[e=h[l=h[f]]],p=16843009*n^65537*e^257*l^16843008*f,n=257*h[m]^16843008*m,e=0;4>e;e++)a[e][f]=n=n<<24^n>>>8,b[e][m]=p=p<<24^p>>>8;for(e=0;5>e;e++)a[e]=a[e].slice(0),b[e]=b[e].slice(0)}};function t(a,b,c){if(4!==b.length)throw new sjcl2.exception.invalid("invalid aes block size");var d=a.b[c],e=b[0]^d[0],f=b[c?3:1]^d[1],g=b[2]^d[2];b=b[c?1:3]^d[3];var h,k,l,n=d.length/4-2,m,p=4,r=[0,0,0,0];h=a.s[c];a=h[0];var q=h[1],v=h[2],w=h[3],x=h[4];for(m=0;m<n;m++)h=a[e>>>24]^q[f>>16&255]^v[g>>8&255]^w[b&255]^d[p],k=a[f>>>24]^q[g>>16&255]^v[b>>8&255]^w[e&255]^d[p+1],l=a[g>>>24]^q[b>>16&255]^v[e>>8&255]^w[f&255]^d[p+2],b=a[b>>>24]^q[e>>16&255]^v[f>>8&255]^w[g&255]^d[p+3],p+=4,e=h,f=k,g=l;for(m=0;4>m;m++)r[c?3&-m:m]=x[e>>>24]<<24^x[f>>16&255]<<16^x[g>>8&255]<<8^x[b&255]^d[p++],h=e,e=f,f=g,g=b,b=h;return r}sjcl2.bitArray={bitSlice:function(a,b,c){a=sjcl2.bitArray.$(a.slice(b/32),32-(b&31)).slice(1);return void 0===c?a:sjcl2.bitArray.clamp(a,c-b)},extract:function(a,b,c){var d=Math.floor(-b-c&31);return((b+c-1^b)&-32?a[b/32|0]<<32-d^a[b/32+1|0]>>>d:a[b/32|0]>>>d)&(1<<c)-1},concat:function(a,b){if(0===a.length||0===b.length)return a.concat(b);var c=a[a.length-1],d=sjcl2.bitArray.getPartial(c);return 32===d?a.concat(b):sjcl2.bitArray.$(b,d,c|0,a.slice(0,a.length-1))},bitLength:function(a){var b=a.length;return 0===b?0:32*(b-1)+sjcl2.bitArray.getPartial(a[b-1])},clamp:function(a,b){if(32*a.length<b)return a;a=a.slice(0,Math.ceil(b/32));var c=a.length;b=b&31;0<c&&b&&(a[c-1]=sjcl2.bitArray.partial(b,a[c-1]&2147483648>>b-1,1));return a},partial:function(a,b,c){return 32===a?b:(c?b|0:b<<32-a)+1099511627776*a},getPartial:function(a){return Math.round(a/1099511627776)||32},equal:function(a,b){if(sjcl2.bitArray.bitLength(a)!==sjcl2.bitArray.bitLength(b))return false;var c=0,d;for(d=0;d<a.length;d++)c|=a[d]^b[d];return 0===c},$:function(a,b,c,d){var e;e=0;for(void 0===d&&(d=[]);32<=b;b-=32)d.push(c),c=0;if(0===b)return d.concat(a);for(e=0;e<a.length;e++)d.push(c|a[e]>>>b),c=a[e]<<32-b;e=a.length?a[a.length-1]:0;a=sjcl2.bitArray.getPartial(e);d.push(sjcl2.bitArray.partial(b+a&31,32<b+a?c:d.pop(),1));return d},i:function(a,b){return[a[0]^b[0],a[1]^b[1],a[2]^b[2],a[3]^b[3]]},byteswapM:function(a){var b,c;for(b=0;b<a.length;++b)c=a[b],a[b]=c>>>24|c>>>8&65280|(c&65280)<<8|c<<24;return a}};sjcl2.codec.utf8String={fromBits:function(a){var b="",c=sjcl2.bitArray.bitLength(a),d,e;for(d=0;d<c/8;d++)0===(d&3)&&(e=a[d/4]),b+=String.fromCharCode(e>>>8>>>8>>>8),e<<=8;return decodeURIComponent(escape(b))},toBits:function(a){a=unescape(encodeURIComponent(a));var b=[],c,d=0;for(c=0;c<a.length;c++)d=d<<8|a.charCodeAt(c),3===(c&3)&&(b.push(d),d=0);c&3&&b.push(sjcl2.bitArray.partial(8*(c&3),d));return b}};sjcl2.codec.hex={fromBits:function(a){var b="",c;for(c=0;c<a.length;c++)b+=((a[c]|0)+0xf00000000000).toString(16).substr(4);return b.substr(0,sjcl2.bitArray.bitLength(a)/4)},toBits:function(a){var b,c=[],d;a=a.replace(/\s|0x/g,"");d=a.length;a=a+"00000000";for(b=0;b<a.length;b+=8)c.push(parseInt(a.substr(b,8),16)^0);return sjcl2.bitArray.clamp(c,4*d)}};sjcl2.codec.base32={B:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",X:"0123456789ABCDEFGHIJKLMNOPQRSTUV",BITS:32,BASE:5,REMAINING:27,fromBits:function(a,b,c){var d=sjcl2.codec.base32.BASE,e=sjcl2.codec.base32.REMAINING,f="",g=0,h=sjcl2.codec.base32.B,k=0,l=sjcl2.bitArray.bitLength(a);c&&(h=sjcl2.codec.base32.X);for(c=0;f.length*d<l;)f+=h.charAt((k^a[c]>>>g)>>>e),g<d?(k=a[c]<<d-g,g+=e,c++):(k<<=d,g-=d);for(;f.length&7&&!b;)f+="=";return f},toBits:function(a,b){a=a.replace(/\s|=/g,"").toUpperCase();var c=sjcl2.codec.base32.BITS,d=sjcl2.codec.base32.BASE,e=sjcl2.codec.base32.REMAINING,f=[],g,h=0,k=sjcl2.codec.base32.B,l=0,n,m="base32";b&&(k=sjcl2.codec.base32.X,m="base32hex");for(g=0;g<a.length;g++){n=k.indexOf(a.charAt(g));if(0>n){if(!b)try{return sjcl2.codec.base32hex.toBits(a)}catch(p){}throw new sjcl2.exception.invalid("this isn't "+m+"!")}h>e?(h-=e,f.push(l^n>>>h),l=n<<c-h):(h+=d,l^=n<<c-h)}h&56&&f.push(sjcl2.bitArray.partial(h&56,l,1));return f}};sjcl2.codec.base32hex={fromBits:function(a,b){return sjcl2.codec.base32.fromBits(a,b,1)},toBits:function(a){return sjcl2.codec.base32.toBits(a,1)}};sjcl2.codec.base64={B:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",fromBits:function(a,b,c){var d="",e=0,f=sjcl2.codec.base64.B,g=0,h=sjcl2.bitArray.bitLength(a);c&&(f=f.substr(0,62)+"-_");for(c=0;6*d.length<h;)d+=f.charAt((g^a[c]>>>e)>>>26),6>e?(g=a[c]<<6-e,e+=26,c++):(g<<=6,e-=6);for(;d.length&3&&!b;)d+="=";return d},toBits:function(a,b){a=a.replace(/\s|=/g,"");var c=[],d,e=0,f=sjcl2.codec.base64.B,g=0,h;b&&(f=f.substr(0,62)+"-_");for(d=0;d<a.length;d++){h=f.indexOf(a.charAt(d));if(0>h)throw new sjcl2.exception.invalid("this isn't base64!");26<e?(e-=26,c.push(g^h>>>e),g=h<<32-e):(e+=6,g^=h<<32-e)}e&56&&c.push(sjcl2.bitArray.partial(e&56,g,1));return c}};sjcl2.codec.base64url={fromBits:function(a){return sjcl2.codec.base64.fromBits(a,1,1)},toBits:function(a){return sjcl2.codec.base64.toBits(a,1)}};sjcl2.hash.sha256=function(a){this.b[0]||this.O();a?(this.F=a.F.slice(0),this.A=a.A.slice(0),this.l=a.l):this.reset()};sjcl2.hash.sha256.hash=function(a){return new sjcl2.hash.sha256().update(a).finalize()};sjcl2.hash.sha256.prototype={blockSize:512,reset:function(){this.F=this.Y.slice(0);this.A=[];this.l=0;return this},update:function(a){"string"===typeof a&&(a=sjcl2.codec.utf8String.toBits(a));var b,c=this.A=sjcl2.bitArray.concat(this.A,a);b=this.l;a=this.l=b+sjcl2.bitArray.bitLength(a);if(9007199254740991<a)throw new sjcl2.exception.invalid("Cannot hash more than 2^53 - 1 bits");if("undefined"!==typeof Uint32Array){var d=new Uint32Array(c),e=0;for(b=512+b-(512+b&511);b<=a;b+=512)u(this,d.subarray(16*e,16*(e+1))),e+=1;c.splice(0,16*e)}else for(b=512+b-(512+b&511);b<=a;b+=512)u(this,c.splice(0,16));return this},finalize:function(){var a,b=this.A,c=this.F,b=sjcl2.bitArray.concat(b,[sjcl2.bitArray.partial(1,1)]);for(a=b.length+2;a&15;a++)b.push(0);b.push(Math.floor(this.l/4294967296));for(b.push(this.l|0);b.length;)u(this,b.splice(0,16));this.reset();return c},Y:[],b:[],O:function(){function a(a2){return 4294967296*(a2-Math.floor(a2))|0}for(var b=0,c=2,d,e;64>b;c++){e=true;for(d=2;d*d<=c;d++)if(0===c%d){e=false;break}e&&(8>b&&(this.Y[b]=a(Math.pow(c,.5))),this.b[b]=a(Math.pow(c,1/3)),b++)}}};function u(a,b){var c,d,e,f=a.F,g=a.b,h=f[0],k=f[1],l=f[2],n=f[3],m=f[4],p=f[5],r=f[6],q=f[7];for(c=0;64>c;c++)16>c?d=b[c]:(d=b[c+1&15],e=b[c+14&15],d=b[c&15]=(d>>>7^d>>>18^d>>>3^d<<25^d<<14)+(e>>>17^e>>>19^e>>>10^e<<15^e<<13)+b[c&15]+b[c+9&15]|0),d=d+q+(m>>>6^m>>>11^m>>>25^m<<26^m<<21^m<<7)+(r^m&(p^r))+g[c],q=r,r=p,p=m,m=n+d|0,n=l,l=k,k=h,h=d+(k&l^n&(k^l))+(k>>>2^k>>>13^k>>>22^k<<30^k<<19^k<<10)|0;f[0]=f[0]+h|0;f[1]=f[1]+k|0;f[2]=f[2]+l|0;f[3]=f[3]+n|0;f[4]=f[4]+m|0;f[5]=f[5]+p|0;f[6]=f[6]+r|0;f[7]=f[7]+q|0}sjcl2.mode.ccm={name:"ccm",G:[],listenProgress:function(a){sjcl2.mode.ccm.G.push(a)},unListenProgress:function(a){a=sjcl2.mode.ccm.G.indexOf(a);-1<a&&sjcl2.mode.ccm.G.splice(a,1)},fa:function(a){var b=sjcl2.mode.ccm.G.slice(),c;for(c=0;c<b.length;c+=1)b[c](a)},encrypt:function(a,b,c,d,e){var f,g=b.slice(0),h=sjcl2.bitArray,k=h.bitLength(c)/8,l=h.bitLength(g)/8;e=e||64;d=d||[];if(7>k)throw new sjcl2.exception.invalid("ccm: iv must be at least 7 bytes");for(f=2;4>f&&l>>>8*f;f++);f<15-k&&(f=15-k);c=h.clamp(c,8*(15-f));b=sjcl2.mode.ccm.V(a,b,c,d,e,f);g=sjcl2.mode.ccm.C(a,g,c,b,e,f);return h.concat(g.data,g.tag)},decrypt:function(a,b,c,d,e){e=e||64;d=d||[];var f=sjcl2.bitArray,g=f.bitLength(c)/8,h=f.bitLength(b),k=f.clamp(b,h-e),l=f.bitSlice(b,h-e),h=(h-e)/8;if(7>g)throw new sjcl2.exception.invalid("ccm: iv must be at least 7 bytes");for(b=2;4>b&&h>>>8*b;b++);b<15-g&&(b=15-g);c=f.clamp(c,8*(15-b));k=sjcl2.mode.ccm.C(a,k,c,l,e,b);a=sjcl2.mode.ccm.V(a,k.data,c,d,e,b);if(!f.equal(k.tag,a))throw new sjcl2.exception.corrupt("ccm: tag doesn't match");return k.data},na:function(a,b,c,d,e,f){var g=[],h=sjcl2.bitArray,k=h.i;d=[h.partial(8,(b.length?64:0)|d-2<<2|f-1)];d=h.concat(d,c);d[3]|=e;d=a.encrypt(d);if(b.length)for(c=h.bitLength(b)/8,65279>=c?g=[h.partial(16,c)]:4294967295>=c&&(g=h.concat([h.partial(16,65534)],[c])),g=h.concat(g,b),b=0;b<g.length;b+=4)d=a.encrypt(k(d,g.slice(b,b+4).concat([0,0,0])));return d},V:function(a,b,c,d,e,f){var g=sjcl2.bitArray,h=g.i;e/=8;if(e%2||4>e||16<e)throw new sjcl2.exception.invalid("ccm: invalid tag length");if(4294967295<d.length||4294967295<b.length)throw new sjcl2.exception.bug("ccm: can't deal with 4GiB or more data");c=sjcl2.mode.ccm.na(a,d,c,e,g.bitLength(b)/8,f);for(d=0;d<b.length;d+=4)c=a.encrypt(h(c,b.slice(d,d+4).concat([0,0,0])));return g.clamp(c,8*e)},C:function(a,b,c,d,e,f){var g,h=sjcl2.bitArray;g=h.i;var k=b.length,l=h.bitLength(b),n=k/50,m=n;c=h.concat([h.partial(8,f-1)],c).concat([0,0,0]).slice(0,4);d=h.bitSlice(g(d,a.encrypt(c)),0,e);if(!k)return{tag:d,data:[]};for(g=0;g<k;g+=4)g>n&&(sjcl2.mode.ccm.fa(g/k),n+=m),c[3]++,e=a.encrypt(c),b[g]^=e[0],b[g+1]^=e[1],b[g+2]^=e[2],b[g+3]^=e[3];return{tag:d,data:h.clamp(b,l)}}};sjcl2.mode.ocb2={name:"ocb2",encrypt:function(a,b,c,d,e,f){if(128!==sjcl2.bitArray.bitLength(c))throw new sjcl2.exception.invalid("ocb iv must be 128 bits");var g,h=sjcl2.mode.ocb2.S,k=sjcl2.bitArray,l=k.i,n=[0,0,0,0];c=h(a.encrypt(c));var m,p=[];d=d||[];e=e||64;for(g=0;g+4<b.length;g+=4)m=b.slice(g,g+4),n=l(n,m),p=p.concat(l(c,a.encrypt(l(c,m)))),c=h(c);m=b.slice(g);b=k.bitLength(m);g=a.encrypt(l(c,[0,0,0,b]));m=k.clamp(l(m.concat([0,0,0]),g),b);n=l(n,l(m.concat([0,0,0]),g));n=a.encrypt(l(n,l(c,h(c))));d.length&&(n=l(n,f?d:sjcl2.mode.ocb2.pmac(a,d)));return p.concat(k.concat(m,k.clamp(n,e)))},decrypt:function(a,b,c,d,e,f){if(128!==sjcl2.bitArray.bitLength(c))throw new sjcl2.exception.invalid("ocb iv must be 128 bits");e=e||64;var g=sjcl2.mode.ocb2.S,h=sjcl2.bitArray,k=h.i,l=[0,0,0,0],n=g(a.encrypt(c)),m,p,r=sjcl2.bitArray.bitLength(b)-e,q=[];d=d||[];for(c=0;c+4<r/32;c+=4)m=k(n,a.decrypt(k(n,b.slice(c,c+4)))),l=k(l,m),q=q.concat(m),n=g(n);p=r-32*c;m=a.encrypt(k(n,[0,0,0,p]));m=k(m,h.clamp(b.slice(c),p).concat([0,0,0]));l=k(l,m);l=a.encrypt(k(l,k(n,g(n))));d.length&&(l=k(l,f?d:sjcl2.mode.ocb2.pmac(a,d)));if(!h.equal(h.clamp(l,e),h.bitSlice(b,r)))throw new sjcl2.exception.corrupt("ocb: tag doesn't match");return q.concat(h.clamp(m,p))},pmac:function(a,b){var c,d=sjcl2.mode.ocb2.S,e=sjcl2.bitArray,f=e.i,g=[0,0,0,0],h=a.encrypt([0,0,0,0]),h=f(h,d(d(h)));for(c=0;c+4<b.length;c+=4)h=d(h),g=f(g,a.encrypt(f(h,b.slice(c,c+4))));c=b.slice(c);128>e.bitLength(c)&&(h=f(h,d(h)),c=e.concat(c,[-2147483648,0,0,0]));g=f(g,c);return a.encrypt(f(d(f(h,d(h))),g))},S:function(a){return[a[0]<<1^a[1]>>>31,a[1]<<1^a[2]>>>31,a[2]<<1^a[3]>>>31,a[3]<<1^135*(a[0]>>>31)]}};sjcl2.mode.gcm={name:"gcm",encrypt:function(a,b,c,d,e){var f=b.slice(0);b=sjcl2.bitArray;d=d||[];a=sjcl2.mode.gcm.C(true,a,f,d,c,e||128);return b.concat(a.data,a.tag)},decrypt:function(a,b,c,d,e){var f=b.slice(0),g=sjcl2.bitArray,h=g.bitLength(f);e=e||128;d=d||[];e<=h?(b=g.bitSlice(f,h-e),f=g.bitSlice(f,0,h-e)):(b=f,f=[]);a=sjcl2.mode.gcm.C(false,a,f,d,c,e);if(!g.equal(a.tag,b))throw new sjcl2.exception.corrupt("gcm: tag doesn't match");return a.data},ka:function(a,b){var c,d,e,f,g,h=sjcl2.bitArray.i;e=[0,0,0,0];f=b.slice(0);for(c=0;128>c;c++){(d=0!==(a[Math.floor(c/32)]&1<<31-c%32))&&(e=h(e,f));g=0!==(f[3]&1);for(d=3;0<d;d--)f[d]=f[d]>>>1|(f[d-1]&1)<<31;f[0]>>>=1;g&&(f[0]^=-520093696)}return e},j:function(a,b,c){var d,e=c.length;b=b.slice(0);for(d=0;d<e;d+=4)b[0]^=4294967295&c[d],b[1]^=4294967295&c[d+1],b[2]^=4294967295&c[d+2],b[3]^=4294967295&c[d+3],b=sjcl2.mode.gcm.ka(b,a);return b},C:function(a,b,c,d,e,f){var g,h,k,l,n,m,p,r,q=sjcl2.bitArray;m=c.length;p=q.bitLength(c);r=q.bitLength(d);h=q.bitLength(e);g=b.encrypt([0,0,0,0]);96===h?(e=e.slice(0),e=q.concat(e,[1])):(e=sjcl2.mode.gcm.j(g,[0,0,0,0],e),e=sjcl2.mode.gcm.j(g,e,[0,0,Math.floor(h/4294967296),h&4294967295]));h=sjcl2.mode.gcm.j(g,[0,0,0,0],d);n=e.slice(0);d=h.slice(0);a||(d=sjcl2.mode.gcm.j(g,h,c));for(l=0;l<m;l+=4)n[3]++,k=b.encrypt(n),c[l]^=k[0],c[l+1]^=k[1],c[l+2]^=k[2],c[l+3]^=k[3];c=q.clamp(c,p);a&&(d=sjcl2.mode.gcm.j(g,h,c));a=[Math.floor(r/4294967296),r&4294967295,Math.floor(p/4294967296),p&4294967295];d=sjcl2.mode.gcm.j(g,d,a);k=b.encrypt(e);d[0]^=k[0];d[1]^=k[1];d[2]^=k[2];d[3]^=k[3];return{tag:q.bitSlice(d,0,f),data:c}}};sjcl2.misc.hmac=function(a,b){this.W=b=b||sjcl2.hash.sha256;var c=[[],[]],d,e=b.prototype.blockSize/32;this.w=[new b,new b];a.length>e&&(a=b.hash(a));for(d=0;d<e;d++)c[0][d]=a[d]^909522486,c[1][d]=a[d]^1549556828;this.w[0].update(c[0]);this.w[1].update(c[1]);this.R=new b(this.w[0])};sjcl2.misc.hmac.prototype.encrypt=sjcl2.misc.hmac.prototype.mac=function(a){if(this.aa)throw new sjcl2.exception.invalid("encrypt on already updated hmac called!");this.update(a);return this.digest(a)};sjcl2.misc.hmac.prototype.reset=function(){this.R=new this.W(this.w[0]);this.aa=false};sjcl2.misc.hmac.prototype.update=function(a){this.aa=true;this.R.update(a)};sjcl2.misc.hmac.prototype.digest=function(){var a=this.R.finalize(),a=new this.W(this.w[1]).update(a).finalize();this.reset();return a};sjcl2.misc.pbkdf2=function(a,b,c,d,e){c=c||1e4;if(0>d||0>c)throw new sjcl2.exception.invalid("invalid params to pbkdf2");"string"===typeof a&&(a=sjcl2.codec.utf8String.toBits(a));"string"===typeof b&&(b=sjcl2.codec.utf8String.toBits(b));e=e||sjcl2.misc.hmac;a=new e(a);var f,g,h,k,l=[],n=sjcl2.bitArray;for(k=1;32*l.length<(d||1);k++){e=f=a.encrypt(n.concat(b,[k]));for(g=1;g<c;g++)for(f=a.encrypt(f),h=0;h<f.length;h++)e[h]^=f[h];l=l.concat(e)}d&&(l=n.clamp(l,d));return l};sjcl2.prng=function(a){this.c=[new sjcl2.hash.sha256];this.m=[0];this.P=0;this.H={};this.N=0;this.U={};this.Z=this.f=this.o=this.ha=0;this.b=[0,0,0,0,0,0,0,0];this.h=[0,0,0,0];this.L=void 0;this.M=a;this.D=false;this.K={progress:{},seeded:{}};this.u=this.ga=0;this.I=1;this.J=2;this.ca=65536;this.T=[0,48,64,96,128,192,256,384,512,768,1024];this.da=3e4;this.ba=80};sjcl2.prng.prototype={randomWords:function(a,b){var c=[],d;d=this.isReady(b);var e;if(d===this.u)throw new sjcl2.exception.notReady("generator isn't seeded");if(d&this.J){d=!(d&this.I);e=[];var f=0,g;this.Z=e[0]=new Date().valueOf()+this.da;for(g=0;16>g;g++)e.push(4294967296*Math.random()|0);for(g=0;g<this.c.length&&(e=e.concat(this.c[g].finalize()),f+=this.m[g],this.m[g]=0,d||!(this.P&1<<g));g++);this.P>=1<<this.c.length&&(this.c.push(new sjcl2.hash.sha256),this.m.push(0));this.f-=f;f>this.o&&(this.o=f);this.P++;this.b=sjcl2.hash.sha256.hash(this.b.concat(e));this.L=new sjcl2.cipher.aes(this.b);for(d=0;4>d&&(this.h[d]=this.h[d]+1|0,!this.h[d]);d++);}for(d=0;d<a;d+=4)0===(d+1)%this.ca&&y(this),e=z(this),c.push(e[0],e[1],e[2],e[3]);y(this);return c.slice(0,a)},setDefaultParanoia:function(a,b){if(0===a&&"Setting paranoia=0 will ruin your security; use it only for testing"!==b)throw new sjcl2.exception.invalid("Setting paranoia=0 will ruin your security; use it only for testing");this.M=a},addEntropy:function(a,b,c){c=c||"user";var d,e,f=new Date().valueOf(),g=this.H[c],h=this.isReady(),k=0;d=this.U[c];void 0===d&&(d=this.U[c]=this.ha++);void 0===g&&(g=this.H[c]=0);this.H[c]=(this.H[c]+1)%this.c.length;switch(typeof a){case"number":void 0===b&&(b=1);this.c[g].update([d,this.N++,1,b,f,1,a|0]);break;case"object":c=Object.prototype.toString.call(a);if("[object Uint32Array]"===c){e=[];for(c=0;c<a.length;c++)e.push(a[c]);a=e}else for("[object Array]"!==c&&(k=1),c=0;c<a.length&&!k;c++)"number"!==typeof a[c]&&(k=1);if(!k){if(void 0===b)for(c=b=0;c<a.length;c++)for(e=a[c];0<e;)b++,e=e>>>1;this.c[g].update([d,this.N++,2,b,f,a.length].concat(a))}break;case"string":void 0===b&&(b=a.length);this.c[g].update([d,this.N++,3,b,f,a.length]);this.c[g].update(a);break;default:k=1}if(k)throw new sjcl2.exception.bug("random: addEntropy only supports number, array of numbers or string");this.m[g]+=b;this.f+=b;h===this.u&&(this.isReady()!==this.u&&A("seeded",Math.max(this.o,this.f)),A("progress",this.getProgress()))},isReady:function(a){a=this.T[void 0!==a?a:this.M];return this.o&&this.o>=a?this.m[0]>this.ba&&new Date().valueOf()>this.Z?this.J|this.I:this.I:this.f>=a?this.J|this.u:this.u},getProgress:function(a){a=this.T[a?a:this.M];return this.o>=a?1:this.f>a?1:this.f/a},startCollectors:function(){if(!this.D){this.a={loadTimeCollector:B(this,this.ma),mouseCollector:B(this,this.oa),keyboardCollector:B(this,this.la),accelerometerCollector:B(this,this.ea),touchCollector:B(this,this.qa)};if(window.addEventListener)window.addEventListener("load",this.a.loadTimeCollector,false),window.addEventListener("mousemove",this.a.mouseCollector,false),window.addEventListener("keypress",this.a.keyboardCollector,false),window.addEventListener("devicemotion",this.a.accelerometerCollector,false),window.addEventListener("touchmove",this.a.touchCollector,false);else if(document.attachEvent)document.attachEvent("onload",this.a.loadTimeCollector),document.attachEvent("onmousemove",this.a.mouseCollector),document.attachEvent("keypress",this.a.keyboardCollector);else throw new sjcl2.exception.bug("can't attach event");this.D=true}},stopCollectors:function(){this.D&&(window.removeEventListener?(window.removeEventListener("load",this.a.loadTimeCollector,false),window.removeEventListener("mousemove",this.a.mouseCollector,false),window.removeEventListener("keypress",this.a.keyboardCollector,false),window.removeEventListener("devicemotion",this.a.accelerometerCollector,false),window.removeEventListener("touchmove",this.a.touchCollector,false)):document.detachEvent&&(document.detachEvent("onload",this.a.loadTimeCollector),document.detachEvent("onmousemove",this.a.mouseCollector),document.detachEvent("keypress",this.a.keyboardCollector)),this.D=false)},addEventListener:function(a,b){this.K[a][this.ga++]=b},removeEventListener:function(a,b){var c,d,e=this.K[a],f=[];for(d in e)e.hasOwnProperty(d)&&e[d]===b&&f.push(d);for(c=0;c<f.length;c++)d=f[c],delete e[d]},la:function(){C(this,1)},oa:function(a){var b,c;try{b=a.x||a.clientX||a.offsetX||0,c=a.y||a.clientY||a.offsetY||0}catch(d){c=b=0}0!=b&&0!=c&&this.addEntropy([b,c],2,"mouse");C(this,0)},qa:function(a){a=a.touches[0]||a.changedTouches[0];this.addEntropy([a.pageX||a.clientX,a.pageY||a.clientY],1,"touch");C(this,0)},ma:function(){C(this,2)},ea:function(a){a=a.accelerationIncludingGravity.x||a.accelerationIncludingGravity.y||a.accelerationIncludingGravity.z;if(window.orientation){var b=window.orientation;"number"===typeof b&&this.addEntropy(b,1,"accelerometer")}a&&this.addEntropy(a,2,"accelerometer");C(this,0)}};function A(a,b){var c,d=sjcl2.random.K[a],e=[];for(c in d)d.hasOwnProperty(c)&&e.push(d[c]);for(c=0;c<e.length;c++)e[c](b)}function C(a,b){"undefined"!==typeof window&&window.performance&&"function"===typeof window.performance.now?a.addEntropy(window.performance.now(),b,"loadtime"):a.addEntropy(new Date().valueOf(),b,"loadtime")}function y(a){a.b=z(a).concat(z(a));a.L=new sjcl2.cipher.aes(a.b)}function z(a){for(var b=0;4>b&&(a.h[b]=a.h[b]+1|0,!a.h[b]);b++);return a.L.encrypt(a.h)}function B(a,b){return function(){b.apply(a,arguments)}}sjcl2.random=new sjcl2.prng(6);a:try{if(G="undefined"!==typeof module&&module.exports){try{H=__require2("crypto")}catch(a){H=null}G=E=H}if(G&&E.randomBytes)D=E.randomBytes(128),D=new Uint32Array(new Uint8Array(D).buffer),sjcl2.random.addEntropy(D,1024,"crypto['randomBytes']");else if("undefined"!==typeof window&&"undefined"!==typeof Uint32Array){F=new Uint32Array(32);if(window.crypto&&window.crypto.getRandomValues)window.crypto.getRandomValues(F);else if(window.msCrypto&&window.msCrypto.getRandomValues)window.msCrypto.getRandomValues(F);else break a;sjcl2.random.addEntropy(F,1024,"crypto['getRandomValues']")}}catch(a){"undefined"!==typeof window&&window.console&&(console.log("There was an error collecting entropy from the browser:"),console.log(a))}var D;var E;var F;var G;var H;sjcl2.json={defaults:{v:1,iter:1e4,ks:128,ts:64,mode:"ccm",adata:"",cipher:"aes"},ja:function(a,b,c,d){c=c||{};d=d||{};var e=sjcl2.json,f=e.g({iv:sjcl2.random.randomWords(4,0)},e.defaults),g;e.g(f,c);c=f.adata;"string"===typeof f.salt&&(f.salt=sjcl2.codec.base64.toBits(f.salt));"string"===typeof f.iv&&(f.iv=sjcl2.codec.base64.toBits(f.iv));if(!sjcl2.mode[f.mode]||!sjcl2.cipher[f.cipher]||"string"===typeof a&&100>=f.iter||64!==f.ts&&96!==f.ts&&128!==f.ts||128!==f.ks&&192!==f.ks&&256!==f.ks||2>f.iv.length||4<f.iv.length)throw new sjcl2.exception.invalid("json encrypt: invalid parameters");"string"===typeof a?(g=sjcl2.misc.cachedPbkdf2(a,f),a=g.key.slice(0,f.ks/32),f.salt=g.salt):sjcl2.ecc&&a instanceof sjcl2.ecc.elGamal.publicKey&&(g=a.kem(),f.kemtag=g.tag,a=g.key.slice(0,f.ks/32));"string"===typeof b&&(b=sjcl2.codec.utf8String.toBits(b));"string"===typeof c&&(f.adata=c=sjcl2.codec.utf8String.toBits(c));g=new sjcl2.cipher[f.cipher](a);e.g(d,f);d.key=a;f.ct="ccm"===f.mode&&sjcl2.arrayBuffer&&sjcl2.arrayBuffer.ccm&&b instanceof ArrayBuffer?sjcl2.arrayBuffer.ccm.encrypt(g,b,f.iv,c,f.ts):sjcl2.mode[f.mode].encrypt(g,b,f.iv,c,f.ts);return f},encrypt:function(a,b,c,d){var e=sjcl2.json,f=e.ja.apply(e,arguments);return e.encode(f)},ia:function(a,b,c,d){c=c||{};d=d||{};var e=sjcl2.json;b=e.g(e.g(e.g({},e.defaults),b),c,true);var f,g;f=b.adata;"string"===typeof b.salt&&(b.salt=sjcl2.codec.base64.toBits(b.salt));"string"===typeof b.iv&&(b.iv=sjcl2.codec.base64.toBits(b.iv));if(!sjcl2.mode[b.mode]||!sjcl2.cipher[b.cipher]||"string"===typeof a&&100>=b.iter||64!==b.ts&&96!==b.ts&&128!==b.ts||128!==b.ks&&192!==b.ks&&256!==b.ks||!b.iv||2>b.iv.length||4<b.iv.length)throw new sjcl2.exception.invalid("json decrypt: invalid parameters");"string"===typeof a?(g=sjcl2.misc.cachedPbkdf2(a,b),a=g.key.slice(0,b.ks/32),b.salt=g.salt):sjcl2.ecc&&a instanceof sjcl2.ecc.elGamal.secretKey&&(a=a.unkem(sjcl2.codec.base64.toBits(b.kemtag)).slice(0,b.ks/32));"string"===typeof f&&(f=sjcl2.codec.utf8String.toBits(f));g=new sjcl2.cipher[b.cipher](a);f="ccm"===b.mode&&sjcl2.arrayBuffer&&sjcl2.arrayBuffer.ccm&&b.ct instanceof ArrayBuffer?sjcl2.arrayBuffer.ccm.decrypt(g,b.ct,b.iv,b.tag,f,b.ts):sjcl2.mode[b.mode].decrypt(g,b.ct,b.iv,f,b.ts);e.g(d,b);d.key=a;return 1===c.raw?f:sjcl2.codec.utf8String.fromBits(f)},decrypt:function(a,b,c,d){var e=sjcl2.json;return e.ia(a,e.decode(b),c,d)},encode:function(a){var b,c="{",d="";for(b in a)if(a.hasOwnProperty(b)){if(!b.match(/^[a-z0-9]+$/i))throw new sjcl2.exception.invalid("json encode: invalid property name");c+=d+'"'+b+'":';d=",";switch(typeof a[b]){case"number":case"boolean":c+=a[b];break;case"string":c+='"'+escape(a[b])+'"';break;case"object":c+='"'+sjcl2.codec.base64.fromBits(a[b],0)+'"';break;default:throw new sjcl2.exception.bug("json encode: unsupported type")}}return c+"}"},decode:function(a){a=a.replace(/\s/g,"");if(!a.match(/^\{.*\}$/))throw new sjcl2.exception.invalid("json decode: this isn't json!");a=a.replace(/^\{|\}$/g,"").split(/,/);var b={},c,d;for(c=0;c<a.length;c++){if(!(d=a[c].match(/^\s*(?:(["']?)([a-z][a-z0-9]*)\1)\s*:\s*(?:(-?\d+)|"([a-z0-9+\/%*_.@=\-]*)"|(true|false))$/i)))throw new sjcl2.exception.invalid("json decode: this isn't json!");null!=d[3]?b[d[2]]=parseInt(d[3],10):null!=d[4]?b[d[2]]=d[2].match(/^(ct|adata|salt|iv)$/)?sjcl2.codec.base64.toBits(d[4]):unescape(d[4]):null!=d[5]&&(b[d[2]]="true"===d[5])}return b},g:function(a,b,c){void 0===a&&(a={});if(void 0===b)return a;for(var d in b)if(b.hasOwnProperty(d)){if(c&&void 0!==a[d]&&a[d]!==b[d])throw new sjcl2.exception.invalid("required parameter overridden");a[d]=b[d]}return a},sa:function(a,b){var c={},d;for(d in a)a.hasOwnProperty(d)&&a[d]!==b[d]&&(c[d]=a[d]);return c},ra:function(a,b){var c={},d;for(d=0;d<b.length;d++)void 0!==a[b[d]]&&(c[b[d]]=a[b[d]]);return c}};sjcl2.encrypt=sjcl2.json.encrypt;sjcl2.decrypt=sjcl2.json.decrypt;sjcl2.misc.pa={};sjcl2.misc.cachedPbkdf2=function(a,b){var c=sjcl2.misc.pa,d;b=b||{};d=b.iter||1e3;c=c[a]=c[a]||{};d=c[d]=c[d]||{firstSalt:b.salt&&b.salt.length?b.salt.slice(0):sjcl2.random.randomWords(2,0)};c=void 0===b.salt?d.firstSalt:b.salt;d[c]=d[c]||sjcl2.misc.pbkdf2(a,c,b.iter);return{key:d[c].slice(0),salt:c.slice(0)}};"undefined"!==typeof module&&module.exports&&(module.exports=sjcl2);"function"===typeof define&&define([],function(){return sjcl2})}});var require_browser=__commonJS2({"node_modules/web-worker/cjs/browser.js"(exports,module){module.exports=Worker}});function parseFunctionFromText(method=""){let getFunctionBody=methodString=>{return methodString.replace(/^\W*(function[^{]+\{([\s\S]*)\}|[^=]+=>[^{]*\{([\s\S]*)\}|[^=]+=>(.+))/i,"$2$3$4")};let getFunctionHead=methodString=>{let startindex=methodString.indexOf("=>")+1;if(startindex<=0){startindex=methodString.indexOf("){")}if(startindex<=0){startindex=methodString.indexOf(") {")}return methodString.slice(0,methodString.indexOf("{",startindex)+1)};let newFuncHead=getFunctionHead(method);let newFuncBody=getFunctionBody(method);let newFunc;if(newFuncHead.includes("function")){let varName=newFuncHead.split("(")[1].split(")")[0];newFunc=new Function(varName,newFuncBody)}else{if(newFuncHead.substring(0,6)===newFuncBody.substring(0,6)){let varName=newFuncHead.split("(")[1].split(")")[0];newFunc=new Function(varName,newFuncBody.substring(newFuncBody.indexOf("{")+1,newFuncBody.length-1))}else{try{newFunc=(0,eval)(newFuncHead+newFuncBody+"}")}catch{}}}return newFunc}var state={pushToState:{},data:{},triggers:{},setState(updateObj){Object.assign(state.data,updateObj);for(const prop of Object.getOwnPropertyNames(updateObj)){if(state.triggers[prop])state.triggers[prop].forEach(obj=>obj.onchange(state.data[prop]))}return state.data},subscribeTrigger(key,onchange){if(key){if(!state.triggers[key]){state.triggers[key]=[]}let l=state.triggers[key].length;state.triggers[key].push({idx:l,onchange});return state.triggers[key].length-1}else return void 0},unsubscribeTrigger(key,sub){let idx=void 0;let triggers=state.triggers[key];if(triggers){if(!sub)delete state.triggers[key];else{let obj=triggers.find(o=>{if(o.idx===sub){return true}});if(obj)triggers.splice(idx,1);return true}}},subscribeTriggerOnce(key,onchange){let sub;let changed=value=>{onchange(value);state.unsubscribeTrigger(key,sub)};sub=state.subscribeTrigger(key,changed)}};var restrictedKeys=["_state","graph"];function merge(props){for(let k in props){if(restrictedKeys.includes(k))continue;else{this._state[k]=props[k];if(k in this)this[k]=props[k];else Object.defineProperty(this,k,{get:()=>this._state[k],set:v=>this._state[k]=v,enumerable:true})}}}var GraphNode=class{constructor(properties={},parentNode,graph){this.nodes=new Map;this._initial={};this._state={};this._unique=Math.random();this.state=state;this.isLooping=false;this.isAnimating=false;this.looper=void 0;this.animation=void 0;this.forward=true;this.backward=false;this.runSync=false;this.firstRun=true;this.DEBUGNODE=false;this.merge=merge;this.operator=(...args)=>{return args};this.runOp=(...args)=>{if(this.DEBUGNODE)console.time(this.tag);let result=this.operator(...args);if(result instanceof Promise){result.then(res=>{if(res!==void 0)this.setState({[this.tag]:res});if(this.DEBUGNODE){console.timeEnd(this.tag);if(result!==void 0)console.log(`${this.tag} result:`,result)};return res})}else{if(result!==void 0)this.setState({[this.tag]:result});if(this.DEBUGNODE){console.timeEnd(this.tag);if(result!==void 0)console.log(`${this.tag} result:`,result)};}return result};this.setOperator=operator=>{if(typeof operator!=="function")return operator;this.operator=operator.bind(this);return operator};this.runAsync=(...args)=>{return new Promise((res,rej)=>{res(this.run(...args))})};this.transformArgs=(args=[])=>args;this.isRunSync=()=>{return!(this.children&&this.forward||this.parent&&this.backward||this.repeat||this.delay||this.frame||this.recursive||this.branch)};this.run=(...args)=>{if(typeof this.transformArgs==="function")args=this.transformArgs(args,this);if(this.firstRun){this.firstRun=false;this.runSync=this.isRunSync();if(this.animate&&!this.isAnimating){this.runAnimation(this.animation,args)}if(this.loop&&typeof this.loop==="number"&&!this.isLooping){this.runLoop(this.looper,args)}if(this.loop||this.animate)return}if(this.runSync){let res=this.runOp(...args);return res}return new Promise(async resolve=>{if(this){let run=(node,tick=0,...input)=>{return new Promise(async r=>{tick++;let res=await node.runOp(...input);if(node.repeat){while(tick<node.repeat){if(node.delay){setTimeout(async()=>{r(await run(node,tick,...input))},node.delay);break}else if(node.frame&&window?.requestAnimationFrame){requestAnimationFrame(async()=>{r(await run(node,tick,...input))});break}else res=await node.runOp(...input);tick++}if(tick===node.repeat){r(res);return}}else if(node.recursive){while(tick<node.recursive){if(node.delay){setTimeout(async()=>{r(await run(node,tick,...res))},node.delay);break}else if(node.frame&&window?.requestAnimationFrame){requestAnimationFrame(async()=>{r(await run(node,tick,...res))});break}else res=await node.runOp(...res);tick++}if(tick===node.recursive){r(res);return}}else{r(res);return}})};let runnode=async()=>{let res=await run(this,void 0,...args);if(res!==void 0){if(this.backward&&this.parent instanceof GraphNode){if(Array.isArray(res))await this.runParent(this,...res);else await this.runParent(this,res)}if(this.children&&this.forward){if(Array.isArray(res))await this.runChildren(this,...res);else await this.runChildren(this,res)}if(this.branch){this.runBranch(this,res)}}return res};if(this.delay){setTimeout(async()=>{resolve(await runnode())},this.delay)}else if(this.frame&&window?.requestAnimationFrame){requestAnimationFrame(async()=>{resolve(await runnode())})}else{resolve(await runnode())}}else resolve(void 0)})};this.runParent=async(n,...args)=>{if(n.backward&&n.parent){if(typeof n.parent==="string"){if(n.graph&&n.graph?.get(n.parent)){n.parent=n.graph;if(n.parent)this.nodes.set(n.parent.tag,n.parent)}else n.parent=this.nodes.get(n.parent)}if(n.parent instanceof GraphNode)await n.parent.run(...args)}};this.runChildren=async(n,...args)=>{if(typeof n.children==="object"){for(const key in n.children){if(typeof n.children[key]==="string"){if(n.graph&&n.graph?.get(n.children[key])){n.children[key]=n.graph.get(n.children[key]);if(!n.nodes.get(n.children[key].tag))n.nodes.set(n.children[key].tag,n.children[key])}if(!n.children[key]&&n.nodes.get(n.children[key]))n.children[key]=n.nodes.get(n.children[key])}else if(typeof n.children[key]==="undefined"||n.children[key]===true){if(n.graph&&n.graph?.get(key)){n.children[key]=n.graph.get(key);if(!n.nodes.get(n.children[key].tag))n.nodes.set(n.children[key].tag,n.children[key])}if(!n.children[key]&&n.nodes.get(key))n.children[key]=n.nodes.get(key)}if(n.children[key]?.runOp)await n.children[key].run(...args)}}};this.runBranch=async(n,output)=>{if(n.branch){let keys=Object.keys(n.branch);await Promise.all(keys.map(async k=>{if(typeof n.branch[k].if==="object")n.branch[k].if=stringifyFast(n.branch[k].if);let pass=false;if(typeof n.branch[k].if==="function"){pass=n.branch[k].if(output)}else{if(typeof output==="object"){if(stringifyFast(output)===n.branch[k].if)pass=true}else if(output===n.branch[k].if)pass=true}if(pass){if(n.branch[k].then.run){if(Array.isArray(output))await n.branch[k].then.run(...output);else await n.branch[k].then.run(...output)}else if(typeof n.branch[k].then==="function"){if(Array.isArray(output))await n.branch[k].then(...output);else await n.branch[k].then(output)}else if(typeof n.branch[k].then==="string"){if(n.graph)n.branch[k].then=n.graph.nodes.get(n.branch[k].then);else n.branch[k].then=n.nodes.get(n.branch[k].then);if(n.branch[k].then.run){if(Array.isArray(output))await n.branch[k].then.run(...output);else await n.branch[k].then.run(...output)}}}return pass}))}};this.runAnimation=(animation=this.animation,args=[])=>{this.animation=animation;if(!animation)this.animation=this.operator;if(this.animate&&!this.isAnimating&&"requestAnimationFrame"in window){this.isAnimating=true;let anim=async()=>{if(this.isAnimating){if(this.DEBUGNODE)console.time(this.tag);let result=this.animation.call(this,...args);if(result instanceof Promise){result=await result}if(this.DEBUGNODE){console.timeEnd(this.tag);if(result!==void 0)console.log(`${this.tag} result:`,result)};if(result!==void 0){if(this.tag)this.setState({[this.tag]:result});if(this.backward&&this.parent?.run){if(Array.isArray(result))await this.runParent(this,...result);else await this.runParent(this,result)}if(this.children&&this.forward){if(Array.isArray(result))await this.runChildren(this,...result);else await this.runChildren(this,result)}if(this.branch){this.runBranch(this,result)}this.setState({[this.tag]:result})}requestAnimationFrame(anim)}};requestAnimationFrame(anim)}};this.runLoop=(loop=this.looper,args=[],timeout=this.loop)=>{this.looper=loop;if(!loop)this.looper=this.operator;if(typeof timeout==="number"&&!this.isLooping){this.isLooping=true;let looping=async()=>{if(this.isLooping){if(this.DEBUGNODE)console.time(this.tag);let result=this.looper.call(this,...args);if(result instanceof Promise){result=await result}if(this.DEBUGNODE){console.timeEnd(this.tag);if(result!==void 0)console.log(`${this.tag} result:`,result)};if(result!==void 0){if(this.tag)this.setState({[this.tag]:result});if(this.backward&&this.parent?.run){if(Array.isArray(result))await this.runParent(this,...result);else await this.runParent(this,result)}if(this.children&&this.forward){if(Array.isArray(result))await this.runChildren(this,...result);else await this.runChildren(this,result)}if(this.branch){this.runBranch(this,result)}this.setState({[this.tag]:result})}setTimeout(async()=>{await looping()},timeout)}};looping()}};this.setParent=parent=>{this.parent=parent;if(this.backward)this.runSync=false};this.setChildren=children=>{this.children=children;if(this.forward)this.runSync=false};this.add=(n={})=>{if(typeof n==="function")n={operator:n};if(n?.node instanceof GraphNode)n=n.node;if(!(n instanceof GraphNode))n=new GraphNode(n.node??n,this,this.graph);this.nodes.set(n.tag,n);if(this.graph){this.graph.nodes.set(n.tag,n);this.graph.nNodes=this.graph.nodes.size}return n};this.remove=n=>{if(typeof n==="string")n=this.nodes.get(n);if(n?.tag){this.nodes.delete(n.tag);if(this.children[n.tag])delete this.children[n.tag];if(this.graph){this.graph.nodes.delete(n.tag);this.graph.nNodes=this.graph.nodes.size}this.nodes.forEach(n2=>{if(n2.nodes.get(n2.tag)){n2.nodes.delete(n2.tag);if(n2.children[n2.tag])delete n2.children[n2.tag];if(n2.parent?.tag===n2.tag)delete n2.parent}});if(n.ondelete)n.ondelete(n)}};this.append=(n,parentNode2=this)=>{if(typeof n==="string")n=this.nodes.get(n);if(n?.nodes){parentNode2.addChildren(n);if(n.forward)n.runSync=false}};this.subscribe=(callback,tag=this.tag)=>{if(callback.run){return this.subscribeNode(callback)}else return this.state.subscribeTrigger(tag,callback)};this.unsubscribe=(sub,tag=this.tag)=>{return this.state.unsubscribeTrigger(tag,sub)};this.addChildren=children=>{if(!this.children)this.children={};if(typeof children==="object"){Object.assign(this.children,children)}this.convertChildrenToNodes();if(this.forward)this.runSync=false};this.callParent=(...args)=>{if(typeof this.parent==="string"){if(this.graph&&this.graph?.get(this.parent)){this.parent=this.graph;if(this.parent)this.nodes.set(this.parent.tag,this.parent)}else this.parent=this.nodes.get(this.parent)}if(typeof this.parent?.operator==="function")return this.parent.runOp(...args)};this.callChildren=(...args)=>{let result;if(typeof this.children==="object"){for(const key in this.children){if(this.children[key]?.runOp)this.children[key].runOp(...args)}}return result};this.getProps=(n=this)=>{return{tag:n.tag,operator:n.operator,graph:n.graph,children:n.children,parent:n.parent,forward:n.forward,backward:n.bacward,loop:n.loop,animate:n.animate,frame:n.frame,delay:n.delay,recursive:n.recursive,repeat:n.repeat,branch:n.branch,oncreate:n.oncreate,DEBUGNODE:n.DEBUGNODE,...this._initial}};this.setProps=(props={})=>{let tmp=Object.assign({},props);if(tmp.children){this.addChildren(props.children);delete tmp.children}if(tmp.operator){this.setOperator(props.operator);delete tmp.operator}Object.assign(tmp,props);this.runSync=this.isRunSync()};this.removeTree=n=>{if(n){if(typeof n==="string")n=this.nodes.get(n)}if(n?.nodes){let checked={};const recursivelyRemove=node=>{if(typeof node.children==="object"&&!checked[node.tag]){checked[node.tag]=true;for(const key in node.children){if(node.children[key].stopNode)node.children[key].stopNode();if(node.children[key].tag){if(this.nodes.get(node.children[key].tag))this.nodes.delete(node.children[key].tag);this.nodes.forEach(n2=>{if(n2.nodes.get(node.children[key].tag))n2.nodes.delete(node.children[key].tag);if(n2.children[key]instanceof GraphNode)delete n2.children[key]});recursivelyRemove(node.children[key])}}}};if(n.stopNode)n.stopNode();if(n.tag){this.nodes.delete(n.tag);if(this.children[n.tag])delete this.children[n.tag];if(this.parent?.tag===n.tag)delete this.parent;if(this[n.tag]instanceof GraphNode)delete this[n.tag];this.nodes.forEach(n2=>{if(n2?.tag){if(n2.nodes.get(n2.tag))n2.nodes.delete(n2.tag);if(n2.children[n2.tag]instanceof GraphNode)delete n2.children[n2.tag]}});recursivelyRemove(n);if(this.graph)this.graph.removeTree(n,checked);else if(n.ondelete)n.ondelete(n)}}};this.checkNodesHaveChildMapped=(n,child,checked={})=>{let tag=n.tag;if(!tag)tag=n.name;if(!checked[tag]){checked[tag]=true;if(n.children){if(child.tag in n.children){if(n.children[child.tag]instanceof GraphNode){if(!n.nodes.get(child.tag))n.nodes.set(child.tag,child);n.children[child.tag]=child;if(!n.firstRun)n.firstRun=true}}}if(n.parent instanceof GraphNode){if(n.nodes.get(child.tag))n.parent.nodes.set(child.tag,child);if(n.parent.children){this.checkNodesHaveChildMapped(n.parent,child,checked)}else if(n.nodes){n.nodes.forEach(n2=>{if(!checked[n2.tag]){this.checkNodesHaveChildMapped(n2,child,checked)}})}}if(n.graph){if(n.parent&&n.parent.name!==n.graph.name){n.graph.nodes.forEach(n2=>{if(!checked[n2.tag]){this.checkNodesHaveChildMapped(n2,child,checked)}})}}}};this.convertChildrenToNodes=(n=this)=>{if(n?.children){for(const key in n.children){if(!(n.children[key]instanceof GraphNode)){if(typeof n.children[key]==="object"){if(!n.children[key].tag)n.children[key].tag=key;if(!n.nodes.get(n.children[key].tag)){n.children[key]=new GraphNode(n.children[key],n,n.graph);this.checkNodesHaveChildMapped(n,n.children[key])}}else{if(typeof n.children[key]==="undefined"||n.children[key]==true){n.children[key]=n.graph.get(key);if(!n.children[key])n.children[key]=n.nodes.get(key)}else if(typeof n.children[key]==="string"){let k=n.children[key];n.children[key]=n.graph.get(k);if(!n.children[key])n.children[key]=n.nodes.get(key)}if(n.children[key]instanceof GraphNode){n.nodes.set(n.children[key].tag,n.children[key]);this.checkNodesHaveChildMapped(n,n.children[key]);if(!(n.children[key].tag in n))n[n.children[key].tag]=n.children[key]}}}}}return n.children};this.stopLooping=(n=this)=>{n.isLooping=false};this.stopAnimating=(n=this)=>{n.isAnimating=false};this.stopNode=(n=this)=>{n.stopAnimating(n);n.stopLooping(n)};this.subscribeNode=n=>{if(typeof n==="string")n=this.nodes.get(n);if(n.tag)this.nodes.set(n.tag,n);if(n)return this.state.subscribeTrigger(this.tag,res=>{if(Array.isArray(res))n.run(...res);else n.run(res)})};this.print=(n=this,printChildren=true,nodesPrinted=[])=>{let dummyNode=new GraphNode;if(typeof n==="string")n=this.nodes.get(n);if(n instanceof GraphNode){nodesPrinted.push(n.tag);let jsonToPrint={tag:n.tag,operator:n.operator.toString()};if(n.parent)jsonToPrint.parent=n.parent.tag;if(typeof n.children==="object"){for(const key in n.children){if(typeof n.children[key]==="string")return n.children[key];if(nodesPrinted.includes(n.children[key].tag))return n.children[key].tag;else if(!printChildren){return n.children[key].tag}else return n.children[key].print(n.children[key],printChildren,nodesPrinted)}}for(const prop in n){if(prop==="parent"||prop==="children")continue;if(typeof dummyNode[prop]==="undefined"){if(typeof n[prop]==="function"){jsonToPrint[prop]=n[prop].toString()}else if(typeof n[prop]==="object"){jsonToPrint[prop]=JSON.stringifyWithCircularRefs(n[prop])}else{jsonToPrint[prop]=n[prop]}}}return JSON.stringify(jsonToPrint)}};this.reconstruct=json=>{let parsed=reconstructObject(json);if(parsed)return this.add(parsed)};this.setState=this.state.setState;this.DEBUGNODES=(debugging=true)=>{this.DEBUGNODE=debugging;this.nodes.forEach(n=>{if(debugging)n.DEBUGNODE=true;else n.DEBUGNODE=false})};if(typeof properties==="function"){properties={operator:properties}}if(typeof properties==="object"){if(properties instanceof GraphNode&&properties._initial)Object.assign(properties,properties._initial);if(properties instanceof Graph){let source=properties;properties={source,operator:input=>{if(typeof input==="object"){let result={};for(const key in input){if(typeof source[key]==="function"){if(Array.isArray(input[key]))result[key]=source[key](...input[key]);else result[key]=source[key](input[key])}else{source[key]=input[key];result[key]=source[key]}}return result}return source}};if(source.operator)properties.operator=source.operator;if(source.children)properties.children=source.children;if(source.forward)properties.forward=source.forward;if(source.backward)properties.backward=source.backward;if(source.repeat)properties.repeat=source.repeat;if(source.recursive)properties.recursive=source.recursive;if(source.loop)properties.loop=source.loop;if(source.animate)properties.animate=source.animate;if(source.looper)properties.looper=source.looper;if(source.animation)properties.animation=source.animation;if(source.delay)properties.delay=source.delay;if(source.tag)properties.tag=source.tag;if(source.oncreate)properties.oncreate=source.oncreate;if(source.node){if(source.node._initial)Object.assign(properties,source.node._initial)}if(source._initial)Object.assign(properties,source._initial);this.nodes=source.nodes;source.node=this;if(graph){source.nodes.forEach(n=>{if(!graph.nodes.get(n.tag)){graph.nodes.set(n.tag,n);graph.nNodes++}})}}if(properties.tag&&(graph||parentNode)){let hasnode;if(graph?.nodes){hasnode=graph.nodes.get(properties.tag)}if(!hasnode&&parentNode?.nodes){hasnode=parentNode.nodes.get(properties.tag)}if(hasnode){if(!this.source)this.source=hasnode;let props=hasnode.getProps();delete props.graph;delete props.parent;for(let k in props)properties[k]=props[k]}}if(properties?.operator){properties.operator=this.setOperator(properties.operator)}if(!properties.tag&&graph){properties.tag=`node${graph.nNodes}`}else if(!properties.tag){properties.tag=`node${Math.floor(Math.random()*1e10)}`}let keys=Object.getOwnPropertyNames(this);for(const key in properties){if(!keys.includes(key))this._initial[key]=properties[key]}if(properties.children)this._initial.children=Object.assign({},properties.children);Object.assign(this,properties);if(!this.tag){if(graph){this.tag=`node${graph.nNodes}`}else{this.tag=`node${Math.floor(Math.random()*1e10)}`}}if(graph){this.graph=graph;if(graph.nodes.get(this.tag)){this.tag=`${this.tag}${graph.nNodes+1}`}graph.nodes.set(this.tag,this);graph.nNodes++}if(parentNode){this.parent=parentNode;if(parentNode instanceof GraphNode||parentNode instanceof Graph)parentNode.nodes.set(this.tag,this)}if(typeof properties.tree==="object"){for(const key in properties.tree){if(typeof properties.tree[key]==="object"){if((!properties.tree[key]).tag){properties.tree[key].tag=key}}let node=new GraphNode(properties.tree[key],this,graph);this.nodes.set(node.tag,node)}}if(this.children)this.convertChildrenToNodes(this);if(this.parent instanceof GraphNode||this.parent instanceof Graph)this.checkNodesHaveChildMapped(this.parent,this);if(typeof this.oncreate==="function")this.oncreate(this);if(!this.firstRun)this.firstRun=true;if(this.animation&&!this.animate)this.animate=true}else return properties}};var Graph=class{constructor(tree,tag,props){this.nNodes=0;this.nodes=new Map;this.state=state;this._state={};this._unique=Math.random();this.tree={};this.merge=merge;this.add=(n={})=>{if(n?.node instanceof GraphNode)n=n.node;let props2=n;if(!(n instanceof GraphNode))n=new GraphNode(props2?.node??props2,this,this);else{this.nNodes=this.nodes.size;if(n.tag){this.tree[n.tag]=props2;this.nodes.set(n.tag,n)}}return n};this.setTree=(tree2=this.tree)=>{if(!tree2)return;for(const node in tree2){const n=this.nodes.get(node);if(!n){if(typeof tree2[node]==="function"){this.add({tag:node,operator:tree2[node]})}else if(typeof tree2[node]==="object"&&!Array.isArray(tree2[node])){if(!tree2[node].tag)tree2[node].tag=node;let newNode=this.add(tree2[node]);if(tree2[node].aliases){tree2[node].aliases.forEach(a=>{this.nodes.set(a,newNode)})}}else{this.add({tag:node,operator:(...args)=>{return tree2[node]}})}}else{if(typeof tree2[node]==="function"){n.setOperator(tree2[node])}else if(typeof tree2[node]==="object"){if(tree2[node]instanceof GraphNode){this.add(tree2[node])}else if(tree2[node]instanceof Graph){let source=tree2[node];let properties={};if(source.operator)properties.operator=source.operator;if(source.children)properties.children=source.children;if(source.forward)properties.forward=source.forward;if(source.backward)properties.backward=source.backward;if(source.repeat)properties.repeat=source.repeat;if(source.recursive)properties.recursive=source.recursive;if(source.loop)properties.loop=source.loop;if(source.animate)properties.animate=source.animate;if(source.looper)properties.looper=source.looper;if(source.animation)properties.animation=source.animation;if(source.delay)properties.delay=source.delay;if(source.tag)properties.tag=source.tag;if(source.oncreate)properties.oncreate=source.oncreate;if(source.node?._initial)Object.assign(properties,source.node._initial);properties.nodes=source.nodes;properties.source=source;n.setProps(properties)}else{n.setProps(tree2[node])}}}}this.nodes.forEach(node=>{if(typeof node.children==="object"){for(const key in node.children){if(typeof node.children[key]==="string"){if(this.nodes.get(node.children[key])){node.children[key]=this.nodes.get(node.children[key])}}else if(node.children[key]===true||typeof node.children[key]==="undefined"){if(this.nodes.get(key)){node.children[key]=this.nodes.get(key)}}if(node.children[key]instanceof GraphNode){node.checkNodesHaveChildMapped(node,node.children[key])}}}if(typeof node.parent==="string"){if(this.nodes.get(node.parent)){node.parent=this.nodes.get(node.parent);node.nodes.set(node.parent.tag,node.parent)}}})};this.get=tag2=>{return this.nodes.get(tag2)};this.set=n=>{return this.nodes.set(n.tag,n)};this.run=(n,...args)=>{if(typeof n==="string")n=this.nodes.get(n);if(n?.run)return n.run(...args);else return void 0};this.runAsync=(n,...args)=>{if(typeof n==="string")n=this.nodes.get(n);if(n?.run)return new Promise((res,rej)=>{res(n.run(...args))});else return new Promise((res,rej)=>{res(void 0)})};this.removeTree=(n,checked)=>{if(typeof n==="string")n=this.nodes.get(n);if(n?.nodes){if(!checked)checked={};const recursivelyRemove=node=>{if(node.children&&!checked[node.tag]){checked[node.tag]=true;if(Array.isArray(node.children)){node.children.forEach(c=>{if(c.stopNode)c.stopNode();if(c.tag){if(this.nodes.get(c.tag))this.nodes.delete(c.tag)}this.nodes.forEach(n2=>{if(n2.nodes.get(c.tag))n2.nodes.delete(c.tag)});recursivelyRemove(c)})}else if(typeof node.children==="object"){if(node.stopNode)node.stopNode();if(node.tag){if(this.nodes.get(node.tag))this.nodes.delete(node.tag)}this.nodes.forEach(n2=>{if(n2.nodes.get(node.tag))n2.nodes.delete(node.tag)});recursivelyRemove(node)}}};if(n.stopNode)n.stopNode();if(n.tag){this.nodes.delete(n.tag);this.nodes.forEach(n2=>{if(n2.nodes.get(n2.tag))n2.nodes.delete(n2.tag)});this.nNodes=this.nodes.size;recursivelyRemove(n)}if(n.ondelete)n.ondelete(n)}return n};this.remove=n=>{if(typeof n==="string")n=this.nodes.get(n);if(n?.nodes){if(n.stopNode)n.stopNode();if(n?.tag){if(this.nodes.get(n.tag)){this.nodes.delete(n.tag);this.nodes.forEach(n2=>{if(n2.nodes.get(n2.tag))n2.nodes.delete(n2.tag)})}}if(n.ondelete)n.ondelete(n)}return n};this.append=(n,parentNode)=>{parentNode.addChildren(n)};this.callParent=async(n,...args)=>{if(n?.parent){return await n.callParent(...args)}};this.callChildren=async(n,...args)=>{if(n?.children){return await n.callChildren(...args)}};this.subscribe=(n,callback)=>{if(!callback)return;if(n?.subscribe&&typeof callback==="function"){return n.subscribe(callback)}else if(callback instanceof GraphNode||typeof callback==="string")return this.subscribeNode(n,callback);else if(typeof n=="string"){return this.state.subscribeTrigger(n,callback)}};this.unsubscribe=(tag2,sub)=>{return this.state.unsubscribeTrigger(tag2,sub)};this.subscribeNode=(inputNode,outputNode)=>{let tag2;if(inputNode?.tag)tag2=inputNode.tag;else if(typeof inputNode==="string")tag2=inputNode;if(typeof outputNode==="string")outputNode=this.nodes.get(outputNode);if(inputNode&&outputNode){let sub=this.state.subscribeTrigger(tag2,res=>{if(Array.isArray(res))outputNode.run(...res);else outputNode.run(res)});return sub}};this.stopNode=n=>{if(typeof n==="string"){n=this.nodes.get(n)}if(n?.stopNode){n.stopNode()}};this.print=(n,printChildren=true)=>{if(n?.print)return n.print(n,printChildren);else{let printed=`{`;this.nodes.forEach(n2=>{printed+=`
"${n2.tag}:${n2.print(n2,printChildren)}"`});return printed}};this.reconstruct=json=>{let parsed=reconstructObject(json);if(parsed)return this.add(parsed)};this.create=(operator,parentNode,props2)=>{return createNode(operator,parentNode,props2,this)};this.setState=this.state.setState;this.DEBUGNODES=(debugging=true)=>{this.nodes.forEach(n=>{if(debugging)n.DEBUGNODE=true;else n.DEBUGNODE=false})};this.tag=tag?tag:`graph${Math.floor(Math.random()*1e11)}`;if(props){Object.assign(this,props);this._initial=props}if(tree||Object.keys(this.tree).length>0)this.setTree(tree)}};function reconstructObject(json="{}"){try{let parsed=typeof json==="string"?JSON.parse(json):json;const parseObj=obj=>{for(const prop in obj){if(typeof obj[prop]==="string"){let funcParsed=parseFunctionFromText(obj[prop]);if(typeof funcParsed==="function"){obj[prop]=funcParsed}}else if(typeof obj[prop]==="object"){parseObj(obj[prop])}}return obj};return parseObj(parsed)}catch(err){console.error(err);return void 0}}var stringifyWithCircularRefs=function(){const refs=new Map;const parents=[];const path=["this"];function clear(){refs.clear();parents.length=0;path.length=1}function updateParents(key,value){var idx=parents.length-1;var prev=parents[idx];if(typeof prev==="object"){if(prev[key]===value||idx===0){path.push(key);parents.push(value.pushed)}else{while(idx-->=0){prev=parents[idx];if(typeof prev==="object"){if(prev[key]===value){idx+=2;parents.length=idx;path.length=idx;--idx;parents[idx]=value;path[idx]=key;break}}idx--}}}}function checkCircular(key,value){if(value!=null){if(typeof value==="object"){if(key){updateParents(key,value)}let other=refs.get(value);if(other){return"[Circular Reference]"+other}else{refs.set(value,path.join("."))}}}return value}return function stringifyWithCircularRefs2(obj,space){try{parents.push(obj);return JSON.stringify(obj,checkCircular,space)}finally{clear()}}}();if(JSON.stringifyWithCircularRefs===void 0){JSON.stringifyWithCircularRefs=stringifyWithCircularRefs}var stringifyFast=function(){const refs=new Map;const parents=[];const path=["this"];function clear(){refs.clear();parents.length=0;path.length=1}function updateParents(key,value){var idx=parents.length-1;if(parents[idx]){var prev=parents[idx];if(typeof prev==="object"){if(prev[key]===value||idx===0){path.push(key);parents.push(value.pushed)}else{while(idx-->=0){prev=parents[idx];if(typeof prev==="object"){if(prev[key]===value){idx+=2;parents.length=idx;path.length=idx;--idx;parents[idx]=value;path[idx]=key;break}}idx++}}}}}function checkValues(key,value){let val;if(value!=null){if(typeof value==="object"){let c=value.constructor.name;if(key&&c==="Object"){updateParents(key,value)}let other=refs.get(value);if(other){return"[Circular Reference]"+other}else{refs.set(value,path.join("."))}if(c==="Array"){if(value.length>20){val=value.slice(value.length-20)}else val=value}else if(c.includes("Set")){val=Array.from(value)}else if(c!=="Object"&&c!=="Number"&&c!=="String"&&c!=="Boolean"){val="instanceof_"+c}else if(c==="Object"){let obj={};for(const prop in value){if(value[prop]==null){obj[prop]=value[prop]}else if(Array.isArray(value[prop])){if(value[prop].length>20)obj[prop]=value[prop].slice(value[prop].length-20);else obj[prop]=value[prop]}else if(value[prop].constructor.name==="Object"){obj[prop]={};for(const p in value[prop]){if(Array.isArray(value[prop][p])){if(value[prop][p].length>20)obj[prop][p]=value[prop][p].slice(value[prop][p].length-20);else obj[prop][p]=value[prop][p]}else{if(value[prop][p]!=null){let con=value[prop][p].constructor.name;if(con.includes("Set")){obj[prop][p]=Array.from(value[prop][p])}else if(con!=="Number"&&con!=="String"&&con!=="Boolean"){obj[prop][p]="instanceof_"+con}else{obj[prop][p]=value[prop][p]}}else{obj[prop][p]=value[prop][p]}}}}else{let con=value[prop].constructor.name;if(con.includes("Set")){obj[prop]=Array.from(value[prop])}else if(con!=="Number"&&con!=="String"&&con!=="Boolean"){obj[prop]="instanceof_"+con}else{obj[prop]=value[prop]}}}val=obj}else{val=value}}else{val=value}}return val}return function stringifyFast2(obj,space){parents.push(obj);let res=JSON.stringify(obj,checkValues,space);clear();return res}}();if(JSON.stringifyFast===void 0){JSON.stringifyFast=stringifyFast}function createNode(operator,parentNode,props,graph){if(typeof props==="object"){props.operator=operator;return new GraphNode(props,parentNode,graph)}return new GraphNode({operator},parentNode,graph)}var Service=class extends Graph{constructor(options={}){super(void 0,options.name?options.name:`service${Math.floor(Math.random()*1e14)}`,options.props);this.routes={};this.loadDefaultRoutes=false;this.keepState=true;this.firstLoad=true;this.customRoutes={};this.customChildren={};this.init=options2=>{if(options2)options2=Object.assign({},options2);else options2={};if(options2.customRoutes)Object.assign(options2.customRoutes,this.customRoutes);else options2.customRoutes=this.customRoutes;if(options2.customChildren)Object.assign(options2.customChildren,this.customChildren);else options2.customChildren=this.customChildren;if(Array.isArray(options2.routes)){options2.routes.forEach(r=>{this.load(r,options2.includeClassName,options2.routeFormat,options2.customRoutes,options2.customChildren)})}else if(options2.routes||(Object.keys(this.routes).length>0||this.loadDefaultRoutes)&&this.firstLoad)this.load(options2.routes,options2.includeClassName,options2.routeFormat,options2.customRoutes,options2.customChildren)};this.load=(routes,includeClassName=true,routeFormat=".",customRoutes,customChildren)=>{if(!routes&&!this.loadDefaultRoutes&&(Object.keys(this.routes).length>0||this.firstLoad))return;if(this.firstLoad)this.firstLoad=false;if(customRoutes)customRoutes=Object.assign(this.customRoutes,customRoutes);else customRoutes=this.customRoutes;let service;let allRoutes={};if(routes){if(!(routes instanceof Graph)&&routes?.name&&!routes.setTree){if(routes.module){let mod=routes;routes={};Object.getOwnPropertyNames(routes.module).forEach(prop=>{if(includeClassName)routes[mod.name+routeFormat+prop]=routes.module[prop];else routes[prop]=routes.module[prop]})}else if(typeof routes==="function"){service=new routes({loadDefaultRoutes:this.loadDefaultRoutes});service.load();routes=service.routes;if(service.customRoutes&&!this.customRoutes)this.customRoutes=service.customRoutes;else if(service.customRoutes&&this.customRoutes)Object.assign(this.customRoutes,service.customRoutes);if(service.customChildren&&!this.customChildren)this.customChildren=service.customChildren;else if(service.customChildren&&this.customChildren)Object.assign(this.customChildren,service.customChildren)}}else if(routes instanceof Graph||routes.source instanceof Graph||routes.setTree){service=routes;routes={};if(includeClassName){let name=service.name;if(!name){name=service.tag;service.name=name}if(!name){name=`graph${Math.floor(Math.random()*1e15)}`;service.name=name;service.tag=name}}if(service.customRoutes&&!this.customRoutes)this.customRoutes=service.customRoutes;else if(service.customRoutes&&this.customRoutes)Object.assign(this.customRoutes,service.customRoutes);if(service.customChildren&&!this.customChildren)this.customChildren=service.customChildren;else if(service.customChildren&&this.customChildren)Object.assign(this.customChildren,service.customChildren);service.nodes.forEach(node=>{routes[node.tag]=node;let checked={};let checkChildGraphNodes=(nd,par)=>{if(!checked[nd.tag]||par&&includeClassName&&!checked[par?.tag+routeFormat+nd.tag]){if(!par)checked[nd.tag]=true;else checked[par.tag+routeFormat+nd.tag]=true;if(nd instanceof Graph||nd.source instanceof Graph||nd.setTree){if(includeClassName){let nm=nd.name;if(!nm){nm=nd.tag;nd.name=nm}if(!nm){nm=`graph${Math.floor(Math.random()*1e15)}`;nd.name=nm;nd.tag=nm}}nd.nodes.forEach(n=>{if(includeClassName&&!routes[nd.tag+routeFormat+n.tag])routes[nd.tag+routeFormat+n.tag]=n;else if(!routes[n.tag])routes[n.tag]=n;checkChildGraphNodes(n,nd)})}}};checkChildGraphNodes(node)})}else if(typeof routes==="object"){let name=routes.constructor.name;if(name==="Object"){name=Object.prototype.toString.call(routes);if(name)name=name.split(" ")[1];if(name)name=name.split("]")[0]}if(name&&name!=="Object"){let module=routes;routes={};Object.getOwnPropertyNames(module).forEach(route=>{if(includeClassName)routes[name+routeFormat+route]=module[route];else routes[route]=module[route]})}}if((service instanceof Graph||service?.setTree)&&service.name&&includeClassName){routes=Object.assign({},routes);for(const prop in routes){let route=routes[prop];delete routes[prop];routes[service.name+routeFormat+prop]=route}}}if(this.loadDefaultRoutes){let rts2=Object.assign({},this.defaultRoutes);if(routes){Object.assign(rts2,this.routes);routes=Object.assign(rts2,routes)}else routes=Object.assign(rts2,this.routes);this.loadDefaultRoutes=false}if(!routes)routes=this.routes;let incr=0;for(const tag in routes){incr++;let childrenIter=(route,routeKey)=>{if(typeof route==="object"){if(!route.tag)route.tag=routeKey;if(typeof route?.children==="object"){nested:for(const key in route.children){incr++;if(typeof route.children[key]==="object"){let rt=route.children[key];if(rt.tag&&allRoutes[rt.tag])continue;if(customChildren){for(const k2 in customChildren){rt=customChildren[k2](rt,key,route,routes,allRoutes);if(!rt)continue nested}}if(rt.id&&!rt.tag){rt.tag=rt.id}let k;if(rt.tag){if(allRoutes[rt.tag]){let randkey=`${rt.tag}${incr}`;allRoutes[randkey]=rt;rt.tag=randkey;childrenIter(allRoutes[randkey],key);k=randkey}else{allRoutes[rt.tag]=rt;childrenIter(allRoutes[rt.tag],key);k=rt.tag}}else{if(allRoutes[key]){let randkey=`${key}${incr}`;allRoutes[randkey]=rt;rt.tag=randkey;childrenIter(allRoutes[randkey],key);k=randkey}else{allRoutes[key]=rt;childrenIter(allRoutes[key],key);k=key}}if(service?.name&&includeClassName){allRoutes[service.name+routeFormat+k]=rt;delete allRoutes[k]}else allRoutes[k]=rt}}}}};allRoutes[tag]=routes[tag];childrenIter(routes[tag],tag)}top:for(const route in allRoutes){if(typeof allRoutes[route]==="object"){let r=allRoutes[route];if(typeof r==="object"){if(customRoutes){for(const key in customRoutes){r=customRoutes[key](r,route,allRoutes);if(!r)continue top}}if(r.get){if(typeof r.get=="object"){}}if(r.post){}if(r.delete){}if(r.put){}if(r.head){}if(r.patch){}if(r.options){}if(r.connect){}if(r.trace){}if(r.post&&!r.operator){allRoutes[route].operator=r.post}else if(!r.operator&&typeof r.get=="function"){allRoutes[route].operator=r.get}}}}for(const route in routes){if(typeof routes[route]==="object"){if(this.routes[route]){if(typeof this.routes[route]==="object")Object.assign(this.routes[route],routes[route]);else this.routes[route]=routes[route]}else this.routes[route]=routes[route]}else if(this.routes[route]){if(typeof this.routes[route]==="object")Object.assign(this.routes[route],routes[route]);else this.routes[route]=routes[route]}else this.routes[route]=routes[route]}if(service){for(const key in this.routes){if(this.routes[key]instanceof GraphNode||this.routes[key].constructor.name.includes("GraphNode")){this.nodes.set(key,this.routes[key]);this.nNodes=this.nodes.size}}}else this.setTree(this.routes);for(const prop in this.routes){if(this.routes[prop]?.aliases){let aliases=this.routes[prop].aliases;aliases.forEach(a=>{if(service?.name&&includeClassName)routes[service.name+routeFormat+a]=this.routes[prop];else routes[a]=this.routes[prop]})}}return this.routes};this.unload=(routes=this.routes)=>{if(!routes)return;let service;if(!(routes instanceof Service)&&typeof routes==="function"){service=new Service;routes=service.routes}else if(routes instanceof Service){routes=routes.routes}for(const r in routes){delete this.routes[r];if(this.nodes.get(r))this.remove(r)}return this.routes};this.handleMethod=(route,method,args)=>{let m=method.toLowerCase();let src=this.nodes.get(route);if(!src){src=this.routes[route];if(!src)src=this.tree[route]}if(src?.[m]){if(!(src[m]instanceof Function)){if(args)src[m]=args;return src[m]}else return src[m](args)}else return this.handleServiceMessage({route,args,method})};this.transmit=(...args)=>{if(typeof args[0]==="object"){if(args[0].method){return this.handleMethod(args[0].route,args[0].method,args[0].args)}else if(args[0].route){return this.handleServiceMessage(args[0])}else if(args[0].node){return this.handleGraphNodeCall(args[0].node,args[0].args)}else if(this.keepState){if(args[0].route)this.setState({[args[0].route]:args[0].args});if(args[0].node)this.setState({[args[0].node]:args[0].args})}return args}else return args};this.receive=(...args)=>{if(args[0]){if(typeof args[0]==="string"){let substr=args[0].substring(0,8);if(substr.includes("{")||substr.includes("[")){if(substr.includes("\\"))args[0]=args[0].replace(/\\/g,"");if(args[0][0]==='"'){args[0]=args[0].substring(1,args[0].length-1)};args[0]=JSON.parse(args[0])}}}if(typeof args[0]==="object"){if(args[0].method){return this.handleMethod(args[0].route,args[0].method,args[0].args)}else if(args[0].route){return this.handleServiceMessage(args[0])}else if(args[0].node){return this.handleGraphNodeCall(args[0].node,args[0].args)}else if(this.keepState){if(args[0].route)this.setState({[args[0].route]:args[0].args});if(args[0].node)this.setState({[args[0].node]:args[0].args})}return args}else return args};this.pipe=(source,destination,endpoint,method,callback)=>{if(source instanceof GraphNode){if(callback)return source.subscribe(res=>{let mod=callback(res);if(mod!==void 0)this.transmit({route:destination,args:mod,method});else this.transmit({route:destination,args:res,method},endpoint)});else return this.subscribe(source,res=>{this.transmit({route:destination,args:res,method},endpoint)})}else if(typeof source==="string")return this.subscribe(source,res=>{this.transmit({route:destination,args:res,method},endpoint)})};this.pipeOnce=(source,destination,endpoint,method,callback)=>{if(source instanceof GraphNode){if(callback)return source.state.subscribeTriggerOnce(source.tag,res=>{let mod=callback(res);if(mod!==void 0)this.transmit({route:destination,args:mod,method});else this.transmit({route:destination,args:res,method},endpoint)});else return this.state.subscribeTriggerOnce(source.tag,res=>{this.transmit({route:destination,args:res,method},endpoint)})}else if(typeof source==="string")return this.state.subscribeTriggerOnce(source,res=>{this.transmit({route:destination,args:res,method},endpoint)})};this.terminate=(...args)=>{this.nodes.forEach(n=>{n.stopNode()})};this.recursivelyAssign=(target,obj)=>{for(const key in obj){if(typeof obj[key]==="object"){if(typeof target[key]==="object")this.recursivelyAssign(target[key],obj[key]);else target[key]=this.recursivelyAssign({},obj[key])}else target[key]=obj[key]}return target};this.defaultRoutes={"/":{get:()=>{return this.print()},aliases:[""]},ping:()=>{console.log("ping");return"pong"},echo:(...args)=>{this.transmit(...args);return args},assign:source=>{if(typeof source==="object"){Object.assign(this,source);return true}return false},recursivelyAssign:source=>{if(typeof source==="object"){this.recursivelyAssign(this,source);return true}return false},log:{post:(...args)=>{console.log("Log: ",...args)},aliases:["info"]},error:message=>{let er=new Error(message);console.error(message);return er},state:key=>{if(key){return this.state.data[key]}else return this.state.data},printState:key=>{if(key){return stringifyWithCircularRefs(this.state.data[key])}else return stringifyWithCircularRefs(this.state.data)},spliceTypedArray:this.spliceTypedArray,transmit:this.transmit,receive:this.receive,load:this.load,unload:this.unload,pipe:this.pipe,terminate:this.terminate,run:this.run,subscribe:this.subscribe,subscribeNode:this.subscribeNode,unsubscribe:this.unsubscribe,stopNode:this.stopNode,get:this.get,add:this.add,remove:this.remove,setTree:this.setTree,setState:this.setState,print:this.print,reconstruct:this.reconstruct,handleMethod:this.handleMethod,handleServiceMessage:this.handleServiceMessage,handleGraphNodeCall:this.handleGraphNodeCall};if(options.name)this.name=options.name;else options.name=this.tag;if("loadDefaultRoutes"in options){this.loadDefaultRoutes=options.loadDefaultRoutes;this.routes=Object.assign(this.defaultRoutes,this.routes)}if(options||Object.keys(this.routes).length>0)this.init(options)}handleServiceMessage(message){let call;if(typeof message==="object"){if(message.route)call=message.route;else if(message.node)call=message.node}if(call){if(Array.isArray(message.args))return this.run(call,...message.args);else return this.run(call,message.args)}else return message}handleGraphNodeCall(route,args){if(!route)return args;if(args?.args){this.handleServiceMessage(args)}else if(Array.isArray(args))return this.run(route,...args);else return this.run(route,args)}isTypedArray(x){return ArrayBuffer.isView(x)&&Object.prototype.toString.call(x)!=="[object DataView]"}spliceTypedArray(arr,start,end){let s=arr.subarray(0,start);let e;if(end){e=arr.subarray(end+1)}let n;if(s.length>0||e?.length>0)n=new arr.constructor(s.length+e.length);if(s.length>0)n.set(s);if(e&&e.length>0)n.set(e,s.length);return n}};var Systems={collision:{tag:"collision",setupEntities:function(entities){for(const key in entities){const entity=entities[key];if(entity.components){if(!entity.components[this.tag])continue}this.setupEntity(entity)}return entities},setupEntity:function(entity){if(!("collisionEnabled"in entity))entity.collisionEnabled=true;if(!entity.collisionType)entity.collisionType="sphere";if(!entity.collisionRadius)entity.collisionRadius=1;if(!entity.collisionBoundsScale)entity.collisionBoundsScale={x:1,y:1,z:1};if(!entity.colliding)entity.colliding={};if(!entity.position)entity.position={x:0,y:0,z:0};return entity},operator:function(entities){let keys=this.entityKeys;for(let i=0;i<keys.length;i++){const entity1=entities[keys[i]];if(entity1.components){if(!entity1.components[this.tag]||!entity1.collisionEnabled)continue}if(!entity1.collisionEnabled)continue;for(let j=0;j<keys.length;j++){if(i===j)continue;const entity2=entities[keys[j]];if(entity2.components){if(!entity2.components[this.tag])continue}if(!entity2.collisionEnabled)continue;let colliding=Systems.collision.collisionCheck(entity1,entity2);if(colliding!==false){if(!entity1.colliding)entity1.colliding={};if(!entity2.colliding)entity2.colliding={};entity1.colliding[entity2.tag]=colliding;entity2.colliding[entity1.tag]=colliding}}}return entities},collisionCheck:(body1,body2)=>{if(body1.collisionEnabled===false||body2.collisionEnabled===false)return false;const dist=Systems.collision.distance(body1.position,body2.position);if(dist<Math.max(...Object.values(body1.collisionBoundsScale))*body1.collisionRadius+Math.max(...Object.values(body2.collisionBoundsScale))*body2.collisionRadius){let isColliding=false;if(body1.collisionType==="sphere"){if(body2.collisionType==="sphere"){isColliding=Systems.collision.sphereCollisionCheck(body1,body2,dist)}else if(body2.collisionType==="box"){isColliding=Systems.collision.sphereBoxCollisionCheck(body1,body2,dist)}else if(body2.collisionType==="point"){isColliding=Systems.collision.isPointInsideSphere(body2.position,body1,dist)}}else if(body1.collisionType==="box"){if(body2.collisionType==="sphere"){isColliding=Systems.collision.sphereBoxCollisionCheck(body2,body1,dist)}else if(body2.collisionType==="box"){isColliding=Systems.collision.boxCollisionCheck(body1,body2)}else if(body2.collisionType==="point"){isColliding=Systems.collision.isPointInsideBox(body1.position,body1)}}else if(body1.collisionType==="point"){if(body2.collisionType==="sphere"){isColliding=Systems.collision.isPointInsideSphere(body1.position,body2,dist)}else if(body2.collisionType==="box"){isColliding=Systems.collision.isPointInsideBox(body1.position,body2)}}if(isColliding)return dist}return false},sphereCollisionCheck:(body1,body2,dist)=>{if(dist===void 0)dist=Systems.collision.distance(body1.position,body2.position);return dist<body1.collisionRadius+body2.collisionRadius},boxCollisionCheck:(body1,body2)=>{let body1minX=(body1.position.x-body1.collisionRadius)*body1.collisionBoundsScale.x;let body1maxX=(body1.position.x+body1.collisionRadius)*body1.collisionBoundsScale.x;let body1minY=(body1.position.y-body1.collisionRadius)*body1.collisionBoundsScale.y;let body1maxY=(body1.position.y+body1.collisionRadius)*body1.collisionBoundsScale.y;let body1minZ=(body1.position.z-body1.collisionRadius)*body1.collisionBoundsScale.z;let body1maxZ=(body1.position.z+body1.collisionRadius)*body1.collisionBoundsScale.z;let body2minX=(body2.position.x-body2.collisionRadius)*body1.collisionBoundsScale.x;let body2maxX=(body2.position.x+body2.collisionRadius)*body1.collisionBoundsScale.x;let body2minY=(body2.position.y-body2.collisionRadius)*body1.collisionBoundsScale.y;let body2maxY=(body2.position.y+body2.collisionRadius)*body1.collisionBoundsScale.y;let body2minZ=(body2.position.z-body2.collisionRadius)*body1.collisionBoundsScale.z;let body2maxZ=(body2.position.z+body2.collisionRadius)*body1.collisionBoundsScale.z;return(body1maxX<=body2maxX&&body1maxX>=body2minX||body1minX<=body2maxX&&body1minX>=body2minX)&&(body1maxY<=body2maxY&&body1maxY>=body2minY||body1minY<=body2maxY&&body1minY>=body2minY)&&(body1maxZ<=body2maxZ&&body1maxZ>=body2minZ||body1minZ<=body2maxZ&&body1minZ>=body2minZ)},sphereBoxCollisionCheck:(sphere,box,dist)=>{let boxMinX=(box.position.x-box.collisionRadius)*box.collisionBoundsScale.x;let boxMaxX=(box.position.x+box.collisionRadius)*box.collisionBoundsScale.x;let boxMinY=(box.position.y-box.collisionRadius)*box.collisionBoundsScale.y;let boxMaxY=(box.position.y+box.collisionRadius)*box.collisionBoundsScale.y;let boxMinZ=(box.position.z-box.collisionRadius)*box.collisionBoundsScale.z;let boxMaxZ=(box.position.z+box.collisionRadius)*box.collisionBoundsScale.z;let clamp={x:Math.max(boxMinX,Math.min(sphere.position.x,boxMaxX)),y:Math.max(boxMinY,Math.min(sphere.position.y,boxMaxY)),z:Math.max(boxMinZ,Math.min(sphere.position.z,boxMaxZ))};if(dist===void 0)dist=Systems.collision.distance(sphere.position,clamp);return dist>sphere.collisionRadius},isPointInsideSphere:(point,sphere,dist)=>{if(dist===void 0)dist=Systems.collision.distance(point,sphere.position);return dist<sphere.collisionRadius},isPointInsideBox:(point,box)=>{let boxminX=(box.position.x-box.collisionRadius)*box.collisionBoundsScale.x;let boxmaxX=(box.position.x+box.collisionRadius)*box.collisionBoundsScale.x;let boxminY=(box.position.y-box.collisionRadius)*box.collisionBoundsScale.x;let boxmaxY=(box.position.y+box.collisionRadius)*box.collisionBoundsScale.x;let boxminZ=(box.position.z-box.collisionRadius)*box.collisionBoundsScale.x;let boxmaxZ=(box.position.z+box.collisionRadius)*box.collisionBoundsScale.x;return point.x>=boxminX&&point.x<=boxmaxX&&(point.y>=boxminY&&point.y<=boxmaxY)&&(point.z>=boxminZ&&point.z<=boxmaxZ)},closestPointOnLine:(point,lineStart,lineEnd)=>{let a={x:lineEnd.x-lineStart.x,y:lineEnd.y-lineStart.y,z:lineEnd.z-lineStart.z};let b={x:lineStart.x-point.x,y:lineStart.y-point.y,z:lineStart.z-point.z};let c={x:lineEnd.x-point.x,y:lineEnd.y-point.y,z:lineEnd.z-point.z};let bdota=Systems.collision.dot(b,a);if(bdota<=0)return lineStart;let cdota=Systems.collision.dot(c,a);if(cdota<=0)return lineEnd;let _bdotapluscdota=1/(bdota+cdota);return{x:lineStart.x+(lineEnd.x-lineStart.x)*bdota*_bdotapluscdota,y:lineStart.y+(lineEnd.y-lineStart.y)*bdota*_bdotapluscdota,z:lineStart.z+(lineEnd.z-lineStart.z)*bdota*_bdotapluscdota}},closestPointOnPolygon:(point,t0,t1,t2)=>{let n=Systems.collision.calcNormal(t0,t1,t2);let dist=Systems.collision.dot(point,n)-Systems.collision.dot(t0,n);let projection=Systems.collision.vecadd(point,Systems.collision.vecscale(n,-dist));let v0x=t2[0]-t0[0];let v0y=t2[1]-t0[1];let v0z=t2[2]-t0[2];let v1x=t1[0]-t0[0];let v1y=t1[1]-t0[1];let v1z=t1[2]-t0[2];let v2x=projection[0]-t0[0];let v2y=projection[1]-t0[1];let v2z=projection[2]-t0[2];let dot00=v0x*v0x+v0y*v0y+v0z*v0z;let dot01=v0x*v1x+v0y*v1y+v0z*v1z;let dot02=v0x*v2x+v0y*v2y+v0z*v2z;let dot11=v1x*v1x+v1y*v1y+v1z*v1z;let dot12=v1x*v2x+v1y*v2y+v1z*v2z;let denom2=dot00*dot11-dot01*dot01;if(Math.abs(denom2)<1e-30){return void 0}let _denom=1/denom2;let u=(dot11*dot02-dot01*dot12)*_denom;let v=(dot00*dot12-dot01*dot02)*_denom;if(u>=0&&v>=0&&u+v<1){return projection}else return void 0},calcNormal:(t0,t1,t2,positive=true)=>{var QR=Systems.collision.makeVec(t0,t1);var QS=Systems.collision.makeVec(t0,t2);if(positive===true){return Systems.collision.normalize(Systems.collision.cross3D(QR,QS))}else{return Systems.collision.normalize(Systems.collision.cross3D(QS,QR))}},dot:(v1,v2)=>{let dot=0;for(const key in v1){dot+=v1[key]*v2[key]}return dot},makeVec(p1,p2){return{x:p2.x-p1.x,y:p2.y-p1.y,z:p2.z-p1.z}},vecadd:(v1,v2)=>{let result=Object.assign({},v1);for(const key in result){result[key]+=v2[key]}return result},vecsub:(v1,v2)=>{let result=Object.assign({},v1);for(const key in result){result[key]-=v2[key]}return result},vecmul:(v1,v2)=>{let result=Object.assign({},v1);for(const key in result){result[key]*=v2[key]}return result},vecdiv:(v1,v2)=>{let result=Object.assign({},v1);for(const key in result){result[key]/=v2[key]}return result},vecscale:(v1,scalar)=>{let result=Object.assign({},v1);for(const key in result){result[key]*=scalar}return result},distance:(v1,v2)=>{let distance=0;for(const key in v1){distance+=Math.pow(v1[key]-v2[key],2)}return Math.sqrt(distance)},magnitude:v=>{let magnitude=0;for(const key in v){magnitude+=v[key]*v[key]}return Math.sqrt(magnitude)},normalize:v=>{let magnitude=Systems.collision.magnitude(v);let _mag=magnitude?1/magnitude:0;let vn=Object.assign({},v);for(const key in v){vn[key]=v[key]*_mag}return vn},distance3D(v1,v2){return Math.sqrt((v1.x-v2.x)*(v1.x-v2.x)+(v1.y-v2.y)*(v1.y-v2.y)+(v1.z-v2.z)*(v1.z-v2.z))},cross3D(v1,v2){return{x:v1.y*v2.z-v1.z*v2.y,y:v1.z*v2.x-v1.x*v2.z,z:v1.x*v2.y-v1.y*v2.x}},nearestNeighborSearch(entities,isWithinRadius=1e15){var tree={};;for(const key in entities){let newnode={tag:key,position:void 0,neighbors:[]};newnode.position=entities[key].position;tree[key]=newnode}for(const i in tree){for(const j in tree){var dist=Systems.collision.distance3D(tree[i].position,tree[j].position);if(dist<isWithinRadius){var newNeighbori={tag:j,position:entities[j].position,dist};tree[i].neighbors.push(newNeighbori);var newNeighborj={tag:j,position:entities[i].position,dist};tree[j].neighbors.push(newNeighborj)}}tree[i].neighbors.sort(function(a,b){return a.dist-b.dist})}return tree},generateBoundingVolumeTree(entities,mode="octree",withinRadius=1e15,minEntities=3){let dynamicBoundingVolumeTree={proto:{parent:void 0,children:{},entities:{},collisionType:"box",collisionRadius:1,collisionBoundsScale:{x:1,y:1,z:1},position:{x:0,y:0,z:0}},tree:{}};let maxX,maxY,maxZ;let minX=0,minY=0,minZ=0;let positions={};let minRadius=withinRadius;for(const key in entities){const body=entities[key];let xx=body.position.x+body.collisionRadius*body.collisionBoundsScale.x;let yy=body.position.y+body.collisionRadius*body.collisionBoundsScale.y;let zz=body.position.z+body.collisionRadius*body.collisionBoundsScale.z;if(maxX<xx)maxX=xx;if(minX>xx)minX=xx;if(maxY<yy)maxY=yy;if(minY>yy)minY=yy;if(maxZ<zz)maxZ=zz;if(minZ>zz)minZ=zz;if(minRadius>body.collisionRadius)minRadius=body.collisionRadius;positions[key]=body.position};let head=JSON.parse(JSON.stringify(dynamicBoundingVolumeTree.proto));let boxpos={x:(maxX+minX)*.5,y:(maxY+minY)*.5,z:(maxZ+minZ)*.5};let boxbounds={x:maxX-boxpos.x,y:maxY-boxpos.y,z:maxZ-boxpos.z};head.position=boxpos;head.collisionBoundsScale=boxbounds;head.entities=entities;dynamicBoundingVolumeTree.tree=head;minRadius*=2;if(mode==="octree"){let genOct=function(parentPos,halfbounds){let oct1={x:parentPos.x+halfbounds.x,y:parentPos.y+halfbounds.y,z:parentPos.z+halfbounds.z};let oct2={x:parentPos.x-halfbounds.x,y:parentPos.y+halfbounds.y,z:parentPos.z+halfbounds.z};let oct3={x:parentPos.x+halfbounds.x,y:parentPos.y-halfbounds.y,z:parentPos.z+halfbounds.z};let oct4={x:parentPos.x+halfbounds.x,y:parentPos.y+halfbounds.y,z:parentPos.z-halfbounds.z};let oct5={x:parentPos.x-halfbounds.x,y:parentPos.y-halfbounds.y,z:parentPos.z+halfbounds.z};let oct6={x:parentPos.x-halfbounds.x,y:parentPos.y+halfbounds.y,z:parentPos.z-halfbounds.z};let oct7={x:parentPos.x+halfbounds.x,y:parentPos.y-halfbounds.y,z:parentPos.z-halfbounds.z};let oct8={x:parentPos.x-halfbounds.x,y:parentPos.y-halfbounds.y,z:parentPos.z-halfbounds.z};return[oct1,oct2,oct3,oct4,oct5,oct6,oct7,oct8]},genOctTree=function(head2){let halfbounds={x:head2.collisionBoundsScale.x*.5,y:head2.collisionBoundsScale.y*.5,z:head2.collisionBoundsScale.z*.5};let octPos=genOct(head2.position,halfbounds);let check=Object.assign({},head2.bodies);for(let i=0;i<8;i++){let octquadrant=Object.assign(JSON.parse(JSON.stringify(dynamicBoundingVolumeTree.proto)),{position:octPos[i],collisionBoundsScale:halfbounds});octquadrant.parent=head2;for(const j in check){let collided=Systems.collision.collisionCheck(check[j],octquadrant);if(collided){octquadrant.entities[j]=check[j];delete check[j]}}if(Object.keys(octquadrant.entities).length>minEntities-1){head2.children[i]=octquadrant;octquadrant.parent=head2;if(Object.keys(octquadrant.entities).length>minEntities&&octquadrant.collisionRadius*.5>minRadius){genOctTree(octquadrant)}}}};genOctTree(head);return head}else{let tree=Systems.collision.nearestNeighborSearch(positions,withinRadius);let keys=Object.keys(tree);let tag=keys[Math.floor(Math.random()*keys.length)];let searching=true;let count=0;let genBoundingBoxLevel=(tree2,volumes)=>{let newVolumes={};let foundidxs={};let treekeys=Object.keys(tree2);while(searching&&count<treekeys.length){let node=tree2[tag];let i=0;let j=0;let ux=positions[node.tag].x-volumes[node.tag].collisionBoundsScale.x,uy=positions[node.tag].y-volumes[node.tag].collisionBoundsScale.y,uz=positions[node.tag].z-volumes[node.tag].collisionBoundsScale.z,mx=positions[node.tag].x+volumes[node.tag].collisionBoundsScale.x,my=positions[node.tag].y+volumes[node.tag].collisionBoundsScale.y,mz=positions[node.tag].z+volumes[node.tag].collisionBoundsScale.z;let newvolume=JSON.parse(JSON.stringify(dynamicBoundingVolumeTree.proto));newvolume.tag=`bound${Math.floor(Math.random()*1e15)}`;newvolume.children[node.tag]=volumes[node.tag];newvolume.bodies[node.tag]=entities[node.tag];volumes[node.tag].parent=newvolume;foundidxs[node.tag]=true;i++;j++;let nkeys=Object.keys(node.neighbors);while(i<nkeys.length&&j<3){if(foundidxs[node.neighbors[i].tag]){i++;continue}let uxn=positions[node.neighbors[i].tag].x-volumes[node.neighbors[i].tag].collisionBoundsScale.x,uyn=positions[node.neighbors[i].tag].y-volumes[node.neighbors[i].tag].collisionBoundsScale.y,uzn=positions[node.neighbors[i].tag].z-volumes[node.neighbors[i].tag].collisionBoundsScale.z,mxn=positions[node.neighbors[i].tag].x+volumes[node.neighbors[i].tag].collisionBoundsScale.x,myn=positions[node.neighbors[i].tag].y+volumes[node.neighbors[i].tag].collisionBoundsScale.y,mzn=positions[node.neighbors[i].tag].z+volumes[node.neighbors[i].tag].collisionBoundsScale.z;if(ux>uxn)ux=uxn;if(mx<mxn)mx=mxn;if(uy>uyn)uy=uyn;if(my<myn)my=myn;if(uz>uzn)uz=uzn;if(mz<mzn)mz=mzn;newvolume.children[node.neighbors[i].tag]=volumes[node.neighbors[i].tag];newvolume.entities[node.neighbors[i].tag]=entities[node.neighbors[i].tag];volumes[node.neighbors[i].tag].parent=newvolume;foundidxs[node.neighbors[i].tag]=true;i++;j++}let pos={x:(mx+ux)*.5,y:(my+uy)*.5,z:(mz+uz)*.5};let bounds={x:mx-pos.x,y:my-pos.y,z:mz-pos.z};newvolume.position=pos;newvolume.collisionBoundsScale=bounds;if(newvolume.bodies.length===1)newvolume=node;newVolumes[newvolume.tag]=newvolume;while(i<node.neighbors.length){if(!foundidxs[node.neighbors[i].tag])break;i++}if(i<node.neighbors.length){tag=node.neighbors[i].tag}else if(Object.keys(foundidxs).length<Object.keys(tree2).length){tag=keys[0]}else searching=false;count++}return newVolumes};let result=genBoundingBoxLevel(tree,entities);while(Object.keys(result).length>2){let nextTree=Systems.collision.nearestNeighborSearch(result,withinRadius);result=genBoundingBoxLevel(nextTree,result)}head.children=result;head.children.forEach(n=>{n.parent=head});return head}}},collider:{tag:"collider",lastTime:performance.now(),setupEntities:function(entities){for(const key in entities){const entity=entities[key];if(entity.components){if(!entity.components[this.tag])continue}this.setupEntity(entity)}return entities},setupEntity:function(entity){if(!("collisionEnabled"in entity))Systems.collision.setupEntity(entity);if(!("boundingBox"in entity))entity.boundingBox={bot:0,top:100,left:0,right:100,front:0,back:100};if(!("position"in entity)){Systems.movement.setupEntity(entity)}if(!("restitution"in entity))entity.restitution=1;if(!("useBoundingBox"in entity))entity.useBoundingBox=true;if(!entity.position.x&&!entity.position.y&&!entity.position.z){entity.position.x=Math.random()*entity.boundingBox.right;entity.position.y=Math.random()*entity.boundingBox.back;entity.position.z=Math.random()*entity.boundingBox.top}return entity},operator:function(entities){let keys=this.entityKeys;for(let i=0;i<keys.length;i++){const entity1=entities[keys[i]];if(entity1.components){if(!entity1.components[this.tag]||!entity1.collisionEnabled)continue}if(entity1.useBoundingBox)this.checkBoundingBox(entity1);if(!entity1.collisionEnabled)continue;if(entity1.colliding){for(const key2 in entity1.colliding){const entity2=entities[key2];if(entity1.colliding[key2]===false){delete entity1.colliding[key2];delete entity2.colliding[entity1.tag];continue}if(!entity2.collisionEnabled)continue;if(entity2.collisionType==="box"){this.resolveBoxCollision(entity1,entity2,entity1.colliding[key2])}else{if(entity1.collisionType==="box"){entity1.fixed=true;this.resolveSphereCollisions(entity1,entity2,entity1.colliding[key2]);entity1.fixed=false}else{this.resolveSphereCollisions(entity1,entity2,entity1.colliding[key2]);delete entity2.colliding[entity1.tag]}}delete entity1.colliding[entity2.tag]}delete entity1.colliding}}return entities},checkBoundingBox:entity=>{const xsize=entity.collisionRadius*entity.collisionBoundsScale.x;const ysize=entity.collisionRadius*entity.collisionBoundsScale.y;const zsize=entity.collisionRadius*entity.collisionBoundsScale.z;if(entity.position.y-ysize<=entity.boundingBox.front){entity.velocity.y*=-entity.restitution;entity.position.y=entity.boundingBox.front+ysize}if(entity.position.y+ysize>=entity.boundingBox.back){entity.velocity.y*=-entity.restitution;entity.position.y=entity.boundingBox.back-ysize}if(entity.position.x-xsize<=entity.boundingBox.left){entity.velocity.x*=-entity.restitution;entity.position.x=entity.boundingBox.left+xsize}if(entity.position.x+xsize>=entity.boundingBox.right){entity.velocity.x*=-entity.restitution;entity.position.x=entity.boundingBox.right-xsize}if(entity.position.z-zsize<=entity.boundingBox.bot){entity.velocity.z*=-entity.restitution;entity.position.z=entity.boundingBox.bot+zsize}if(entity.position.z+zsize>=entity.boundingBox.top){entity.velocity.z*=-entity.restitution;entity.position.z=entity.boundingBox.top-zsize}},resolveBoxCollision:(body1,box,negate)=>{let positionVec=Systems.collision.makeVec(body1.position,box.position);var directionVec=Object.values(positionVec);let closestSide;let closestDist=Infinity;let mul=-1;if(directionVec[idx]<0)mul=1;if(negate)mul=-mul;for(const key in body1.position){let dist=Math.abs(box.position[key]-body1.position[key]);if(dist<closestDist&&Math.abs(box.position[key]-body1.position[key]+body1.velocity[key]*1e-17)<dist){closestSide=key;closestDist=dist}}var idx=directionVec.indexOf(closestSide);if(idx===0)idx="x";if(idx===1)idx="y";if(idx===2)idx="z";if(idx===3)idx="w";let boxEdgeAxisPosition=box.position[idx]+box.collisionRadius*box.collisionBoundsScale[idx]*mul;if(negate){let body1Offset=boxEdgeAxisPosition-body1.collisionRadius*body1.collisionBoundsScale[idx]*mul;body1.position[idx]=body1Offset}else{let body1Offset=boxEdgeAxisPosition+body1.collisionRadius*body1.collisionBoundsScale[idx]*mul;body1.position[idx]=body1Offset}body1.velocity[idx]=-body1.velocity[idx]*body1.restitution;if(negate)body1.force[idx]=-body1.velocity[idx];var body2AccelMag=Systems.collision.magnitude(box.acceleration);var body2AccelNormal=Systems.collision.normalize(box.acceleration);body1.force[idx]=-body2AccelNormal[idx]*body2AccelMag*box.mass;if(negate)body1.force[idx]=-body1.force[idx]},resolveSphereCollisions:(entity1,entity2,dist)=>{if(dist===void 0)dist=Systems.collision.distance(entity1.position,entity2.position);let vecn=Systems.collision.normalize(Systems.collision.makeVec(entity1.position,entity2.position));let sumMass=entity1.mass+entity2.mass;let ratio=entity1.mass/sumMass;let rmin=1-ratio;if(entity1.fixed===false){entity1.position.x+=vecn.x*rmin*1.01;entity1.position.y+=vecn.y*rmin*1.01;entity1.position.z+=vecn.z*rmin*1.001}else{entity2.position.x-=vecn.x*1.01;entity2.position.y-=vecn.y*1.01;entity2.position.z-=vecn.z*1.01}if(entity2.fixed===false){entity2.position.x+=vecn.x*ratio*1.01;entity2.position.y+=vecn.y*ratio*1.01;entity2.position.z+=vecn.z*ratio*1.01}else{entity1.position.x+=vecn.x*1.01;entity1.position.y+=vecn.y*1.01;entity1.position.z+=vecn.z*1.01}dist=Systems.collision.distance(entity1.position,entity2.position);let vrel={x:entity1.velocity.x-entity2.velocity.x,y:entity1.velocity.y-entity2.velocity.y,z:entity1.velocity.z-entity2.velocity.z};let speed=vrel.x*vecn.x+vrel.y*vecn.y+vrel.z*vecn.z;if(speed>0){let impulse=2*speed/sumMass;if(entity1.fixed===false){entity1.velocity.x-=impulse*vecn.x*entity2.mass*entity1.restitution;entity1.velocity.y-=impulse*vecn.y*entity2.mass*entity1.restitution;entity1.velocity.z-=impulse*vecn.z*entity2.mass*entity1.restitution}if(entity2.fixed===false){entity2.velocity.x+=impulse*vecn.x*entity2.mass*entity2.restitution/entity2.mass;entity2.velocity.y+=impulse*vecn.y*entity2.mass*entity2.restitution/entity2.mass;entity2.velocity.z+=impulse*vecn.z*entity2.mass*entity2.restitution/entity2.mass}}}},nbody:{tag:"nbody",lastTime:performance.now(),G:6674e-14,frameMax:10,setupEntities:function(entities){for(const key in entities){const entity=entities[key];if(entity.components){if(!entity.components[this.tag])continue}this.setupEntity(entity)}return entities},setupEntity:function(entity){if(!("collisionEnabled"in entity))Systems.collider.setupEntity(entity);entity.isAttractor=true;if(!("attractorGroup"in entity))entity.attractorGroup=0;if(!("attractorGroupRules"in entity))entity.attractorGroupRules={0:this.G};return entity},operator:function(entities){let keys=this.entityKeys;for(let i=0;i<keys.length;i++){const entity=entities[keys[i]];if(entity.components){if(!entity.components[this.tag])continue}if(!entity.mass)continue;let nSearched=0;nested:for(let j=0;j<keys.length;j++){let randKey=keys[Math.floor(Math.random()*keys.length)];nSearched++;const entity2=entities[randKey];if(nSearched>this.frameMax)break nested;if(entity2.components){if(!entity2.components[this.tag])continue nested}if(!entity2.mass||!entity2.isAttractor)continue nested;this.attract(entity,entity2,void 0,this.G)}}return entities},attract:function(body1,body2,dist,G=this.G,vecn){if(dist===void 0)dist=Systems.collision.distance3D(body1.position,body2.position);if(vecn===void 0)vecn=Systems.collision.normalize(Systems.collision.makeVec(body1.position,body2.position));let Fg=0;if(dist<.1)dist=.1;if(body1.attractorGroupRules[body2.attractorGroup]){Fg=body1.attractorGroupRules[body2.attractorGroup]*body1.mass*body2.mass/(dist*dist)}else Fg=G*body1.mass*body2.mass/(dist*dist);body1.force.x+=vecn.x*Fg;body1.force.y+=vecn.y*Fg;body1.force.z+=vecn.z*Fg;body2.force.x-=vecn.x*Fg;body2.force.y-=vecn.y*Fg;body2.force.z-=vecn.z*Fg}},boid:{tag:"boid",lastTime:performance.now(),defaultAnchor:{x:Math.random(),y:Math.random(),z:Math.random(),mul:.006},setupEntities:function(entities){for(const key in entities){const entity=entities[key];this.setupEntity(entity)}return entities},setupEntity:function(entity){if(!entity.position){Systems.collider.setupEntity(entity)}let adjustedAnchor=Object.assign({},this.defaultAnchor);adjustedAnchor.x*=entity.boundingBox.right;adjustedAnchor.y*=entity.boundingBox.back;adjustedAnchor.z*=entity.boundingBox.top;let boidDefaults={cohesion:1e-5,separation:1e-4,alignment:.006,swirl:adjustedAnchor,attractor:Object.assign(adjustedAnchor,{mul:.002}),useCohesion:true,useSeparation:true,useAlignment:true,useSwirl:true,useAttractor:true,useAttraction:false,groupRadius:200,groupSize:5,searchLimit:5};if(!entity.boid){entity.boid=boidDefaults}else entity.boid=Object.assign(boidDefaults,entity.boid);if(this.entityKeys.length>1e3){entity.boid.groupSize=1;entity.boid.searchLimit=1}return entity},operator:function(entities){let now=performance.now();let timeStep=now-this.lastTime;this.lastTime=now;let keys=this.entityKeys;let length=keys.length;let _timeStep=1/timeStep;let w=-1;outer:for(let i=0;i<keys.length;i++){w++;let p0=entities[keys[i]];const inRange=[];const distances=[];const boidVelocities=[p0.position.x,p0.position.y,p0.position.z,0,0,0,p0.velocity.x,p0.velocity.y,p0.velocity.z,0,0,0,0,0,0,0,0,0];let groupCount=1;let k=-1;nested:for(let j=0;j<keys.length;j++){k++;if(distances.length>p0.boid.groupSize||k>p0.boid.searchLimit){break nested}let randj=keys[Math.floor(Math.random()*length)];if(k===w||randj===keys[i]||inRange.indexOf(randj)>-1){continue nested}else{let pr=entities[randj];let disttemp=Math.sqrt((p0.position.x-pr.position.x)*(p0.position.x-pr.position.x)+(p0.position.y-pr.position.y)*(p0.position.y-pr.position.y)+(p0.position.z-pr.position.z)*(p0.position.z-pr.position.z));if(disttemp>p0.boid.groupRadius){continue nested}else{distances.push(disttemp);inRange.push(randj);let distInv;if(p0.boid.useSeparation||p0.boid.useAlignment){distInv=p0.boid.groupRadius/(disttemp*disttemp);if(distInv>p0.maxSpeed)distInv=p0.maxSpeed;else if(distInv<-p0.maxSpeed)distInv=-p0.maxSpeed}if(p0.boid.useCohesion){boidVelocities[0]+=(pr.position.x-p0.position.x)*.5*disttemp*_timeStep;boidVelocities[1]+=(pr.position.y-p0.position.y)*.5*disttemp*_timeStep;boidVelocities[2]+=(pr.position.z-p0.position.z)*.5*disttemp*_timeStep}if(isNaN(disttemp)||isNaN(boidVelocities[0])||isNaN(pr.position.x)){console.log(disttemp,i,randj,p0.position,pr.position,boidVelocities);p0.position.x=NaN;return}if(p0.boid.useSeparation){boidVelocities[3]=boidVelocities[3]+(p0.position.x-pr.position.x)*distInv;boidVelocities[4]=boidVelocities[4]+(p0.position.y-pr.position.y)*distInv;boidVelocities[5]=boidVelocities[5]+(p0.position.z-pr.position.z)*distInv}if(p0.boid.useAttraction&&pr.boid.useAttraction){Systems.nbody.attract(p0,pr,disttemp)}if(p0.boid.useAlignment){boidVelocities[6]=boidVelocities[6]+pr.velocity.x*distInv;boidVelocities[7]=boidVelocities[7]+pr.velocity.y*distInv;boidVelocities[8]=boidVelocities[8]+pr.velocity.z*distInv}groupCount++}}}let _groupCount=1/groupCount;if(p0.boid.useCohesion){boidVelocities[0]=p0.boid.cohesion*(boidVelocities[0]*_groupCount);boidVelocities[1]=p0.boid.cohesion*(boidVelocities[1]*_groupCount);boidVelocities[2]=p0.boid.cohesion*(boidVelocities[2]*_groupCount)}else{boidVelocities[0]=0;boidVelocities[1]=0;boidVelocities[2]=0}if(p0.boid.useSeparation){boidVelocities[3]=p0.boid.separation*boidVelocities[3];boidVelocities[4]=p0.boid.separation*boidVelocities[4];boidVelocities[5]=p0.boid.separation*boidVelocities[5]}else{boidVelocities[3]=0;boidVelocities[4]=0;boidVelocities[5]=0}if(p0.boid.useAlignment){boidVelocities[6]=-(p0.boid.alignment*boidVelocities[6]*_groupCount);boidVelocities[7]=p0.boid.alignment*boidVelocities[7]*_groupCount;boidVelocities[8]=p0.boid.alignment*boidVelocities[8]*_groupCount}else{boidVelocities[6]=0;boidVelocities[7]=0;boidVelocities[8]=0}const swirlVec=[0,0,0];if(p0.boid.useSwirl==true){boidVelocities[9]=-(p0.position.y-p0.boid.swirl.y)*p0.boid.swirl.mul;boidVelocities[10]=(p0.position.z-p0.boid.swirl.z)*p0.boid.swirl.mul;boidVelocities[11]=(p0.position.x-p0.boid.swirl.x)*p0.boid.swirl.mul}const attractorVec=[0,0,0];if(p0.boid.useAttractor==true){boidVelocities[12]=(p0.boid.attractor.x-p0.position.x)*p0.boid.attractor.mul;if(p0.position.x>p0.boundingBox.left||p0.position.x<p0.boundingBox.right){boidVelocities[12]*=3}boidVelocities[13]=(p0.boid.attractor.y-p0.position.y)*p0.boid.attractor.mul;if(p0.position.y>p0.boundingBox.top||p0.position.y<p0.boundingBox.bottom){boidVelocities[13]*=3}boidVelocities[14]=(p0.boid.attractor.z-p0.position.z)*p0.boid.attractor.mul;if(p0.position.z>p0.boundingBox.front||p0.position.z<p0.boundingBox.back){boidVelocities[14]*=3}}p0.velocity.x=p0.velocity.x+boidVelocities[0]+boidVelocities[3]+boidVelocities[6]+boidVelocities[9]+boidVelocities[12]+boidVelocities[15],p0.velocity.y=p0.velocity.y+boidVelocities[1]+boidVelocities[4]+boidVelocities[7]+boidVelocities[10]+boidVelocities[13]+boidVelocities[16],p0.velocity.z=p0.velocity.z+boidVelocities[2]+boidVelocities[5]+boidVelocities[8]+boidVelocities[11]+boidVelocities[14]+boidVelocities[17];if(isNaN(p0.velocity.x))console.error(p0,i,groupCount,p0.position,p0.velocity,swirlVec,attractorVec)}return entities}},movement:{tag:"movement",lastTime:performance.now(),setupEntities:function(entities){for(const key in entities){const entity=entities[key];if(entity.components){if(!entity.components[this.tag])continue}this.setupEntity(entity)}},setupEntity:function(entity){if(!("mass"in entity))entity.mass=1;if(!("fixed"in entity))entity.fixed=false;if(!entity.force)entity.force={x:0,y:0,z:0};if(!("mass"in entity))entity.mass=1;if(!("gravity"in entity))entity.gravity=-9.81;if(!entity.acceleration)entity.acceleration={x:0,y:0,z:0};if(!entity.velocity)entity.velocity={x:0,y:0,z:0};if(!("maxSpeed"in entity))entity.maxSpeed=10;if(!entity.position)entity.position={x:0,y:0,z:0};return entity},operator:function(entities){let now=performance.now();let timeStep=(now-this.lastTime)*.001;this.lastTime=now;let keys=this.entityKeys;for(let i=0;i<keys.length;i++){const entity=entities[keys[i]];if(entity.components){if(!entity.components[this.tag])continue}if(entity.fixed)continue;if(entity.mass){if(entity.force.x){entity.acceleration.x+=entity.force.x/entity.mass;entity.force.x=0}if(entity.force.y){entity.acceleration.y+=entity.force.y/entity.mass;entity.force.y=0}if(entity.force.z){entity.acceleration.z+=entity.force.z/entity.mass+entity.gravity;entity.force.z=0}}if(entity.drag){if(entity.acceleration.x)entity.acceleration.x-=entity.acceleration.x*entity.drag*timeStep;if(entity.acceleration.y)entity.acceleration.y-=entity.acceleration.y*entity.drag*timeStep;if(entity.acceleration.z)entity.acceleration.z-=entity.acceleration.z*entity.drag*timeStep}if(entity.acceleration.x)entity.velocity.x+=entity.acceleration.x*timeStep;if(entity.acceleration.y)entity.velocity.y+=entity.acceleration.y*timeStep;if(entity.acceleration.z)entity.velocity.z+=entity.acceleration.z*timeStep;if(entity.maxSpeed>0){let magnitude=Systems.collision.magnitude(entity.velocity);if(magnitude>entity.maxSpeed){let scalar=entity.maxSpeed/magnitude;entity.velocity.x*=scalar;entity.velocity.y*=scalar;entity.velocity.z*=scalar}}if(entity.velocity.x)entity.position.x+=entity.velocity.x*timeStep;if(entity.velocity.y)entity.position.y+=entity.velocity.y*timeStep;if(entity.velocity.z)entity.position.z+=entity.velocity.z*timeStep}return entities}}};var import_sjcl=__toESM2(require_sjcl());var _HTTPfrontend=class extends Service{constructor(options,path,fetched){super(options);this.name="http";this.fetchProxied=false;this.listening={};this.GET=(url2="http://localhost:8080/ping",type="",mimeType)=>{if(type==="json")mimeType="application/json";return new Promise((resolve,reject)=>{let xhr=_HTTPfrontend.request({method:"GET",url:url2,responseType:type,mimeType,onload:ev=>{let data;if(xhr.responseType===""||xhr.responseType==="text")data=xhr.responseText;else data=xhr.response;if(url2 instanceof URL)url2=url2.toString();this.setState({[url2]:data});resolve(data)},onabort:er=>{reject(er)}})}).catch(console.error)};this.POST=(message,url2="http://localhost:8080/echo",type="",mimeType)=>{if(typeof message==="object"&&(type==="json"||type==="text"||!type)){message=JSON.stringify(message)}if(type==="json")mimeType="application/json";return new Promise((resolve,reject)=>{let xhr=_HTTPfrontend.request({method:"POST",url:url2,data:message,responseType:type,mimeType,onload:ev=>{let data;if(xhr.responseType===""||xhr.responseType==="text")data=xhr.responseText;else data=xhr.response;if(url2 instanceof URL)url2=url2.toString();this.setState({[url2]:data});resolve(data)},onabort:er=>{reject(er)}})}).catch(console.error)};this.transmit=(message,url2)=>{let obj=message;if(typeof obj==="object"){message=JSON.stringify(obj)}if(obj?.method?.toLowerCase()=="get"||message?.toLowerCase()==="get")return this.GET(url2);return this.post(message,url2)};this.transponder=(url2,message,type="",mimeType)=>{if(typeof message==="object")message=JSON.stringify(message);let method="GET";if(message){method="POST"}if(type==="json")mimeType="application/json";else return new Promise((resolve,reject)=>{let xhr=_HTTPfrontend.request({method,url:url2,data:message,responseType:type,onload:ev=>{let body=xhr.response;if(typeof body==="string"){let substr=body.substring(0,8);if(substr.includes("{")||substr.includes("[")){if(substr.includes("\\"))body=body.replace(/\\/g,"");if(body[0]==='"'){body=body.substring(1,body.length-1)};body=JSON.parse(body)}}if(typeof body?.method==="string"){return resolve(this.handleMethod(body.route,body.method,body.args))}else if(typeof body?.route==="string"){return resolve(this.handleServiceMessage(body))}else if(typeof body?.node==="string"||body.node instanceof GraphNode){return resolve(this.handleGraphNodeCall(body.node,body.args))}else return resolve(body)},onabort:er=>{reject(er)}})}).catch(console.error)};this.listen=(path2="0",fetched2=async(clone,args,response)=>{const result=await clone.text();const returned=this.receive(result);this.setState({[response.url]:returned})})=>{this.listening[path2]={};let listenerId=`${path2}${Math.floor(Math.random()*1e15)}`;this.listening[path2][listenerId]=fetched2;if(!this.fetchProxied){globalThis.fetch=new Proxy(globalThis.fetch,{apply(fetch,that,args){const result=fetch.apply(that,args);result.then(response=>{if(!response.ok)return;if(this.listening["0"]){for(const key in this.listeners){const clone=response.clone();this.listening["0"][key](clone,args,response)}}else{for(const key in this.listening){if(response.url.includes(key)){for(const key2 in this.listening[path2]){const clone=response.clone();this.listening[path2][key2](clone,args,response)}break}}}}).catch(er=>{console.error(er)});return result}});this.fetchProxied=true}return listenerId};this.stopListening=(path2,listener)=>{if(!path2&&path2!==0){for(const key in this.listening)delete this.listening[key]}else{if(!listener)delete this.listening[path2];else delete this.listeners[listener]}};this.routes={request:this.request,GET:this.GET,POST:this.POST,transponder:this.transponder,listen:this.listen,stopListening:this.stopListening};this.load(this.routes);this.listen(path,fetched)}};var HTTPfrontend=_HTTPfrontend;HTTPfrontend.request=options=>{const xhr=new XMLHttpRequest;if(options.responseType)xhr.responseType=options.responseType;else options.responseType="json";if(options.mimeType){xhr.overrideMimeType(options.mimeType)}if(options.onload)xhr.addEventListener("load",options.onload,false);if(options.onprogress)xhr.addEventListener("progress",options.onprogress,false);if(options.onabort)xhr.addEventListener("abort",options.onabort,false);if(options.onloadend)xhr.addEventListener("loadend",options.onloadend,false);if(options.onerror)xhr.addEventListener("error",options.onerror,false);xhr.open(options.method,options.url,true,options.user,options.pass);if(!options.onerror)xhr.onerror=function(){xhr.abort()};xhr.send(options.data);return xhr};var import_web_worker=__toESM2(require_browser());var WorkerService=class extends Service{constructor(options){super(options);this.name="worker";this.workers={};this.threadRot=0;this.connections={workers:this.workers};this.customRoutes={"worker":(route,routeKey,routes)=>{let rt=route;if(rt?.worker||rt?.workerId){if(rt.workerUrl)rt.url=rt.workerUrl;if(rt.workerId)rt.tag=rt.workerId;if(!rt.tag)rt.tag=routeKey;rt._id=rt.tag;let worker;if(this.workers[rt._id])worker=this.workers[rt._id];if(!worker)worker=this.addWorker(rt);rt.worker=worker;if(rt.transferFunctions){for(const prop in rt.transferFunctions){this.transferFunction(worker,rt.transferFunctions[prop],prop)}}if(rt.transferClasses){for(const prop in rt.transferClasses){this.transferClass(worker,rt.transferClasses[prop],prop)}}if(worker){if(!rt.operator){rt.operator=(...args)=>{console.log("operator",args);if(rt.callback){if(!this.nodes.get(rt.tag)?.children)worker.post(rt.callback,args);else return worker.run(rt.callback,args)}else{if(!this.nodes.get(rt.tag)?.children)worker.send(args);else return worker.request(args)}}}}}return rt}};this.customChildren={"worker":(child,childRouteKey,parent,routes,checked)=>{let worker;if(child?.worker||child?.workerId){if(child.workerUrl)child.url=child.workerUrl;if(child.workerId)child.tag=child.workerId;if(!child.tag)child.tag=childRouteKey;child._id=child.tag;if(this.workers[child._id])worker=this.workers[child._id];if(!worker)worker=this.addWorker(child);child.worker=worker;if(child.transferFunctions){for(const prop in child.transferFunctions){this.transferFunction(worker,child.transferFunctions[prop],prop)}}if(child.transferClasses){for(const prop in child.transferClasses){this.transferClass(worker,child.transferClasses[prop],prop)}}if(worker){if(!child.operator){child.operator=(...args)=>{console.log("operator",args);if(child.callback){if(!this.nodes.get(child.tag)?.children)worker.post(child.callback,args);else return worker.run(child.callback,args)}else{if(!this.nodes.get(child.tag)?.children)worker.send(args);else return worker.request(args)}}}}}if(child.parentRoute&&(parent?.worker||parent?.workerId)){if(worker){let portId=this.establishMessageChannel(worker,parent.worker.worker);worker.post("subscribeToWorker",child.parentRoute,portId,child.callback)}else{parent.worker.subscribe(child.parentRoute,result=>{this.nodes.get(child.tag?child.tag:childRouteKey).run(result)})}}}};this.addWorker=options2=>{let worker;if(!options2._id)options2._id=`worker${Math.floor(Math.random()*1e15)}`;if(options2.url)worker=new import_web_worker.default(options2.url);else if(options2.port){worker=options2.port}else if(this.workers[options2._id]){if(this.workers[options2._id].port)worker=this.workers[options2._id].port;else worker=this.workers[options2._id].worker}if(!worker)return;let send=(message,transfer)=>{return this.transmit(message,worker,transfer)};let post=(route,args,transfer,method)=>{let message={route,args};if(method)message.method=method;return this.transmit(message,worker,transfer)};let run=(route,args,transfer,method)=>{return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[{route,args},options2._id,callbackId]};if(method)req.args[0].method=method;let onmessage=ev=>{if(typeof ev.data==="object"){if(ev.data.callbackId===callbackId){worker.removeEventListener("message",onmessage);res(ev.data.args)}}};worker.addEventListener("message",onmessage);this.transmit(req,worker,transfer)})};let request=(message,transfer,method)=>{return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[message,options2._id,callbackId]};if(method)req.method=method;let onmessage=ev=>{if(typeof ev.data==="object"){if(ev.data.callbackId===callbackId){worker.removeEventListener("message",onmessage);res(ev.data.args)}}};worker.addEventListener("message",onmessage);this.transmit(req,worker,transfer)})};let subscribe=(route,callback)=>{return this.subscribeToWorker(route,options2._id,callback)};let unsubscribe=(route,sub)=>{return run("unsubscribe",[route,sub])};let terminate=()=>{return this.terminate(options2._id)};if(!options2.onmessage)options2.onmessage=ev=>{this.receive(ev.data);this.setState({[options2._id]:ev.data})};if(!options2.onerror){options2.onerror=ev=>{console.error(ev.data)}}worker.onmessage=options2.onmessage;worker.onerror=options2.onerror;this.workers[options2._id]={worker,send,post,run,request,subscribe,unsubscribe,terminate,graph:this,...options2};return this.workers[options2._id]};this.toObjectURL=scriptTemplate=>{let blob=new Blob([scriptTemplate],{type:"text/javascript"});return URL.createObjectURL(blob)};this.transmit=(message,worker,transfer)=>{if(!transfer){transfer=this.getTransferable(message)}if(worker instanceof import_web_worker.default||worker instanceof MessagePort){worker.postMessage(message,transfer)}else if(typeof worker==="string"){if(this.workers[worker]){if(this.workers[worker].port)this.workers[worker].port.postMessage(message,transfer);else if(this.workers[worker].worker)this.workers[worker].worker.postMessage(message,transfer)}}else{let keys=Object.keys(this.workers);this.workers[keys[this.threadRot]].worker.postMessage(message,transfer);this.threadRot++;if(this.threadRot===keys.length)this.threadRot=0}return message};this.terminate=worker=>{let onclose;if(typeof worker==="string"){let obj=this.workers[worker];if(obj)delete this.workers[worker];worker=obj.worker;if(obj.onclose)onclose=obj.onclose}if(worker instanceof import_web_worker.default){worker.terminate();if(onclose)onclose(worker);return true}if(worker instanceof MessagePort){worker.close();if(onclose)onclose(worker);return true}return false};this.establishMessageChannel=(worker,worker2)=>{let workerId;if(typeof worker==="string"){workerId=worker;if(this.workers[worker]){if(this.workers[worker].port)worker=this.workers[worker].port;else worker2=this.workers[worker].worker}}if(typeof worker2==="string"){if(this.workers[worker2]){if(this.workers[worker2].port)worker2=this.workers[worker2].port;else worker2=this.workers[worker2].worker}}if(worker instanceof import_web_worker.default||worker instanceof MessagePort){let channel=new MessageChannel;let portId=`port${Math.floor(Math.random()*1e15)}`;worker.postMessage({route:"addWorker",args:{port:channel.port1,_id:portId}},[channel.port1]);if(worker2 instanceof import_web_worker.default||worker2 instanceof MessagePort){worker2.postMessage({route:"addWorker",args:{port:channel.port2,_id:portId}},[channel.port2])}else if(workerId&&this.workers[workerId])this.workers[workerId].port=channel.port2;return portId}return false};this.request=(message,workerId,transfer,method)=>{let worker=this.workers[workerId].worker;return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[message,callbackId]};if(method)req.method=method;let onmessage=ev=>{if(typeof ev.data==="object"){if(ev.data.callbackId===callbackId){worker.removeEventListener("message",onmessage);res(ev.data.args)}}};worker.addEventListener("message",onmessage);this.transmit(req,worker,transfer)})};this.runRequest=(message,worker,callbackId)=>{let res=this.receive(message);if(typeof worker==="string"&&this.workers[worker]){if(this.workers[worker].port)worker=this.workers[worker].port;else worker=this.workers[worker].worker}if(res instanceof Promise){res.then(r=>{if(worker instanceof import_web_worker.default||worker instanceof MessagePort)worker.postMessage({args:r,callbackId});else if(typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope)globalThis.postMessage({args:r,callbackId})})}else{if(worker instanceof import_web_worker.default||worker instanceof MessagePort)worker.postMessage({args:res,callbackId});else if(typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope)globalThis.postMessage({args:res,callbackId})}return res};this.subscribeWorker=(route,worker)=>{if(typeof worker==="string"&&this.workers[worker]){if(this.workers[worker].port)worker=this.workers[worker].port;else worker=this.workers[worker].worker}return this.subscribe(route,res=>{if(res instanceof Promise){res.then(r=>{if(worker?.postMessage)worker.postMessage({args:r,callbackId:route});else if(globalThis.postMessage)globalThis.postMessage({args:r,callbackId:route})})}else{if(worker?.postMessage)worker.postMessage({args:res,callbackId:route});else if(globalThis.postMessage)globalThis.postMessage({args:res,callbackId:route})}})};this.subscribeToWorker=(route,workerId,callback)=>{if(typeof workerId==="string"&&this.workers[workerId]){this.subscribe(workerId,res=>{if(res?.callbackId===route){if(!callback)this.setState({[workerId]:res.args});else if(typeof callback==="string"){this.run(callback,res.args)}else callback(res.args)}});return this.workers[workerId].run("subscribeWorker",[route,workerId])}};this.routes={addWorker:{operator:this.addWorker,aliases:["open"]},toObjectURL:this.toObjectURL,request:this.request,runRequest:this.runRequest,establishMessageChannel:this.establishMessageChannel,subscribeWorker:this.subscribeWorker,subscribeToWorker:this.subscribeToWorker,unsubscribe:this.unsubscribe,terminate:this.terminate};this.load(this.routes);if(typeof WorkerGlobalScope!=="undefined"&&globalThis instanceof WorkerGlobalScope){globalThis.onmessage=ev=>{let result=this.receive(ev.data);if(this.keepState)this.setState({[this.name]:result})}}}getTransferable(message){let transfer;if(typeof message==="object"){if(message.args){if(message.args.constructor?.name==="Object"){for(const key in message.args){if(ArrayBuffer.isView(message.args[key])){if(!transfer)transfer=[message.args[key].buffer];else transfer.push(message.args[key].buffer)}else if(message.args[key]?.constructor?.name==="ArrayBuffer"){if(!transfer)transfer=[message.args[key]];else transfer.push(message.args[key])}}}else if(Array.isArray(message.args)&&message.args.length<11){message.args.forEach(arg=>{if(ArrayBuffer.isView(arg)){transfer=[arg.buffer]}else if(arg.constructor?.name==="ArrayBuffer")transfer=[arg]})}else if(ArrayBuffer.isView(message.args)){transfer=[message.args.buffer]}else if(message.args.constructor?.name==="ArrayBuffer"){transfer=[message]}}else if(message.constructor?.name==="Object"){for(const key in message){if(ArrayBuffer.isView(message[key])){if(!transfer)transfer=[message[key].buffer];else transfer.push(message[key].buffer)}else if(message[key]?.constructor?.name==="ArrayBuffer"){if(!transfer)transfer=[message[key]];else transfer.push(message[key])}}}else if(Array.isArray(message)&&message.length<11){message.forEach(arg=>{if(ArrayBuffer.isView(arg)){transfer=[arg.buffer]}else if(arg.constructor?.name==="ArrayBuffer")transfer=[arg]})}else if(ArrayBuffer.isView(message)){transfer=[message.buffer]}else if(message.constructor?.name==="ArrayBuffer"){transfer=[message]}}return transfer}transferFunction(worker,fn,fnName){if(!fnName)fnName=fn.name;return worker.request({route:"setRoute",args:[fn.toString(),fnName]})}transferClass(worker,cls,className){if(!className)className=cls.name;return worker.request({route:"receiveClass",args:[cls.toString(),className]})}};var mouseEventHandler=makeSendPropertiesHandler(["ctrlKey","metaKey","shiftKey","button","pointerType","clientX","clientY","pageX","pageY"]);var wheelEventHandlerImpl=makeSendPropertiesHandler(["deltaX","deltaY"]);var keydownEventHandler=makeSendPropertiesHandler(["ctrlKey","metaKey","shiftKey","keyCode"]);function wheelEventHandler(event,sendFn){event.preventDefault();wheelEventHandlerImpl(event,sendFn)}function preventDefaultHandler(event){event.preventDefault()}function copyProperties(src,properties,dst){for(const name of properties){dst[name]=src[name]}}function makeSendPropertiesHandler(properties){return function sendProperties(event,sendFn){const data={type:event.type};copyProperties(event,properties,data);sendFn(data)}}function touchEventHandler(event,sendFn){const touches=[];const data={type:event.type,touches};for(let i=0;i<event.touches.length;++i){const touch=event.touches[i];touches.push({pageX:touch.pageX,pageY:touch.pageY})}sendFn(data)}var orbitKeys={"37":true,"38":true,"39":true,"40":true};function filteredKeydownEventHandler(event,sendFn){const{keyCode}=event;if(orbitKeys[keyCode]){event.preventDefault();keydownEventHandler(event,sendFn)}}var eventHandlers={contextmenu:preventDefaultHandler,mousedown:mouseEventHandler,mousemove:mouseEventHandler,mouseup:mouseEventHandler,pointerdown:mouseEventHandler,pointermove:mouseEventHandler,pointerup:mouseEventHandler,touchstart:touchEventHandler,touchmove:touchEventHandler,touchend:touchEventHandler,wheel:wheelEventHandler,keydown:filteredKeydownEventHandler};function initProxyElement(element,worker,id){if(!id)id="proxy"+Math.floor(Math.random()*1e15);const sendEvent=data=>{worker.postMessage({route:"handleProxyEvent",args:[data,id]})};let entries=Object.entries(eventHandlers);for(const[eventName,handler]of entries){element.addEventListener(eventName,function(event){handler(event,sendEvent)})}const sendSize=()=>{const rect=element.getBoundingClientRect();sendEvent({type:"resize",left:rect.left,top:rect.top,width:element.clientWidth,height:element.clientHeight})};sendSize();globalThis.addEventListener("resize",sendSize);return id}var EventDispatcher=class{addEventListener(type,listener){if(this._listeners===void 0)this._listeners={};const listeners=this._listeners;if(listeners[type]===void 0){listeners[type]=[]}if(listeners[type].indexOf(listener)===-1){listeners[type].push(listener)}}hasEventListener(type,listener){if(this._listeners===void 0)return false;const listeners=this._listeners;return listeners[type]!==void 0&&listeners[type].indexOf(listener)!==-1}removeEventListener(type,listener){if(this._listeners===void 0)return;const listeners=this._listeners;const listenerArray=listeners[type];if(listenerArray!==void 0){const index=listenerArray.indexOf(listener);if(index!==-1){listenerArray.splice(index,1)}}}dispatchEvent(event,target){if(this._listeners===void 0)return;const listeners=this._listeners;const listenerArray=listeners[event.type];if(listenerArray!==void 0){if(!target)event.target=this;else event.target=target;const array=listenerArray.slice(0);for(let i=0,l=array.length;i<l;i++){array[i].call(this,event)}event.target=null}}};function noop(){}var ElementProxyReceiver=class extends EventDispatcher{constructor(){super();this._listeners={};this.style={};this.setPointerCapture=()=>{};this.releasePointerCapture=()=>{};this.getBoundingClientRect=()=>{return{left:this.left,top:this.top,width:this.width,height:this.height,right:this.left+this.width,bottom:this.top+this.height}};this.handleEvent=data=>{if(data.type==="resize"){this.left=data.left;this.top=data.top;this.width=data.width;this.height=data.height;if(typeof this.proxied==="object"){this.proxied.width=this.width;this.proxied.height=this.height;this.proxied.clientWidth=this.width;this.proxied.clientHeight=this.height}}data.preventDefault=noop;data.stopPropagation=noop;this.dispatchEvent(data,this.proxied)};this.style={}}get clientWidth(){return this.width}get clientHeight(){return this.height}focus(){}};var ProxyManager=class{constructor(){this.targets={};this.makeProxy=(id,addTo=void 0)=>{if(!id)id=`proxyReceiver${Math.floor(Math.random()*1e15)}`;let proxy;if(this.targets[id])proxy=this.targets[id];else{proxy=new ElementProxyReceiver;this.targets[id]=proxy}if(typeof addTo==="object"){addTo.proxy=proxy;proxy.proxied=addTo;console.log(proxy,addTo);addTo.style=proxy.style;if(proxy.width){addTo.width=proxy.width;addTo.clientWidth=proxy.width}if(proxy.height){addTo.height=proxy.height;addTo.clientHeight=proxy.height}addTo.setPointerCapture=proxy.setPointerCapture.bind(proxy);addTo.releasePointerCapture=proxy.releasePointerCapture.bind(proxy);addTo.getBoundingClientRect=proxy.getBoundingClientRect.bind(proxy);addTo.addEventListener=proxy.addEventListener.bind(proxy);addTo.removeEventListener=proxy.removeEventListener.bind(proxy);addTo.handleEvent=proxy.handleEvent.bind(proxy);addTo.dispatchEvent=proxy.dispatchEvent.bind(proxy);addTo.focus=proxy.focus.bind(proxy)}};this.getProxy=id=>{return this.targets[id]};this.handleEvent=(data,id)=>{if(!this.targets[id])this.makeProxy(id);if(this.targets[id]){this.targets[id].handleEvent(data);return true}return void 0};if(!globalThis.document)globalThis.document={}}};var proxyElementWorkerRoutes={initProxyElement,makeProxy:function(id,elm){if(!this.graph.ProxyManager)this.graph.ProxyManager=new ProxyManager;this.graph.ProxyManager.makeProxy(id,elm);return id},handleProxyEvent:function(data,id){if(!this.graph.ProxyManager)this.graph.ProxyManager=new ProxyManager;if(this.graph.ProxyManager.handleEvent(data,id))return data}};var workerCanvasRoutes={...proxyElementWorkerRoutes,transferCanvas:function(worker,options,route){if(!options)return void 0;if(!options._id)options._id=`canvas${Math.floor(Math.random()*1e15)}`;let offscreen=options.canvas.transferControlToOffscreen();let message={route:route?route:"receiveCanvas",args:{canvas:offscreen,context:options.context,_id:options._id}};this.graph.run("initProxyElement",options.canvas,worker,options._id);if(options.draw){if(typeof options.draw==="function")message.args.draw=options.draw.toString();else message.args.draw=options.draw}if(options.update){if(typeof options.update==="function")message.args.update=options.update.toString();else message.args.update=options.update}if(options.init){if(typeof options.init==="function")message.args.init=options.init.toString();else message.args.init=options.init}if(options.clear){if(typeof options.clear==="function")message.args.clear=options.clear.toString();else message.args.clear=options.clear}worker.postMessage(message,[offscreen]);const workercontrols={_id:options._id,worker,draw:props=>{worker.postMessage({route:"drawFrame",args:[options._id,props]})},update:props=>{worker.postMessage({route:"updateCanvas",args:[options._id,props]})},clear:()=>{worker.postMessage({route:"clearCanvas",args:options._id})},init:()=>{console.log("Posting init");worker.postMessage({route:"initCanvas",args:options._id})},stop:()=>{worker.postMessage({route:"stopAnim",args:options._id})},start:()=>{worker.postMessage({route:"startAnim",args:options._id})},set:newDrawProps=>{worker.postMessage({route:"setDraw",args:[newDrawProps,options._id]})}};return workercontrols},receiveCanvas:function(options){if(!this.graph.CANVASES)this.graph.CANVASES={};let canvasOptions=options;options._id?canvasOptions._id=options._id:canvasOptions._id=`canvas${Math.floor(Math.random()*1e15)}`;typeof options.context==="string"?canvasOptions.context=options.canvas.getContext(options.context):canvasOptions.context=options.context;"animating"in options?canvasOptions.animating=options.animating:canvasOptions.animating=true;if(this.graph.CANVASES[canvasOptions._id]){this.graph.run("setDraw",canvasOptions)}else{canvasOptions.graph=this.graph;this.graph.CANVASES[canvasOptions._id]=canvasOptions;this.graph.run("makeProxy",canvasOptions._id,canvasOptions.canvas);if(options.width)canvasOptions.canvas.width=options.width;if(options.height)canvasOptions.canvas.height=options.height;if(typeof canvasOptions.draw==="string"){canvasOptions.draw=parseFunctionFromText(canvasOptions.draw)}if(typeof canvasOptions.update==="string"){canvasOptions.update=parseFunctionFromText(canvasOptions.update)}if(typeof canvasOptions.init==="string"){canvasOptions.init=parseFunctionFromText(canvasOptions.init)}if(typeof canvasOptions.clear==="string"){canvasOptions.clear=parseFunctionFromText(canvasOptions.clear)}if(typeof canvasOptions.init==="function")canvasOptions.init(canvasOptions,canvasOptions.canvas,canvasOptions.context);if(typeof canvasOptions.draw==="function"&&canvasOptions.animating){let draw=(s,canvas,context)=>{if(s.animating){s.draw(s,canvas,context);requestAnimationFrame(()=>{draw(s,canvas,context)})}};draw(canvasOptions,canvasOptions.canvas,canvasOptions.context)}}return canvasOptions._id},setDraw:function(settings,_id){let canvasopts;if(_id)canvasopts=this.graph.CANVASES?.[settings._id];else if(settings._id)canvasopts=this.graph.CANVASES?.[settings._id];else canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]];if(canvasopts){if(settings.canvas){canvasopts.canvas=settings.canvas;this.graph.run("makeProxy",canvasopts._id,canvasopts.canvas)}if(typeof settings.context==="string")canvasopts.context=canvasopts.canvas.getContext(settings.context);else if(settings.context)canvasopts.context=settings.context;if(settings.width)canvasopts.canvas.width=settings.width;if(settings.height)canvasopts.canvas.height=settings.height;if(typeof settings.draw==="string")settings.draw=parseFunctionFromText(settings.draw);if(typeof settings.draw==="function"){canvasopts.draw=settings.draw}if(typeof settings.update==="string")settings.update=parseFunctionFromText(settings.update);if(typeof settings.update==="function"){canvasopts.update=settings.update}if(typeof settings.init==="string")settings.init=parseFunctionFromText(settings.init);if(typeof settings.init==="function"){canvasopts.init=settings.init}if(typeof settings.clear==="string")settings.clear=parseFunctionFromText(settings.clear);if(typeof settings.clear==="function"){canvasopts.clear=settings.clear}return settings._id}return void 0},drawFrame:function(props,_id){let canvasopts;if(!_id)canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]];else canvasopts=this.graph.CANVASES?.[_id];if(canvasopts){if(props)Object.assign(canvasopts,props);if(canvasopts.draw){canvasopts.draw(canvasopts,canvasopts.canvas,canvasopts.context);return _id}}return void 0},clearCanvas:function(_id){let canvasopts;if(!_id)canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]];else canvasopts=this.graph.CANVASES?.[_id];if(canvasopts?.clear){canvasopts.clear(canvasopts,canvasopts.canvas,canvasopts.context);return _id}return void 0},initCanvas:function(_id){let canvasopts;if(!_id)canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]];else canvasopts=this.graph.CANVASES?.[_id];if(canvasopts?.init){canvasopts.init(canvasopts,canvasopts.canvas,canvasopts.context);return _id}return void 0},updateCanvas:function(input,_id){let canvasopts;if(!_id)canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]];else canvasopts=this.graph.CANVASES?.[_id];if(canvasopts?.update){canvasopts.update(canvasopts,canvasopts.canvas,canvasopts.context,input);return _id}return void 0},setProps:function(props,_id){let canvasopts;if(!_id)canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]];else canvasopts=this.graph.CANVASES?.[_id];if(canvasopts){Object.assign(canvasopts,props);if(props.width)canvasopts.canvas.width=props.width;if(props.height)canvasopts.canvas.height=props.height;return _id}return void 0},startAnim:function(_id,draw){let canvasopts;if(!_id)canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]];else canvasopts=this.graph.CANVASES?.[_id];canvasopts.animating=true;if(canvasopts&&draw){if(typeof draw==="string")draw=parseFunctionFromText(draw);if(typeof draw==="function"){canvasopts.draw=draw}return _id}if(typeof canvasopts?.draw==="function"){let draw2=(s,canvas,context)=>{if(s.animating){s.draw(s,canvas,context);requestAnimationFrame(()=>{draw2(s,canvas,context)})}};if(typeof canvasopts.clear==="function")canvasopts.clear(canvasopts,canvasopts.canvas,canvasopts.context);if(typeof canvasopts.init==="function")canvasopts.init(canvasopts,canvasopts.canvas,canvasopts.context);draw2(canvasopts,canvasopts.canvas,canvasopts.context);return _id}return void 0},stopAnim:function(_id){let canvasopts;if(!_id)canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]];else canvasopts=this.graph.CANVASES?.[_id];if(canvasopts){canvasopts.animating=false;if(typeof canvasopts.clear==="function")canvasopts.clear(canvasopts,canvasopts.canvas,canvasopts.context);return _id}return void 0}};var url=URL.createObjectURL(new Blob([String('(()=>{var __require=(x2=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(x2,{get:(a,b)=>(typeof require!=="undefined"?require:a)[b]}):x2)(function(x2){if(typeof require!=="undefined")return require.apply(this,arguments);throw new Error(\'Dynamic require of "\'+x2+\'" is not supported\')});var __create=Object.create;var __defProp=Object.defineProperty;var __getOwnPropDesc=Object.getOwnPropertyDescriptor;var __getOwnPropNames=Object.getOwnPropertyNames;var __getProtoOf=Object.getPrototypeOf;var __hasOwnProp=Object.prototype.hasOwnProperty;var __require2=(x2=>typeof __require!=="undefined"?__require:typeof Proxy!=="undefined"?new Proxy(x2,{get:(a,b)=>(typeof __require!=="undefined"?__require:a)[b]}):x2)(function(x2){if(typeof __require!=="undefined")return __require.apply(this,arguments);throw new Error(\'Dynamic require of "\'+x2+\'" is not supported\')});var __commonJS=(cb,mod)=>function __require22(){return mod||(0,cb[__getOwnPropNames(cb)[0]])((mod={exports:{}}).exports,mod),mod.exports};var __copyProps=(to,from,except,desc)=>{if(from&&typeof from==="object"||typeof from==="function"){for(let key of __getOwnPropNames(from))if(!__hasOwnProp.call(to,key)&&key!==except)__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable})}return to};var __toESM=(mod,isNodeMode,target)=>(target=mod!=null?__create(__getProtoOf(mod)):{},__copyProps(isNodeMode||!mod||!mod.__esModule?__defProp(target,"default",{value:mod,enumerable:true}):target,mod));var require_sjcl=__commonJS({"services/e2ee/sjcl.js"(exports,module){"use strict";var sjcl2={cipher:{},hash:{},keyexchange:{},mode:{},misc:{},codec:{},exception:{corrupt:function(a){this.toString=function(){return"CORRUPT: "+this.message};this.message=a},invalid:function(a){this.toString=function(){return"INVALID: "+this.message};this.message=a},bug:function(a){this.toString=function(){return"BUG: "+this.message};this.message=a},notReady:function(a){this.toString=function(){return"NOT READY: "+this.message};this.message=a}}};sjcl2.cipher.aes=function(a){this.s[0][0][0]||this.O();var b,c,d,e,f=this.s[0][4],g=this.s[1];b=a.length;var h=1;if(4!==b&&6!==b&&8!==b)throw new sjcl2.exception.invalid("invalid aes key size");this.b=[d=a.slice(0),e=[]];for(a=b;a<4*b+28;a++){c=d[a-1];if(0===a%b||8===b&&4===a%b)c=f[c>>>24]<<24^f[c>>16&255]<<16^f[c>>8&255]<<8^f[c&255],0===a%b&&(c=c<<8^c>>>24^h<<24,h=h<<1^283*(h>>7));d[a]=d[a-b]^c}for(b=0;a;b++,a--)c=d[b&3?a:a-4],e[b]=4>=a||4>b?c:g[0][f[c>>>24]]^g[1][f[c>>16&255]]^g[2][f[c>>8&255]]^g[3][f[c&255]]};sjcl2.cipher.aes.prototype={encrypt:function(a){return t(this,a,0)},decrypt:function(a){return t(this,a,1)},s:[[[],[],[],[],[]],[[],[],[],[],[]]],O:function(){var a=this.s[0],b=this.s[1],c=a[4],d=b[4],e,f,g,h=[],k=[],l,n,m,p;for(e=0;256>e;e++)k[(h[e]=e<<1^283*(e>>7))^e]=e;for(f=g=0;!c[f];f^=l||1,g=k[g]||1)for(m=g^g<<1^g<<2^g<<3^g<<4,m=m>>8^m&255^99,c[f]=m,d[m]=f,n=h[e=h[l=h[f]]],p=16843009*n^65537*e^257*l^16843008*f,n=257*h[m]^16843008*m,e=0;4>e;e++)a[e][f]=n=n<<24^n>>>8,b[e][m]=p=p<<24^p>>>8;for(e=0;5>e;e++)a[e]=a[e].slice(0),b[e]=b[e].slice(0)}};function t(a,b,c){if(4!==b.length)throw new sjcl2.exception.invalid("invalid aes block size");var d=a.b[c],e=b[0]^d[0],f=b[c?3:1]^d[1],g=b[2]^d[2];b=b[c?1:3]^d[3];var h,k,l,n=d.length/4-2,m,p=4,r=[0,0,0,0];h=a.s[c];a=h[0];var q=h[1],v=h[2],w=h[3],x2=h[4];for(m=0;m<n;m++)h=a[e>>>24]^q[f>>16&255]^v[g>>8&255]^w[b&255]^d[p],k=a[f>>>24]^q[g>>16&255]^v[b>>8&255]^w[e&255]^d[p+1],l=a[g>>>24]^q[b>>16&255]^v[e>>8&255]^w[f&255]^d[p+2],b=a[b>>>24]^q[e>>16&255]^v[f>>8&255]^w[g&255]^d[p+3],p+=4,e=h,f=k,g=l;for(m=0;4>m;m++)r[c?3&-m:m]=x2[e>>>24]<<24^x2[f>>16&255]<<16^x2[g>>8&255]<<8^x2[b&255]^d[p++],h=e,e=f,f=g,g=b,b=h;return r}sjcl2.bitArray={bitSlice:function(a,b,c){a=sjcl2.bitArray.$(a.slice(b/32),32-(b&31)).slice(1);return void 0===c?a:sjcl2.bitArray.clamp(a,c-b)},extract:function(a,b,c){var d=Math.floor(-b-c&31);return((b+c-1^b)&-32?a[b/32|0]<<32-d^a[b/32+1|0]>>>d:a[b/32|0]>>>d)&(1<<c)-1},concat:function(a,b){if(0===a.length||0===b.length)return a.concat(b);var c=a[a.length-1],d=sjcl2.bitArray.getPartial(c);return 32===d?a.concat(b):sjcl2.bitArray.$(b,d,c|0,a.slice(0,a.length-1))},bitLength:function(a){var b=a.length;return 0===b?0:32*(b-1)+sjcl2.bitArray.getPartial(a[b-1])},clamp:function(a,b){if(32*a.length<b)return a;a=a.slice(0,Math.ceil(b/32));var c=a.length;b=b&31;0<c&&b&&(a[c-1]=sjcl2.bitArray.partial(b,a[c-1]&2147483648>>b-1,1));return a},partial:function(a,b,c){return 32===a?b:(c?b|0:b<<32-a)+1099511627776*a},getPartial:function(a){return Math.round(a/1099511627776)||32},equal:function(a,b){if(sjcl2.bitArray.bitLength(a)!==sjcl2.bitArray.bitLength(b))return false;var c=0,d;for(d=0;d<a.length;d++)c|=a[d]^b[d];return 0===c},$:function(a,b,c,d){var e;e=0;for(void 0===d&&(d=[]);32<=b;b-=32)d.push(c),c=0;if(0===b)return d.concat(a);for(e=0;e<a.length;e++)d.push(c|a[e]>>>b),c=a[e]<<32-b;e=a.length?a[a.length-1]:0;a=sjcl2.bitArray.getPartial(e);d.push(sjcl2.bitArray.partial(b+a&31,32<b+a?c:d.pop(),1));return d},i:function(a,b){return[a[0]^b[0],a[1]^b[1],a[2]^b[2],a[3]^b[3]]},byteswapM:function(a){var b,c;for(b=0;b<a.length;++b)c=a[b],a[b]=c>>>24|c>>>8&65280|(c&65280)<<8|c<<24;return a}};sjcl2.codec.utf8String={fromBits:function(a){var b="",c=sjcl2.bitArray.bitLength(a),d,e;for(d=0;d<c/8;d++)0===(d&3)&&(e=a[d/4]),b+=String.fromCharCode(e>>>8>>>8>>>8),e<<=8;return decodeURIComponent(escape(b))},toBits:function(a){a=unescape(encodeURIComponent(a));var b=[],c,d=0;for(c=0;c<a.length;c++)d=d<<8|a.charCodeAt(c),3===(c&3)&&(b.push(d),d=0);c&3&&b.push(sjcl2.bitArray.partial(8*(c&3),d));return b}};sjcl2.codec.hex={fromBits:function(a){var b="",c;for(c=0;c<a.length;c++)b+=((a[c]|0)+0xf00000000000).toString(16).substr(4);return b.substr(0,sjcl2.bitArray.bitLength(a)/4)},toBits:function(a){var b,c=[],d;a=a.replace(/\\s|0x/g,"");d=a.length;a=a+"00000000";for(b=0;b<a.length;b+=8)c.push(parseInt(a.substr(b,8),16)^0);return sjcl2.bitArray.clamp(c,4*d)}};sjcl2.codec.base32={B:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",X:"0123456789ABCDEFGHIJKLMNOPQRSTUV",BITS:32,BASE:5,REMAINING:27,fromBits:function(a,b,c){var d=sjcl2.codec.base32.BASE,e=sjcl2.codec.base32.REMAINING,f="",g=0,h=sjcl2.codec.base32.B,k=0,l=sjcl2.bitArray.bitLength(a);c&&(h=sjcl2.codec.base32.X);for(c=0;f.length*d<l;)f+=h.charAt((k^a[c]>>>g)>>>e),g<d?(k=a[c]<<d-g,g+=e,c++):(k<<=d,g-=d);for(;f.length&7&&!b;)f+="=";return f},toBits:function(a,b){a=a.replace(/\\s|=/g,"").toUpperCase();var c=sjcl2.codec.base32.BITS,d=sjcl2.codec.base32.BASE,e=sjcl2.codec.base32.REMAINING,f=[],g,h=0,k=sjcl2.codec.base32.B,l=0,n,m="base32";b&&(k=sjcl2.codec.base32.X,m="base32hex");for(g=0;g<a.length;g++){n=k.indexOf(a.charAt(g));if(0>n){if(!b)try{return sjcl2.codec.base32hex.toBits(a)}catch(p){}throw new sjcl2.exception.invalid("this isn\'t "+m+"!")}h>e?(h-=e,f.push(l^n>>>h),l=n<<c-h):(h+=d,l^=n<<c-h)}h&56&&f.push(sjcl2.bitArray.partial(h&56,l,1));return f}};sjcl2.codec.base32hex={fromBits:function(a,b){return sjcl2.codec.base32.fromBits(a,b,1)},toBits:function(a){return sjcl2.codec.base32.toBits(a,1)}};sjcl2.codec.base64={B:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",fromBits:function(a,b,c){var d="",e=0,f=sjcl2.codec.base64.B,g=0,h=sjcl2.bitArray.bitLength(a);c&&(f=f.substr(0,62)+"-_");for(c=0;6*d.length<h;)d+=f.charAt((g^a[c]>>>e)>>>26),6>e?(g=a[c]<<6-e,e+=26,c++):(g<<=6,e-=6);for(;d.length&3&&!b;)d+="=";return d},toBits:function(a,b){a=a.replace(/\\s|=/g,"");var c=[],d,e=0,f=sjcl2.codec.base64.B,g=0,h;b&&(f=f.substr(0,62)+"-_");for(d=0;d<a.length;d++){h=f.indexOf(a.charAt(d));if(0>h)throw new sjcl2.exception.invalid("this isn\'t base64!");26<e?(e-=26,c.push(g^h>>>e),g=h<<32-e):(e+=6,g^=h<<32-e)}e&56&&c.push(sjcl2.bitArray.partial(e&56,g,1));return c}};sjcl2.codec.base64url={fromBits:function(a){return sjcl2.codec.base64.fromBits(a,1,1)},toBits:function(a){return sjcl2.codec.base64.toBits(a,1)}};sjcl2.hash.sha256=function(a){this.b[0]||this.O();a?(this.F=a.F.slice(0),this.A=a.A.slice(0),this.l=a.l):this.reset()};sjcl2.hash.sha256.hash=function(a){return new sjcl2.hash.sha256().update(a).finalize()};sjcl2.hash.sha256.prototype={blockSize:512,reset:function(){this.F=this.Y.slice(0);this.A=[];this.l=0;return this},update:function(a){"string"===typeof a&&(a=sjcl2.codec.utf8String.toBits(a));var b,c=this.A=sjcl2.bitArray.concat(this.A,a);b=this.l;a=this.l=b+sjcl2.bitArray.bitLength(a);if(9007199254740991<a)throw new sjcl2.exception.invalid("Cannot hash more than 2^53 - 1 bits");if("undefined"!==typeof Uint32Array){var d=new Uint32Array(c),e=0;for(b=512+b-(512+b&511);b<=a;b+=512)u(this,d.subarray(16*e,16*(e+1))),e+=1;c.splice(0,16*e)}else for(b=512+b-(512+b&511);b<=a;b+=512)u(this,c.splice(0,16));return this},finalize:function(){var a,b=this.A,c=this.F,b=sjcl2.bitArray.concat(b,[sjcl2.bitArray.partial(1,1)]);for(a=b.length+2;a&15;a++)b.push(0);b.push(Math.floor(this.l/4294967296));for(b.push(this.l|0);b.length;)u(this,b.splice(0,16));this.reset();return c},Y:[],b:[],O:function(){function a(a2){return 4294967296*(a2-Math.floor(a2))|0}for(var b=0,c=2,d,e;64>b;c++){e=true;for(d=2;d*d<=c;d++)if(0===c%d){e=false;break}e&&(8>b&&(this.Y[b]=a(Math.pow(c,.5))),this.b[b]=a(Math.pow(c,1/3)),b++)}}};function u(a,b){var c,d,e,f=a.F,g=a.b,h=f[0],k=f[1],l=f[2],n=f[3],m=f[4],p=f[5],r=f[6],q=f[7];for(c=0;64>c;c++)16>c?d=b[c]:(d=b[c+1&15],e=b[c+14&15],d=b[c&15]=(d>>>7^d>>>18^d>>>3^d<<25^d<<14)+(e>>>17^e>>>19^e>>>10^e<<15^e<<13)+b[c&15]+b[c+9&15]|0),d=d+q+(m>>>6^m>>>11^m>>>25^m<<26^m<<21^m<<7)+(r^m&(p^r))+g[c],q=r,r=p,p=m,m=n+d|0,n=l,l=k,k=h,h=d+(k&l^n&(k^l))+(k>>>2^k>>>13^k>>>22^k<<30^k<<19^k<<10)|0;f[0]=f[0]+h|0;f[1]=f[1]+k|0;f[2]=f[2]+l|0;f[3]=f[3]+n|0;f[4]=f[4]+m|0;f[5]=f[5]+p|0;f[6]=f[6]+r|0;f[7]=f[7]+q|0}sjcl2.mode.ccm={name:"ccm",G:[],listenProgress:function(a){sjcl2.mode.ccm.G.push(a)},unListenProgress:function(a){a=sjcl2.mode.ccm.G.indexOf(a);-1<a&&sjcl2.mode.ccm.G.splice(a,1)},fa:function(a){var b=sjcl2.mode.ccm.G.slice(),c;for(c=0;c<b.length;c+=1)b[c](a)},encrypt:function(a,b,c,d,e){var f,g=b.slice(0),h=sjcl2.bitArray,k=h.bitLength(c)/8,l=h.bitLength(g)/8;e=e||64;d=d||[];if(7>k)throw new sjcl2.exception.invalid("ccm: iv must be at least 7 bytes");for(f=2;4>f&&l>>>8*f;f++);f<15-k&&(f=15-k);c=h.clamp(c,8*(15-f));b=sjcl2.mode.ccm.V(a,b,c,d,e,f);g=sjcl2.mode.ccm.C(a,g,c,b,e,f);return h.concat(g.data,g.tag)},decrypt:function(a,b,c,d,e){e=e||64;d=d||[];var f=sjcl2.bitArray,g=f.bitLength(c)/8,h=f.bitLength(b),k=f.clamp(b,h-e),l=f.bitSlice(b,h-e),h=(h-e)/8;if(7>g)throw new sjcl2.exception.invalid("ccm: iv must be at least 7 bytes");for(b=2;4>b&&h>>>8*b;b++);b<15-g&&(b=15-g);c=f.clamp(c,8*(15-b));k=sjcl2.mode.ccm.C(a,k,c,l,e,b);a=sjcl2.mode.ccm.V(a,k.data,c,d,e,b);if(!f.equal(k.tag,a))throw new sjcl2.exception.corrupt("ccm: tag doesn\'t match");return k.data},na:function(a,b,c,d,e,f){var g=[],h=sjcl2.bitArray,k=h.i;d=[h.partial(8,(b.length?64:0)|d-2<<2|f-1)];d=h.concat(d,c);d[3]|=e;d=a.encrypt(d);if(b.length)for(c=h.bitLength(b)/8,65279>=c?g=[h.partial(16,c)]:4294967295>=c&&(g=h.concat([h.partial(16,65534)],[c])),g=h.concat(g,b),b=0;b<g.length;b+=4)d=a.encrypt(k(d,g.slice(b,b+4).concat([0,0,0])));return d},V:function(a,b,c,d,e,f){var g=sjcl2.bitArray,h=g.i;e/=8;if(e%2||4>e||16<e)throw new sjcl2.exception.invalid("ccm: invalid tag length");if(4294967295<d.length||4294967295<b.length)throw new sjcl2.exception.bug("ccm: can\'t deal with 4GiB or more data");c=sjcl2.mode.ccm.na(a,d,c,e,g.bitLength(b)/8,f);for(d=0;d<b.length;d+=4)c=a.encrypt(h(c,b.slice(d,d+4).concat([0,0,0])));return g.clamp(c,8*e)},C:function(a,b,c,d,e,f){var g,h=sjcl2.bitArray;g=h.i;var k=b.length,l=h.bitLength(b),n=k/50,m=n;c=h.concat([h.partial(8,f-1)],c).concat([0,0,0]).slice(0,4);d=h.bitSlice(g(d,a.encrypt(c)),0,e);if(!k)return{tag:d,data:[]};for(g=0;g<k;g+=4)g>n&&(sjcl2.mode.ccm.fa(g/k),n+=m),c[3]++,e=a.encrypt(c),b[g]^=e[0],b[g+1]^=e[1],b[g+2]^=e[2],b[g+3]^=e[3];return{tag:d,data:h.clamp(b,l)}}};sjcl2.mode.ocb2={name:"ocb2",encrypt:function(a,b,c,d,e,f){if(128!==sjcl2.bitArray.bitLength(c))throw new sjcl2.exception.invalid("ocb iv must be 128 bits");var g,h=sjcl2.mode.ocb2.S,k=sjcl2.bitArray,l=k.i,n=[0,0,0,0];c=h(a.encrypt(c));var m,p=[];d=d||[];e=e||64;for(g=0;g+4<b.length;g+=4)m=b.slice(g,g+4),n=l(n,m),p=p.concat(l(c,a.encrypt(l(c,m)))),c=h(c);m=b.slice(g);b=k.bitLength(m);g=a.encrypt(l(c,[0,0,0,b]));m=k.clamp(l(m.concat([0,0,0]),g),b);n=l(n,l(m.concat([0,0,0]),g));n=a.encrypt(l(n,l(c,h(c))));d.length&&(n=l(n,f?d:sjcl2.mode.ocb2.pmac(a,d)));return p.concat(k.concat(m,k.clamp(n,e)))},decrypt:function(a,b,c,d,e,f){if(128!==sjcl2.bitArray.bitLength(c))throw new sjcl2.exception.invalid("ocb iv must be 128 bits");e=e||64;var g=sjcl2.mode.ocb2.S,h=sjcl2.bitArray,k=h.i,l=[0,0,0,0],n=g(a.encrypt(c)),m,p,r=sjcl2.bitArray.bitLength(b)-e,q=[];d=d||[];for(c=0;c+4<r/32;c+=4)m=k(n,a.decrypt(k(n,b.slice(c,c+4)))),l=k(l,m),q=q.concat(m),n=g(n);p=r-32*c;m=a.encrypt(k(n,[0,0,0,p]));m=k(m,h.clamp(b.slice(c),p).concat([0,0,0]));l=k(l,m);l=a.encrypt(k(l,k(n,g(n))));d.length&&(l=k(l,f?d:sjcl2.mode.ocb2.pmac(a,d)));if(!h.equal(h.clamp(l,e),h.bitSlice(b,r)))throw new sjcl2.exception.corrupt("ocb: tag doesn\'t match");return q.concat(h.clamp(m,p))},pmac:function(a,b){var c,d=sjcl2.mode.ocb2.S,e=sjcl2.bitArray,f=e.i,g=[0,0,0,0],h=a.encrypt([0,0,0,0]),h=f(h,d(d(h)));for(c=0;c+4<b.length;c+=4)h=d(h),g=f(g,a.encrypt(f(h,b.slice(c,c+4))));c=b.slice(c);128>e.bitLength(c)&&(h=f(h,d(h)),c=e.concat(c,[-2147483648,0,0,0]));g=f(g,c);return a.encrypt(f(d(f(h,d(h))),g))},S:function(a){return[a[0]<<1^a[1]>>>31,a[1]<<1^a[2]>>>31,a[2]<<1^a[3]>>>31,a[3]<<1^135*(a[0]>>>31)]}};sjcl2.mode.gcm={name:"gcm",encrypt:function(a,b,c,d,e){var f=b.slice(0);b=sjcl2.bitArray;d=d||[];a=sjcl2.mode.gcm.C(true,a,f,d,c,e||128);return b.concat(a.data,a.tag)},decrypt:function(a,b,c,d,e){var f=b.slice(0),g=sjcl2.bitArray,h=g.bitLength(f);e=e||128;d=d||[];e<=h?(b=g.bitSlice(f,h-e),f=g.bitSlice(f,0,h-e)):(b=f,f=[]);a=sjcl2.mode.gcm.C(false,a,f,d,c,e);if(!g.equal(a.tag,b))throw new sjcl2.exception.corrupt("gcm: tag doesn\'t match");return a.data},ka:function(a,b){var c,d,e,f,g,h=sjcl2.bitArray.i;e=[0,0,0,0];f=b.slice(0);for(c=0;128>c;c++){(d=0!==(a[Math.floor(c/32)]&1<<31-c%32))&&(e=h(e,f));g=0!==(f[3]&1);for(d=3;0<d;d--)f[d]=f[d]>>>1|(f[d-1]&1)<<31;f[0]>>>=1;g&&(f[0]^=-520093696)}return e},j:function(a,b,c){var d,e=c.length;b=b.slice(0);for(d=0;d<e;d+=4)b[0]^=4294967295&c[d],b[1]^=4294967295&c[d+1],b[2]^=4294967295&c[d+2],b[3]^=4294967295&c[d+3],b=sjcl2.mode.gcm.ka(b,a);return b},C:function(a,b,c,d,e,f){var g,h,k,l,n,m,p,r,q=sjcl2.bitArray;m=c.length;p=q.bitLength(c);r=q.bitLength(d);h=q.bitLength(e);g=b.encrypt([0,0,0,0]);96===h?(e=e.slice(0),e=q.concat(e,[1])):(e=sjcl2.mode.gcm.j(g,[0,0,0,0],e),e=sjcl2.mode.gcm.j(g,e,[0,0,Math.floor(h/4294967296),h&4294967295]));h=sjcl2.mode.gcm.j(g,[0,0,0,0],d);n=e.slice(0);d=h.slice(0);a||(d=sjcl2.mode.gcm.j(g,h,c));for(l=0;l<m;l+=4)n[3]++,k=b.encrypt(n),c[l]^=k[0],c[l+1]^=k[1],c[l+2]^=k[2],c[l+3]^=k[3];c=q.clamp(c,p);a&&(d=sjcl2.mode.gcm.j(g,h,c));a=[Math.floor(r/4294967296),r&4294967295,Math.floor(p/4294967296),p&4294967295];d=sjcl2.mode.gcm.j(g,d,a);k=b.encrypt(e);d[0]^=k[0];d[1]^=k[1];d[2]^=k[2];d[3]^=k[3];return{tag:q.bitSlice(d,0,f),data:c}}};sjcl2.misc.hmac=function(a,b){this.W=b=b||sjcl2.hash.sha256;var c=[[],[]],d,e=b.prototype.blockSize/32;this.w=[new b,new b];a.length>e&&(a=b.hash(a));for(d=0;d<e;d++)c[0][d]=a[d]^909522486,c[1][d]=a[d]^1549556828;this.w[0].update(c[0]);this.w[1].update(c[1]);this.R=new b(this.w[0])};sjcl2.misc.hmac.prototype.encrypt=sjcl2.misc.hmac.prototype.mac=function(a){if(this.aa)throw new sjcl2.exception.invalid("encrypt on already updated hmac called!");this.update(a);return this.digest(a)};sjcl2.misc.hmac.prototype.reset=function(){this.R=new this.W(this.w[0]);this.aa=false};sjcl2.misc.hmac.prototype.update=function(a){this.aa=true;this.R.update(a)};sjcl2.misc.hmac.prototype.digest=function(){var a=this.R.finalize(),a=new this.W(this.w[1]).update(a).finalize();this.reset();return a};sjcl2.misc.pbkdf2=function(a,b,c,d,e){c=c||1e4;if(0>d||0>c)throw new sjcl2.exception.invalid("invalid params to pbkdf2");"string"===typeof a&&(a=sjcl2.codec.utf8String.toBits(a));"string"===typeof b&&(b=sjcl2.codec.utf8String.toBits(b));e=e||sjcl2.misc.hmac;a=new e(a);var f,g,h,k,l=[],n=sjcl2.bitArray;for(k=1;32*l.length<(d||1);k++){e=f=a.encrypt(n.concat(b,[k]));for(g=1;g<c;g++)for(f=a.encrypt(f),h=0;h<f.length;h++)e[h]^=f[h];l=l.concat(e)}d&&(l=n.clamp(l,d));return l};sjcl2.prng=function(a){this.c=[new sjcl2.hash.sha256];this.m=[0];this.P=0;this.H={};this.N=0;this.U={};this.Z=this.f=this.o=this.ha=0;this.b=[0,0,0,0,0,0,0,0];this.h=[0,0,0,0];this.L=void 0;this.M=a;this.D=false;this.K={progress:{},seeded:{}};this.u=this.ga=0;this.I=1;this.J=2;this.ca=65536;this.T=[0,48,64,96,128,192,256,384,512,768,1024];this.da=3e4;this.ba=80};sjcl2.prng.prototype={randomWords:function(a,b){var c=[],d;d=this.isReady(b);var e;if(d===this.u)throw new sjcl2.exception.notReady("generator isn\'t seeded");if(d&this.J){d=!(d&this.I);e=[];var f=0,g;this.Z=e[0]=new Date().valueOf()+this.da;for(g=0;16>g;g++)e.push(4294967296*Math.random()|0);for(g=0;g<this.c.length&&(e=e.concat(this.c[g].finalize()),f+=this.m[g],this.m[g]=0,d||!(this.P&1<<g));g++);this.P>=1<<this.c.length&&(this.c.push(new sjcl2.hash.sha256),this.m.push(0));this.f-=f;f>this.o&&(this.o=f);this.P++;this.b=sjcl2.hash.sha256.hash(this.b.concat(e));this.L=new sjcl2.cipher.aes(this.b);for(d=0;4>d&&(this.h[d]=this.h[d]+1|0,!this.h[d]);d++);}for(d=0;d<a;d+=4)0===(d+1)%this.ca&&y(this),e=z(this),c.push(e[0],e[1],e[2],e[3]);y(this);return c.slice(0,a)},setDefaultParanoia:function(a,b){if(0===a&&"Setting paranoia=0 will ruin your security; use it only for testing"!==b)throw new sjcl2.exception.invalid("Setting paranoia=0 will ruin your security; use it only for testing");this.M=a},addEntropy:function(a,b,c){c=c||"user";var d,e,f=new Date().valueOf(),g=this.H[c],h=this.isReady(),k=0;d=this.U[c];void 0===d&&(d=this.U[c]=this.ha++);void 0===g&&(g=this.H[c]=0);this.H[c]=(this.H[c]+1)%this.c.length;switch(typeof a){case"number":void 0===b&&(b=1);this.c[g].update([d,this.N++,1,b,f,1,a|0]);break;case"object":c=Object.prototype.toString.call(a);if("[object Uint32Array]"===c){e=[];for(c=0;c<a.length;c++)e.push(a[c]);a=e}else for("[object Array]"!==c&&(k=1),c=0;c<a.length&&!k;c++)"number"!==typeof a[c]&&(k=1);if(!k){if(void 0===b)for(c=b=0;c<a.length;c++)for(e=a[c];0<e;)b++,e=e>>>1;this.c[g].update([d,this.N++,2,b,f,a.length].concat(a))}break;case"string":void 0===b&&(b=a.length);this.c[g].update([d,this.N++,3,b,f,a.length]);this.c[g].update(a);break;default:k=1}if(k)throw new sjcl2.exception.bug("random: addEntropy only supports number, array of numbers or string");this.m[g]+=b;this.f+=b;h===this.u&&(this.isReady()!==this.u&&A("seeded",Math.max(this.o,this.f)),A("progress",this.getProgress()))},isReady:function(a){a=this.T[void 0!==a?a:this.M];return this.o&&this.o>=a?this.m[0]>this.ba&&new Date().valueOf()>this.Z?this.J|this.I:this.I:this.f>=a?this.J|this.u:this.u},getProgress:function(a){a=this.T[a?a:this.M];return this.o>=a?1:this.f>a?1:this.f/a},startCollectors:function(){if(!this.D){this.a={loadTimeCollector:B(this,this.ma),mouseCollector:B(this,this.oa),keyboardCollector:B(this,this.la),accelerometerCollector:B(this,this.ea),touchCollector:B(this,this.qa)};if(window.addEventListener)window.addEventListener("load",this.a.loadTimeCollector,false),window.addEventListener("mousemove",this.a.mouseCollector,false),window.addEventListener("keypress",this.a.keyboardCollector,false),window.addEventListener("devicemotion",this.a.accelerometerCollector,false),window.addEventListener("touchmove",this.a.touchCollector,false);else if(document.attachEvent)document.attachEvent("onload",this.a.loadTimeCollector),document.attachEvent("onmousemove",this.a.mouseCollector),document.attachEvent("keypress",this.a.keyboardCollector);else throw new sjcl2.exception.bug("can\'t attach event");this.D=true}},stopCollectors:function(){this.D&&(window.removeEventListener?(window.removeEventListener("load",this.a.loadTimeCollector,false),window.removeEventListener("mousemove",this.a.mouseCollector,false),window.removeEventListener("keypress",this.a.keyboardCollector,false),window.removeEventListener("devicemotion",this.a.accelerometerCollector,false),window.removeEventListener("touchmove",this.a.touchCollector,false)):document.detachEvent&&(document.detachEvent("onload",this.a.loadTimeCollector),document.detachEvent("onmousemove",this.a.mouseCollector),document.detachEvent("keypress",this.a.keyboardCollector)),this.D=false)},addEventListener:function(a,b){this.K[a][this.ga++]=b},removeEventListener:function(a,b){var c,d,e=this.K[a],f=[];for(d in e)e.hasOwnProperty(d)&&e[d]===b&&f.push(d);for(c=0;c<f.length;c++)d=f[c],delete e[d]},la:function(){C(this,1)},oa:function(a){var b,c;try{b=a.x||a.clientX||a.offsetX||0,c=a.y||a.clientY||a.offsetY||0}catch(d){c=b=0}0!=b&&0!=c&&this.addEntropy([b,c],2,"mouse");C(this,0)},qa:function(a){a=a.touches[0]||a.changedTouches[0];this.addEntropy([a.pageX||a.clientX,a.pageY||a.clientY],1,"touch");C(this,0)},ma:function(){C(this,2)},ea:function(a){a=a.accelerationIncludingGravity.x||a.accelerationIncludingGravity.y||a.accelerationIncludingGravity.z;if(window.orientation){var b=window.orientation;"number"===typeof b&&this.addEntropy(b,1,"accelerometer")}a&&this.addEntropy(a,2,"accelerometer");C(this,0)}};function A(a,b){var c,d=sjcl2.random.K[a],e=[];for(c in d)d.hasOwnProperty(c)&&e.push(d[c]);for(c=0;c<e.length;c++)e[c](b)}function C(a,b){"undefined"!==typeof window&&window.performance&&"function"===typeof window.performance.now?a.addEntropy(window.performance.now(),b,"loadtime"):a.addEntropy(new Date().valueOf(),b,"loadtime")}function y(a){a.b=z(a).concat(z(a));a.L=new sjcl2.cipher.aes(a.b)}function z(a){for(var b=0;4>b&&(a.h[b]=a.h[b]+1|0,!a.h[b]);b++);return a.L.encrypt(a.h)}function B(a,b){return function(){b.apply(a,arguments)}}sjcl2.random=new sjcl2.prng(6);a:try{if(G="undefined"!==typeof module&&module.exports){try{H=__require2("crypto")}catch(a){H=null}G=E=H}if(G&&E.randomBytes)D=E.randomBytes(128),D=new Uint32Array(new Uint8Array(D).buffer),sjcl2.random.addEntropy(D,1024,"crypto[\'randomBytes\']");else if("undefined"!==typeof window&&"undefined"!==typeof Uint32Array){F=new Uint32Array(32);if(window.crypto&&window.crypto.getRandomValues)window.crypto.getRandomValues(F);else if(window.msCrypto&&window.msCrypto.getRandomValues)window.msCrypto.getRandomValues(F);else break a;sjcl2.random.addEntropy(F,1024,"crypto[\'getRandomValues\']")}}catch(a){"undefined"!==typeof window&&window.console&&(console.log("There was an error collecting entropy from the browser:"),console.log(a))}var D;var E;var F;var G;var H;sjcl2.json={defaults:{v:1,iter:1e4,ks:128,ts:64,mode:"ccm",adata:"",cipher:"aes"},ja:function(a,b,c,d){c=c||{};d=d||{};var e=sjcl2.json,f=e.g({iv:sjcl2.random.randomWords(4,0)},e.defaults),g;e.g(f,c);c=f.adata;"string"===typeof f.salt&&(f.salt=sjcl2.codec.base64.toBits(f.salt));"string"===typeof f.iv&&(f.iv=sjcl2.codec.base64.toBits(f.iv));if(!sjcl2.mode[f.mode]||!sjcl2.cipher[f.cipher]||"string"===typeof a&&100>=f.iter||64!==f.ts&&96!==f.ts&&128!==f.ts||128!==f.ks&&192!==f.ks&&256!==f.ks||2>f.iv.length||4<f.iv.length)throw new sjcl2.exception.invalid("json encrypt: invalid parameters");"string"===typeof a?(g=sjcl2.misc.cachedPbkdf2(a,f),a=g.key.slice(0,f.ks/32),f.salt=g.salt):sjcl2.ecc&&a instanceof sjcl2.ecc.elGamal.publicKey&&(g=a.kem(),f.kemtag=g.tag,a=g.key.slice(0,f.ks/32));"string"===typeof b&&(b=sjcl2.codec.utf8String.toBits(b));"string"===typeof c&&(f.adata=c=sjcl2.codec.utf8String.toBits(c));g=new sjcl2.cipher[f.cipher](a);e.g(d,f);d.key=a;f.ct="ccm"===f.mode&&sjcl2.arrayBuffer&&sjcl2.arrayBuffer.ccm&&b instanceof ArrayBuffer?sjcl2.arrayBuffer.ccm.encrypt(g,b,f.iv,c,f.ts):sjcl2.mode[f.mode].encrypt(g,b,f.iv,c,f.ts);return f},encrypt:function(a,b,c,d){var e=sjcl2.json,f=e.ja.apply(e,arguments);return e.encode(f)},ia:function(a,b,c,d){c=c||{};d=d||{};var e=sjcl2.json;b=e.g(e.g(e.g({},e.defaults),b),c,true);var f,g;f=b.adata;"string"===typeof b.salt&&(b.salt=sjcl2.codec.base64.toBits(b.salt));"string"===typeof b.iv&&(b.iv=sjcl2.codec.base64.toBits(b.iv));if(!sjcl2.mode[b.mode]||!sjcl2.cipher[b.cipher]||"string"===typeof a&&100>=b.iter||64!==b.ts&&96!==b.ts&&128!==b.ts||128!==b.ks&&192!==b.ks&&256!==b.ks||!b.iv||2>b.iv.length||4<b.iv.length)throw new sjcl2.exception.invalid("json decrypt: invalid parameters");"string"===typeof a?(g=sjcl2.misc.cachedPbkdf2(a,b),a=g.key.slice(0,b.ks/32),b.salt=g.salt):sjcl2.ecc&&a instanceof sjcl2.ecc.elGamal.secretKey&&(a=a.unkem(sjcl2.codec.base64.toBits(b.kemtag)).slice(0,b.ks/32));"string"===typeof f&&(f=sjcl2.codec.utf8String.toBits(f));g=new sjcl2.cipher[b.cipher](a);f="ccm"===b.mode&&sjcl2.arrayBuffer&&sjcl2.arrayBuffer.ccm&&b.ct instanceof ArrayBuffer?sjcl2.arrayBuffer.ccm.decrypt(g,b.ct,b.iv,b.tag,f,b.ts):sjcl2.mode[b.mode].decrypt(g,b.ct,b.iv,f,b.ts);e.g(d,b);d.key=a;return 1===c.raw?f:sjcl2.codec.utf8String.fromBits(f)},decrypt:function(a,b,c,d){var e=sjcl2.json;return e.ia(a,e.decode(b),c,d)},encode:function(a){var b,c="{",d="";for(b in a)if(a.hasOwnProperty(b)){if(!b.match(/^[a-z0-9]+$/i))throw new sjcl2.exception.invalid("json encode: invalid property name");c+=d+\'"\'+b+\'":\';d=",";switch(typeof a[b]){case"number":case"boolean":c+=a[b];break;case"string":c+=\'"\'+escape(a[b])+\'"\';break;case"object":c+=\'"\'+sjcl2.codec.base64.fromBits(a[b],0)+\'"\';break;default:throw new sjcl2.exception.bug("json encode: unsupported type")}}return c+"}"},decode:function(a){a=a.replace(/\\s/g,"");if(!a.match(/^\\{.*\\}$/))throw new sjcl2.exception.invalid("json decode: this isn\'t json!");a=a.replace(/^\\{|\\}$/g,"").split(/,/);var b={},c,d;for(c=0;c<a.length;c++){if(!(d=a[c].match(/^\\s*(?:(["\']?)([a-z][a-z0-9]*)\\1)\\s*:\\s*(?:(-?\\d+)|"([a-z0-9+\\/%*_.@=\\-]*)"|(true|false))$/i)))throw new sjcl2.exception.invalid("json decode: this isn\'t json!");null!=d[3]?b[d[2]]=parseInt(d[3],10):null!=d[4]?b[d[2]]=d[2].match(/^(ct|adata|salt|iv)$/)?sjcl2.codec.base64.toBits(d[4]):unescape(d[4]):null!=d[5]&&(b[d[2]]="true"===d[5])}return b},g:function(a,b,c){void 0===a&&(a={});if(void 0===b)return a;for(var d in b)if(b.hasOwnProperty(d)){if(c&&void 0!==a[d]&&a[d]!==b[d])throw new sjcl2.exception.invalid("required parameter overridden");a[d]=b[d]}return a},sa:function(a,b){var c={},d;for(d in a)a.hasOwnProperty(d)&&a[d]!==b[d]&&(c[d]=a[d]);return c},ra:function(a,b){var c={},d;for(d=0;d<b.length;d++)void 0!==a[b[d]]&&(c[b[d]]=a[b[d]]);return c}};sjcl2.encrypt=sjcl2.json.encrypt;sjcl2.decrypt=sjcl2.json.decrypt;sjcl2.misc.pa={};sjcl2.misc.cachedPbkdf2=function(a,b){var c=sjcl2.misc.pa,d;b=b||{};d=b.iter||1e3;c=c[a]=c[a]||{};d=c[d]=c[d]||{firstSalt:b.salt&&b.salt.length?b.salt.slice(0):sjcl2.random.randomWords(2,0)};c=void 0===b.salt?d.firstSalt:b.salt;d[c]=d[c]||sjcl2.misc.pbkdf2(a,c,b.iter);return{key:d[c].slice(0),salt:c.slice(0)}};"undefined"!==typeof module&&module.exports&&(module.exports=sjcl2);"function"===typeof define&&define([],function(){return sjcl2})}});var require_browser=__commonJS({"node_modules/web-worker/cjs/browser.js"(exports,module){module.exports=Worker}});function parseFunctionFromText(method=""){let getFunctionBody=methodString=>{return methodString.replace(/^\\W*(function[^{]+\\{([\\s\\S]*)\\}|[^=]+=>[^{]*\\{([\\s\\S]*)\\}|[^=]+=>(.+))/i,"$2$3$4")};let getFunctionHead=methodString=>{let startindex=methodString.indexOf("=>")+1;if(startindex<=0){startindex=methodString.indexOf("){")}if(startindex<=0){startindex=methodString.indexOf(") {")}return methodString.slice(0,methodString.indexOf("{",startindex)+1)};let newFuncHead=getFunctionHead(method);let newFuncBody=getFunctionBody(method);let newFunc;if(newFuncHead.includes("function")){let varName=newFuncHead.split("(")[1].split(")")[0];newFunc=new Function(varName,newFuncBody)}else{if(newFuncHead.substring(0,6)===newFuncBody.substring(0,6)){let varName=newFuncHead.split("(")[1].split(")")[0];newFunc=new Function(varName,newFuncBody.substring(newFuncBody.indexOf("{")+1,newFuncBody.length-1))}else{try{newFunc=(0,eval)(newFuncHead+newFuncBody+"}")}catch{}}}return newFunc}var state={pushToState:{},data:{},triggers:{},setState(updateObj){Object.assign(state.data,updateObj);for(const prop of Object.getOwnPropertyNames(updateObj)){if(state.triggers[prop])state.triggers[prop].forEach(obj=>obj.onchange(state.data[prop]))}return state.data},subscribeTrigger(key,onchange){if(key){if(!state.triggers[key]){state.triggers[key]=[]}let l=state.triggers[key].length;state.triggers[key].push({idx:l,onchange});return state.triggers[key].length-1}else return void 0},unsubscribeTrigger(key,sub){let idx=void 0;let triggers=state.triggers[key];if(triggers){if(!sub)delete state.triggers[key];else{let obj=triggers.find(o=>{if(o.idx===sub){return true}});if(obj)triggers.splice(idx,1);return true}}},subscribeTriggerOnce(key,onchange){let sub;let changed=value=>{onchange(value);state.unsubscribeTrigger(key,sub)};sub=state.subscribeTrigger(key,changed)}};var restrictedKeys=["_state","graph"];function merge(props){for(let k in props){if(restrictedKeys.includes(k))continue;else{this._state[k]=props[k];if(k in this)this[k]=props[k];else Object.defineProperty(this,k,{get:()=>this._state[k],set:v=>this._state[k]=v,enumerable:true})}}}var GraphNode=class{constructor(properties={},parentNode,graph){this.nodes=new Map;this._initial={};this._state={};this._unique=Math.random();this.state=state;this.isLooping=false;this.isAnimating=false;this.looper=void 0;this.animation=void 0;this.forward=true;this.backward=false;this.runSync=false;this.firstRun=true;this.DEBUGNODE=false;this.merge=merge;this.operator=(...args)=>{return args};this.runOp=(...args)=>{if(this.DEBUGNODE)console.time(this.tag);let result=this.operator(...args);if(result instanceof Promise){result.then(res=>{if(res!==void 0)this.setState({[this.tag]:res});if(this.DEBUGNODE){console.timeEnd(this.tag);if(result!==void 0)console.log(`${this.tag} result:`,result)};return res})}else{if(result!==void 0)this.setState({[this.tag]:result});if(this.DEBUGNODE){console.timeEnd(this.tag);if(result!==void 0)console.log(`${this.tag} result:`,result)};}return result};this.setOperator=operator=>{if(typeof operator!=="function")return operator;this.operator=operator.bind(this);return operator};this.runAsync=(...args)=>{return new Promise((res,rej)=>{res(this.run(...args))})};this.transformArgs=(args=[])=>args;this.isRunSync=()=>{return!(this.children&&this.forward||this.parent&&this.backward||this.repeat||this.delay||this.frame||this.recursive||this.branch)};this.run=(...args)=>{if(typeof this.transformArgs==="function")args=this.transformArgs(args,this);if(this.firstRun){this.firstRun=false;this.runSync=this.isRunSync();if(this.animate&&!this.isAnimating){this.runAnimation(this.animation,args)}if(this.loop&&typeof this.loop==="number"&&!this.isLooping){this.runLoop(this.looper,args)}if(this.loop||this.animate)return}if(this.runSync){let res=this.runOp(...args);return res}return new Promise(async resolve=>{if(this){let run=(node,tick=0,...input)=>{return new Promise(async r=>{tick++;let res=await node.runOp(...input);if(node.repeat){while(tick<node.repeat){if(node.delay){setTimeout(async()=>{r(await run(node,tick,...input))},node.delay);break}else if(node.frame&&window?.requestAnimationFrame){requestAnimationFrame(async()=>{r(await run(node,tick,...input))});break}else res=await node.runOp(...input);tick++}if(tick===node.repeat){r(res);return}}else if(node.recursive){while(tick<node.recursive){if(node.delay){setTimeout(async()=>{r(await run(node,tick,...res))},node.delay);break}else if(node.frame&&window?.requestAnimationFrame){requestAnimationFrame(async()=>{r(await run(node,tick,...res))});break}else res=await node.runOp(...res);tick++}if(tick===node.recursive){r(res);return}}else{r(res);return}})};let runnode=async()=>{let res=await run(this,void 0,...args);if(res!==void 0){if(this.backward&&this.parent instanceof GraphNode){if(Array.isArray(res))await this.runParent(this,...res);else await this.runParent(this,res)}if(this.children&&this.forward){if(Array.isArray(res))await this.runChildren(this,...res);else await this.runChildren(this,res)}if(this.branch){this.runBranch(this,res)}}return res};if(this.delay){setTimeout(async()=>{resolve(await runnode())},this.delay)}else if(this.frame&&window?.requestAnimationFrame){requestAnimationFrame(async()=>{resolve(await runnode())})}else{resolve(await runnode())}}else resolve(void 0)})};this.runParent=async(n,...args)=>{if(n.backward&&n.parent){if(typeof n.parent==="string"){if(n.graph&&n.graph?.get(n.parent)){n.parent=n.graph;if(n.parent)this.nodes.set(n.parent.tag,n.parent)}else n.parent=this.nodes.get(n.parent)}if(n.parent instanceof GraphNode)await n.parent.run(...args)}};this.runChildren=async(n,...args)=>{if(typeof n.children==="object"){for(const key in n.children){if(typeof n.children[key]==="string"){if(n.graph&&n.graph?.get(n.children[key])){n.children[key]=n.graph.get(n.children[key]);if(!n.nodes.get(n.children[key].tag))n.nodes.set(n.children[key].tag,n.children[key])}if(!n.children[key]&&n.nodes.get(n.children[key]))n.children[key]=n.nodes.get(n.children[key])}else if(typeof n.children[key]==="undefined"||n.children[key]===true){if(n.graph&&n.graph?.get(key)){n.children[key]=n.graph.get(key);if(!n.nodes.get(n.children[key].tag))n.nodes.set(n.children[key].tag,n.children[key])}if(!n.children[key]&&n.nodes.get(key))n.children[key]=n.nodes.get(key)}if(n.children[key]?.runOp)await n.children[key].run(...args)}}};this.runBranch=async(n,output)=>{if(n.branch){let keys=Object.keys(n.branch);await Promise.all(keys.map(async k=>{if(typeof n.branch[k].if==="object")n.branch[k].if=stringifyFast(n.branch[k].if);let pass=false;if(typeof n.branch[k].if==="function"){pass=n.branch[k].if(output)}else{if(typeof output==="object"){if(stringifyFast(output)===n.branch[k].if)pass=true}else if(output===n.branch[k].if)pass=true}if(pass){if(n.branch[k].then.run){if(Array.isArray(output))await n.branch[k].then.run(...output);else await n.branch[k].then.run(...output)}else if(typeof n.branch[k].then==="function"){if(Array.isArray(output))await n.branch[k].then(...output);else await n.branch[k].then(output)}else if(typeof n.branch[k].then==="string"){if(n.graph)n.branch[k].then=n.graph.nodes.get(n.branch[k].then);else n.branch[k].then=n.nodes.get(n.branch[k].then);if(n.branch[k].then.run){if(Array.isArray(output))await n.branch[k].then.run(...output);else await n.branch[k].then.run(...output)}}}return pass}))}};this.runAnimation=(animation=this.animation,args=[])=>{this.animation=animation;if(!animation)this.animation=this.operator;if(this.animate&&!this.isAnimating&&"requestAnimationFrame"in window){this.isAnimating=true;let anim=async()=>{if(this.isAnimating){if(this.DEBUGNODE)console.time(this.tag);let result=this.animation.call(this,...args);if(result instanceof Promise){result=await result}if(this.DEBUGNODE){console.timeEnd(this.tag);if(result!==void 0)console.log(`${this.tag} result:`,result)};if(result!==void 0){if(this.tag)this.setState({[this.tag]:result});if(this.backward&&this.parent?.run){if(Array.isArray(result))await this.runParent(this,...result);else await this.runParent(this,result)}if(this.children&&this.forward){if(Array.isArray(result))await this.runChildren(this,...result);else await this.runChildren(this,result)}if(this.branch){this.runBranch(this,result)}this.setState({[this.tag]:result})}requestAnimationFrame(anim)}};requestAnimationFrame(anim)}};this.runLoop=(loop=this.looper,args=[],timeout=this.loop)=>{this.looper=loop;if(!loop)this.looper=this.operator;if(typeof timeout==="number"&&!this.isLooping){this.isLooping=true;let looping=async()=>{if(this.isLooping){if(this.DEBUGNODE)console.time(this.tag);let result=this.looper.call(this,...args);if(result instanceof Promise){result=await result}if(this.DEBUGNODE){console.timeEnd(this.tag);if(result!==void 0)console.log(`${this.tag} result:`,result)};if(result!==void 0){if(this.tag)this.setState({[this.tag]:result});if(this.backward&&this.parent?.run){if(Array.isArray(result))await this.runParent(this,...result);else await this.runParent(this,result)}if(this.children&&this.forward){if(Array.isArray(result))await this.runChildren(this,...result);else await this.runChildren(this,result)}if(this.branch){this.runBranch(this,result)}this.setState({[this.tag]:result})}setTimeout(async()=>{await looping()},timeout)}};looping()}};this.setParent=parent=>{this.parent=parent;if(this.backward)this.runSync=false};this.setChildren=children=>{this.children=children;if(this.forward)this.runSync=false};this.add=(n={})=>{if(typeof n==="function")n={operator:n};if(n?.node instanceof GraphNode)n=n.node;if(!(n instanceof GraphNode))n=new GraphNode(n.node??n,this,this.graph);this.nodes.set(n.tag,n);if(this.graph){this.graph.nodes.set(n.tag,n);this.graph.nNodes=this.graph.nodes.size}return n};this.remove=n=>{if(typeof n==="string")n=this.nodes.get(n);if(n?.tag){this.nodes.delete(n.tag);if(this.children[n.tag])delete this.children[n.tag];if(this.graph){this.graph.nodes.delete(n.tag);this.graph.nNodes=this.graph.nodes.size}this.nodes.forEach(n2=>{if(n2.nodes.get(n2.tag)){n2.nodes.delete(n2.tag);if(n2.children[n2.tag])delete n2.children[n2.tag];if(n2.parent?.tag===n2.tag)delete n2.parent}});if(n.ondelete)n.ondelete(n)}};this.append=(n,parentNode2=this)=>{if(typeof n==="string")n=this.nodes.get(n);if(n?.nodes){parentNode2.addChildren(n);if(n.forward)n.runSync=false}};this.subscribe=(callback,tag=this.tag)=>{if(callback.run){return this.subscribeNode(callback)}else return this.state.subscribeTrigger(tag,callback)};this.unsubscribe=(sub,tag=this.tag)=>{return this.state.unsubscribeTrigger(tag,sub)};this.addChildren=children=>{if(!this.children)this.children={};if(typeof children==="object"){Object.assign(this.children,children)}this.convertChildrenToNodes();if(this.forward)this.runSync=false};this.callParent=(...args)=>{if(typeof this.parent==="string"){if(this.graph&&this.graph?.get(this.parent)){this.parent=this.graph;if(this.parent)this.nodes.set(this.parent.tag,this.parent)}else this.parent=this.nodes.get(this.parent)}if(typeof this.parent?.operator==="function")return this.parent.runOp(...args)};this.callChildren=(...args)=>{let result;if(typeof this.children==="object"){for(const key in this.children){if(this.children[key]?.runOp)this.children[key].runOp(...args)}}return result};this.getProps=(n=this)=>{return{tag:n.tag,operator:n.operator,graph:n.graph,children:n.children,parent:n.parent,forward:n.forward,backward:n.bacward,loop:n.loop,animate:n.animate,frame:n.frame,delay:n.delay,recursive:n.recursive,repeat:n.repeat,branch:n.branch,oncreate:n.oncreate,DEBUGNODE:n.DEBUGNODE,...this._initial}};this.setProps=(props={})=>{let tmp=Object.assign({},props);if(tmp.children){this.addChildren(props.children);delete tmp.children}if(tmp.operator){this.setOperator(props.operator);delete tmp.operator}Object.assign(tmp,props);this.runSync=this.isRunSync()};this.removeTree=n=>{if(n){if(typeof n==="string")n=this.nodes.get(n)}if(n?.nodes){let checked={};const recursivelyRemove=node=>{if(typeof node.children==="object"&&!checked[node.tag]){checked[node.tag]=true;for(const key in node.children){if(node.children[key].stopNode)node.children[key].stopNode();if(node.children[key].tag){if(this.nodes.get(node.children[key].tag))this.nodes.delete(node.children[key].tag);this.nodes.forEach(n2=>{if(n2.nodes.get(node.children[key].tag))n2.nodes.delete(node.children[key].tag);if(n2.children[key]instanceof GraphNode)delete n2.children[key]});recursivelyRemove(node.children[key])}}}};if(n.stopNode)n.stopNode();if(n.tag){this.nodes.delete(n.tag);if(this.children[n.tag])delete this.children[n.tag];if(this.parent?.tag===n.tag)delete this.parent;if(this[n.tag]instanceof GraphNode)delete this[n.tag];this.nodes.forEach(n2=>{if(n2?.tag){if(n2.nodes.get(n2.tag))n2.nodes.delete(n2.tag);if(n2.children[n2.tag]instanceof GraphNode)delete n2.children[n2.tag]}});recursivelyRemove(n);if(this.graph)this.graph.removeTree(n,checked);else if(n.ondelete)n.ondelete(n)}}};this.checkNodesHaveChildMapped=(n,child,checked={})=>{let tag=n.tag;if(!tag)tag=n.name;if(!checked[tag]){checked[tag]=true;if(n.children){if(child.tag in n.children){if(n.children[child.tag]instanceof GraphNode){if(!n.nodes.get(child.tag))n.nodes.set(child.tag,child);n.children[child.tag]=child;if(!n.firstRun)n.firstRun=true}}}if(n.parent instanceof GraphNode){if(n.nodes.get(child.tag))n.parent.nodes.set(child.tag,child);if(n.parent.children){this.checkNodesHaveChildMapped(n.parent,child,checked)}else if(n.nodes){n.nodes.forEach(n2=>{if(!checked[n2.tag]){this.checkNodesHaveChildMapped(n2,child,checked)}})}}if(n.graph){if(n.parent&&n.parent.name!==n.graph.name){n.graph.nodes.forEach(n2=>{if(!checked[n2.tag]){this.checkNodesHaveChildMapped(n2,child,checked)}})}}}};this.convertChildrenToNodes=(n=this)=>{if(n?.children){for(const key in n.children){if(!(n.children[key]instanceof GraphNode)){if(typeof n.children[key]==="object"){if(!n.children[key].tag)n.children[key].tag=key;if(!n.nodes.get(n.children[key].tag)){n.children[key]=new GraphNode(n.children[key],n,n.graph);this.checkNodesHaveChildMapped(n,n.children[key])}}else{if(typeof n.children[key]==="undefined"||n.children[key]==true){n.children[key]=n.graph.get(key);if(!n.children[key])n.children[key]=n.nodes.get(key)}else if(typeof n.children[key]==="string"){let k=n.children[key];n.children[key]=n.graph.get(k);if(!n.children[key])n.children[key]=n.nodes.get(key)}if(n.children[key]instanceof GraphNode){n.nodes.set(n.children[key].tag,n.children[key]);this.checkNodesHaveChildMapped(n,n.children[key]);if(!(n.children[key].tag in n))n[n.children[key].tag]=n.children[key]}}}}}return n.children};this.stopLooping=(n=this)=>{n.isLooping=false};this.stopAnimating=(n=this)=>{n.isAnimating=false};this.stopNode=(n=this)=>{n.stopAnimating(n);n.stopLooping(n)};this.subscribeNode=n=>{if(typeof n==="string")n=this.nodes.get(n);if(n.tag)this.nodes.set(n.tag,n);if(n)return this.state.subscribeTrigger(this.tag,res=>{if(Array.isArray(res))n.run(...res);else n.run(res)})};this.print=(n=this,printChildren=true,nodesPrinted=[])=>{let dummyNode=new GraphNode;if(typeof n==="string")n=this.nodes.get(n);if(n instanceof GraphNode){nodesPrinted.push(n.tag);let jsonToPrint={tag:n.tag,operator:n.operator.toString()};if(n.parent)jsonToPrint.parent=n.parent.tag;if(typeof n.children==="object"){for(const key in n.children){if(typeof n.children[key]==="string")return n.children[key];if(nodesPrinted.includes(n.children[key].tag))return n.children[key].tag;else if(!printChildren){return n.children[key].tag}else return n.children[key].print(n.children[key],printChildren,nodesPrinted)}}for(const prop in n){if(prop==="parent"||prop==="children")continue;if(typeof dummyNode[prop]==="undefined"){if(typeof n[prop]==="function"){jsonToPrint[prop]=n[prop].toString()}else if(typeof n[prop]==="object"){jsonToPrint[prop]=JSON.stringifyWithCircularRefs(n[prop])}else{jsonToPrint[prop]=n[prop]}}}return JSON.stringify(jsonToPrint)}};this.reconstruct=json=>{let parsed=reconstructObject(json);if(parsed)return this.add(parsed)};this.setState=this.state.setState;this.DEBUGNODES=(debugging=true)=>{this.DEBUGNODE=debugging;this.nodes.forEach(n=>{if(debugging)n.DEBUGNODE=true;else n.DEBUGNODE=false})};if(typeof properties==="function"){properties={operator:properties}}if(typeof properties==="object"){if(properties instanceof GraphNode&&properties._initial)Object.assign(properties,properties._initial);if(properties instanceof Graph){let source=properties;properties={source,operator:input=>{if(typeof input==="object"){let result={};for(const key in input){if(typeof source[key]==="function"){if(Array.isArray(input[key]))result[key]=source[key](...input[key]);else result[key]=source[key](input[key])}else{source[key]=input[key];result[key]=source[key]}}return result}return source}};if(source.operator)properties.operator=source.operator;if(source.children)properties.children=source.children;if(source.forward)properties.forward=source.forward;if(source.backward)properties.backward=source.backward;if(source.repeat)properties.repeat=source.repeat;if(source.recursive)properties.recursive=source.recursive;if(source.loop)properties.loop=source.loop;if(source.animate)properties.animate=source.animate;if(source.looper)properties.looper=source.looper;if(source.animation)properties.animation=source.animation;if(source.delay)properties.delay=source.delay;if(source.tag)properties.tag=source.tag;if(source.oncreate)properties.oncreate=source.oncreate;if(source.node){if(source.node._initial)Object.assign(properties,source.node._initial)}if(source._initial)Object.assign(properties,source._initial);this.nodes=source.nodes;source.node=this;if(graph){source.nodes.forEach(n=>{if(!graph.nodes.get(n.tag)){graph.nodes.set(n.tag,n);graph.nNodes++}})}}if(properties.tag&&(graph||parentNode)){let hasnode;if(graph?.nodes){hasnode=graph.nodes.get(properties.tag)}if(!hasnode&&parentNode?.nodes){hasnode=parentNode.nodes.get(properties.tag)}if(hasnode){if(!this.source)this.source=hasnode;let props=hasnode.getProps();delete props.graph;delete props.parent;for(let k in props)properties[k]=props[k]}}if(properties?.operator){properties.operator=this.setOperator(properties.operator)}if(!properties.tag&&graph){properties.tag=`node${graph.nNodes}`}else if(!properties.tag){properties.tag=`node${Math.floor(Math.random()*1e10)}`}let keys=Object.getOwnPropertyNames(this);for(const key in properties){if(!keys.includes(key))this._initial[key]=properties[key]}if(properties.children)this._initial.children=Object.assign({},properties.children);Object.assign(this,properties);if(!this.tag){if(graph){this.tag=`node${graph.nNodes}`}else{this.tag=`node${Math.floor(Math.random()*1e10)}`}}if(graph){this.graph=graph;if(graph.nodes.get(this.tag)){this.tag=`${this.tag}${graph.nNodes+1}`}graph.nodes.set(this.tag,this);graph.nNodes++}if(parentNode){this.parent=parentNode;if(parentNode instanceof GraphNode||parentNode instanceof Graph)parentNode.nodes.set(this.tag,this)}if(typeof properties.tree==="object"){for(const key in properties.tree){if(typeof properties.tree[key]==="object"){if((!properties.tree[key]).tag){properties.tree[key].tag=key}}let node=new GraphNode(properties.tree[key],this,graph);this.nodes.set(node.tag,node)}}if(this.children)this.convertChildrenToNodes(this);if(this.parent instanceof GraphNode||this.parent instanceof Graph)this.checkNodesHaveChildMapped(this.parent,this);if(typeof this.oncreate==="function")this.oncreate(this);if(!this.firstRun)this.firstRun=true;if(this.animation&&!this.animate)this.animate=true}else return properties}};var Graph=class{constructor(tree,tag,props){this.nNodes=0;this.nodes=new Map;this.state=state;this._state={};this._unique=Math.random();this.tree={};this.merge=merge;this.add=(n={})=>{if(n?.node instanceof GraphNode)n=n.node;let props2=n;if(!(n instanceof GraphNode))n=new GraphNode(props2?.node??props2,this,this);else{this.nNodes=this.nodes.size;if(n.tag){this.tree[n.tag]=props2;this.nodes.set(n.tag,n)}}return n};this.setTree=(tree2=this.tree)=>{if(!tree2)return;for(const node in tree2){const n=this.nodes.get(node);if(!n){if(typeof tree2[node]==="function"){this.add({tag:node,operator:tree2[node]})}else if(typeof tree2[node]==="object"&&!Array.isArray(tree2[node])){if(!tree2[node].tag)tree2[node].tag=node;let newNode=this.add(tree2[node]);if(tree2[node].aliases){tree2[node].aliases.forEach(a=>{this.nodes.set(a,newNode)})}}else{this.add({tag:node,operator:(...args)=>{return tree2[node]}})}}else{if(typeof tree2[node]==="function"){n.setOperator(tree2[node])}else if(typeof tree2[node]==="object"){if(tree2[node]instanceof GraphNode){this.add(tree2[node])}else if(tree2[node]instanceof Graph){let source=tree2[node];let properties={};if(source.operator)properties.operator=source.operator;if(source.children)properties.children=source.children;if(source.forward)properties.forward=source.forward;if(source.backward)properties.backward=source.backward;if(source.repeat)properties.repeat=source.repeat;if(source.recursive)properties.recursive=source.recursive;if(source.loop)properties.loop=source.loop;if(source.animate)properties.animate=source.animate;if(source.looper)properties.looper=source.looper;if(source.animation)properties.animation=source.animation;if(source.delay)properties.delay=source.delay;if(source.tag)properties.tag=source.tag;if(source.oncreate)properties.oncreate=source.oncreate;if(source.node?._initial)Object.assign(properties,source.node._initial);properties.nodes=source.nodes;properties.source=source;n.setProps(properties)}else{n.setProps(tree2[node])}}}}this.nodes.forEach(node=>{if(typeof node.children==="object"){for(const key in node.children){if(typeof node.children[key]==="string"){if(this.nodes.get(node.children[key])){node.children[key]=this.nodes.get(node.children[key])}}else if(node.children[key]===true||typeof node.children[key]==="undefined"){if(this.nodes.get(key)){node.children[key]=this.nodes.get(key)}}if(node.children[key]instanceof GraphNode){node.checkNodesHaveChildMapped(node,node.children[key])}}}if(typeof node.parent==="string"){if(this.nodes.get(node.parent)){node.parent=this.nodes.get(node.parent);node.nodes.set(node.parent.tag,node.parent)}}})};this.get=tag2=>{return this.nodes.get(tag2)};this.set=n=>{return this.nodes.set(n.tag,n)};this.run=(n,...args)=>{if(typeof n==="string")n=this.nodes.get(n);if(n?.run)return n.run(...args);else return void 0};this.runAsync=(n,...args)=>{if(typeof n==="string")n=this.nodes.get(n);if(n?.run)return new Promise((res,rej)=>{res(n.run(...args))});else return new Promise((res,rej)=>{res(void 0)})};this.removeTree=(n,checked)=>{if(typeof n==="string")n=this.nodes.get(n);if(n?.nodes){if(!checked)checked={};const recursivelyRemove=node=>{if(node.children&&!checked[node.tag]){checked[node.tag]=true;if(Array.isArray(node.children)){node.children.forEach(c=>{if(c.stopNode)c.stopNode();if(c.tag){if(this.nodes.get(c.tag))this.nodes.delete(c.tag)}this.nodes.forEach(n2=>{if(n2.nodes.get(c.tag))n2.nodes.delete(c.tag)});recursivelyRemove(c)})}else if(typeof node.children==="object"){if(node.stopNode)node.stopNode();if(node.tag){if(this.nodes.get(node.tag))this.nodes.delete(node.tag)}this.nodes.forEach(n2=>{if(n2.nodes.get(node.tag))n2.nodes.delete(node.tag)});recursivelyRemove(node)}}};if(n.stopNode)n.stopNode();if(n.tag){this.nodes.delete(n.tag);this.nodes.forEach(n2=>{if(n2.nodes.get(n2.tag))n2.nodes.delete(n2.tag)});this.nNodes=this.nodes.size;recursivelyRemove(n)}if(n.ondelete)n.ondelete(n)}return n};this.remove=n=>{if(typeof n==="string")n=this.nodes.get(n);if(n?.nodes){if(n.stopNode)n.stopNode();if(n?.tag){if(this.nodes.get(n.tag)){this.nodes.delete(n.tag);this.nodes.forEach(n2=>{if(n2.nodes.get(n2.tag))n2.nodes.delete(n2.tag)})}}if(n.ondelete)n.ondelete(n)}return n};this.append=(n,parentNode)=>{parentNode.addChildren(n)};this.callParent=async(n,...args)=>{if(n?.parent){return await n.callParent(...args)}};this.callChildren=async(n,...args)=>{if(n?.children){return await n.callChildren(...args)}};this.subscribe=(n,callback)=>{if(!callback)return;if(n?.subscribe&&typeof callback==="function"){return n.subscribe(callback)}else if(callback instanceof GraphNode||typeof callback==="string")return this.subscribeNode(n,callback);else if(typeof n=="string"){return this.state.subscribeTrigger(n,callback)}};this.unsubscribe=(tag2,sub)=>{return this.state.unsubscribeTrigger(tag2,sub)};this.subscribeNode=(inputNode,outputNode)=>{let tag2;if(inputNode?.tag)tag2=inputNode.tag;else if(typeof inputNode==="string")tag2=inputNode;if(typeof outputNode==="string")outputNode=this.nodes.get(outputNode);if(inputNode&&outputNode){let sub=this.state.subscribeTrigger(tag2,res=>{if(Array.isArray(res))outputNode.run(...res);else outputNode.run(res)});return sub}};this.stopNode=n=>{if(typeof n==="string"){n=this.nodes.get(n)}if(n?.stopNode){n.stopNode()}};this.print=(n,printChildren=true)=>{if(n?.print)return n.print(n,printChildren);else{let printed=`{`;this.nodes.forEach(n2=>{printed+=`\n"${n2.tag}:${n2.print(n2,printChildren)}"`});return printed}};this.reconstruct=json=>{let parsed=reconstructObject(json);if(parsed)return this.add(parsed)};this.create=(operator,parentNode,props2)=>{return createNode(operator,parentNode,props2,this)};this.setState=this.state.setState;this.DEBUGNODES=(debugging=true)=>{this.nodes.forEach(n=>{if(debugging)n.DEBUGNODE=true;else n.DEBUGNODE=false})};this.tag=tag?tag:`graph${Math.floor(Math.random()*1e11)}`;if(props){Object.assign(this,props);this._initial=props}if(tree||Object.keys(this.tree).length>0)this.setTree(tree)}};function reconstructObject(json="{}"){try{let parsed=typeof json==="string"?JSON.parse(json):json;const parseObj=obj=>{for(const prop in obj){if(typeof obj[prop]==="string"){let funcParsed=parseFunctionFromText(obj[prop]);if(typeof funcParsed==="function"){obj[prop]=funcParsed}}else if(typeof obj[prop]==="object"){parseObj(obj[prop])}}return obj};return parseObj(parsed)}catch(err){console.error(err);return void 0}}var stringifyWithCircularRefs=function(){const refs=new Map;const parents=[];const path=["this"];function clear(){refs.clear();parents.length=0;path.length=1}function updateParents(key,value){var idx=parents.length-1;var prev=parents[idx];if(typeof prev==="object"){if(prev[key]===value||idx===0){path.push(key);parents.push(value.pushed)}else{while(idx-->=0){prev=parents[idx];if(typeof prev==="object"){if(prev[key]===value){idx+=2;parents.length=idx;path.length=idx;--idx;parents[idx]=value;path[idx]=key;break}}idx--}}}}function checkCircular(key,value){if(value!=null){if(typeof value==="object"){if(key){updateParents(key,value)}let other=refs.get(value);if(other){return"[Circular Reference]"+other}else{refs.set(value,path.join("."))}}}return value}return function stringifyWithCircularRefs2(obj,space){try{parents.push(obj);return JSON.stringify(obj,checkCircular,space)}finally{clear()}}}();if(JSON.stringifyWithCircularRefs===void 0){JSON.stringifyWithCircularRefs=stringifyWithCircularRefs}var stringifyFast=function(){const refs=new Map;const parents=[];const path=["this"];function clear(){refs.clear();parents.length=0;path.length=1}function updateParents(key,value){var idx=parents.length-1;if(parents[idx]){var prev=parents[idx];if(typeof prev==="object"){if(prev[key]===value||idx===0){path.push(key);parents.push(value.pushed)}else{while(idx-->=0){prev=parents[idx];if(typeof prev==="object"){if(prev[key]===value){idx+=2;parents.length=idx;path.length=idx;--idx;parents[idx]=value;path[idx]=key;break}}idx++}}}}}function checkValues(key,value){let val;if(value!=null){if(typeof value==="object"){let c=value.constructor.name;if(key&&c==="Object"){updateParents(key,value)}let other=refs.get(value);if(other){return"[Circular Reference]"+other}else{refs.set(value,path.join("."))}if(c==="Array"){if(value.length>20){val=value.slice(value.length-20)}else val=value}else if(c.includes("Set")){val=Array.from(value)}else if(c!=="Object"&&c!=="Number"&&c!=="String"&&c!=="Boolean"){val="instanceof_"+c}else if(c==="Object"){let obj={};for(const prop in value){if(value[prop]==null){obj[prop]=value[prop]}else if(Array.isArray(value[prop])){if(value[prop].length>20)obj[prop]=value[prop].slice(value[prop].length-20);else obj[prop]=value[prop]}else if(value[prop].constructor.name==="Object"){obj[prop]={};for(const p in value[prop]){if(Array.isArray(value[prop][p])){if(value[prop][p].length>20)obj[prop][p]=value[prop][p].slice(value[prop][p].length-20);else obj[prop][p]=value[prop][p]}else{if(value[prop][p]!=null){let con=value[prop][p].constructor.name;if(con.includes("Set")){obj[prop][p]=Array.from(value[prop][p])}else if(con!=="Number"&&con!=="String"&&con!=="Boolean"){obj[prop][p]="instanceof_"+con}else{obj[prop][p]=value[prop][p]}}else{obj[prop][p]=value[prop][p]}}}}else{let con=value[prop].constructor.name;if(con.includes("Set")){obj[prop]=Array.from(value[prop])}else if(con!=="Number"&&con!=="String"&&con!=="Boolean"){obj[prop]="instanceof_"+con}else{obj[prop]=value[prop]}}}val=obj}else{val=value}}else{val=value}}return val}return function stringifyFast2(obj,space){parents.push(obj);let res=JSON.stringify(obj,checkValues,space);clear();return res}}();if(JSON.stringifyFast===void 0){JSON.stringifyFast=stringifyFast}function createNode(operator,parentNode,props,graph){if(typeof props==="object"){props.operator=operator;return new GraphNode(props,parentNode,graph)}return new GraphNode({operator},parentNode,graph)}var Service=class extends Graph{constructor(options={}){super(void 0,options.name?options.name:`service${Math.floor(Math.random()*1e14)}`,options.props);this.routes={};this.loadDefaultRoutes=false;this.keepState=true;this.firstLoad=true;this.customRoutes={};this.customChildren={};this.init=options2=>{if(options2)options2=Object.assign({},options2);else options2={};if(options2.customRoutes)Object.assign(options2.customRoutes,this.customRoutes);else options2.customRoutes=this.customRoutes;if(options2.customChildren)Object.assign(options2.customChildren,this.customChildren);else options2.customChildren=this.customChildren;if(Array.isArray(options2.routes)){options2.routes.forEach(r=>{this.load(r,options2.includeClassName,options2.routeFormat,options2.customRoutes,options2.customChildren)})}else if(options2.routes||(Object.keys(this.routes).length>0||this.loadDefaultRoutes)&&this.firstLoad)this.load(options2.routes,options2.includeClassName,options2.routeFormat,options2.customRoutes,options2.customChildren)};this.load=(routes,includeClassName=true,routeFormat=".",customRoutes,customChildren)=>{if(!routes&&!this.loadDefaultRoutes&&(Object.keys(this.routes).length>0||this.firstLoad))return;if(this.firstLoad)this.firstLoad=false;if(customRoutes)customRoutes=Object.assign(this.customRoutes,customRoutes);else customRoutes=this.customRoutes;let service;let allRoutes={};if(routes){if(!(routes instanceof Graph)&&routes?.name&&!routes.setTree){if(routes.module){let mod=routes;routes={};Object.getOwnPropertyNames(routes.module).forEach(prop=>{if(includeClassName)routes[mod.name+routeFormat+prop]=routes.module[prop];else routes[prop]=routes.module[prop]})}else if(typeof routes==="function"){service=new routes({loadDefaultRoutes:this.loadDefaultRoutes});service.load();routes=service.routes;if(service.customRoutes&&!this.customRoutes)this.customRoutes=service.customRoutes;else if(service.customRoutes&&this.customRoutes)Object.assign(this.customRoutes,service.customRoutes);if(service.customChildren&&!this.customChildren)this.customChildren=service.customChildren;else if(service.customChildren&&this.customChildren)Object.assign(this.customChildren,service.customChildren)}}else if(routes instanceof Graph||routes.source instanceof Graph||routes.setTree){service=routes;routes={};if(includeClassName){let name=service.name;if(!name){name=service.tag;service.name=name}if(!name){name=`graph${Math.floor(Math.random()*1e15)}`;service.name=name;service.tag=name}}if(service.customRoutes&&!this.customRoutes)this.customRoutes=service.customRoutes;else if(service.customRoutes&&this.customRoutes)Object.assign(this.customRoutes,service.customRoutes);if(service.customChildren&&!this.customChildren)this.customChildren=service.customChildren;else if(service.customChildren&&this.customChildren)Object.assign(this.customChildren,service.customChildren);service.nodes.forEach(node=>{routes[node.tag]=node;let checked={};let checkChildGraphNodes=(nd,par)=>{if(!checked[nd.tag]||par&&includeClassName&&!checked[par?.tag+routeFormat+nd.tag]){if(!par)checked[nd.tag]=true;else checked[par.tag+routeFormat+nd.tag]=true;if(nd instanceof Graph||nd.source instanceof Graph||nd.setTree){if(includeClassName){let nm=nd.name;if(!nm){nm=nd.tag;nd.name=nm}if(!nm){nm=`graph${Math.floor(Math.random()*1e15)}`;nd.name=nm;nd.tag=nm}}nd.nodes.forEach(n=>{if(includeClassName&&!routes[nd.tag+routeFormat+n.tag])routes[nd.tag+routeFormat+n.tag]=n;else if(!routes[n.tag])routes[n.tag]=n;checkChildGraphNodes(n,nd)})}}};checkChildGraphNodes(node)})}else if(typeof routes==="object"){let name=routes.constructor.name;if(name==="Object"){name=Object.prototype.toString.call(routes);if(name)name=name.split(" ")[1];if(name)name=name.split("]")[0]}if(name&&name!=="Object"){let module=routes;routes={};Object.getOwnPropertyNames(module).forEach(route=>{if(includeClassName)routes[name+routeFormat+route]=module[route];else routes[route]=module[route]})}}if((service instanceof Graph||service?.setTree)&&service.name&&includeClassName){routes=Object.assign({},routes);for(const prop in routes){let route=routes[prop];delete routes[prop];routes[service.name+routeFormat+prop]=route}}}if(this.loadDefaultRoutes){let rts2=Object.assign({},this.defaultRoutes);if(routes){Object.assign(rts2,this.routes);routes=Object.assign(rts2,routes)}else routes=Object.assign(rts2,this.routes);this.loadDefaultRoutes=false}if(!routes)routes=this.routes;let incr=0;for(const tag in routes){incr++;let childrenIter=(route,routeKey)=>{if(typeof route==="object"){if(!route.tag)route.tag=routeKey;if(typeof route?.children==="object"){nested:for(const key in route.children){incr++;if(typeof route.children[key]==="object"){let rt=route.children[key];if(rt.tag&&allRoutes[rt.tag])continue;if(customChildren){for(const k2 in customChildren){rt=customChildren[k2](rt,key,route,routes,allRoutes);if(!rt)continue nested}}if(rt.id&&!rt.tag){rt.tag=rt.id}let k;if(rt.tag){if(allRoutes[rt.tag]){let randkey=`${rt.tag}${incr}`;allRoutes[randkey]=rt;rt.tag=randkey;childrenIter(allRoutes[randkey],key);k=randkey}else{allRoutes[rt.tag]=rt;childrenIter(allRoutes[rt.tag],key);k=rt.tag}}else{if(allRoutes[key]){let randkey=`${key}${incr}`;allRoutes[randkey]=rt;rt.tag=randkey;childrenIter(allRoutes[randkey],key);k=randkey}else{allRoutes[key]=rt;childrenIter(allRoutes[key],key);k=key}}if(service?.name&&includeClassName){allRoutes[service.name+routeFormat+k]=rt;delete allRoutes[k]}else allRoutes[k]=rt}}}}};allRoutes[tag]=routes[tag];childrenIter(routes[tag],tag)}top:for(const route in allRoutes){if(typeof allRoutes[route]==="object"){let r=allRoutes[route];if(typeof r==="object"){if(customRoutes){for(const key in customRoutes){r=customRoutes[key](r,route,allRoutes);if(!r)continue top}}if(r.get){if(typeof r.get=="object"){}}if(r.post){}if(r.delete){}if(r.put){}if(r.head){}if(r.patch){}if(r.options){}if(r.connect){}if(r.trace){}if(r.post&&!r.operator){allRoutes[route].operator=r.post}else if(!r.operator&&typeof r.get=="function"){allRoutes[route].operator=r.get}}}}for(const route in routes){if(typeof routes[route]==="object"){if(this.routes[route]){if(typeof this.routes[route]==="object")Object.assign(this.routes[route],routes[route]);else this.routes[route]=routes[route]}else this.routes[route]=routes[route]}else if(this.routes[route]){if(typeof this.routes[route]==="object")Object.assign(this.routes[route],routes[route]);else this.routes[route]=routes[route]}else this.routes[route]=routes[route]}if(service){for(const key in this.routes){if(this.routes[key]instanceof GraphNode||this.routes[key].constructor.name.includes("GraphNode")){this.nodes.set(key,this.routes[key]);this.nNodes=this.nodes.size}}}else this.setTree(this.routes);for(const prop in this.routes){if(this.routes[prop]?.aliases){let aliases=this.routes[prop].aliases;aliases.forEach(a=>{if(service?.name&&includeClassName)routes[service.name+routeFormat+a]=this.routes[prop];else routes[a]=this.routes[prop]})}}return this.routes};this.unload=(routes=this.routes)=>{if(!routes)return;let service;if(!(routes instanceof Service)&&typeof routes==="function"){service=new Service;routes=service.routes}else if(routes instanceof Service){routes=routes.routes}for(const r in routes){delete this.routes[r];if(this.nodes.get(r))this.remove(r)}return this.routes};this.handleMethod=(route,method,args)=>{let m=method.toLowerCase();let src=this.nodes.get(route);if(!src){src=this.routes[route];if(!src)src=this.tree[route]}if(src?.[m]){if(!(src[m]instanceof Function)){if(args)src[m]=args;return src[m]}else return src[m](args)}else return this.handleServiceMessage({route,args,method})};this.transmit=(...args)=>{if(typeof args[0]==="object"){if(args[0].method){return this.handleMethod(args[0].route,args[0].method,args[0].args)}else if(args[0].route){return this.handleServiceMessage(args[0])}else if(args[0].node){return this.handleGraphNodeCall(args[0].node,args[0].args)}else if(this.keepState){if(args[0].route)this.setState({[args[0].route]:args[0].args});if(args[0].node)this.setState({[args[0].node]:args[0].args})}return args}else return args};this.receive=(...args)=>{if(args[0]){if(typeof args[0]==="string"){let substr=args[0].substring(0,8);if(substr.includes("{")||substr.includes("[")){if(substr.includes("\\\\"))args[0]=args[0].replace(/\\\\/g,"");if(args[0][0]===\'"\'){args[0]=args[0].substring(1,args[0].length-1)};args[0]=JSON.parse(args[0])}}}if(typeof args[0]==="object"){if(args[0].method){return this.handleMethod(args[0].route,args[0].method,args[0].args)}else if(args[0].route){return this.handleServiceMessage(args[0])}else if(args[0].node){return this.handleGraphNodeCall(args[0].node,args[0].args)}else if(this.keepState){if(args[0].route)this.setState({[args[0].route]:args[0].args});if(args[0].node)this.setState({[args[0].node]:args[0].args})}return args}else return args};this.pipe=(source,destination,endpoint,method,callback)=>{if(source instanceof GraphNode){if(callback)return source.subscribe(res=>{let mod=callback(res);if(mod!==void 0)this.transmit({route:destination,args:mod,method});else this.transmit({route:destination,args:res,method},endpoint)});else return this.subscribe(source,res=>{this.transmit({route:destination,args:res,method},endpoint)})}else if(typeof source==="string")return this.subscribe(source,res=>{this.transmit({route:destination,args:res,method},endpoint)})};this.pipeOnce=(source,destination,endpoint,method,callback)=>{if(source instanceof GraphNode){if(callback)return source.state.subscribeTriggerOnce(source.tag,res=>{let mod=callback(res);if(mod!==void 0)this.transmit({route:destination,args:mod,method});else this.transmit({route:destination,args:res,method},endpoint)});else return this.state.subscribeTriggerOnce(source.tag,res=>{this.transmit({route:destination,args:res,method},endpoint)})}else if(typeof source==="string")return this.state.subscribeTriggerOnce(source,res=>{this.transmit({route:destination,args:res,method},endpoint)})};this.terminate=(...args)=>{this.nodes.forEach(n=>{n.stopNode()})};this.recursivelyAssign=(target,obj)=>{for(const key in obj){if(typeof obj[key]==="object"){if(typeof target[key]==="object")this.recursivelyAssign(target[key],obj[key]);else target[key]=this.recursivelyAssign({},obj[key])}else target[key]=obj[key]}return target};this.defaultRoutes={"/":{get:()=>{return this.print()},aliases:[""]},ping:()=>{console.log("ping");return"pong"},echo:(...args)=>{this.transmit(...args);return args},assign:source=>{if(typeof source==="object"){Object.assign(this,source);return true}return false},recursivelyAssign:source=>{if(typeof source==="object"){this.recursivelyAssign(this,source);return true}return false},log:{post:(...args)=>{console.log("Log: ",...args)},aliases:["info"]},error:message=>{let er=new Error(message);console.error(message);return er},state:key=>{if(key){return this.state.data[key]}else return this.state.data},printState:key=>{if(key){return stringifyWithCircularRefs(this.state.data[key])}else return stringifyWithCircularRefs(this.state.data)},spliceTypedArray:this.spliceTypedArray,transmit:this.transmit,receive:this.receive,load:this.load,unload:this.unload,pipe:this.pipe,terminate:this.terminate,run:this.run,subscribe:this.subscribe,subscribeNode:this.subscribeNode,unsubscribe:this.unsubscribe,stopNode:this.stopNode,get:this.get,add:this.add,remove:this.remove,setTree:this.setTree,setState:this.setState,print:this.print,reconstruct:this.reconstruct,handleMethod:this.handleMethod,handleServiceMessage:this.handleServiceMessage,handleGraphNodeCall:this.handleGraphNodeCall};if(options.name)this.name=options.name;else options.name=this.tag;if("loadDefaultRoutes"in options){this.loadDefaultRoutes=options.loadDefaultRoutes;this.routes=Object.assign(this.defaultRoutes,this.routes)}if(options||Object.keys(this.routes).length>0)this.init(options)}handleServiceMessage(message){let call;if(typeof message==="object"){if(message.route)call=message.route;else if(message.node)call=message.node}if(call){if(Array.isArray(message.args))return this.run(call,...message.args);else return this.run(call,message.args)}else return message}handleGraphNodeCall(route,args){if(!route)return args;if(args?.args){this.handleServiceMessage(args)}else if(Array.isArray(args))return this.run(route,...args);else return this.run(route,args)}isTypedArray(x2){return ArrayBuffer.isView(x2)&&Object.prototype.toString.call(x2)!=="[object DataView]"}spliceTypedArray(arr,start,end){let s=arr.subarray(0,start);let e;if(end){e=arr.subarray(end+1)}let n;if(s.length>0||e?.length>0)n=new arr.constructor(s.length+e.length);if(s.length>0)n.set(s);if(e&&e.length>0)n.set(e,s.length);return n}};var unsafeRoutes={setRoute:function(fn,fnName){if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;if(this.graph.get(fnName)){this.graph.get(fnName).setOperator(fn.bind(this.graph.get(fnName)))}else{let node=this.graph.add({tag:fnName,operator:fn});if(this.graph instanceof Service)this.graph.load({[fnName]:node})}return true}return false},setNode:function(fn,fnName){if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;if(this.graph.get(fnName)){this.graph.get(fnName).setOperator(fn)}else this.graph.add({tag:fnName,operator:fn});return true}return false},setMethod:function(route,fn,fnName){if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;if(this.graph.get(route)){this.graph.get(route)[fnName]=fn}else this.graph.add({tag:fnName,[fnName]:fn});return true}return false},assignRoute:function(route,source){if(this.graph.get(route)&&typeof source==="object"){Object.assign(this.graph.get(route),source)}},transferClass:(classObj,className)=>{if(typeof classObj==="object"){let str2=classObj.toString();let message={route:"receiveClass",args:[str2,className]};return message}return false},receiveClass:function(stringified,className){if(typeof stringified==="string"){if(stringified.indexOf("class")===0){let cls=(0,eval)("("+stringified+")");let name=className;if(!name)name=cls.name;this.graph[name]=cls;return true}}return false},setGlobal:(key,value)=>{globalThis[key]=value;return true},assignGlobalObject:(target,source)=>{if(!globalThis[target])return false;if(typeof source==="object")Object.assign(globalThis[target],source);return true},setValue:function(key,value){this.graph[key]=value;return true},assignObject:function(target,source){if(!this.graph[target])return false;if(typeof source==="object")Object.assign(this.graph[target],source);return true},setGlobalFunction:(fn,fnName)=>{if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;globalThis[fnName]=fn;return true}return false},assignFunctionToGlobalObject:function(globalObjectName,fn,fnName){if(!globalThis[globalObjectName])return false;if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;this.graph[globalObjectName][fnName]=fn;return true}return false},setFunction:function(fn,fnName){if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;this.graph[fnName]=fn;return true}return false},assignFunctionToObject:function(objectName,fn,fnName){if(!this.graph[objectName])return false;if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;this.graph[objectName][fnName]=fn;return true}return false}};var Systems={collision:{tag:"collision",setupEntities:function(entities){for(const key in entities){const entity=entities[key];if(entity.components){if(!entity.components[this.tag])continue}this.setupEntity(entity)}return entities},setupEntity:function(entity){if(!("collisionEnabled"in entity))entity.collisionEnabled=true;if(!entity.collisionType)entity.collisionType="sphere";if(!entity.collisionRadius)entity.collisionRadius=1;if(!entity.collisionBoundsScale)entity.collisionBoundsScale={x:1,y:1,z:1};if(!entity.colliding)entity.colliding={};if(!entity.position)entity.position={x:0,y:0,z:0};return entity},operator:function(entities){let keys=this.entityKeys;for(let i=0;i<keys.length;i++){const entity1=entities[keys[i]];if(entity1.components){if(!entity1.components[this.tag]||!entity1.collisionEnabled)continue}if(!entity1.collisionEnabled)continue;for(let j=0;j<keys.length;j++){if(i===j)continue;const entity2=entities[keys[j]];if(entity2.components){if(!entity2.components[this.tag])continue}if(!entity2.collisionEnabled)continue;let colliding=Systems.collision.collisionCheck(entity1,entity2);if(colliding!==false){if(!entity1.colliding)entity1.colliding={};if(!entity2.colliding)entity2.colliding={};entity1.colliding[entity2.tag]=colliding;entity2.colliding[entity1.tag]=colliding}}}return entities},collisionCheck:(body1,body2)=>{if(body1.collisionEnabled===false||body2.collisionEnabled===false)return false;const dist=Systems.collision.distance(body1.position,body2.position);if(dist<Math.max(...Object.values(body1.collisionBoundsScale))*body1.collisionRadius+Math.max(...Object.values(body2.collisionBoundsScale))*body2.collisionRadius){let isColliding=false;if(body1.collisionType==="sphere"){if(body2.collisionType==="sphere"){isColliding=Systems.collision.sphereCollisionCheck(body1,body2,dist)}else if(body2.collisionType==="box"){isColliding=Systems.collision.sphereBoxCollisionCheck(body1,body2,dist)}else if(body2.collisionType==="point"){isColliding=Systems.collision.isPointInsideSphere(body2.position,body1,dist)}}else if(body1.collisionType==="box"){if(body2.collisionType==="sphere"){isColliding=Systems.collision.sphereBoxCollisionCheck(body2,body1,dist)}else if(body2.collisionType==="box"){isColliding=Systems.collision.boxCollisionCheck(body1,body2)}else if(body2.collisionType==="point"){isColliding=Systems.collision.isPointInsideBox(body1.position,body1)}}else if(body1.collisionType==="point"){if(body2.collisionType==="sphere"){isColliding=Systems.collision.isPointInsideSphere(body1.position,body2,dist)}else if(body2.collisionType==="box"){isColliding=Systems.collision.isPointInsideBox(body1.position,body2)}}if(isColliding)return dist}return false},sphereCollisionCheck:(body1,body2,dist)=>{if(dist===void 0)dist=Systems.collision.distance(body1.position,body2.position);return dist<body1.collisionRadius+body2.collisionRadius},boxCollisionCheck:(body1,body2)=>{let body1minX=(body1.position.x-body1.collisionRadius)*body1.collisionBoundsScale.x;let body1maxX=(body1.position.x+body1.collisionRadius)*body1.collisionBoundsScale.x;let body1minY=(body1.position.y-body1.collisionRadius)*body1.collisionBoundsScale.y;let body1maxY=(body1.position.y+body1.collisionRadius)*body1.collisionBoundsScale.y;let body1minZ=(body1.position.z-body1.collisionRadius)*body1.collisionBoundsScale.z;let body1maxZ=(body1.position.z+body1.collisionRadius)*body1.collisionBoundsScale.z;let body2minX=(body2.position.x-body2.collisionRadius)*body1.collisionBoundsScale.x;let body2maxX=(body2.position.x+body2.collisionRadius)*body1.collisionBoundsScale.x;let body2minY=(body2.position.y-body2.collisionRadius)*body1.collisionBoundsScale.y;let body2maxY=(body2.position.y+body2.collisionRadius)*body1.collisionBoundsScale.y;let body2minZ=(body2.position.z-body2.collisionRadius)*body1.collisionBoundsScale.z;let body2maxZ=(body2.position.z+body2.collisionRadius)*body1.collisionBoundsScale.z;return(body1maxX<=body2maxX&&body1maxX>=body2minX||body1minX<=body2maxX&&body1minX>=body2minX)&&(body1maxY<=body2maxY&&body1maxY>=body2minY||body1minY<=body2maxY&&body1minY>=body2minY)&&(body1maxZ<=body2maxZ&&body1maxZ>=body2minZ||body1minZ<=body2maxZ&&body1minZ>=body2minZ)},sphereBoxCollisionCheck:(sphere,box,dist)=>{let boxMinX=(box.position.x-box.collisionRadius)*box.collisionBoundsScale.x;let boxMaxX=(box.position.x+box.collisionRadius)*box.collisionBoundsScale.x;let boxMinY=(box.position.y-box.collisionRadius)*box.collisionBoundsScale.y;let boxMaxY=(box.position.y+box.collisionRadius)*box.collisionBoundsScale.y;let boxMinZ=(box.position.z-box.collisionRadius)*box.collisionBoundsScale.z;let boxMaxZ=(box.position.z+box.collisionRadius)*box.collisionBoundsScale.z;let clamp={x:Math.max(boxMinX,Math.min(sphere.position.x,boxMaxX)),y:Math.max(boxMinY,Math.min(sphere.position.y,boxMaxY)),z:Math.max(boxMinZ,Math.min(sphere.position.z,boxMaxZ))};if(dist===void 0)dist=Systems.collision.distance(sphere.position,clamp);return dist>sphere.collisionRadius},isPointInsideSphere:(point,sphere,dist)=>{if(dist===void 0)dist=Systems.collision.distance(point,sphere.position);return dist<sphere.collisionRadius},isPointInsideBox:(point,box)=>{let boxminX=(box.position.x-box.collisionRadius)*box.collisionBoundsScale.x;let boxmaxX=(box.position.x+box.collisionRadius)*box.collisionBoundsScale.x;let boxminY=(box.position.y-box.collisionRadius)*box.collisionBoundsScale.x;let boxmaxY=(box.position.y+box.collisionRadius)*box.collisionBoundsScale.x;let boxminZ=(box.position.z-box.collisionRadius)*box.collisionBoundsScale.x;let boxmaxZ=(box.position.z+box.collisionRadius)*box.collisionBoundsScale.x;return point.x>=boxminX&&point.x<=boxmaxX&&(point.y>=boxminY&&point.y<=boxmaxY)&&(point.z>=boxminZ&&point.z<=boxmaxZ)},closestPointOnLine:(point,lineStart,lineEnd)=>{let a={x:lineEnd.x-lineStart.x,y:lineEnd.y-lineStart.y,z:lineEnd.z-lineStart.z};let b={x:lineStart.x-point.x,y:lineStart.y-point.y,z:lineStart.z-point.z};let c={x:lineEnd.x-point.x,y:lineEnd.y-point.y,z:lineEnd.z-point.z};let bdota=Systems.collision.dot(b,a);if(bdota<=0)return lineStart;let cdota=Systems.collision.dot(c,a);if(cdota<=0)return lineEnd;let _bdotapluscdota=1/(bdota+cdota);return{x:lineStart.x+(lineEnd.x-lineStart.x)*bdota*_bdotapluscdota,y:lineStart.y+(lineEnd.y-lineStart.y)*bdota*_bdotapluscdota,z:lineStart.z+(lineEnd.z-lineStart.z)*bdota*_bdotapluscdota}},closestPointOnPolygon:(point,t0,t1,t2)=>{let n=Systems.collision.calcNormal(t0,t1,t2);let dist=Systems.collision.dot(point,n)-Systems.collision.dot(t0,n);let projection=Systems.collision.vecadd(point,Systems.collision.vecscale(n,-dist));let v0x=t2[0]-t0[0];let v0y=t2[1]-t0[1];let v0z=t2[2]-t0[2];let v1x=t1[0]-t0[0];let v1y=t1[1]-t0[1];let v1z=t1[2]-t0[2];let v2x=projection[0]-t0[0];let v2y=projection[1]-t0[1];let v2z=projection[2]-t0[2];let dot00=v0x*v0x+v0y*v0y+v0z*v0z;let dot01=v0x*v1x+v0y*v1y+v0z*v1z;let dot02=v0x*v2x+v0y*v2y+v0z*v2z;let dot11=v1x*v1x+v1y*v1y+v1z*v1z;let dot12=v1x*v2x+v1y*v2y+v1z*v2z;let denom2=dot00*dot11-dot01*dot01;if(Math.abs(denom2)<1e-30){return void 0}let _denom=1/denom2;let u=(dot11*dot02-dot01*dot12)*_denom;let v=(dot00*dot12-dot01*dot02)*_denom;if(u>=0&&v>=0&&u+v<1){return projection}else return void 0},calcNormal:(t0,t1,t2,positive=true)=>{var QR=Systems.collision.makeVec(t0,t1);var QS=Systems.collision.makeVec(t0,t2);if(positive===true){return Systems.collision.normalize(Systems.collision.cross3D(QR,QS))}else{return Systems.collision.normalize(Systems.collision.cross3D(QS,QR))}},dot:(v1,v2)=>{let dot=0;for(const key in v1){dot+=v1[key]*v2[key]}return dot},makeVec(p1,p2){return{x:p2.x-p1.x,y:p2.y-p1.y,z:p2.z-p1.z}},vecadd:(v1,v2)=>{let result=Object.assign({},v1);for(const key in result){result[key]+=v2[key]}return result},vecsub:(v1,v2)=>{let result=Object.assign({},v1);for(const key in result){result[key]-=v2[key]}return result},vecmul:(v1,v2)=>{let result=Object.assign({},v1);for(const key in result){result[key]*=v2[key]}return result},vecdiv:(v1,v2)=>{let result=Object.assign({},v1);for(const key in result){result[key]/=v2[key]}return result},vecscale:(v1,scalar)=>{let result=Object.assign({},v1);for(const key in result){result[key]*=scalar}return result},distance:(v1,v2)=>{let distance=0;for(const key in v1){distance+=Math.pow(v1[key]-v2[key],2)}return Math.sqrt(distance)},magnitude:v=>{let magnitude=0;for(const key in v){magnitude+=v[key]*v[key]}return Math.sqrt(magnitude)},normalize:v=>{let magnitude=Systems.collision.magnitude(v);let _mag=magnitude?1/magnitude:0;let vn=Object.assign({},v);for(const key in v){vn[key]=v[key]*_mag}return vn},distance3D(v1,v2){return Math.sqrt((v1.x-v2.x)*(v1.x-v2.x)+(v1.y-v2.y)*(v1.y-v2.y)+(v1.z-v2.z)*(v1.z-v2.z))},cross3D(v1,v2){return{x:v1.y*v2.z-v1.z*v2.y,y:v1.z*v2.x-v1.x*v2.z,z:v1.x*v2.y-v1.y*v2.x}},nearestNeighborSearch(entities,isWithinRadius=1e15){var tree={};;for(const key in entities){let newnode={tag:key,position:void 0,neighbors:[]};newnode.position=entities[key].position;tree[key]=newnode}for(const i in tree){for(const j in tree){var dist=Systems.collision.distance3D(tree[i].position,tree[j].position);if(dist<isWithinRadius){var newNeighbori={tag:j,position:entities[j].position,dist};tree[i].neighbors.push(newNeighbori);var newNeighborj={tag:j,position:entities[i].position,dist};tree[j].neighbors.push(newNeighborj)}}tree[i].neighbors.sort(function(a,b){return a.dist-b.dist})}return tree},generateBoundingVolumeTree(entities,mode="octree",withinRadius=1e15,minEntities=3){let dynamicBoundingVolumeTree={proto:{parent:void 0,children:{},entities:{},collisionType:"box",collisionRadius:1,collisionBoundsScale:{x:1,y:1,z:1},position:{x:0,y:0,z:0}},tree:{}};let maxX,maxY,maxZ;let minX=0,minY=0,minZ=0;let positions={};let minRadius=withinRadius;for(const key in entities){const body=entities[key];let xx=body.position.x+body.collisionRadius*body.collisionBoundsScale.x;let yy=body.position.y+body.collisionRadius*body.collisionBoundsScale.y;let zz=body.position.z+body.collisionRadius*body.collisionBoundsScale.z;if(maxX<xx)maxX=xx;if(minX>xx)minX=xx;if(maxY<yy)maxY=yy;if(minY>yy)minY=yy;if(maxZ<zz)maxZ=zz;if(minZ>zz)minZ=zz;if(minRadius>body.collisionRadius)minRadius=body.collisionRadius;positions[key]=body.position};let head=JSON.parse(JSON.stringify(dynamicBoundingVolumeTree.proto));let boxpos={x:(maxX+minX)*.5,y:(maxY+minY)*.5,z:(maxZ+minZ)*.5};let boxbounds={x:maxX-boxpos.x,y:maxY-boxpos.y,z:maxZ-boxpos.z};head.position=boxpos;head.collisionBoundsScale=boxbounds;head.entities=entities;dynamicBoundingVolumeTree.tree=head;minRadius*=2;if(mode==="octree"){let genOct=function(parentPos,halfbounds){let oct1={x:parentPos.x+halfbounds.x,y:parentPos.y+halfbounds.y,z:parentPos.z+halfbounds.z};let oct2={x:parentPos.x-halfbounds.x,y:parentPos.y+halfbounds.y,z:parentPos.z+halfbounds.z};let oct3={x:parentPos.x+halfbounds.x,y:parentPos.y-halfbounds.y,z:parentPos.z+halfbounds.z};let oct4={x:parentPos.x+halfbounds.x,y:parentPos.y+halfbounds.y,z:parentPos.z-halfbounds.z};let oct5={x:parentPos.x-halfbounds.x,y:parentPos.y-halfbounds.y,z:parentPos.z+halfbounds.z};let oct6={x:parentPos.x-halfbounds.x,y:parentPos.y+halfbounds.y,z:parentPos.z-halfbounds.z};let oct7={x:parentPos.x+halfbounds.x,y:parentPos.y-halfbounds.y,z:parentPos.z-halfbounds.z};let oct8={x:parentPos.x-halfbounds.x,y:parentPos.y-halfbounds.y,z:parentPos.z-halfbounds.z};return[oct1,oct2,oct3,oct4,oct5,oct6,oct7,oct8]},genOctTree=function(head2){let halfbounds={x:head2.collisionBoundsScale.x*.5,y:head2.collisionBoundsScale.y*.5,z:head2.collisionBoundsScale.z*.5};let octPos=genOct(head2.position,halfbounds);let check=Object.assign({},head2.bodies);for(let i=0;i<8;i++){let octquadrant=Object.assign(JSON.parse(JSON.stringify(dynamicBoundingVolumeTree.proto)),{position:octPos[i],collisionBoundsScale:halfbounds});octquadrant.parent=head2;for(const j in check){let collided=Systems.collision.collisionCheck(check[j],octquadrant);if(collided){octquadrant.entities[j]=check[j];delete check[j]}}if(Object.keys(octquadrant.entities).length>minEntities-1){head2.children[i]=octquadrant;octquadrant.parent=head2;if(Object.keys(octquadrant.entities).length>minEntities&&octquadrant.collisionRadius*.5>minRadius){genOctTree(octquadrant)}}}};genOctTree(head);return head}else{let tree=Systems.collision.nearestNeighborSearch(positions,withinRadius);let keys=Object.keys(tree);let tag=keys[Math.floor(Math.random()*keys.length)];let searching=true;let count=0;let genBoundingBoxLevel=(tree2,volumes)=>{let newVolumes={};let foundidxs={};let treekeys=Object.keys(tree2);while(searching&&count<treekeys.length){let node=tree2[tag];let i=0;let j=0;let ux=positions[node.tag].x-volumes[node.tag].collisionBoundsScale.x,uy=positions[node.tag].y-volumes[node.tag].collisionBoundsScale.y,uz=positions[node.tag].z-volumes[node.tag].collisionBoundsScale.z,mx=positions[node.tag].x+volumes[node.tag].collisionBoundsScale.x,my=positions[node.tag].y+volumes[node.tag].collisionBoundsScale.y,mz=positions[node.tag].z+volumes[node.tag].collisionBoundsScale.z;let newvolume=JSON.parse(JSON.stringify(dynamicBoundingVolumeTree.proto));newvolume.tag=`bound${Math.floor(Math.random()*1e15)}`;newvolume.children[node.tag]=volumes[node.tag];newvolume.bodies[node.tag]=entities[node.tag];volumes[node.tag].parent=newvolume;foundidxs[node.tag]=true;i++;j++;let nkeys=Object.keys(node.neighbors);while(i<nkeys.length&&j<3){if(foundidxs[node.neighbors[i].tag]){i++;continue}let uxn=positions[node.neighbors[i].tag].x-volumes[node.neighbors[i].tag].collisionBoundsScale.x,uyn=positions[node.neighbors[i].tag].y-volumes[node.neighbors[i].tag].collisionBoundsScale.y,uzn=positions[node.neighbors[i].tag].z-volumes[node.neighbors[i].tag].collisionBoundsScale.z,mxn=positions[node.neighbors[i].tag].x+volumes[node.neighbors[i].tag].collisionBoundsScale.x,myn=positions[node.neighbors[i].tag].y+volumes[node.neighbors[i].tag].collisionBoundsScale.y,mzn=positions[node.neighbors[i].tag].z+volumes[node.neighbors[i].tag].collisionBoundsScale.z;if(ux>uxn)ux=uxn;if(mx<mxn)mx=mxn;if(uy>uyn)uy=uyn;if(my<myn)my=myn;if(uz>uzn)uz=uzn;if(mz<mzn)mz=mzn;newvolume.children[node.neighbors[i].tag]=volumes[node.neighbors[i].tag];newvolume.entities[node.neighbors[i].tag]=entities[node.neighbors[i].tag];volumes[node.neighbors[i].tag].parent=newvolume;foundidxs[node.neighbors[i].tag]=true;i++;j++}let pos={x:(mx+ux)*.5,y:(my+uy)*.5,z:(mz+uz)*.5};let bounds={x:mx-pos.x,y:my-pos.y,z:mz-pos.z};newvolume.position=pos;newvolume.collisionBoundsScale=bounds;if(newvolume.bodies.length===1)newvolume=node;newVolumes[newvolume.tag]=newvolume;while(i<node.neighbors.length){if(!foundidxs[node.neighbors[i].tag])break;i++}if(i<node.neighbors.length){tag=node.neighbors[i].tag}else if(Object.keys(foundidxs).length<Object.keys(tree2).length){tag=keys[0]}else searching=false;count++}return newVolumes};let result=genBoundingBoxLevel(tree,entities);while(Object.keys(result).length>2){let nextTree=Systems.collision.nearestNeighborSearch(result,withinRadius);result=genBoundingBoxLevel(nextTree,result)}head.children=result;head.children.forEach(n=>{n.parent=head});return head}}},collider:{tag:"collider",lastTime:performance.now(),setupEntities:function(entities){for(const key in entities){const entity=entities[key];if(entity.components){if(!entity.components[this.tag])continue}this.setupEntity(entity)}return entities},setupEntity:function(entity){if(!("collisionEnabled"in entity))Systems.collision.setupEntity(entity);if(!("boundingBox"in entity))entity.boundingBox={bot:0,top:100,left:0,right:100,front:0,back:100};if(!("position"in entity)){Systems.movement.setupEntity(entity)}if(!("restitution"in entity))entity.restitution=1;if(!("useBoundingBox"in entity))entity.useBoundingBox=true;if(!entity.position.x&&!entity.position.y&&!entity.position.z){entity.position.x=Math.random()*entity.boundingBox.right;entity.position.y=Math.random()*entity.boundingBox.back;entity.position.z=Math.random()*entity.boundingBox.top}return entity},operator:function(entities){let keys=this.entityKeys;for(let i=0;i<keys.length;i++){const entity1=entities[keys[i]];if(entity1.components){if(!entity1.components[this.tag]||!entity1.collisionEnabled)continue}if(entity1.useBoundingBox)this.checkBoundingBox(entity1);if(!entity1.collisionEnabled)continue;if(entity1.colliding){for(const key2 in entity1.colliding){const entity2=entities[key2];if(entity1.colliding[key2]===false){delete entity1.colliding[key2];delete entity2.colliding[entity1.tag];continue}if(!entity2.collisionEnabled)continue;if(entity2.collisionType==="box"){this.resolveBoxCollision(entity1,entity2,entity1.colliding[key2])}else{if(entity1.collisionType==="box"){entity1.fixed=true;this.resolveSphereCollisions(entity1,entity2,entity1.colliding[key2]);entity1.fixed=false}else{this.resolveSphereCollisions(entity1,entity2,entity1.colliding[key2]);delete entity2.colliding[entity1.tag]}}delete entity1.colliding[entity2.tag]}delete entity1.colliding}}return entities},checkBoundingBox:entity=>{const xsize=entity.collisionRadius*entity.collisionBoundsScale.x;const ysize=entity.collisionRadius*entity.collisionBoundsScale.y;const zsize=entity.collisionRadius*entity.collisionBoundsScale.z;if(entity.position.y-ysize<=entity.boundingBox.front){entity.velocity.y*=-entity.restitution;entity.position.y=entity.boundingBox.front+ysize}if(entity.position.y+ysize>=entity.boundingBox.back){entity.velocity.y*=-entity.restitution;entity.position.y=entity.boundingBox.back-ysize}if(entity.position.x-xsize<=entity.boundingBox.left){entity.velocity.x*=-entity.restitution;entity.position.x=entity.boundingBox.left+xsize}if(entity.position.x+xsize>=entity.boundingBox.right){entity.velocity.x*=-entity.restitution;entity.position.x=entity.boundingBox.right-xsize}if(entity.position.z-zsize<=entity.boundingBox.bot){entity.velocity.z*=-entity.restitution;entity.position.z=entity.boundingBox.bot+zsize}if(entity.position.z+zsize>=entity.boundingBox.top){entity.velocity.z*=-entity.restitution;entity.position.z=entity.boundingBox.top-zsize}},resolveBoxCollision:(body1,box,negate)=>{let positionVec=Systems.collision.makeVec(body1.position,box.position);var directionVec=Object.values(positionVec);let closestSide;let closestDist=Infinity;let mul=-1;if(directionVec[idx]<0)mul=1;if(negate)mul=-mul;for(const key in body1.position){let dist=Math.abs(box.position[key]-body1.position[key]);if(dist<closestDist&&Math.abs(box.position[key]-body1.position[key]+body1.velocity[key]*1e-17)<dist){closestSide=key;closestDist=dist}}var idx=directionVec.indexOf(closestSide);if(idx===0)idx="x";if(idx===1)idx="y";if(idx===2)idx="z";if(idx===3)idx="w";let boxEdgeAxisPosition=box.position[idx]+box.collisionRadius*box.collisionBoundsScale[idx]*mul;if(negate){let body1Offset=boxEdgeAxisPosition-body1.collisionRadius*body1.collisionBoundsScale[idx]*mul;body1.position[idx]=body1Offset}else{let body1Offset=boxEdgeAxisPosition+body1.collisionRadius*body1.collisionBoundsScale[idx]*mul;body1.position[idx]=body1Offset}body1.velocity[idx]=-body1.velocity[idx]*body1.restitution;if(negate)body1.force[idx]=-body1.velocity[idx];var body2AccelMag=Systems.collision.magnitude(box.acceleration);var body2AccelNormal=Systems.collision.normalize(box.acceleration);body1.force[idx]=-body2AccelNormal[idx]*body2AccelMag*box.mass;if(negate)body1.force[idx]=-body1.force[idx]},resolveSphereCollisions:(entity1,entity2,dist)=>{if(dist===void 0)dist=Systems.collision.distance(entity1.position,entity2.position);let vecn=Systems.collision.normalize(Systems.collision.makeVec(entity1.position,entity2.position));let sumMass=entity1.mass+entity2.mass;let ratio=entity1.mass/sumMass;let rmin=1-ratio;if(entity1.fixed===false){entity1.position.x+=vecn.x*rmin*1.01;entity1.position.y+=vecn.y*rmin*1.01;entity1.position.z+=vecn.z*rmin*1.001}else{entity2.position.x-=vecn.x*1.01;entity2.position.y-=vecn.y*1.01;entity2.position.z-=vecn.z*1.01}if(entity2.fixed===false){entity2.position.x+=vecn.x*ratio*1.01;entity2.position.y+=vecn.y*ratio*1.01;entity2.position.z+=vecn.z*ratio*1.01}else{entity1.position.x+=vecn.x*1.01;entity1.position.y+=vecn.y*1.01;entity1.position.z+=vecn.z*1.01}dist=Systems.collision.distance(entity1.position,entity2.position);let vrel={x:entity1.velocity.x-entity2.velocity.x,y:entity1.velocity.y-entity2.velocity.y,z:entity1.velocity.z-entity2.velocity.z};let speed=vrel.x*vecn.x+vrel.y*vecn.y+vrel.z*vecn.z;if(speed>0){let impulse=2*speed/sumMass;if(entity1.fixed===false){entity1.velocity.x-=impulse*vecn.x*entity2.mass*entity1.restitution;entity1.velocity.y-=impulse*vecn.y*entity2.mass*entity1.restitution;entity1.velocity.z-=impulse*vecn.z*entity2.mass*entity1.restitution}if(entity2.fixed===false){entity2.velocity.x+=impulse*vecn.x*entity2.mass*entity2.restitution/entity2.mass;entity2.velocity.y+=impulse*vecn.y*entity2.mass*entity2.restitution/entity2.mass;entity2.velocity.z+=impulse*vecn.z*entity2.mass*entity2.restitution/entity2.mass}}}},nbody:{tag:"nbody",lastTime:performance.now(),G:6674e-14,frameMax:10,setupEntities:function(entities){for(const key in entities){const entity=entities[key];if(entity.components){if(!entity.components[this.tag])continue}this.setupEntity(entity)}return entities},setupEntity:function(entity){if(!("collisionEnabled"in entity))Systems.collider.setupEntity(entity);entity.isAttractor=true;if(!("attractorGroup"in entity))entity.attractorGroup=0;if(!("attractorGroupRules"in entity))entity.attractorGroupRules={0:this.G};return entity},operator:function(entities){let keys=this.entityKeys;for(let i=0;i<keys.length;i++){const entity=entities[keys[i]];if(entity.components){if(!entity.components[this.tag])continue}if(!entity.mass)continue;let nSearched=0;nested:for(let j=0;j<keys.length;j++){let randKey=keys[Math.floor(Math.random()*keys.length)];nSearched++;const entity2=entities[randKey];if(nSearched>this.frameMax)break nested;if(entity2.components){if(!entity2.components[this.tag])continue nested}if(!entity2.mass||!entity2.isAttractor)continue nested;this.attract(entity,entity2,void 0,this.G)}}return entities},attract:function(body1,body2,dist,G=this.G,vecn){if(dist===void 0)dist=Systems.collision.distance3D(body1.position,body2.position);if(vecn===void 0)vecn=Systems.collision.normalize(Systems.collision.makeVec(body1.position,body2.position));let Fg=0;if(dist<.1)dist=.1;if(body1.attractorGroupRules[body2.attractorGroup]){Fg=body1.attractorGroupRules[body2.attractorGroup]*body1.mass*body2.mass/(dist*dist)}else Fg=G*body1.mass*body2.mass/(dist*dist);body1.force.x+=vecn.x*Fg;body1.force.y+=vecn.y*Fg;body1.force.z+=vecn.z*Fg;body2.force.x-=vecn.x*Fg;body2.force.y-=vecn.y*Fg;body2.force.z-=vecn.z*Fg}},boid:{tag:"boid",lastTime:performance.now(),defaultAnchor:{x:Math.random(),y:Math.random(),z:Math.random(),mul:.006},setupEntities:function(entities){for(const key in entities){const entity=entities[key];this.setupEntity(entity)}return entities},setupEntity:function(entity){if(!entity.position){Systems.collider.setupEntity(entity)}let adjustedAnchor=Object.assign({},this.defaultAnchor);adjustedAnchor.x*=entity.boundingBox.right;adjustedAnchor.y*=entity.boundingBox.back;adjustedAnchor.z*=entity.boundingBox.top;let boidDefaults={cohesion:1e-5,separation:1e-4,alignment:.006,swirl:adjustedAnchor,attractor:Object.assign(adjustedAnchor,{mul:.002}),useCohesion:true,useSeparation:true,useAlignment:true,useSwirl:true,useAttractor:true,useAttraction:false,groupRadius:200,groupSize:5,searchLimit:5};if(!entity.boid){entity.boid=boidDefaults}else entity.boid=Object.assign(boidDefaults,entity.boid);if(this.entityKeys.length>1e3){entity.boid.groupSize=1;entity.boid.searchLimit=1}return entity},operator:function(entities){let now=performance.now();let timeStep=now-this.lastTime;this.lastTime=now;let keys=this.entityKeys;let length=keys.length;let _timeStep=1/timeStep;let w=-1;outer:for(let i=0;i<keys.length;i++){w++;let p0=entities[keys[i]];const inRange=[];const distances=[];const boidVelocities=[p0.position.x,p0.position.y,p0.position.z,0,0,0,p0.velocity.x,p0.velocity.y,p0.velocity.z,0,0,0,0,0,0,0,0,0];let groupCount=1;let k=-1;nested:for(let j=0;j<keys.length;j++){k++;if(distances.length>p0.boid.groupSize||k>p0.boid.searchLimit){break nested}let randj=keys[Math.floor(Math.random()*length)];if(k===w||randj===keys[i]||inRange.indexOf(randj)>-1){continue nested}else{let pr=entities[randj];let disttemp=Math.sqrt((p0.position.x-pr.position.x)*(p0.position.x-pr.position.x)+(p0.position.y-pr.position.y)*(p0.position.y-pr.position.y)+(p0.position.z-pr.position.z)*(p0.position.z-pr.position.z));if(disttemp>p0.boid.groupRadius){continue nested}else{distances.push(disttemp);inRange.push(randj);let distInv;if(p0.boid.useSeparation||p0.boid.useAlignment){distInv=p0.boid.groupRadius/(disttemp*disttemp);if(distInv>p0.maxSpeed)distInv=p0.maxSpeed;else if(distInv<-p0.maxSpeed)distInv=-p0.maxSpeed}if(p0.boid.useCohesion){boidVelocities[0]+=(pr.position.x-p0.position.x)*.5*disttemp*_timeStep;boidVelocities[1]+=(pr.position.y-p0.position.y)*.5*disttemp*_timeStep;boidVelocities[2]+=(pr.position.z-p0.position.z)*.5*disttemp*_timeStep}if(isNaN(disttemp)||isNaN(boidVelocities[0])||isNaN(pr.position.x)){console.log(disttemp,i,randj,p0.position,pr.position,boidVelocities);p0.position.x=NaN;return}if(p0.boid.useSeparation){boidVelocities[3]=boidVelocities[3]+(p0.position.x-pr.position.x)*distInv;boidVelocities[4]=boidVelocities[4]+(p0.position.y-pr.position.y)*distInv;boidVelocities[5]=boidVelocities[5]+(p0.position.z-pr.position.z)*distInv}if(p0.boid.useAttraction&&pr.boid.useAttraction){Systems.nbody.attract(p0,pr,disttemp)}if(p0.boid.useAlignment){boidVelocities[6]=boidVelocities[6]+pr.velocity.x*distInv;boidVelocities[7]=boidVelocities[7]+pr.velocity.y*distInv;boidVelocities[8]=boidVelocities[8]+pr.velocity.z*distInv}groupCount++}}}let _groupCount=1/groupCount;if(p0.boid.useCohesion){boidVelocities[0]=p0.boid.cohesion*(boidVelocities[0]*_groupCount);boidVelocities[1]=p0.boid.cohesion*(boidVelocities[1]*_groupCount);boidVelocities[2]=p0.boid.cohesion*(boidVelocities[2]*_groupCount)}else{boidVelocities[0]=0;boidVelocities[1]=0;boidVelocities[2]=0}if(p0.boid.useSeparation){boidVelocities[3]=p0.boid.separation*boidVelocities[3];boidVelocities[4]=p0.boid.separation*boidVelocities[4];boidVelocities[5]=p0.boid.separation*boidVelocities[5]}else{boidVelocities[3]=0;boidVelocities[4]=0;boidVelocities[5]=0}if(p0.boid.useAlignment){boidVelocities[6]=-(p0.boid.alignment*boidVelocities[6]*_groupCount);boidVelocities[7]=p0.boid.alignment*boidVelocities[7]*_groupCount;boidVelocities[8]=p0.boid.alignment*boidVelocities[8]*_groupCount}else{boidVelocities[6]=0;boidVelocities[7]=0;boidVelocities[8]=0}const swirlVec=[0,0,0];if(p0.boid.useSwirl==true){boidVelocities[9]=-(p0.position.y-p0.boid.swirl.y)*p0.boid.swirl.mul;boidVelocities[10]=(p0.position.z-p0.boid.swirl.z)*p0.boid.swirl.mul;boidVelocities[11]=(p0.position.x-p0.boid.swirl.x)*p0.boid.swirl.mul}const attractorVec=[0,0,0];if(p0.boid.useAttractor==true){boidVelocities[12]=(p0.boid.attractor.x-p0.position.x)*p0.boid.attractor.mul;if(p0.position.x>p0.boundingBox.left||p0.position.x<p0.boundingBox.right){boidVelocities[12]*=3}boidVelocities[13]=(p0.boid.attractor.y-p0.position.y)*p0.boid.attractor.mul;if(p0.position.y>p0.boundingBox.top||p0.position.y<p0.boundingBox.bottom){boidVelocities[13]*=3}boidVelocities[14]=(p0.boid.attractor.z-p0.position.z)*p0.boid.attractor.mul;if(p0.position.z>p0.boundingBox.front||p0.position.z<p0.boundingBox.back){boidVelocities[14]*=3}}p0.velocity.x=p0.velocity.x+boidVelocities[0]+boidVelocities[3]+boidVelocities[6]+boidVelocities[9]+boidVelocities[12]+boidVelocities[15],p0.velocity.y=p0.velocity.y+boidVelocities[1]+boidVelocities[4]+boidVelocities[7]+boidVelocities[10]+boidVelocities[13]+boidVelocities[16],p0.velocity.z=p0.velocity.z+boidVelocities[2]+boidVelocities[5]+boidVelocities[8]+boidVelocities[11]+boidVelocities[14]+boidVelocities[17];if(isNaN(p0.velocity.x))console.error(p0,i,groupCount,p0.position,p0.velocity,swirlVec,attractorVec)}return entities}},movement:{tag:"movement",lastTime:performance.now(),setupEntities:function(entities){for(const key in entities){const entity=entities[key];if(entity.components){if(!entity.components[this.tag])continue}this.setupEntity(entity)}},setupEntity:function(entity){if(!("mass"in entity))entity.mass=1;if(!("fixed"in entity))entity.fixed=false;if(!entity.force)entity.force={x:0,y:0,z:0};if(!("mass"in entity))entity.mass=1;if(!("gravity"in entity))entity.gravity=-9.81;if(!entity.acceleration)entity.acceleration={x:0,y:0,z:0};if(!entity.velocity)entity.velocity={x:0,y:0,z:0};if(!("maxSpeed"in entity))entity.maxSpeed=10;if(!entity.position)entity.position={x:0,y:0,z:0};return entity},operator:function(entities){let now=performance.now();let timeStep=(now-this.lastTime)*.001;this.lastTime=now;let keys=this.entityKeys;for(let i=0;i<keys.length;i++){const entity=entities[keys[i]];if(entity.components){if(!entity.components[this.tag])continue}if(entity.fixed)continue;if(entity.mass){if(entity.force.x){entity.acceleration.x+=entity.force.x/entity.mass;entity.force.x=0}if(entity.force.y){entity.acceleration.y+=entity.force.y/entity.mass;entity.force.y=0}if(entity.force.z){entity.acceleration.z+=entity.force.z/entity.mass+entity.gravity;entity.force.z=0}}if(entity.drag){if(entity.acceleration.x)entity.acceleration.x-=entity.acceleration.x*entity.drag*timeStep;if(entity.acceleration.y)entity.acceleration.y-=entity.acceleration.y*entity.drag*timeStep;if(entity.acceleration.z)entity.acceleration.z-=entity.acceleration.z*entity.drag*timeStep}if(entity.acceleration.x)entity.velocity.x+=entity.acceleration.x*timeStep;if(entity.acceleration.y)entity.velocity.y+=entity.acceleration.y*timeStep;if(entity.acceleration.z)entity.velocity.z+=entity.acceleration.z*timeStep;if(entity.maxSpeed>0){let magnitude=Systems.collision.magnitude(entity.velocity);if(magnitude>entity.maxSpeed){let scalar=entity.maxSpeed/magnitude;entity.velocity.x*=scalar;entity.velocity.y*=scalar;entity.velocity.z*=scalar}}if(entity.velocity.x)entity.position.x+=entity.velocity.x*timeStep;if(entity.velocity.y)entity.position.y+=entity.velocity.y*timeStep;if(entity.velocity.z)entity.position.z+=entity.velocity.z*timeStep}return entities}}};var import_sjcl=__toESM(require_sjcl());var _HTTPfrontend=class extends Service{constructor(options,path,fetched){super(options);this.name="http";this.fetchProxied=false;this.listening={};this.GET=(url="http://localhost:8080/ping",type="",mimeType)=>{if(type==="json")mimeType="application/json";return new Promise((resolve,reject)=>{let xhr=_HTTPfrontend.request({method:"GET",url,responseType:type,mimeType,onload:ev2=>{let data;if(xhr.responseType===""||xhr.responseType==="text")data=xhr.responseText;else data=xhr.response;if(url instanceof URL)url=url.toString();this.setState({[url]:data});resolve(data)},onabort:er=>{reject(er)}})}).catch(console.error)};this.POST=(message,url="http://localhost:8080/echo",type="",mimeType)=>{if(typeof message==="object"&&(type==="json"||type==="text"||!type)){message=JSON.stringify(message)}if(type==="json")mimeType="application/json";return new Promise((resolve,reject)=>{let xhr=_HTTPfrontend.request({method:"POST",url,data:message,responseType:type,mimeType,onload:ev2=>{let data;if(xhr.responseType===""||xhr.responseType==="text")data=xhr.responseText;else data=xhr.response;if(url instanceof URL)url=url.toString();this.setState({[url]:data});resolve(data)},onabort:er=>{reject(er)}})}).catch(console.error)};this.transmit=(message,url)=>{let obj=message;if(typeof obj==="object"){message=JSON.stringify(obj)}if(obj?.method?.toLowerCase()=="get"||message?.toLowerCase()==="get")return this.GET(url);return this.post(message,url)};this.transponder=(url,message,type="",mimeType)=>{if(typeof message==="object")message=JSON.stringify(message);let method="GET";if(message){method="POST"}if(type==="json")mimeType="application/json";else return new Promise((resolve,reject)=>{let xhr=_HTTPfrontend.request({method,url,data:message,responseType:type,onload:ev2=>{let body=xhr.response;if(typeof body==="string"){let substr=body.substring(0,8);if(substr.includes("{")||substr.includes("[")){if(substr.includes("\\\\"))body=body.replace(/\\\\/g,"");if(body[0]===\'"\'){body=body.substring(1,body.length-1)};body=JSON.parse(body)}}if(typeof body?.method==="string"){return resolve(this.handleMethod(body.route,body.method,body.args))}else if(typeof body?.route==="string"){return resolve(this.handleServiceMessage(body))}else if(typeof body?.node==="string"||body.node instanceof GraphNode){return resolve(this.handleGraphNodeCall(body.node,body.args))}else return resolve(body)},onabort:er=>{reject(er)}})}).catch(console.error)};this.listen=(path2="0",fetched2=async(clone,args,response)=>{const result=await clone.text();const returned=this.receive(result);this.setState({[response.url]:returned})})=>{this.listening[path2]={};let listenerId=`${path2}${Math.floor(Math.random()*1e15)}`;this.listening[path2][listenerId]=fetched2;if(!this.fetchProxied){globalThis.fetch=new Proxy(globalThis.fetch,{apply(fetch,that,args){const result=fetch.apply(that,args);result.then(response=>{if(!response.ok)return;if(this.listening["0"]){for(const key in this.listeners){const clone=response.clone();this.listening["0"][key](clone,args,response)}}else{for(const key in this.listening){if(response.url.includes(key)){for(const key2 in this.listening[path2]){const clone=response.clone();this.listening[path2][key2](clone,args,response)}break}}}}).catch(er=>{console.error(er)});return result}});this.fetchProxied=true}return listenerId};this.stopListening=(path2,listener)=>{if(!path2&&path2!==0){for(const key in this.listening)delete this.listening[key]}else{if(!listener)delete this.listening[path2];else delete this.listeners[listener]}};this.routes={request:this.request,GET:this.GET,POST:this.POST,transponder:this.transponder,listen:this.listen,stopListening:this.stopListening};this.load(this.routes);this.listen(path,fetched)}};var HTTPfrontend=_HTTPfrontend;HTTPfrontend.request=options=>{const xhr=new XMLHttpRequest;if(options.responseType)xhr.responseType=options.responseType;else options.responseType="json";if(options.mimeType){xhr.overrideMimeType(options.mimeType)}if(options.onload)xhr.addEventListener("load",options.onload,false);if(options.onprogress)xhr.addEventListener("progress",options.onprogress,false);if(options.onabort)xhr.addEventListener("abort",options.onabort,false);if(options.onloadend)xhr.addEventListener("loadend",options.onloadend,false);if(options.onerror)xhr.addEventListener("error",options.onerror,false);xhr.open(options.method,options.url,true,options.user,options.pass);if(!options.onerror)xhr.onerror=function(){xhr.abort()};xhr.send(options.data);return xhr};var import_web_worker=__toESM(require_browser());var WorkerService=class extends Service{constructor(options){super(options);this.name="worker";this.workers={};this.threadRot=0;this.connections={workers:this.workers};this.customRoutes={"worker":(route,routeKey,routes)=>{let rt=route;if(rt?.worker||rt?.workerId){if(rt.workerUrl)rt.url=rt.workerUrl;if(rt.workerId)rt.tag=rt.workerId;if(!rt.tag)rt.tag=routeKey;rt._id=rt.tag;let worker;if(this.workers[rt._id])worker=this.workers[rt._id];if(!worker)worker=this.addWorker(rt);rt.worker=worker;if(rt.transferFunctions){for(const prop in rt.transferFunctions){this.transferFunction(worker,rt.transferFunctions[prop],prop)}}if(rt.transferClasses){for(const prop in rt.transferClasses){this.transferClass(worker,rt.transferClasses[prop],prop)}}if(worker){if(!rt.operator){rt.operator=(...args)=>{console.log("operator",args);if(rt.callback){if(!this.nodes.get(rt.tag)?.children)worker.post(rt.callback,args);else return worker.run(rt.callback,args)}else{if(!this.nodes.get(rt.tag)?.children)worker.send(args);else return worker.request(args)}}}}}return rt}};this.customChildren={"worker":(child,childRouteKey,parent,routes,checked)=>{let worker;if(child?.worker||child?.workerId){if(child.workerUrl)child.url=child.workerUrl;if(child.workerId)child.tag=child.workerId;if(!child.tag)child.tag=childRouteKey;child._id=child.tag;if(this.workers[child._id])worker=this.workers[child._id];if(!worker)worker=this.addWorker(child);child.worker=worker;if(child.transferFunctions){for(const prop in child.transferFunctions){this.transferFunction(worker,child.transferFunctions[prop],prop)}}if(child.transferClasses){for(const prop in child.transferClasses){this.transferClass(worker,child.transferClasses[prop],prop)}}if(worker){if(!child.operator){child.operator=(...args)=>{console.log("operator",args);if(child.callback){if(!this.nodes.get(child.tag)?.children)worker.post(child.callback,args);else return worker.run(child.callback,args)}else{if(!this.nodes.get(child.tag)?.children)worker.send(args);else return worker.request(args)}}}}}if(child.parentRoute&&(parent?.worker||parent?.workerId)){if(worker){let portId=this.establishMessageChannel(worker,parent.worker.worker);worker.post("subscribeToWorker",child.parentRoute,portId,child.callback)}else{parent.worker.subscribe(child.parentRoute,result=>{this.nodes.get(child.tag?child.tag:childRouteKey).run(result)})}}}};this.addWorker=options2=>{let worker;if(!options2._id)options2._id=`worker${Math.floor(Math.random()*1e15)}`;if(options2.url)worker=new import_web_worker.default(options2.url);else if(options2.port){worker=options2.port}else if(this.workers[options2._id]){if(this.workers[options2._id].port)worker=this.workers[options2._id].port;else worker=this.workers[options2._id].worker}if(!worker)return;let send=(message,transfer)=>{return this.transmit(message,worker,transfer)};let post=(route,args,transfer,method)=>{let message={route,args};if(method)message.method=method;return this.transmit(message,worker,transfer)};let run=(route,args,transfer,method)=>{return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[{route,args},options2._id,callbackId]};if(method)req.args[0].method=method;let onmessage=ev2=>{if(typeof ev2.data==="object"){if(ev2.data.callbackId===callbackId){worker.removeEventListener("message",onmessage);res(ev2.data.args)}}};worker.addEventListener("message",onmessage);this.transmit(req,worker,transfer)})};let request=(message,transfer,method)=>{return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[message,options2._id,callbackId]};if(method)req.method=method;let onmessage=ev2=>{if(typeof ev2.data==="object"){if(ev2.data.callbackId===callbackId){worker.removeEventListener("message",onmessage);res(ev2.data.args)}}};worker.addEventListener("message",onmessage);this.transmit(req,worker,transfer)})};let subscribe=(route,callback)=>{return this.subscribeToWorker(route,options2._id,callback)};let unsubscribe=(route,sub)=>{return run("unsubscribe",[route,sub])};let terminate=()=>{return this.terminate(options2._id)};if(!options2.onmessage)options2.onmessage=ev2=>{this.receive(ev2.data);this.setState({[options2._id]:ev2.data})};if(!options2.onerror){options2.onerror=ev2=>{console.error(ev2.data)}}worker.onmessage=options2.onmessage;worker.onerror=options2.onerror;this.workers[options2._id]={worker,send,post,run,request,subscribe,unsubscribe,terminate,graph:this,...options2};return this.workers[options2._id]};this.toObjectURL=scriptTemplate=>{let blob=new Blob([scriptTemplate],{type:"text/javascript"});return URL.createObjectURL(blob)};this.transmit=(message,worker,transfer)=>{if(!transfer){transfer=this.getTransferable(message)}if(worker instanceof import_web_worker.default||worker instanceof MessagePort){worker.postMessage(message,transfer)}else if(typeof worker==="string"){if(this.workers[worker]){if(this.workers[worker].port)this.workers[worker].port.postMessage(message,transfer);else if(this.workers[worker].worker)this.workers[worker].worker.postMessage(message,transfer)}}else{let keys=Object.keys(this.workers);this.workers[keys[this.threadRot]].worker.postMessage(message,transfer);this.threadRot++;if(this.threadRot===keys.length)this.threadRot=0}return message};this.terminate=worker=>{let onclose;if(typeof worker==="string"){let obj=this.workers[worker];if(obj)delete this.workers[worker];worker=obj.worker;if(obj.onclose)onclose=obj.onclose}if(worker instanceof import_web_worker.default){worker.terminate();if(onclose)onclose(worker);return true}if(worker instanceof MessagePort){worker.close();if(onclose)onclose(worker);return true}return false};this.establishMessageChannel=(worker,worker2)=>{let workerId;if(typeof worker==="string"){workerId=worker;if(this.workers[worker]){if(this.workers[worker].port)worker=this.workers[worker].port;else worker2=this.workers[worker].worker}}if(typeof worker2==="string"){if(this.workers[worker2]){if(this.workers[worker2].port)worker2=this.workers[worker2].port;else worker2=this.workers[worker2].worker}}if(worker instanceof import_web_worker.default||worker instanceof MessagePort){let channel=new MessageChannel;let portId=`port${Math.floor(Math.random()*1e15)}`;worker.postMessage({route:"addWorker",args:{port:channel.port1,_id:portId}},[channel.port1]);if(worker2 instanceof import_web_worker.default||worker2 instanceof MessagePort){worker2.postMessage({route:"addWorker",args:{port:channel.port2,_id:portId}},[channel.port2])}else if(workerId&&this.workers[workerId])this.workers[workerId].port=channel.port2;return portId}return false};this.request=(message,workerId,transfer,method)=>{let worker=this.workers[workerId].worker;return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[message,callbackId]};if(method)req.method=method;let onmessage=ev2=>{if(typeof ev2.data==="object"){if(ev2.data.callbackId===callbackId){worker.removeEventListener("message",onmessage);res(ev2.data.args)}}};worker.addEventListener("message",onmessage);this.transmit(req,worker,transfer)})};this.runRequest=(message,worker,callbackId)=>{let res=this.receive(message);if(typeof worker==="string"&&this.workers[worker]){if(this.workers[worker].port)worker=this.workers[worker].port;else worker=this.workers[worker].worker}if(res instanceof Promise){res.then(r=>{if(worker instanceof import_web_worker.default||worker instanceof MessagePort)worker.postMessage({args:r,callbackId});else if(typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope)globalThis.postMessage({args:r,callbackId})})}else{if(worker instanceof import_web_worker.default||worker instanceof MessagePort)worker.postMessage({args:res,callbackId});else if(typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope)globalThis.postMessage({args:res,callbackId})}return res};this.subscribeWorker=(route,worker)=>{if(typeof worker==="string"&&this.workers[worker]){if(this.workers[worker].port)worker=this.workers[worker].port;else worker=this.workers[worker].worker}return this.subscribe(route,res=>{if(res instanceof Promise){res.then(r=>{if(worker?.postMessage)worker.postMessage({args:r,callbackId:route});else if(globalThis.postMessage)globalThis.postMessage({args:r,callbackId:route})})}else{if(worker?.postMessage)worker.postMessage({args:res,callbackId:route});else if(globalThis.postMessage)globalThis.postMessage({args:res,callbackId:route})}})};this.subscribeToWorker=(route,workerId,callback)=>{if(typeof workerId==="string"&&this.workers[workerId]){this.subscribe(workerId,res=>{if(res?.callbackId===route){if(!callback)this.setState({[workerId]:res.args});else if(typeof callback==="string"){this.run(callback,res.args)}else callback(res.args)}});return this.workers[workerId].run("subscribeWorker",[route,workerId])}};this.routes={addWorker:{operator:this.addWorker,aliases:["open"]},toObjectURL:this.toObjectURL,request:this.request,runRequest:this.runRequest,establishMessageChannel:this.establishMessageChannel,subscribeWorker:this.subscribeWorker,subscribeToWorker:this.subscribeToWorker,unsubscribe:this.unsubscribe,terminate:this.terminate};this.load(this.routes);if(typeof WorkerGlobalScope!=="undefined"&&globalThis instanceof WorkerGlobalScope){globalThis.onmessage=ev2=>{let result=this.receive(ev2.data);if(this.keepState)this.setState({[this.name]:result})}}}getTransferable(message){let transfer;if(typeof message==="object"){if(message.args){if(message.args.constructor?.name==="Object"){for(const key in message.args){if(ArrayBuffer.isView(message.args[key])){if(!transfer)transfer=[message.args[key].buffer];else transfer.push(message.args[key].buffer)}else if(message.args[key]?.constructor?.name==="ArrayBuffer"){if(!transfer)transfer=[message.args[key]];else transfer.push(message.args[key])}}}else if(Array.isArray(message.args)&&message.args.length<11){message.args.forEach(arg=>{if(ArrayBuffer.isView(arg)){transfer=[arg.buffer]}else if(arg.constructor?.name==="ArrayBuffer")transfer=[arg]})}else if(ArrayBuffer.isView(message.args)){transfer=[message.args.buffer]}else if(message.args.constructor?.name==="ArrayBuffer"){transfer=[message]}}else if(message.constructor?.name==="Object"){for(const key in message){if(ArrayBuffer.isView(message[key])){if(!transfer)transfer=[message[key].buffer];else transfer.push(message[key].buffer)}else if(message[key]?.constructor?.name==="ArrayBuffer"){if(!transfer)transfer=[message[key]];else transfer.push(message[key])}}}else if(Array.isArray(message)&&message.length<11){message.forEach(arg=>{if(ArrayBuffer.isView(arg)){transfer=[arg.buffer]}else if(arg.constructor?.name==="ArrayBuffer")transfer=[arg]})}else if(ArrayBuffer.isView(message)){transfer=[message.buffer]}else if(message.constructor?.name==="ArrayBuffer"){transfer=[message]}}return transfer}transferFunction(worker,fn,fnName){if(!fnName)fnName=fn.name;return worker.request({route:"setRoute",args:[fn.toString(),fnName]})}transferClass(worker,cls,className){if(!className)className=cls.name;return worker.request({route:"receiveClass",args:[cls.toString(),className]})}};var mouseEventHandler=makeSendPropertiesHandler(["ctrlKey","metaKey","shiftKey","button","pointerType","clientX","clientY","pageX","pageY"]);var wheelEventHandlerImpl=makeSendPropertiesHandler(["deltaX","deltaY"]);var keydownEventHandler=makeSendPropertiesHandler(["ctrlKey","metaKey","shiftKey","keyCode"]);function wheelEventHandler(event,sendFn){event.preventDefault();wheelEventHandlerImpl(event,sendFn)}function preventDefaultHandler(event){event.preventDefault()}function copyProperties(src,properties,dst){for(const name of properties){dst[name]=src[name]}}function makeSendPropertiesHandler(properties){return function sendProperties(event,sendFn){const data={type:event.type};copyProperties(event,properties,data);sendFn(data)}}function touchEventHandler(event,sendFn){const touches=[];const data={type:event.type,touches};for(let i=0;i<event.touches.length;++i){const touch=event.touches[i];touches.push({pageX:touch.pageX,pageY:touch.pageY})}sendFn(data)}var orbitKeys={"37":true,"38":true,"39":true,"40":true};function filteredKeydownEventHandler(event,sendFn){const{keyCode}=event;if(orbitKeys[keyCode]){event.preventDefault();keydownEventHandler(event,sendFn)}}var eventHandlers={contextmenu:preventDefaultHandler,mousedown:mouseEventHandler,mousemove:mouseEventHandler,mouseup:mouseEventHandler,pointerdown:mouseEventHandler,pointermove:mouseEventHandler,pointerup:mouseEventHandler,touchstart:touchEventHandler,touchmove:touchEventHandler,touchend:touchEventHandler,wheel:wheelEventHandler,keydown:filteredKeydownEventHandler};function initProxyElement(element,worker,id){if(!id)id="proxy"+Math.floor(Math.random()*1e15);const sendEvent=data=>{worker.postMessage({route:"handleProxyEvent",args:[data,id]})};let entries=Object.entries(eventHandlers);for(const[eventName,handler]of entries){element.addEventListener(eventName,function(event){handler(event,sendEvent)})}const sendSize=()=>{const rect=element.getBoundingClientRect();sendEvent({type:"resize",left:rect.left,top:rect.top,width:element.clientWidth,height:element.clientHeight})};sendSize();globalThis.addEventListener("resize",sendSize);return id}var EventDispatcher=class{addEventListener(type,listener){if(this._listeners===void 0)this._listeners={};const listeners=this._listeners;if(listeners[type]===void 0){listeners[type]=[]}if(listeners[type].indexOf(listener)===-1){listeners[type].push(listener)}}hasEventListener(type,listener){if(this._listeners===void 0)return false;const listeners=this._listeners;return listeners[type]!==void 0&&listeners[type].indexOf(listener)!==-1}removeEventListener(type,listener){if(this._listeners===void 0)return;const listeners=this._listeners;const listenerArray=listeners[type];if(listenerArray!==void 0){const index=listenerArray.indexOf(listener);if(index!==-1){listenerArray.splice(index,1)}}}dispatchEvent(event,target){if(this._listeners===void 0)return;const listeners=this._listeners;const listenerArray=listeners[event.type];if(listenerArray!==void 0){if(!target)event.target=this;else event.target=target;const array=listenerArray.slice(0);for(let i=0,l=array.length;i<l;i++){array[i].call(this,event)}event.target=null}}};function noop(){}var ElementProxyReceiver=class extends EventDispatcher{constructor(){super();this._listeners={};this.style={};this.setPointerCapture=()=>{};this.releasePointerCapture=()=>{};this.getBoundingClientRect=()=>{return{left:this.left,top:this.top,width:this.width,height:this.height,right:this.left+this.width,bottom:this.top+this.height}};this.handleEvent=data=>{if(data.type==="resize"){this.left=data.left;this.top=data.top;this.width=data.width;this.height=data.height;if(typeof this.proxied==="object"){this.proxied.width=this.width;this.proxied.height=this.height;this.proxied.clientWidth=this.width;this.proxied.clientHeight=this.height}}data.preventDefault=noop;data.stopPropagation=noop;this.dispatchEvent(data,this.proxied)};this.style={}}get clientWidth(){return this.width}get clientHeight(){return this.height}focus(){}};var ProxyManager=class{constructor(){this.targets={};this.makeProxy=(id,addTo=void 0)=>{if(!id)id=`proxyReceiver${Math.floor(Math.random()*1e15)}`;let proxy;if(this.targets[id])proxy=this.targets[id];else{proxy=new ElementProxyReceiver;this.targets[id]=proxy}if(typeof addTo==="object"){addTo.proxy=proxy;proxy.proxied=addTo;console.log(proxy,addTo);addTo.style=proxy.style;if(proxy.width){addTo.width=proxy.width;addTo.clientWidth=proxy.width}if(proxy.height){addTo.height=proxy.height;addTo.clientHeight=proxy.height}addTo.setPointerCapture=proxy.setPointerCapture.bind(proxy);addTo.releasePointerCapture=proxy.releasePointerCapture.bind(proxy);addTo.getBoundingClientRect=proxy.getBoundingClientRect.bind(proxy);addTo.addEventListener=proxy.addEventListener.bind(proxy);addTo.removeEventListener=proxy.removeEventListener.bind(proxy);addTo.handleEvent=proxy.handleEvent.bind(proxy);addTo.dispatchEvent=proxy.dispatchEvent.bind(proxy);addTo.focus=proxy.focus.bind(proxy)}};this.getProxy=id=>{return this.targets[id]};this.handleEvent=(data,id)=>{if(!this.targets[id])this.makeProxy(id);if(this.targets[id]){this.targets[id].handleEvent(data);return true}return void 0};if(!globalThis.document)globalThis.document={}}};var proxyElementWorkerRoutes={initProxyElement,makeProxy:function(id,elm){if(!this.graph.ProxyManager)this.graph.ProxyManager=new ProxyManager;this.graph.ProxyManager.makeProxy(id,elm);return id},handleProxyEvent:function(data,id){if(!this.graph.ProxyManager)this.graph.ProxyManager=new ProxyManager;if(this.graph.ProxyManager.handleEvent(data,id))return data}};var workerCanvasRoutes={...proxyElementWorkerRoutes,transferCanvas:function(worker,options,route){if(!options)return void 0;if(!options._id)options._id=`canvas${Math.floor(Math.random()*1e15)}`;let offscreen=options.canvas.transferControlToOffscreen();let message={route:route?route:"receiveCanvas",args:{canvas:offscreen,context:options.context,_id:options._id}};this.graph.run("initProxyElement",options.canvas,worker,options._id);if(options.draw){if(typeof options.draw==="function")message.args.draw=options.draw.toString();else message.args.draw=options.draw}if(options.update){if(typeof options.update==="function")message.args.update=options.update.toString();else message.args.update=options.update}if(options.init){if(typeof options.init==="function")message.args.init=options.init.toString();else message.args.init=options.init}if(options.clear){if(typeof options.clear==="function")message.args.clear=options.clear.toString();else message.args.clear=options.clear}worker.postMessage(message,[offscreen]);const workercontrols={_id:options._id,worker,draw:props=>{worker.postMessage({route:"drawFrame",args:[options._id,props]})},update:props=>{worker.postMessage({route:"updateCanvas",args:[options._id,props]})},clear:()=>{worker.postMessage({route:"clearCanvas",args:options._id})},init:()=>{console.log("Posting init");worker.postMessage({route:"initCanvas",args:options._id})},stop:()=>{worker.postMessage({route:"stopAnim",args:options._id})},start:()=>{worker.postMessage({route:"startAnim",args:options._id})},set:newDrawProps=>{worker.postMessage({route:"setDraw",args:[newDrawProps,options._id]})}};return workercontrols},receiveCanvas:function(options){if(!this.graph.CANVASES)this.graph.CANVASES={};let canvasOptions=options;options._id?canvasOptions._id=options._id:canvasOptions._id=`canvas${Math.floor(Math.random()*1e15)}`;typeof options.context==="string"?canvasOptions.context=options.canvas.getContext(options.context):canvasOptions.context=options.context;"animating"in options?canvasOptions.animating=options.animating:canvasOptions.animating=true;if(this.graph.CANVASES[canvasOptions._id]){this.graph.run("setDraw",canvasOptions)}else{canvasOptions.graph=this.graph;this.graph.CANVASES[canvasOptions._id]=canvasOptions;this.graph.run("makeProxy",canvasOptions._id,canvasOptions.canvas);if(options.width)canvasOptions.canvas.width=options.width;if(options.height)canvasOptions.canvas.height=options.height;if(typeof canvasOptions.draw==="string"){canvasOptions.draw=parseFunctionFromText(canvasOptions.draw)}if(typeof canvasOptions.update==="string"){canvasOptions.update=parseFunctionFromText(canvasOptions.update)}if(typeof canvasOptions.init==="string"){canvasOptions.init=parseFunctionFromText(canvasOptions.init)}if(typeof canvasOptions.clear==="string"){canvasOptions.clear=parseFunctionFromText(canvasOptions.clear)}if(typeof canvasOptions.init==="function")canvasOptions.init(canvasOptions,canvasOptions.canvas,canvasOptions.context);if(typeof canvasOptions.draw==="function"&&canvasOptions.animating){let draw=(s,canvas,context)=>{if(s.animating){s.draw(s,canvas,context);requestAnimationFrame(()=>{draw(s,canvas,context)})}};draw(canvasOptions,canvasOptions.canvas,canvasOptions.context)}}return canvasOptions._id},setDraw:function(settings,_id){let canvasopts;if(_id)canvasopts=this.graph.CANVASES?.[settings._id];else if(settings._id)canvasopts=this.graph.CANVASES?.[settings._id];else canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]];if(canvasopts){if(settings.canvas){canvasopts.canvas=settings.canvas;this.graph.run("makeProxy",canvasopts._id,canvasopts.canvas)}if(typeof settings.context==="string")canvasopts.context=canvasopts.canvas.getContext(settings.context);else if(settings.context)canvasopts.context=settings.context;if(settings.width)canvasopts.canvas.width=settings.width;if(settings.height)canvasopts.canvas.height=settings.height;if(typeof settings.draw==="string")settings.draw=parseFunctionFromText(settings.draw);if(typeof settings.draw==="function"){canvasopts.draw=settings.draw}if(typeof settings.update==="string")settings.update=parseFunctionFromText(settings.update);if(typeof settings.update==="function"){canvasopts.update=settings.update}if(typeof settings.init==="string")settings.init=parseFunctionFromText(settings.init);if(typeof settings.init==="function"){canvasopts.init=settings.init}if(typeof settings.clear==="string")settings.clear=parseFunctionFromText(settings.clear);if(typeof settings.clear==="function"){canvasopts.clear=settings.clear}return settings._id}return void 0},drawFrame:function(props,_id){let canvasopts;if(!_id)canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]];else canvasopts=this.graph.CANVASES?.[_id];if(canvasopts){if(props)Object.assign(canvasopts,props);if(canvasopts.draw){canvasopts.draw(canvasopts,canvasopts.canvas,canvasopts.context);return _id}}return void 0},clearCanvas:function(_id){let canvasopts;if(!_id)canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]];else canvasopts=this.graph.CANVASES?.[_id];if(canvasopts?.clear){canvasopts.clear(canvasopts,canvasopts.canvas,canvasopts.context);return _id}return void 0},initCanvas:function(_id){let canvasopts;if(!_id)canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]];else canvasopts=this.graph.CANVASES?.[_id];if(canvasopts?.init){canvasopts.init(canvasopts,canvasopts.canvas,canvasopts.context);return _id}return void 0},updateCanvas:function(input,_id){let canvasopts;if(!_id)canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]];else canvasopts=this.graph.CANVASES?.[_id];if(canvasopts?.update){canvasopts.update(canvasopts,canvasopts.canvas,canvasopts.context,input);return _id}return void 0},setProps:function(props,_id){let canvasopts;if(!_id)canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]];else canvasopts=this.graph.CANVASES?.[_id];if(canvasopts){Object.assign(canvasopts,props);if(props.width)canvasopts.canvas.width=props.width;if(props.height)canvasopts.canvas.height=props.height;return _id}return void 0},startAnim:function(_id,draw){let canvasopts;if(!_id)canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]];else canvasopts=this.graph.CANVASES?.[_id];canvasopts.animating=true;if(canvasopts&&draw){if(typeof draw==="string")draw=parseFunctionFromText(draw);if(typeof draw==="function"){canvasopts.draw=draw}return _id}if(typeof canvasopts?.draw==="function"){let draw2=(s,canvas,context)=>{if(s.animating){s.draw(s,canvas,context);requestAnimationFrame(()=>{draw2(s,canvas,context)})}};if(typeof canvasopts.clear==="function")canvasopts.clear(canvasopts,canvasopts.canvas,canvasopts.context);if(typeof canvasopts.init==="function")canvasopts.init(canvasopts,canvasopts.canvas,canvasopts.context);draw2(canvasopts,canvasopts.canvas,canvasopts.context);return _id}return void 0},stopAnim:function(_id){let canvasopts;if(!_id)canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]];else canvasopts=this.graph.CANVASES?.[_id];if(canvasopts){canvasopts.animating=false;if(typeof canvasopts.clear==="function")canvasopts.clear(canvasopts,canvasopts.canvas,canvasopts.context);return _id}return void 0}};var rechk=/^([<>])?(([1-9]\\d*)?([xcbB?hHiIfdsp]))*$/;var refmt=/([1-9]\\d*)?([xcbB?hHiIfdsp])/g;var str=(v,o,c)=>String.fromCharCode(...new Uint8Array(v.buffer,v.byteOffset+o,c));var rts=(v,o,c,s)=>new Uint8Array(v.buffer,v.byteOffset+o,c).set(s.split("").map(str2=>str2.charCodeAt(0)));var pst=(v,o,c)=>str(v,o+1,Math.min(v.getUint8(o),c-1));var tsp=(v,o,c,s)=>{v.setUint8(o,s.length);rts(v,o+1,c-1,s)};var lut=le=>({x:c=>[1,c,0],c:c=>[c,1,o=>({u:v=>str(v,o,1),p:(v,c2)=>rts(v,o,1,c2)})],"?":c=>[c,1,o=>({u:v=>Boolean(v.getUint8(o)),p:(v,B)=>v.setUint8(o,B)})],b:c=>[c,1,o=>({u:v=>v.getInt8(o),p:(v,b)=>v.setInt8(o,b)})],B:c=>[c,1,o=>({u:v=>v.getUint8(o),p:(v,B)=>v.setUint8(o,B)})],h:c=>[c,2,o=>({u:v=>v.getInt16(o,le),p:(v,h)=>v.setInt16(o,h,le)})],H:c=>[c,2,o=>({u:v=>v.getUint16(o,le),p:(v,H)=>v.setUint16(o,H,le)})],i:c=>[c,4,o=>({u:v=>v.getInt32(o,le),p:(v,i)=>v.setInt32(o,i,le)})],I:c=>[c,4,o=>({u:v=>v.getUint32(o,le),p:(v,I)=>v.setUint32(o,I,le)})],f:c=>[c,4,o=>({u:v=>v.getFloat32(o,le),p:(v,f)=>v.setFloat32(o,f,le)})],d:c=>[c,8,o=>({u:v=>v.getFloat64(o,le),p:(v,d)=>v.setFloat64(o,d,le)})],s:c=>[1,c,o=>({u:v=>str(v,o,c),p:(v,s)=>rts(v,o,c,s.slice(0,c))})],p:c=>[1,c,o=>({u:v=>pst(v,o,c),p:(v,s)=>tsp(v,o,c,s.slice(0,c-1))})]});var errbuf=new RangeError("Structure larger than remaining buffer");var errval=new RangeError("Not enough values for structure");var _bitflippin=class{static toDataView(value){if(!(value instanceof DataView)){if(typeof value==="string"&&parseInt(value))value=parseInt(value);if(typeof value==="string"){let enc=new TextEncoder;let hascodes={};for(const code in _bitflippin.codes){while(value.indexOf(code)>-1){let idx=value.indexOf(code);value=value.replace(code,"");hascodes[idx]=code}}let encoded=Array.from(enc.encode(value));for(const key in hascodes){encoded.splice(parseInt(key),0,_bitflippin.codes[hascodes[key]])}value=new DataView(new Uint8Array(encoded).buffer)}else if(typeof value==="number"){let tmp=value;if(value<256){value=new DataView(new ArrayBuffer(1));value.setUint8(0,tmp)}else if(value<65536){value=new DataView(new ArrayBuffer(2));value.setInt16(0,tmp)}else{value=new DataView(new ArrayBuffer(4));value.setUint32(0,tmp)}}else if(value instanceof ArrayBuffer||typeof SharedArrayBuffer!=="undefined"&&value instanceof SharedArrayBuffer){value=new DataView(value)}else if(Array.isArray(value)){value=new DataView(Uint8Array.from(value).buffer)}else if(typeof value==="object"){value=new TextEncoder().encode(JSON.stringify(value))}}return value}static searchBuffer(buffer,searchString,limit){var needle=searchString;var haystack=buffer;var search=_bitflippin.boyerMoore(needle);var skip=search.byteLength;var indices=[];for(var i=search(haystack);i!==-1;i=search(haystack,i+skip)){indices.push(i);if(limit){if(indices.length>=limit)break}}return indices}static genTimestamps(ct,sps11){let now=Date.now();let toInterp=[now-ct*1e3/sps11,now];return _bitflippin.upsample(toInterp,ct)}static absmax(array){return Math.max(Math.abs(Math.min(...array)),Math.max(...array))}static downsample(array,fitCount,scalar=1){if(array.length>fitCount){let output=new Array(fitCount);let incr=array.length/fitCount;let lastIdx=array.length-1;let last=0;let counter=0;for(let i=incr;i<array.length;i+=incr){let rounded=Math.round(i);if(rounded>lastIdx)rounded=lastIdx;for(let j=last;j<rounded;j++){output[counter]+=array[j]}output[counter]/=(rounded-last)*scalar;counter++;last=rounded}return output}else return array}static upsample(array,fitCount,scalar=1){var linearInterpolate=function(before2,after2,atPoint2){return(before2+(after2-before2)*atPoint2)*scalar};var newData=new Array(fitCount);var springFactor=(array.length-1)/(fitCount-1);newData[0]=array[0];for(var i=1;i<fitCount-1;i++){var tmp=i*springFactor;var before=Math.floor(tmp);var after=Math.ceil(tmp);var atPoint=tmp-before;newData[i]=linearInterpolate(array[before],array[after],atPoint)}newData[fitCount-1]=array[array.length-1];return newData}static interpolate(array,fitCount,scalar=1){if(array.length>fitCount){return _bitflippin.downsample(array,fitCount,scalar)}else if(array.length<fitCount){return _bitflippin.upsample(array,fitCount,scalar)}return array}static bytesToInt16(x0,x1){let int16=(255&x0)<<8|255&x1;if((int16&32768)>0){int16|=4294901760}else{int16&=65535}return int16}static bytesToUInt16(x0,x1){return x0*256+x1}static Uint16ToBytes(y){return[y&255,y>>8&255]}static bytesToInt24(x0,x1,x2){let int24=(255&x0)<<16|(255&x1)<<8|255&x2;if((int24&8388608)>0){int24|=4278190080}else{int24&=16777215}return int24}static bytesToUInt24(x0,x1,x2){return x0*65536+x1*256+x2}static Uint24ToBytes(y){return[y&255,y>>8&255,y>>16&255]}static bytesToInt32(x0,x1,x2,x3){let int32=(255&x0)<<24|(255&x1)<<16|(255&x2)<<8|255&x3;if((int32&2147483648)>0){int32|=0}else{int32&=4294967295}return int32}static bytesToUInt32(x0,x1,x2,x3){return x0*16777216+x1*65536+x2*256+x3}static Uint32ToBytes(y){return[y&255,y>>8&255,y>>16&255,y>>24&255]}static get2sCompliment(val,nbits2){if(val>4294967296)return null;return val<<32-nbits2>>32-nbits2}static getSignedInt(...args){let pos=0;function getInt(size){var value=0;var first=true;while(size--){if(first){let byte=args[pos++];value+=byte&127;if(byte&128){value-=128}first=false}else{value*=256;value+=args[pos++]}}return value}return getInt(args.length)}static asUint8Array(input){if(input instanceof Uint8Array){return input}else if(typeof input==="string"){var arr=new Uint8Array(input.length);for(var i=0;i<input.length;i++){var c=input.charCodeAt(i);if(c>127){throw new TypeError("Only ASCII patterns are supported")}arr[i]=c}return arr}else{return new Uint8Array(input)}}static boyerMoore(patternBuffer){var pattern=_bitflippin.asUint8Array(patternBuffer);var M=pattern.length;if(M===0){throw new TypeError("patternBuffer must be at least 1 byte long")}var R=256;var rightmost_positions=new Int32Array(R);for(var c=0;c<R;c++){rightmost_positions[c]=-1}for(var j=0;j<M;j++){rightmost_positions[pattern[j]]=j}var boyerMooreSearch=(txtBuffer,start,end)=>{var txt=_bitflippin.asUint8Array(txtBuffer);if(start===void 0)start=0;if(end===void 0)end=txt.length;var pat=pattern;var right=rightmost_positions;var lastIndex=end-pat.length;var lastPatIndex=pat.length-1;var skip;for(var i=start;i<=lastIndex;i+=skip){skip=0;for(var j2=lastPatIndex;j2>=0;j2--){var c2=txt[i+j2];if(pat[j2]!==c2){skip=Math.max(1,j2-right[c2]);break}}if(skip===0){return i}}return-1};boyerMooreSearch.byteLength=pattern.byteLength;return boyerMooreSearch}static struct(format){let fns=[],size=0,m=rechk.exec(format);if(!m){throw new RangeError("Invalid format string")}const t=lut("<"===m[1]),lu=(n,c)=>t[c](n?parseInt(n,10):1);while(m=refmt.exec(format)){((r,s,f)=>{for(let i=0;i<r;++i,size+=s){if(f){fns.push(f(size))}}})(...lu(...m.slice(1)))}const unpack_from=(arrb,offs)=>{if(arrb.byteLength<(offs|0)+size){throw errbuf}let v=new DataView(arrb,offs|0);return fns.map(f=>f.u(v))};const pack_into=(arrb,offs,...values)=>{if(values.length<fns.length){throw errval}if(arrb.byteLength<offs+size){throw errbuf}const v=new DataView(arrb,offs);new Uint8Array(arrb,offs,size).fill(0);fns.forEach((f,i)=>f.p(v,values[i]))};const pack=(...values)=>{let b=new ArrayBuffer(size);pack_into(b,0,...values);return b};const unpack=arrb=>unpack_from(arrb,0);function*iter_unpack(arrb){for(let offs=0;offs+size<=arrb.byteLength;offs+=size){yield unpack_from(arrb,offs)}}return Object.freeze({unpack,pack,unpack_from,pack_into,iter_unpack,format,size})}};var bitflippin=_bitflippin;bitflippin.codes={"\\\\n":10,"\\\\r":13,"\\\\t":9,"\\\\s":32,"\\\\b":8,"\\\\f":12,"\\\\":92};var WebSerial=class extends bitflippin{constructor(){super(...arguments);this.streams={};this.createStream=options=>{let stream={_id:options._id?options._id:`stream${Math.floor(Math.random()*1e15)}`,info:options.port.getInfo(),running:false,...options};if(options.port?.readable){if(options.transforms){stream.reader=WebSerial.setStreamTransforms(options.port.readable,options.transforms).getReader()}else{stream.reader=options.port.readable.getReader()}}this.streams[stream._id]=stream;return stream}}getPorts(){return navigator.serial.getPorts()}requestPort(usbVendorId,usbProductId){let options={};if(usbVendorId){options.usbVendorId=usbVendorId}if(usbProductId){options.usbProductId=usbProductId}if(options.usbVendorId)return navigator.serial.requestPort({filters:[options]});else return navigator.serial.requestPort()}openPort(port,options){if(options)options=Object.assign({},options);if(options?.ondisconnect){port.ondisconnect=options.ondisconnect;delete options.ondisconnect}return port.open(options).then(()=>{if(options?.onconnect)options.onconnect(port)})}async readWithTimeout(port,timeout){const reader=port.readable.getReader();const timer=setTimeout(()=>{reader.releaseLock()},timeout);const result=await reader.read();clearTimeout(timer);reader.releaseLock();return result}async writePort(port,message){const writer=port.writable.getWriter();await writer.write(WebSerial.toDataView(message));writer.releaseLock();return true}getSignals(port){return port.getSignals()}setSignals(port,signals){return port.setSignals(signals)}readStream(stream){if(stream.reader&&!stream.running){let reader=stream.reader;if(stream.buffering){if(typeof stream.buffering!=="object")stream.buffering={};if(!stream.buffering.buffer){stream.buffering.buffer=[]}if(!stream.buffering.searchBytes)stream.buffering.searchBytes=new Uint8Array([13,10])}let readLoop=()=>{if(stream.port.readable&&stream.running){reader.read().then(result=>{if(result.done)reader.releaseLock();else{if(stream.buffering){stream.buffering.buffer.push(...result.value);const needle=stream.buffering.searchBytes;const haystack=stream.buffering.buffer;const search=WebSerial.boyerMoore(needle);const skip=search.byteLength;let nextIndex=-1;for(var i=search(haystack);i!==-1;i=search(haystack,i+skip)){if(!stream.buffering.locked&&!("lockIdx"in stream.buffering))stream.buffering.lockIdx=i;else{nextIndex=i;if(nextIndex>=0){if(!stream.buffering.locked){stream.ondata(new Uint8Array(stream.buffering.buffer.splice(stream.buffering.lockIdx+stream.buffering.searchBytes.length,nextIndex+stream.buffering.searchBytes.length)));stream.buffering.buffer.splice(0,stream.buffering.searchBytes.length);stream.buffering.locked=true}else if(nextIndex>0){stream.ondata(new Uint8Array(stream.buffering.buffer.splice(stream.buffering.searchBytes.length,nextIndex)))}}}}}else stream.ondata(result.value);setTimeout(()=>{readLoop()},stream.frequency)}})}else if(!stream.running&&stream.port.readable){try{reader.releaseLock()}catch(er){console.error(er)}}};stream.running=true;readLoop();return stream}return void 0}writeStream(stream,message){if(typeof stream==="string")stream=this.streams[stream];if(stream.port.writable){let writer=stream.port.writable.getWriter();writer.write(WebSerial.toDataView(message));writer.releaseLock();return true}return void 0}closeStream(stream,onclose){if(typeof stream==="string")stream=this.streams[stream];stream.running=false;return new Promise((res,rej)=>{setTimeout(async()=>{if(stream.port.readable&&stream.reader){try{stream.reader.releaseLock();try{await stream.reader.cancel()}catch(err){}}catch(er){console.error(er)}}try{await stream.port.close().then(()=>{if(onclose)onclose(this.streams[stream._id])})}catch(er){rej(er)}delete this.streams[stream._id];res(true)},300)})}static setStreamTransforms(stream,transforms){let transform=[];Object.keys(transforms).forEach(t=>{let opt=transforms[t];if(opt instanceof TransformStream){transform.push(opt)}else{if(!opt.start)opt.start=function start(){};if(!opt.flush)opt.flush=function flush(){};let transformer=new TransformStream({start:opt.start,transform:opt.transform,flush:opt.flush},opt.writableStrategy,opt.readableStrategy);transform.push(transformer)}});let str2=stream;transform.forEach(transform2=>{str2=str2.pipeThrough(transform2)});return str2}};function ads131m08codec(data){let arr;if(data.getInt8)arr=new Uint8Array(data.buffer);else if(!data.buffer)arr=new Uint8Array(data);else arr=data;let output={0:new Array(9),1:new Array(9),2:new Array(9),3:new Array(9),4:new Array(9),5:new Array(9),6:new Array(9),7:new Array(9),timestamp:Date.now()};for(let i=0;i<9;i++){let j=i*25;output[0][i]=bitflippin.bytesToUInt24(arr[j],arr[j+1],arr[j+2]);output[1][i]=bitflippin.bytesToUInt24(arr[j+3],arr[j+4],arr[j+5]);output[2][i]=bitflippin.bytesToUInt24(arr[j+6],arr[j+7],arr[j+8]);output[3][i]=bitflippin.bytesToUInt24(arr[j+9],arr[j+10],arr[j+11]);output[4][i]=bitflippin.bytesToUInt24(arr[j+12],arr[j+13],arr[j+14]);output[5][i]=bitflippin.bytesToUInt24(arr[j+15],arr[j+16],arr[j+17]);output[6][i]=bitflippin.bytesToUInt24(arr[j+18],arr[j+19],arr[j+20]);output[7][i]=bitflippin.bytesToUInt24(arr[j+21],arr[j+22],arr[j+23])}return output}var sps=250;var defaultChartSetting={nSec:10,sps,units:"mV"};var ads131m08ChartSettings={lines:{"0":JSON.parse(JSON.stringify(defaultChartSetting)),"1":JSON.parse(JSON.stringify(defaultChartSetting)),"2":JSON.parse(JSON.stringify(defaultChartSetting)),"3":JSON.parse(JSON.stringify(defaultChartSetting)),"4":JSON.parse(JSON.stringify(defaultChartSetting)),"5":JSON.parse(JSON.stringify(defaultChartSetting)),"6":JSON.parse(JSON.stringify(defaultChartSetting)),"7":JSON.parse(JSON.stringify(defaultChartSetting))}};var gain=32;var nbits=24;var vref=1.2;var defaultsetting={sps,useDCBlock:false,useBandpass:false,bandpassLower:3,bandpassUpper:45,useScaling:true,scalar:.96*1e3*vref/(gain*(Math.pow(2,nbits)-1))};var ads131m08FilterSettings={"0":JSON.parse(JSON.stringify(defaultsetting)),"1":JSON.parse(JSON.stringify(defaultsetting)),"2":JSON.parse(JSON.stringify(defaultsetting)),"3":JSON.parse(JSON.stringify(defaultsetting)),"4":JSON.parse(JSON.stringify(defaultsetting)),"5":JSON.parse(JSON.stringify(defaultsetting)),"6":JSON.parse(JSON.stringify(defaultsetting)),"7":JSON.parse(JSON.stringify(defaultsetting))};function cytoncodec(data){let arr;if(!data.buffer)arr=new Uint8Array(data);else arr=data;let output={};for(let i=0;i<8;i++){let idx=1+3*i;output[i]=bitflippin.bytesToInt24(arr[idx],arr[idx+1],arr[idx+2])}let accIdx=25;output.ax=bitflippin.bytesToInt16(arr[accIdx],arr[accIdx+1]);output.ay=bitflippin.bytesToInt16(arr[accIdx+2],arr[accIdx+3]);output.az=bitflippin.bytesToInt16(arr[accIdx+4],arr[accIdx+5]);output.gx=bitflippin.bytesToInt16(arr[accIdx+6],arr[accIdx+7]);output.gy=bitflippin.bytesToInt16(arr[accIdx+8],arr[accIdx+9]);output.gz=bitflippin.bytesToInt16(arr[accIdx+10],arr[accIdx+11]);output.timestamp=Date.now();return output}var sps2=250;var cytonSerialSettings={baudRate:115200,codec:cytoncodec,sps:sps2};var defaultsetting2={sps:sps2,useDCBlock:true,useBandpass:true,bandpassLower:3,bandpassUpper:45,useScaling:true,scalar:1e3*4.5/(24*(Math.pow(2,23)-1))};var cytonFilterSettings={"0":JSON.parse(JSON.stringify(defaultsetting2)),"1":JSON.parse(JSON.stringify(defaultsetting2)),"2":JSON.parse(JSON.stringify(defaultsetting2)),"3":JSON.parse(JSON.stringify(defaultsetting2)),"4":JSON.parse(JSON.stringify(defaultsetting2)),"5":JSON.parse(JSON.stringify(defaultsetting2)),"6":JSON.parse(JSON.stringify(defaultsetting2)),"7":JSON.parse(JSON.stringify(defaultsetting2)),"8":JSON.parse(JSON.stringify(defaultsetting2)),"9":JSON.parse(JSON.stringify(defaultsetting2)),"10":JSON.parse(JSON.stringify(defaultsetting2)),"11":JSON.parse(JSON.stringify(defaultsetting2)),"12":JSON.parse(JSON.stringify(defaultsetting2)),"13":JSON.parse(JSON.stringify(defaultsetting2)),"14":JSON.parse(JSON.stringify(defaultsetting2)),"15":JSON.parse(JSON.stringify(defaultsetting2))};function freeeeg128codec(data){let arr;if(data.getInt8)arr=new Uint8Array(data.buffer);else if(!data.buffer)arr=new Uint8Array(data);else arr=data;let output={};for(let i=0;i<128;i++){let idx=i*3+1;output[i]=bitflippin.bytesToUInt24(arr[idx],arr[idx+1],arr[idx+2])}let accIdx=385;output["ax"]=bitflippin.bytesToInt16(arr[accIdx],arr[accIdx+1]);output["ay"]=bitflippin.bytesToInt16(arr[accIdx+2],arr[accIdx+3]);output["az"]=bitflippin.bytesToInt16(arr[accIdx+4],arr[accIdx+5]);output["gx"]=bitflippin.bytesToInt16(arr[accIdx+6],arr[accIdx+7]);output["gy"]=bitflippin.bytesToInt16(arr[accIdx+8],arr[accIdx+9]);output["gz"]=bitflippin.bytesToInt16(arr[accIdx+10],arr[accIdx+11]);output.timestamp=Date.now();return output}var sps3=250;var freeeeg128SerialSettings={baudRate:921600,bufferSize:2e3,frequency:1.9,codec:freeeeg128codec,sps:sps3};var freeeeg128ChartSettings={lines:{"ax":{nSec:10,sps:sps3},"ay":{nSec:10,sps:sps3},"az":{nSec:10,sps:sps3},"gx":{nSec:10,sps:sps3},"gy":{nSec:10,sps:sps3},"gz":{nSec:10,sps:sps3}}};var freeeeg128FilterSettings={};for(let i=0;i<128;i++){freeeeg128ChartSettings.lines[i]={sps:250,nSec:10};freeeeg128FilterSettings[i]={sps:250,useDCBlock:true,useBandpass:true,bandpassLower:3,bandpassUpper:45,scalar:1e3*2.5/(32*(Math.pow(2,24)-1))}}function freeeeg32codec(data){let arr;if(data.getInt8)arr=new Uint8Array(data.buffer);else if(!data.buffer)arr=new Uint8Array(data);else arr=data;let output={};for(let i=0;i<32;i++){let idx=i*3+1;output[i]=bitflippin.bytesToUInt24(arr[idx],arr[idx+1],arr[idx+2])}let accIdx=97;output["ax"]=bitflippin.bytesToInt16(arr[accIdx],arr[accIdx+1]);output["ay"]=bitflippin.bytesToInt16(arr[accIdx+2],arr[accIdx+3]);output["az"]=bitflippin.bytesToInt16(arr[accIdx+4],arr[accIdx+5]);output["gx"]=bitflippin.bytesToInt16(arr[accIdx+6],arr[accIdx+7]);output["gy"]=bitflippin.bytesToInt16(arr[accIdx+8],arr[accIdx+9]);output["gz"]=bitflippin.bytesToInt16(arr[accIdx+10],arr[accIdx+11]);output.timestamp=Date.now();return output}var sps4=512;var freeeeg32SerialSettings={baudRate:921600,bufferSize:2e3,frequency:1.9,codec:freeeeg32codec,sps:sps4};var freeeeg32_optical_SerialSettings={baudRate:1e6,bufferSize:2e3,frequency:1.9,codec:freeeeg32codec,sps:sps4};var freeeeg32ChartSettings={lines:{"ax":{nSec:10,sps:sps4},"ay":{nSec:10,sps:sps4},"az":{nSec:10,sps:sps4},"gx":{nSec:10,sps:sps4},"gy":{nSec:10,sps:sps4},"gz":{nSec:10,sps:sps4}}};var freeeeg32FilterSettings={};for(let i=0;i<32;i++){freeeeg32ChartSettings.lines[i]={sps:sps4,nSec:10};freeeeg32FilterSettings[i]={sps:sps4,useDCBlock:true,useBandpass:true,bandpassLower:3,bandpassUpper:45,useScaling:true,scalar:1e3*2.5/(8*(Math.pow(2,24)-1))}}var textdecoder=new TextDecoder;function hegduinocodec(value){let output={timestamp:0,red:0,infrared:0,heg:0,ambient:0,temperature:0};let txt=textdecoder.decode(value);let line=txt.split("|");if(line.length===3){output.timestamp=Date.now();output.red=parseInt(line[0]);output.infrared=parseInt(line[1]);output.heg=parseFloat(line[2])}else if(line.length>=5){output.timestamp=Date.now();output.red=parseInt(line[1]);output.infrared=parseInt(line[2]);output.heg=parseFloat(line[3]);output.ambient=parseFloat(line[4]);output.temperature=parseFloat(line[5]);return output}else return txt}var sps5=40;var hegduinoSerialSettings={baudRate:115200,write:"t\\n",codec:hegduinocodec,sps:sps5};var hegduinoBLESettings={sps:sps5,services:{["6E400001-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{"6e400002-b5a3-f393-e0a9-e50e24dcca9e":{write:"t"},"6e400003-b5a3-f393-e0a9-e50e24dcca9e":{notify:true,notifyCallback:void 0,codec:hegduinocodec,sps:sps5}},["6E400004-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{["6E400005-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{read:true},["6E400006-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{write:void 0,notify:true,notifyCallback:void 0},["6E400007-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{read:true}}},androidWebBLE:"o"};function max3010xcodec(data){let arr;if(data.getInt8)arr=new Uint8Array(data.buffer);else if(!data.buffer)arr=new Uint8Array(data);else arr=data;const output={"red":new Array(32),"ir":new Array(32),"max_dietemp":bitflippin.get2sCompliment(arr[193],8)+.0625*arr[194],"timestamp":Date.now()};let i=0;while(i<32){let idx=i*6;if(i%2===0){output["ir"][i]=(arr[idx+1]<<16|arr[idx+2]<<8|arr[idx+3])&524287;output["ir"][i+1]=(arr[idx+4]<<16|arr[idx+5]<<8|arr[idx+6])&524287}else{output["red"][i-1]=(arr[idx+1]<<16|arr[idx+2]<<8|arr[idx+3])&524287;output["red"][i]=(arr[idx+4]<<16|arr[idx+5]<<8|arr[idx+6])&524287}i++}return output}function mpu6050codec(data){let arr;if(data.getInt8)arr=new Uint8Array(data.buffer);else if(!data.buffer)arr=new Uint8Array(data);else arr=data;let output={"ax":new Array(20),"ay":new Array(20),"az":new Array(20),"gx":new Array(20),"gy":new Array(20),"gz":new Array(20),"mpu_dietemp":(bitflippin.bytesToInt16(arr[241],arr[242])+521)/340+35,timestamp:Date.now()};for(let i=0;i<20;i++){let idx=i*12;output.ax[i]=bitflippin.bytesToInt16(arr[idx+1],arr[idx+2]);output.ay[i]=bitflippin.bytesToInt16(arr[idx+3],arr[idx+4]);output.az[i]=bitflippin.bytesToInt16(arr[idx+5],arr[idx+6]);output.gx[i]=bitflippin.bytesToInt16(arr[idx+7],arr[idx+8]);output.gy[i]=bitflippin.bytesToInt16(arr[idx+9],arr[idx+10]);output.gz[i]=bitflippin.bytesToInt16(arr[idx+11],arr[idx+12])}return output}function cognixionONE_EEG_codec(data){let arr;if(data.getInt8)arr=new Uint8Array(data.buffer);else if(!data.buffer)arr=new Uint8Array(data);else arr=data;let output={0:new Array,1:new Array,2:new Array,3:new Array,4:new Array,5:new Array,6:new Array,7:new Array,timestamp:Date.now()};for(let i=0;i<7;i++){let j=i*26+1;if(!arr[j+23])break;output[0][i]=bitflippin.bytesToUInt24(arr[j],arr[j+1],arr[j+2]);output[1][i]=bitflippin.bytesToUInt24(arr[j+3],arr[j+4],arr[j+5]);output[2][i]=bitflippin.bytesToUInt24(arr[j+6],arr[j+7],arr[j+8]);output[3][i]=bitflippin.bytesToUInt24(arr[j+9],arr[j+10],arr[j+11]);output[4][i]=bitflippin.bytesToUInt24(arr[j+12],arr[j+13],arr[j+14]);output[5][i]=bitflippin.bytesToUInt24(arr[j+15],arr[j+16],arr[j+17]);output[6][i]=bitflippin.bytesToUInt24(arr[j+18],arr[j+19],arr[j+20]);output[7][i]=bitflippin.bytesToUInt24(arr[j+21],arr[j+22],arr[j+23])}return output}var sps6=250;var cognixionONEBLESettings={services:{["82046698-6313-4BB1-9645-6BA28BF86DF5".toLowerCase()]:{["8204669A-6313-4BB1-9645-6BA28BF86DF5".toLowerCase()]:{notify:true,notifyCallback:void 0,codec:cognixionONE_EEG_codec,sps:sps6}},["82E12914-9AFA-4648-BD1B-8E2B3DC6DAAF".toLowerCase()]:{["82E12915-9AFA-4648-BD1B-8E2B3DC6DAAF".toLowerCase()]:{write:void 0},["82E12916-9AFA-4648-BD1B-8E2B3DC6DAAF".toLowerCase()]:{read:true}}},sps:sps6};var PeanutCodes={2:{type:"POOR_SIGNAL",format:"<B",byteLength:1},144:{type:"unfilteredHEG",format:"<i",byteLength:4},145:{type:"heg",format:"<i",byteLength:4},147:{type:"rawdata4",format:"<iiii",byteLength:4*4},148:{type:"rawdata6",format:"<iiiiii",byteLength:4*6},160:{type:"sampleNumber",format:"<i",byteLength:4},176:{type:"debug0",format:"<i",byteLength:4},177:{type:"debug1",format:"<i",byteLength:4},178:{type:"debug2",format:"<i",byteLength:4},179:{type:"debug3",format:"<i",byteLength:4},180:{type:"debug4",format:"<iiiiii",byteLength:4*6},181:{type:"debug4",format:"<iiiiii",byteLength:4*6},182:{type:"rawdata27",format:"<B"+"i".repeat(26),byteLength:1+4*26}};function peanutcodec(data){let result={};let i=0;while(i<data.length){if(PeanutCodes[data[i]]&&i+1+PeanutCodes[data[i]].byteLength<=data.length){let slice=data.slice(i+1,i+1+PeanutCodes[data[i]].byteLength).buffer;let unpacked=bitflippin.struct(PeanutCodes[data[i]].format).unpack(slice);let code=PeanutCodes[data[i]].type;if(code==="unfilteredHEG"||code==="heg")unpacked=unpacked[0]/256;else if(code==="POOR_SIGNAL"||code==="sampleNumber"||code==="debug0"||code==="debug1"||code==="debug2"||code==="debug3")unpacked=unpacked[0];if(!result[PeanutCodes[data[i]].type]){if(Array.isArray(unpacked))result[PeanutCodes[data[i]].type]=unpacked;else result[PeanutCodes[data[i]].type]=[unpacked]}else{if(Array.isArray(unpacked))result[PeanutCodes[data[i]].type].push(...unpacked);else result[PeanutCodes[data[i]].type].push(unpacked)}i+=PeanutCodes[data[i]].byteLength+1}else i++}result.timestamp=Date.now();return result}var peanutSerialSettings={baudRate:38400,bufferSize:500,write:"protocol 3\\n",buffering:{searchBytes:new Uint8Array([170,170])},codec:peanutcodec,sps:10.101};var sealevel_hpa=1013.25;var bme280codec=data=>{let arr;if(data.getInt8)arr=new Uint8Array(data.buffer);else if(!data.buffer)arr=new Uint8Array(data);else arr=data;let output={temp:[],pressure:[],humidity:[],altitude:[]};for(let j=0;j<3;j++){let i=j*24;let tint=bitflippin.bytesToUInt32(arr[0+i],arr[1+i],arr[2+i],arr[3+i]);let tfrac=bitflippin.bytesToUInt32(arr[4+i],arr[5+i],arr[6+i],arr[7+i]);output.temp.push(tint+tfrac/Math.pow(10,Math.ceil(Math.log10(tfrac))));let pint=bitflippin.bytesToUInt32(arr[8+i],arr[9+i],arr[10+i],arr[11+i]);let pfrac=bitflippin.bytesToUInt32(arr[12+i],arr[13+i],arr[14+i],arr[15+i]);output.pressure.push(pint+pfrac/Math.pow(10,Math.ceil(Math.log10(pfrac))));let hint=bitflippin.bytesToUInt32(arr[16+i],arr[17+i],arr[18+i],arr[19+i]);let hfrac=bitflippin.bytesToUInt32(arr[20+i],arr[21+i],arr[22+i],arr[23+i]);output.humidity.push(hint+hfrac/Math.pow(10,Math.ceil(Math.log10(hfrac))));output.altitude.push(altitude(output.pressure[j],output.temp[j]))}return output};var exponent=1/5.257;var denom=1/.0065;function altitude(pressure,temperature){return(Math.pow(sealevel_hpa/pressure,exponent)-1)*(temperature+273.15)*denom}function nrf5x_usbcodec(data){let arr;if(data.getInt8)arr=new Uint8Array(data.buffer);else if(!data.buffer)arr=new Uint8Array(data);else arr=data;const output={};if(arr[0]===2){Object.assign(output,ads131m08codec(arr.subarray(2)))}else if(arr[0]===3){let result=ads131m08codec(arr.subarray(2));Object.keys(result).forEach((key,i)=>{output[i+8]=result[key]})}else if(arr[0]===4){Object.assign(output,mpu6050codec(arr.subarray(2)))}else if(arr[0]===5){Object.assign(output,max3010xcodec(arr.subarray(2)))}else if(arr[0]===6){Object.assign(output,bme280codec(arr.subarray(2)))}else{Object.assign(output,ads131m08codec(arr))}return output}var nrf5xSerialSettings={baudRate:115200,buffering:{searchBytes:new Uint8Array([240,240])},codec:nrf5x_usbcodec,sps:250};var nrf5xBLESettings={sps:250,services:{"0000cafe-b0ba-8bad-f00d-deadbeef0000":{"0001cafe-b0ba-8bad-f00d-deadbeef0000":{write:void 0},"0002cafe-b0ba-8bad-f00d-deadbeef0000":{notify:true,notifyCallback:void 0,codec:ads131m08codec,sps:250},"0003cafe-b0ba-8bad-f00d-deadbeef0000":{notify:true,notifyCallback:void 0,codec:max3010xcodec,sps:100},"0004cafe-b0ba-8bad-f00d-deadbeef0000":{notify:true,notifyCallback:void 0,codec:mpu6050codec,sps:100},"0005cafe-b0ba-8bad-f00d-deadbeef0000":{notify:true,notifyCallback:void 0,codec:ads131m08codec,sps:250},"0006cafe-b0ba-8bad-f00d-deadbeef0000":{notify:true,notifyCallback:void 0,codec:bme280codec,sps:3.33}}}};var defaultsetting3={sps:250,useDCBlock:false,useBandpass:false,bandpassLower:3,bandpassUpper:45,useScaling:true,scalar:1e3*1.2/(32*(Math.pow(2,24)-1))};var nrf5x_usbFilterSettings={"0":JSON.parse(JSON.stringify(defaultsetting3)),"1":JSON.parse(JSON.stringify(defaultsetting3)),"2":JSON.parse(JSON.stringify(defaultsetting3)),"3":JSON.parse(JSON.stringify(defaultsetting3)),"4":JSON.parse(JSON.stringify(defaultsetting3)),"5":JSON.parse(JSON.stringify(defaultsetting3)),"6":JSON.parse(JSON.stringify(defaultsetting3)),"7":JSON.parse(JSON.stringify(defaultsetting3)),"8":JSON.parse(JSON.stringify(defaultsetting3)),"9":JSON.parse(JSON.stringify(defaultsetting3)),"10":JSON.parse(JSON.stringify(defaultsetting3)),"11":JSON.parse(JSON.stringify(defaultsetting3)),"12":JSON.parse(JSON.stringify(defaultsetting3)),"13":JSON.parse(JSON.stringify(defaultsetting3)),"14":JSON.parse(JSON.stringify(defaultsetting3)),"15":JSON.parse(JSON.stringify(defaultsetting3))};var textdecoder2=new TextDecoder;function statechangercodec(value){let output={timestamp:0,left_red:0,left_infrared:0,left_heg:0,center_red:0,center_infrared:0,center_heg:0,right_red:0,right_infrared:0,right_heg:0};let txt=textdecoder2.decode(value);let line=txt.split("|");if(line.length>=5){output.timestamp=Date.now();output.left_red=parseInt(line[1]);output.left_infrared=parseInt(line[2]);output.left_heg=parseFloat(line[3]);output.center_red=parseInt(line[4]);output.center_infrared=parseInt(line[5]);output.center_heg=parseFloat(line[6]);output.right_red=parseInt(line[7]);output.right_infrared=parseInt(line[8]);output.right_heg=parseFloat(line[9]);return output}else return txt}var statechangerSerialSettings={baudRate:115200,codec:statechangercodec};var statechangerBLESettings={services:{["6E400001-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{"6e400002-b5a3-f393-e0a9-e50e24dcca9e":{write:"t"},"6e400003-b5a3-f393-e0a9-e50e24dcca9e":{notify:true,notifyCallback:void 0,codec:statechangercodec}},["6E400004-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{["6E400005-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{read:true},["6E400006-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{write:void 0,notify:true,notifyCallback:void 0},["6E400007-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{read:true}}},androidWebBLE:"o"};var sps7=250;var museSettings={sps:sps7,connect:(settings={})=>{return new Promise(async(res,rej)=>{let _id=`muse${Math.floor(Math.random()*1e15)}`;if(typeof MuseClient==="undefined"){document.head.insertAdjacentHTML("beforeend",`<script src="https://cdn.jsdelivr.net/npm/muse-js-tinybuild@1.0.0/dist/muse.min.js"><\\/script>`)}let client=new MuseClient;let info={_id,client,settings:Object.assign(Object.assign({},museSettings),settings)};await client.connect();await client.start();let eegts;client.eegReadings.subscribe(reading=>{reading.origin="eeg";if(reading.electrode===0){eegts=bitflippin.genTimestamps(12,250)}if(!eegts)eegts=bitflippin.genTimestamps(12,250);reading.timestamp=eegts;info.settings.ondata(reading)});client.telemetryData.subscribe(reading=>{reading.origin="telemetry";info.settings.ondata(reading)});client.gyroscopeData.subscribe(reading=>{reading.origin="gyro";info.settings.ondata(reading)});client.accelerometerData.subscribe(reading=>{reading.origin="accelerometer";info.settings.ondata(reading)});if(client.enablePPG){client.ppgData.subscribe(reading=>{reading.origin="ppg";info.settings.ondata(reading)})}info.settings.onconnect(info);res(info)})},codec:reading=>{let origin=reading.origin;if(origin==="eeg"){return{[reading.electrode]:reading.samples,timestamp:Date.now()}}else if(origin==="gyro"){let transformed={gx:[],gy:[],gz:[],timestamp:Date.now()};reading.samples.forEach(s=>{transformed.gx.push(s.x);transformed.gy.push(s.y);transformed.gz.push(s.z)});return transformed}else if(origin==="accelerometer"){let transformed={ax:[],ay:[],az:[],timestamp:Date.now()};reading.samples.forEach(s=>{transformed.ax.push(s.x);transformed.ay.push(s.y);transformed.az.push(s.z)});return transformed}else if(origin==="ppg"){return{[`ppg${reading.ppgChannel}`]:reading.samples,timestamp:Date.now()}}else if(origin==="telemetry"){return reading}},disconnect:info=>{info.client.disconnect();info.settings.ondisconnect(info)},onconnect:info=>{console.log("muse connected!",info)},ondisconnect:info=>{console.log("muse disconnected!",info)},ondata:parsed=>{console.log(parsed)}};var defaultsetting4={sps:sps7,useDCBlock:true,useBandpass:true,bandpassLower:3,bandpassUpper:45};var museFilterSettings={"0":JSON.parse(JSON.stringify(defaultsetting4)),"1":JSON.parse(JSON.stringify(defaultsetting4)),"2":JSON.parse(JSON.stringify(defaultsetting4)),"3":JSON.parse(JSON.stringify(defaultsetting4)),"4":JSON.parse(JSON.stringify(defaultsetting4))};function blueberrycodec(value){let output={red:value.getInt32(2),ir:value.getInt32(6),ir2:value.getInt32(10),timestamp:Date.now()};output.heg=output.red/(.5*(output.ir+output.ir2));return output}var sps8=40;var blueberryBLESettings={namePrefix:"blueberry",services:{"0f0e0d0c-0b0a-0908-0706-050403020100":{"1f1e1d1c-1b1a-1918-1716-151413121110":{write:void 0},"3f3e3d3c-3b3a-3938-3736-353433323130":{notify:true,notifyCallback:void 0,codec:blueberrycodec,sps:sps8}}},sps:sps8};function blueberryshortcodec(value){let output={sred:value.getInt32(2),sir:value.getInt32(6),sir2:value.getInt32(10),timestamp:Date.now()};output.sheg=output.sred/(.5*(output.sir+output.sir2));return output}function blueberrylongcodec(value){let output={red:value.getInt32(2),ir:value.getInt32(6),ir2:value.getInt32(10),timestamp:Date.now()};output.heg=output.sred/(.5*(output.ir+output.ir2));return output}var sps9=40;var blueberry2BLESettings={namePrefix:"blueberry",services:{"0f0e0d0c-0b0a-0908-0706-050403020100":{"1f1e1d1c-1b1a-1918-1716-151413121110":{write:void 0},"4f4e4d4c-4b6a-6968-6766-656463426160":{notify:true,notifyCallback:void 0,codec:blueberrylongcodec,sps:sps9},"4f4e4d4c-4b5a-5958-5756-555453425150":{notify:true,notifyCallback:void 0,codec:blueberryshortcodec,sps:sps9}}},sps:sps9};var sps10=250;var ganglionSettings={sps:sps10,connect:(settings={})=>{return new Promise(async(res,rej)=>{let _id=`ganglion${Math.floor(Math.random()*1e15)}`;if(typeof Ganglion==="undefined"){document.head.insertAdjacentHTML("beforeend",`<script src="https://cdn.jsdelivr.net/npm/ganglion-browser-min@1.0.2/dist/index.js"><\\/script>`)}let client=new Ganglion;let info={_id,client,settings:Object.assign(Object.assign({},ganglionSettings),settings)};await client.connect();await client.start();client.stream.subscribe(reading=>{reading.origin="eeg";info.settings.ondata(reading)});client.accelData.subscribe(reading=>{reading.origin="accelerometer";info.settings.ondata(reading)});info.settings.onconnect(info);res(info)})},codec:reading=>{let origin=reading.origin;if(origin==="eeg"){return{0:reading.data[0],1:reading.data[1],2:reading.data[2],3:reading.data[3],timestamp:Date.now()}}else if(origin==="accelerometer"){return{ax:reading.data[0],ay:reading.data[1],az:reading.data[2],timestamp:Date.now()}}},disconnect:info=>{info.client.disconnect();info.settings.ondisconnect(info)},onconnect:info=>{console.log("ganglion connected!",info)},ondisconnect:info=>{console.log("ganglion disconnected!",info)},ondata:parsed=>{console.log(parsed)}};var defaultsetting5={sps:sps10,useDCBlock:true,useBandpass:true,bandpassLower:3,bandpassUpper:45};var ganglionFilterSettings={"0":JSON.parse(JSON.stringify(defaultsetting5)),"1":JSON.parse(JSON.stringify(defaultsetting5)),"2":JSON.parse(JSON.stringify(defaultsetting5)),"3":JSON.parse(JSON.stringify(defaultsetting5))};function hrcodec(data){return{hr:data.getInt8(1),timestamp:Date.now()}}var heartRateBLESettings={services:{"heart_rate":{"heart_rate_measurement":{notify:true,notifyCallback:void 0,codec:hrcodec}}}};var Devices={BLE:{"nrf5x":nrf5xBLESettings,"hegduino":hegduinoBLESettings,"cognixionONE":cognixionONEBLESettings,"statechanger":statechangerBLESettings,"blueberry":blueberryBLESettings,"blueberry2":blueberry2BLESettings,"heart_rate":heartRateBLESettings},USB:{"nrf5x":nrf5xSerialSettings,"freeEEG32":freeeeg32SerialSettings,"freeEEG32_optical":freeeeg32_optical_SerialSettings,"freeEEG128":freeeeg128SerialSettings,"hegduino":hegduinoSerialSettings,"cyton":cytonSerialSettings,"cyton_daisy":cytonSerialSettings,"peanut":peanutSerialSettings,"statechanger":statechangerSerialSettings,"cognixionONE":cytonSerialSettings},BLE_OTHER:{"muse":museSettings,"ganglion":ganglionSettings},USB_OTHER:{},OTHER:{}};var textdecoder3=new TextDecoder;var decoders={"raw":data=>{if(data?.buffer)return Array.from(new Uint8Array(data));else return data},"utf8":data=>{return textdecoder3.decode(data)},"console-f12":data=>{if(data?.buffer)data=Array.from(new Uint8Array(data));console.log(data);return data},"debug":(data,debugmessage)=>{if(data?.buffer)data=Array.from(new Uint8Array(data));console.log(debugmessage,data);return data},"ads131m08":ads131m08codec,"max3010x":max3010xcodec,"mpu6050":mpu6050codec,"bme280":bme280codec,"freeeeg32":freeeeg32codec,"freeeeg128":freeeeg128codec,"cyton":cytoncodec,"cognixionONE_BLE":cognixionONE_EEG_codec,"hegduino":hegduinocodec,"nrf5x":nrf5x_usbcodec,"peanut":peanutcodec,"statechanger":statechangercodec,"blueberry":blueberrycodec,"heart_rate":hrcodec};var BiquadChannelFilterer=class{constructor(options={sps:512,useSMA4:false,useNotch50:true,useNotch60:true,useLowpass:false,lowpassHz:100,useBandpass:false,bandpassLower:3,bandpassUpper:45,useDCBlock:true,DCBresonance:.995,useScaling:false,scalar:1}){this.idx=0;this.sps=options.sps;this.bandpassLower=options.bandpassLower?options.bandpassLower:3;this.bandpassUpper=options.bandpassUpper?options.bandpassUpper:45;this.useSMA4=options.useSMA4;this.last4=[];this.useNotch50=options.useNotch50;this.useNotch60=options.useNotch60;this.useLowpass=options.useLowpass;this.lowpassHz=options.lowpassHz?options.lowpassHz:100;this.useBandpass=options.useBandpass;this.useDCBlock=options.useDCBlock;this.DCBresonance=options.DCBresonance?options.DCBresonance:.995;this.useScaling=options.useScaling;this.scalar=options.scalar;let sps11=this.sps;this.notch50=[makeNotchFilter(50,sps11,2),makeNotchFilter(100,sps11,2)];this.notch60=[makeNotchFilter(60,sps11,2),makeNotchFilter(120,sps11,2)];this.lp1=[new Biquad("lowpass",this.lowpassHz,sps11),new Biquad("lowpass",this.lowpassHz,sps11),new Biquad("lowpass",this.lowpassHz,sps11),new Biquad("lowpass",this.lowpassHz,sps11)];this.bp1=[makeBandpassFilter(this.bandpassLower,this.bandpassUpper,sps11,1),makeBandpassFilter(this.bandpassLower,this.bandpassUpper,sps11,1),makeBandpassFilter(this.bandpassLower,this.bandpassUpper,sps11,1),makeBandpassFilter(this.bandpassLower,this.bandpassUpper,sps11,1)];this.dcb=new DCBlocker(options.DCBresonance?options.DCBresonance:.995)}reset(sps11=this.sps){this.notch50=[makeNotchFilter(50,sps11,2),makeNotchFilter(100,sps11,2)];this.notch60=[makeNotchFilter(60,sps11,2),makeNotchFilter(120,sps11,2)];this.lp1=[new Biquad("lowpass",this.lowpassHz,sps11),new Biquad("lowpass",this.lowpassHz,sps11),new Biquad("lowpass",this.lowpassHz,sps11),new Biquad("lowpass",this.lowpassHz,sps11)];this.bp1=[makeBandpassFilter(this.bandpassLower,this.bandpassUpper,sps11,1),makeBandpassFilter(this.bandpassLower,this.bandpassUpper,sps11,1),makeBandpassFilter(this.bandpassLower,this.bandpassUpper,sps11,1),makeBandpassFilter(this.bandpassLower,this.bandpassUpper,sps11,1)];this.dcb=new DCBlocker(this.DCBresonance)}setBandpass(bandpassLower=this.bandpassLower,bandpassUpper=this.bandpassUpper,sps11=this.sps){this.bandpassLower=bandpassLower;this.bandpassUpper=bandpassUpper;this.bp1=[makeBandpassFilter(bandpassLower,bandpassUpper,sps11),makeBandpassFilter(bandpassLower,bandpassUpper,sps11),makeBandpassFilter(bandpassLower,bandpassUpper,sps11),makeBandpassFilter(bandpassLower,bandpassUpper,sps11)]}apply(latestData=0){let out=latestData;if(this.useDCBlock===true){out=this.dcb.applyFilter(out)}if(this.useSMA4===true){if(this.last4.length<4){this.last4.push(out)}else{out=this.last4.reduce((accumulator,currentValue)=>accumulator+currentValue)/this.last4.length;this.last4.shift();this.last4.push(out)}}if(this.useNotch50===true){this.notch50.forEach((f,i)=>{out=f.applyFilter(out)})}if(this.useNotch60===true){this.notch60.forEach((f,i)=>{out=f.applyFilter(out)})}if(this.useLowpass===true){this.lp1.forEach((f,i)=>{out=f.applyFilter(out)})}if(this.useBandpass===true){this.bp1.forEach((f,i)=>{out=f.applyFilter(out)});out*=this.bp1.length}if(this.useScaling===true){out*=this.scalar}this.idx++;return out}};var Biquad=class{constructor(type,freq,sps11,Q=1/Math.sqrt(2),dbGain=0){this.a0=0;this.a1=0;this.a2=0;this.b0=0;this.b1=0;this.b2=0;this.x1=0;this.x2=0;this.y1=0;this.y2=0;let types=["lowpass","highpass","bandpass","notch","peak","lowshelf","highshelf"];if(types.indexOf(type)<0){console.error("Valid types: \'lowpass\',\'highpass\',\'bandpass\',\'notch\',\'peak\',\'lowshelf\',\'highshelf\'");return}this.type=type;this.freq=freq;this.sps=sps11;this.Q=Q;this.dbGain=dbGain;let A=Math.pow(10,dbGain/40);let omega=2*Math.PI*freq/sps11;let sn=Math.sin(omega);let cs=Math.cos(omega);let alpha=sn/(2*Q);let beta=Math.sqrt(A+A);this[type](A,sn,cs,alpha,beta);this.b0/=this.a0;this.b1/=this.a0;this.b2/=this.a0;this.a1/=this.a0;this.a2/=this.a0}lowpass(A,sn,cs,alpha,beta){this.b0=(1-cs)*.5;this.b1=1-cs;this.b2=(1-cs)*.5;this.a0=1+alpha;this.a1=-2*cs;this.a2=1-alpha}highpass(A,sn,cs,alpha,beta){this.b0=(1+cs)*.5;this.b1=-(1+cs);this.b2=(1+cs)*.5;this.a0=1+alpha;this.a1=-2*cs;this.a2=1-alpha}bandpass(A,sn,cs,alpha,beta){this.b0=alpha;this.b1=0;this.b2=-alpha;this.a0=1+alpha;this.a1=-2*cs;this.a2=1-alpha}notch(A,sn,cs,alpha,beta){this.b0=1;this.b1=-2*cs;this.b2=1;this.a0=1+alpha;this.a1=-2*cs;this.a2=1-alpha}peak(A,sn,cs,alpha,beta){this.b0=1+alpha*A;this.b1=-2*cs;this.b2=1-alpha*A;this.a0=1+alpha/A;this.a1=-2*cs;this.a2=1-alpha/A}lowshelf(A,sn,cs,alpha,beta){this.b0=A*(A+1-(A-1)*cs+beta*sn);this.b1=2*A*(A-1-(A+1)*cs);this.b2=A*(A+1-(A-1)*cs-beta*sn);this.a0=A+1+(A+1)*cs+beta*sn;this.a1=2*(A-1+(A+1)*cs);this.a2=A+1+(A-1)*cs-beta*sn}highshelf(A,sn,cs,alpha,beta){this.b0=A*(A+1+(A-1)*cs+beta*sn);this.b1=2*A*(A-1+(A+1)*cs);this.b2=A*(A+1-(A-1)*cs-beta*sn);this.a0=A+1-(A+1)*cs-beta*sn;this.a1=2*(A-1-(A+1)*cs);this.a2=A+1-(A-1)*cs-beta*sn}applyFilter(signal_step){let y=this.b0*signal_step+this.b1*this.x1+this.b2*this.x2-this.a1*this.y1-this.a2*this.y2;this.x2=this.x1;this.x1=signal_step;this.y2=this.y1;this.y1=y;return y}zResult(freq){try{let phi=Math.pow(Math.sin(Math.PI*freq*2/(2*this.sps)),2);let result=(Math.pow(this.b0+this.b1+this.b2,2)-4*(this.b0*this.b1+4*this.b0*this.b2+this.b1*this.b2)*phi+16*this.b0*this.b2*phi*phi)/(Math.pow(1+this.a1+this.a2,2)-4*(this.a1+4*this.a2+this.a1*this.a2)*phi+16*this.a2*phi*phi);return result}catch(err){return-200}}static calcCenterFrequency(freqStart,freqEnd){return(freqStart+freqEnd)/2}static calcBandwidth(freqStart,freqEnd){return freqEnd-this.calcCenterFrequency(freqStart,freqEnd)}static calcBandpassQ(frequency,bandwidth,resonance=Math.pow(10,Math.floor(Math.log10(frequency)))){let Q=resonance*Math.sqrt((frequency-bandwidth)*(frequency+bandwidth))/(2*bandwidth);return Q}static calcNotchQ(frequency,bandwidth,resonance=Math.pow(10,Math.floor(Math.log10(frequency)))){let Q=resonance*frequency*bandwidth/Math.sqrt((frequency-bandwidth)*(frequency+bandwidth));return Q}};var DCBlocker=class{constructor(r=.995){this.r=r;this.y1=this.y2=this.x1=this.x2=0}applyFilter(signal_step){this.x2=this.x1;this.x1=signal_step;let y=this.x1-this.x2+this.r*this.y1;this.y2=this.y1;this.y1=y;return y}};var makeNotchFilter=(frequency,sps11,bandwidth)=>{return new Biquad("notch",frequency,sps11,Biquad.calcNotchQ(frequency,bandwidth),0)};var makeBandpassFilter=(freqStart,freqEnd,sps11,resonance=Math.pow(10,Math.floor(Math.log10(Biquad.calcCenterFrequency(freqStart,freqEnd)))))=>{return new Biquad("bandpass",Biquad.calcCenterFrequency(freqStart,freqEnd),sps11,Biquad.calcBandpassQ(Biquad.calcCenterFrequency(freqStart,freqEnd),Biquad.calcBandwidth(freqStart,freqEnd),resonance),0)};var ArrayManip=class{static autoscale(array,lineIdx=0,nLines=1,centerZero=false,ymin,ymax){if(array?.length===0)return array;let max=ymax?ymax:Math.max(...array);let min=ymin?ymin:Math.min(...array);let _lines=1/nLines;let scalar=1;if(centerZero){let absmax=Math.max(Math.abs(min),Math.abs(max));if(absmax!==0)scalar=_lines/absmax;return array.map(y=>y*scalar+(_lines*(lineIdx+1)*2-1-_lines))}else{if(max===min){if(max!==0){scalar=_lines/max}}else scalar=_lines/(max-min);return array.map(y=>2*((y-min)*scalar-1/(2*nLines))+(_lines*(lineIdx+1)*2-1-_lines))}}static genTimestamps(ct,sps11){let now=Date.now();let toInterp=[now-ct*1e3/sps11,now];return ArrayManip.upsample(toInterp,ct)}static absmax(array){return Math.max(Math.abs(Math.min(...array)),Math.max(...array))}static downsample(array,fitCount,scalar=1){if(array.length>fitCount){let output=new Array(fitCount);let incr=array.length/fitCount;let lastIdx=array.length-1;let last=0;let counter=0;for(let i=incr;i<array.length;i+=incr){let rounded=Math.round(i);if(rounded>lastIdx)rounded=lastIdx;for(let j=last;j<rounded;j++){output[counter]+=array[j]}output[counter]/=(rounded-last)*scalar;counter++;last=rounded}return output}else return array}static upsample(array,fitCount,scalar=1){var linearInterpolate=function(before2,after2,atPoint2){return(before2+(after2-before2)*atPoint2)*scalar};var newData=new Array(fitCount);var springFactor=(array.length-1)/(fitCount-1);newData[0]=array[0];for(var i=1;i<fitCount-1;i++){var tmp=i*springFactor;var before=Math.floor(tmp);var after=Math.ceil(tmp);var atPoint=tmp-before;newData[i]=linearInterpolate(array[before],array[after],atPoint)}newData[fitCount-1]=array[array.length-1];return newData}static interpolate(array,fitCount,scalar=1){if(array.length>fitCount){return ArrayManip.downsample(array,fitCount,scalar)}else if(array.length<fitCount){return ArrayManip.upsample(array,fitCount,scalar)}return array}static HSLToRGB(h,s,l,scalar=255){s/=100;l/=100;let c=(1-Math.abs(2*l-1))*s,x2=c*(1-Math.abs(h/60%2-1)),m=l-c/2,r=0,g=0,b=0;if(0<=h&&h<60){r=c;g=x2;b=0}else if(60<=h&&h<120){r=x2;g=c;b=0}else if(120<=h&&h<180){r=0;g=c;b=x2}else if(180<=h&&h<240){r=0;g=x2;b=c}else if(240<=h&&h<300){r=x2;g=0;b=c}else if(300<=h&&h<360){r=c;g=0;b=x2}r=(r+m)*scalar;g=(g+m)*scalar;b=(b+m)*scalar;return[r,g,b]}static circularBuffer(arr,newEntries){if(newEntries.length<arr.length)arr.splice(0,arr.length-newEntries.length,...arr.slice(newEntries.length)).splice(newEntries.length,arr.length,...newEntries);else if(newEntries.length>arr.length){arr.splice(0,arr.length,newEntries.slice(newEntries.length-arr.length))}else{arr.splice(0,arr.length,...newEntries)}return arr}static reformatData(data,key){if(Array.isArray(data)){if(Array.isArray(data[0])){let d={};data.forEach((arr,i)=>{d[i]=arr});data=d;if(isNaN(data[0][0]))return void 0}else if(key){data={[key]:data};if(isNaN(data[key][0]))return void 0}else{data={0:data};if(isNaN(data[0][0]))return void 0}}else if(typeof data==="object"){for(const key2 in data){if(typeof data[key2]==="number")data[key2]=[data[key2]];else if(data[key2]?.values){if(typeof data[key2].values==="number")data[key2].values=[data[key2].values]}if(isNaN(data[key2][0]))return void 0}}else if(typeof data==="string"){let split;if(data.includes("	")){split=data.split("	")}else if(data.includes(",")){split=data.split(",")}data={};if(split){split.forEach((val,i)=>{if(val.includes(":")){let[key2,v]=val.split(":");let fl=parseFloat(v);if(fl)data[key2]=[fl];else return void 0}else{let fl=parseFloat(val);if(fl)data[i]=[fl];else return void 0}})}}else if(typeof data==="number"){if(key)data={[key]:[data]};else data={0:[data]}}return data}static padTime(data,lastValue,time,targetFit){let slopeIncr=(data[0]-lastValue)/time/targetFit;let padded=[...new Array(targetFit-data.length).map((_,i)=>lastValue+slopeIncr*(i+1)),...data];return padded}static interpolateForTime(data,time,targetSPS){return ArrayManip.interpolate(data,Math.ceil(targetSPS*time))}};var __defProp2=Object.defineProperty;var __defNormalProp=(obj,key,value)=>key in obj?__defProp2(obj,key,{enumerable:true,configurable:true,writable:true,value}):obj[key]=value;var __publicField=(obj,key,value)=>{__defNormalProp(obj,typeof key!=="symbol"?key+"":key,value);return value};var _Math2=class{constructor(){}static genSineWave(freq=20,peakAmp=1,nSec=1,fs=512,freq2=0,peakAmp2=1){var sineWave=[];var t=[];var increment=1/fs;for(var ti=0;ti<nSec;ti+=increment){var amplitude=Math.sin(2*Math.PI*freq*ti)*peakAmp;amplitude+=Math.sin(2*Math.PI*freq2*ti)*peakAmp2;sineWave.push(amplitude);t.push(ti)}return[t,sineWave]}static getSineAmplitude(frequency=20,peakAmplitude=1,ti=0,tOffset=0){return Math.sin(this.TWO_PI*frequency*ti+tOffset)*peakAmplitude}static mean(arr){var sum=arr.reduce((prev,curr)=>curr+=prev);return sum/arr.length}static mode(arr){return arr.sort((a,b)=>arr.filter(v=>v===a).length-arr.filter(v=>v===b).length).pop()}static std(arr,mean=void 0){let avg=mean;if(!mean)avg=this.mean(arr);let summed=0;for(let i=0;i<arr.length;i++){let subbed=arr[i]-avg;summed+=subbed*subbed}return Math.sqrt(summed/arr.length)}static relError(actual=[],forecast=[],abs=true){if(actual.length!==forecast.length)throw new Error("Input arrays of same length!");let i=actual.length;let d=new Array(actual.length);for(let j=0;j<i;j++){let dd=(actual[j]-forecast[j])/actual[j];if(abs)dd=Math.abs(dd);d[j]=dd}return d}static informationEntropy(probabilities=[]){let len=probabilities.length;let entropy=new Array(len);for(let i=0;i<len;i++){let ent=probabilities[i]*Math.log(probabilities[i]);if(isNaN(ent))ent=0;entropy[i]=ent}return entropy}static zscore(arr){let mean=this.mean(arr);let std=this.std(arr,mean);let z=new Array().length(arr.length);for(let i=0;i<arr.length;i++){z[i]=(arr[i]-mean)/std}return z}static variance(arr){var mean=this.mean(arr);return arr.reduce((a,b)=>a+(b-mean)**2,0)/arr.length}static dot(vec1,vec2){var dot=0;for(var i=0;i<vec1.length;i++){dot+=vec1[i]*vec2[i]}return dot}static cross3D(vec1,vec2){return[vec1[1]*vec2[2]-vec1[2]*vec2[1],vec1[2]*vec2[0]-vec1[0]*vec2[2],vec1[0]*vec2[1]-vec1[1]*vec2[0]]}static magnitude(vec){var sqrd=0;vec.forEach(c=>{sqrd+=c*c});return Math.sqrt(sqrd)}static distance(point1,point2){var dsqrd=0;point1.forEach((c,i)=>{dsqrd+=(point2[i]-c)*(point2[i]-c)});return Math.sqrt(dsqrd)}static midpoint(point1=[1,2,3],point2=[3,4,5]){return point1.map((c,i)=>{return(c+point2[i])*.5})}static normalize(vec){var norm=0;norm=this.magnitude(vec);var vecn=new Array(vec.length);vec.forEach((c,i)=>{vecn[i]=c*norm});return vecn}static normalizeSeries(arr=[],fromZero=true){let max=Math.max(...arr);let min=Math.min(...arr);if(fromZero==false){max=Math.max(max,Math.abs(min));min=0}if(max-min===0){min=0;if(max===0)max=1e-13}return arr.map(v=>(v-min)/(max-min))}static quadraticFormula(a,b,c){let bbmac4=Math.sqrt(b*b-4*a*c);if(!isNaN(bbmac4))return["complex","complex"];let _a2=1/(2*a);if(bbmac4===0)return[b*_a2];let nb=-b;return[(nb+bbmac4)*_a2,(nb-bbmac4)*_a2]}static newtonsMethod(foo=x2=>{return Math.pow(x2,5)+x2*x2-x2-.2},start=0,end=1,precision=.01,attempts=10){let roots=[];for(let i=0;i<attempts;i++){let seedx=Math.random()*(end-start);let guess=foo(seedx);let guess2=foo(seedx+precision);let slope=(guess2-guess)/precision;let xn=seedx+precision;while(Math.abs(slope)>precision){let step=-guess/slope2;let xn12=xn+step;guess=guess2;guess2=foo(xn12);let slope2=(guess2-guess)/(xn12-xn)}let idx;let f=roots.find((root,i2)=>{if(Math.abs(xn1-root)<precision){idx=i2;return true}});if(f)roots[idx]=(xn1+f)*.5;else roots.push(xn1)}return roots}static makeVec(point1,point2){var vec=[];point1.forEach((c,i)=>{vec.push(point2[i]-c)});return vec}static getBufferedValueByCoordinates(vb=new Array(300).fill(1),dims=[10,10,2],coordinate=[1,2,1],cardinal=void 0){let getIdx=(foundIdx=0,dimIdx=0)=>{if(dimIdx===dims.length)return foundIdx;if(dimIdx==0)foundIdx+=coordinate[dimIdx];else if(dims[dimIdx]==0)dimsAt0++;else{let reMul=(val=coordinate[dimIdx],di=dimIdx-1)=>{val*=dims[di];di--;if(di==0)return val;else return reMul(val,di)};foundIdx+=reMul(coordinate[dimIdx]+1,dimIdx-1)}dimIdx++;return getIdx(foundIdx,dimIdx)};let found=getIdx();if(cardinal){if(coordinate[coordinate.length-1]===0){let lastnonzero=0;let idx=0;while(idx!==coordinate.length-1){if(coordinate[idx]!==0)lastnonzero=idx;idx++}return vb[found-lastnonzero+cardinal]}return vb[found-dims.length+cardinal]}else{if(coordinate[coordinate.length-1]===0){let lastnonzero=0;let idx=0;while(idx!==coordinate.length-1){if(coordinate[idx]!==0)lastnonzero=idx;idx++}return vb.slice(found-lastnonzero,found+1)}return vb.slice(found-dims.length,found+1)}}static forBufferedMat(vb=new Array(100).fill(1),dims=[10,10],asIndex=(v,i,x2,y)=>{return v+x2+y}){let coordinate=[];let idx=0;let recurseFor=(depth=0,nextDepth=depth+1)=>{let result=new Array(vb.length);for(let di=0;di<dims[depth];di++){coordinate[depth]=di;if(dims[nextDepth])recurseFor(nextDepth);else{result[idx]=asIndex(vb[idx],idx,...coordinate);idx++}}return result};let recurseForArrFuncs=(depth,nextDepth=depth+1)=>{let result=new Array(vb.length);for(let di=0;di<dims[depth];di++){coordinate[depth]=di;if(dims[nextDepth])recurseFor(nextDepth);else{for(let dj=0;dj<dims.length;dj++){result[idx]=asIndex[dj](vb[idx],idx,...coordinate);idx++}}}return result};if(typeof asIndex==="function"){return recurseFor()}else if(Array.isArray(asIndex)){return recurseForArrFuncs()}}static mapBufferedMat(buffer=new Array(100).fill(1),dimensions=[10,10],asIndex=(v,idx,i,j)=>{console.log(`value:${v}, idx:${idx}, x:${i},y:${j}`);return v+i+j}){let coordinate=new Array(dimensions.length).fill(0);const iterateCoordinate=(coord,idx=0)=>{if(coord[idx]>=dimensions[idx]){coord[idx]=0;idx++;if(idx===dimensions.length)return;iterateCoordinate(coord,idx)}else coord[idx]++};let result=new Array(buffer.length);let i=0;if(typeof asIndex==="function"){while(i<buffer.length){result[i]=asIndex(buffer[i],i,...coordinate);i+=dimensions.length;iterateCoordinate(coordinate)}}else if(Array.isArray(asIndex)){while(i<buffer.length){asIndex.forEach(func=>{result[i]=func(buffer[i],i,...coordinate);i++;iterateCoordinate(coordinate)})}}return result}static combinations(choices=["a","b","c"],vecsize=3){var result=[];if(vecsize<=0){result.push([])}else{_Math2.combinations(choices,vecsize-1).forEach(function(previousComb){choices.forEach(function(element){result.push([element].concat(previousComb))})})}return result}static generateCoordinateSpace(upperBounds=[10,10,10],lowerBounds=[-10,-10,-10],steps=[1,1,1],mutater=void 0){for(let i=0;i<upperBounds.length;i++){if(lowerBounds[i]>upperBounds[i]){let temp=upperBounds[i];upperBounds[i]=lowerBounds[i];lowerBounds[i]=temp}}let result=[];let copy=[...upperBounds];let lastindex=copy.length-1;result.push([...copy]);while(copy[0]>=lowerBounds[0]){let checkNextIndex=decrIdx2=>{if(copy[decrIdx2]<=lowerBounds[decrIdx2]){if(decrIdx2===0)return;copy[decrIdx2]=upperBounds[decrIdx2];decrIdx2--;if(decrIdx2<0)return;if(typeof steps[decrIdx2]=="function")copy[decrIdx2]-=steps[decrIdx2](copy[decrIdx2]);else copy[decrIdx2]-=steps[decrIdx2];checkNextIndex(decrIdx2)}};let decrIdx=lastindex;if(typeof steps[decrIdx]=="function")copy[decrIdx]-=steps[decrIdx](copy[decrIdx]);else copy[decrIdx]-=steps[decrIdx];result.push([...copy]);checkNextIndex(decrIdx);if(mutater)result[result.length-1]=mutater(result[result.length-1])}return result}static calcVectorField(coordinates=[[0,0],[0,1],[1,0],[1,1]],formula=(x2,y)=>{return[x2*10,y*10]}){return coordinates.map(vec=>formula(...vec))}static transpose(mat){return mat[0].map((_,colIndex)=>mat.map(row=>row[colIndex]))}static matmul(a,b){var aNumRows=a.length,aNumCols=a[0].length,bNumRows=b.length,bNumCols=b[0].length,m=new Array(aNumRows);for(var r=0;r<aNumRows;++r){m[r]=new Array(bNumCols);for(var c=0;c<bNumCols;++c){m[r][c]=0;for(var i=0;i<aNumCols;++i){m[r][c]+=a[r][i]*b[i][c]}}}return m}static matscale(mat,scalar){let m=[];for(var i=0;i<mat.length;i++){m[i]=[];for(let j=0;j<mat[0].length;j++){m[i][j]=mat[i][j]*scalar}}return m}static matadd(a,b){let m=[];for(let i=0;i<a.length;i++){m[i]=[];for(var j=0;j<a[0].length;j++){m[i][j]=a[i][j]+b[i][j]}}return m}static matsub(a,b){let m=[];for(let i=0;i<a.length;i++){m[i]=[];for(var j=0;j<a[0].length;j++){m[i][j]=a[i][j]-b[i][j]}}return m}static histogram(arr=[],binSize=1,nBins=void 0){let copy=[...arr];copy.sort(function(a,b){return a-b});let binStart=Math.min(...copy);if(typeof nBins==="number"){let binEnd=Math.max(...copy);binSize=Math.abs((binEnd-binStart)/(nBins-1))}let j=binStart;let binx=[];let biny=[];for(let i=0;i<copy.length;i++){let binidx=binSize*j;if(copy[i]>binStart+binidx){j++;binidx+=binSize;let binmin=binStart+binidx;let binmid=binmin+binidx*.5;binx.push(binmid);biny.push(0)}biny[biny.length-1]++}return[binx,biny]}static normalDistribution(samples=[],normalize=true,cutoff=1e-4){let m=this.mean(samples);let vari=this.variance(samples);let nSamples=samples.length;let probabilities=[];let denom2=1/(this.TWO_PI*vari);let _variance=1/vari;let sum=0;for(let i=0;i<nSamples;i++){let px=Math.exp(-.5*Math.pow((samples[i]-m)*_variance,2))*denom2;if(px<cutoff)px=0;probabilities.push(px);sum+=px}if(normalize){let _sum=1/sum;probabilities=probabilities.map(x2=>x2*_sum)}return probabilities}static expectedValue(samples=[],probabilities=this.normalDistribution(samples)){return samples.reduce((sum,item,idx)=>sum+item*probabilities[idx])}static originMoment(samples=[],probabilities=this.normalDistribution(samples),order=1){return samples.reduce((sum,item,idx)=>sum+Math.pow(item,order)*probabilities[idx])}static centralMoment(samples=[],probabilities=this.normalDistribution(samples),order=1){let m=this.mean(samples);return samples.reduce((sum,item,idx)=>sum+Math.pow(item-m,order)*probabilities[idx]/samples.length)}static linearDiscriminantAnalysis(samples=[],classifier=[]){let mean=this.mean(samples);let meank=this.mean(classifier);let covariance=this.cov1d(samples,classifier);let probs=this.normalDistribution(samples);let dk=[];for(let i=0;i<samples.length;i++){dk.push(x[i]*covariance*meank-.5*mean*covariance*meank+Math.log10(probs[i]))}return dk}static conv1D(arr=[],kern=[1/3,1/3,1/3],pad=Math.floor(kern.length*.5)){let result=[];let _n=1/kern.length;if(pad>0){let pads=new Array(pad).fill(0);arr=[...pads,...arr,...pads]}let start=Math.floor(kern.length*.5);let end=arr.length-kern.length+start;for(let i=start;i<end;i++){let acc=0;for(let j=0;j<kern.length;j++){acc+=arr[i-start]*kern[j]}result.push(acc*_n)}return result}static conv2D(mat=[[],[],[]],kern=[[],[],[]],pad=0){let result=new Array(mat.length-Math.ceil(kern.length*.5)).fill([]);let mat_t;let kern_t=_Math2.transpose(kern_t);if(pad>0){let pads=new Array(pad).fill(0);mat_t=_Math2.transpose(mat);for(let i2=0;i2<mat_t.length;i2++){mat_t[i2]=[...pads,...mat_t[i2],...pads]}mat=_Math2.transpose(mat_t);for(let j=0;j<mat.length;j++){mat[j]=[...pads,...mat[j],...pads]}}let startr=Math.floor(kern[0].length*.5);let startl=Math.floor(kern_t[0].length*.5);let endr=mat[0].length-kern[0].length+startr;let endl=mat_t[0].length-kern_t[0].length+startl;let _n=1/(kern[0].length*kern_t[0].length);let iters=endr*endl;let i=startr;let x2;let y=startl;while(i<iters){let acc=0;x2=i%mat[0].length;if(x2===0){y++}for(let j=0;j<kern[0].length;j++){for(let k=0;k<kern_t[0].length;j++){acc+=mat[y-startl+k][x2-startr+j]*kern[k][j]}result[y].push(acc*_n)}i++}return result}static cov2d(mat){var mattransposed=this.transpose(mat);var matproducts=[];var rowmeans=[];var colmeans=[];mat.forEach((row,idx)=>{rowmeans.push(this.mean(row))});mattransposed.forEach((col,idx)=>{colmeans.push(this.mean(col))});mat.forEach((row,idx)=>{matproducts.push([]);for(var col=0;col<row.length;col++){matproducts[idx].push((mat[idx][col]-rowmeans[idx])*(mat[idx][col]-colmeans[col])/(row.length-1))}});var matproductstransposed=this.transpose(matproducts);var aNumRows=matproducts.length,aNumCols=matproducts[0].length,bNumRows=matproductstransposed.length,bNumCols=matproductstransposed[0].length,m=new Array(aNumRows);for(var r=0;r<aNumRows;++r){m[r]=new Array(bNumCols);for(var c=0;c<bNumCols;++c){m[r][c]=0;for(var i=0;i<aNumCols;++i){m[r][c]+=matproducts[r][i]*matproductstransposed[i][c]/(mat[0].length-1)}}}return m}static cov1d(arr1=[],arr2=[]){return this.cov2d([arr1,arr2])}static cov3d(x2=[],y=[],z=[]){return[[this.cov1d(x2,x2),this.cov1d(x2,y),this.cov1d(x2,z)],[this.cov1d(y,x2),this.cov1d(y,y),this.cov1d(y,z)],[this.cov1d(z,x2),this.cov1d(z,y),this.cov1d(z,z)]]}static covNd(dimensionalData=[]){let covariance=[];dimensionalData.forEach((arr,i)=>{covariance.push([]);dimensionalData.forEach((arr2,j)=>{covariance[i].push(this.cov1d(arr,arr2))})})}static eigens2x2(mat=[[1,2],[3,4]]){let det=mat[0][0]*mat[1][1]-mat[0][1]*mat[1][0];let mean=(mat[0][0]+mat[1][1])*.5;let sqrt=Math.sqrt(mean*mean-det);let eig1=mean+sqrt;let eig2=mean-sqrt;return[eig1,eig2]}static eigenvectors2x2(mat=[[1,2],[3,4]],eigens=[1,2]){let v1=[-mat[0][1],mat[0][0]-eigens[0]];if(v1[0]===0&&v1[1]===0){v1[0]=mat[1][1]-eigens[0];v1[1]=-mat[1][0]}let v2=[-mat[0][1],mat[0][0]-eigens[1]];if(v2[0]===0&&v2[1]===0){v2[0]=mat[1][1]-eigens[1];v2[1]=-mat[1][0]}return[v1,v2]}static fastpca2d(xarr,yarr){let cov1d=this.cov1d(xarr,yarr);let eigs=this.eigens2x2(cov1d);if(eigs[1]>eigs[0])eigs.reverse();let evs=this.eigenvectors2x2(cov1d,eigs);console.log(eigs,evs);return[eigs,evs]}static crosscorrelation(arr1,arr2){var arr2buf=[...arr2,...Array(arr2.length).fill(0)];var mean1=this.mean(arr1);var mean2=this.mean(arr2);var arr1Est=arr1.reduce((sum,item)=>sum+=Math.pow(item-mean1,2));arr1Est=Math.sqrt(arr1Est);var arr2Est=arr2.reduce((sum,item)=>sum+=Math.pow(item-mean1,2));arr2Est=Math.sqrt(arr2Est);var _arrEstsMul=1/(arr1Est*arr2Est);var correlations=new Array(arr1.length).fill(0);for(var delay=0;delay<arr1.length;delay++){var r=arr1.reduce((sum,item,i)=>sum+=(item-mean1)*(arr2buf[delay+i]-mean2));correlations[delay]=r*_arrEstsMul}return correlations}static autocorrelation(arr1){var delaybuf=[...arr1,...Array(arr1.length).fill(0)];var mean1=this.mean(arr1);var arr1Est=arr1.reduce((sum,item)=>sum+=Math.pow(item-mean1,2));arr1Est=Math.sqrt(arr1Est);var _arr1estsqrd=1/(arr1Est*arr1Est);var correlations=new Array(arr1.length).fill(0);for(var delay=0;delay<arr1.length;delay++){var r=arr1.reduce((sum,item,i)=>sum+=(item-mean1)*(delaybuf[delay+i]-mean1));correlations[delay]=r*_arr1estsqrd}return correlations}static autocorrelation2dNormalized(mat2d2){let result=[];for(let y=0;y<mat2d2.length;y++){result.push([]);for(let x2=0;x2<mat2d2[y].length;x2++){let G=0;let _G=0;for(let b=0;b<mat2d2.length;b++){for(let a=0;a<mat2d2[b].length;a++){G+=mat2d2[y][x2]*mat2d2[mat2d2.length-1-b][mat2d2[y].length-1-a];_G+=mat2d2[y][x2]*mat2d2[mat2d2.length-1][mat2d2[y].length-1]}}result[y][x2]=G/_G-1}}return result}static crosscorrelation2d(mat2d1,mat2d2){let result=[];for(let y=0;y<mat2d1.length;y++){result.push([]);for(let x2=0;x2<mat2d1[y].length;x2++){let G=0;for(let b=0;b<mat2d2.length;b++){for(let a=0;a<mat2d2[b].length;a++){G+=mat2d1[y][x2]*mat2d2[mat2d2.length-1-b][mat2d2[y].length-1-a]}}result[y][x2]=G}}return result}static crosscorrelation2dNormalized(mat2d1,mat2d2){let result=[];for(let y=0;y<mat2d1.length;y++){result.push([]);for(let x2=0;x2<mat2d1[y].length;x2++){let G=0;let _G=0;for(let b=0;b<mat2d2.length;b++){for(let a=0;a<mat2d2[b].length;a++){G+=mat2d1[y][x2]*mat2d2[mat2d.length-1-b][mat2d2[y].length-1-a];_G+=mat2d1[y][x2]*mat2d2[mat2d2.length-1][mat2d2[y].length-1]}}result[y][x2]=G/_G-1}}return result}static correlograms(dat=[[],[]]){var correlograms=[];dat.forEach((row1,i)=>{dat.forEach((row2,j)=>{if(j>=i){correlograms.push(_Math2.crosscorrelation(row1,row2))}})});return correlograms}static dft(sineWave=[]){var TWOPI=2*3.141592653589793;var real=[];var imag=[];var mags=[];for(var k=0;k<sineWave.length;k++){real.push(0);imag.push(0);for(var j=0;j<sineWave.length;j++){var shared=TWOPI*k*j/sineWave.length;real[k]=real[k]+sineWave[j]*Math.cos(shared);imag[k]=imag[k]-sineWave[j]*Math.sin(shared)}mags.push(Math.sqrt(real[k]*real[k]+imag[k]*imag[k]))}function orderMagnitudes(unorderedMags){return[...unorderedMags.slice(Math.ceil(unorderedMags.length*.5),unorderedMags.length),...unorderedMags.slice(0,Math.ceil(unorderedMags.length*.5))]}mags=orderMagnitudes(mags);let halflen=mags.length*.5;let freqs=mags.map((m,i)=>{return i-halflen});return{real,imag,freqs,mags}}static sma(arr=[],window2){var smaArr=[];for(var i=0;i<arr.length;i++){if(i==0){smaArr.push(arr[0])}else if(i<window2){var arrslice=arr.slice(0,i+1);smaArr.push(arrslice.reduce((previous,current)=>current+=previous)/(i+1))}else{var arrslice=arr.slice(i-window2,i);smaArr.push(arrslice.reduce((previous,current)=>current+=previous)/window2)}}return smaArr}static sum(arr=[]){if(arr.length>0){var sum=arr.reduce((prev,curr)=>curr+=prev);return sum}else{return 0}}static reduceArrByFactor(arr,factor=2){let x2=arr.filter((element,index)=>{return index%factor===0});return x2}static makeArr(startValue,stopValue,nSteps){var arr=[];var step=(stopValue-startValue)/(nSteps-1);for(var i=0;i<nSteps;i++){arr.push(startValue+step*i)}return arr}static autoscale(array,stackedLines=1,stackPosition=0,centerZero=false){if(array?.length===0)return array;let max=Math.max(...array);let min=Math.min(...array);let _lines=1/stackedLines;let scalar;if(centerZero){let absmax=Math.max(Math.abs(min),Math.abs(max));scalar=_lines/absmax;return array.map(y=>y*scalar+(_lines*(stackPosition+1)*2-1-_lines))}else{scalar=_lines/(max-min);return array.map(y=>2*((y-min)*scalar-1/(2*stackedLines))+(_lines*(stackPosition+1)*2-1-_lines))}}static absmax(array){return Math.max(Math.abs(Math.min(...array)),Math.max(...array))}static downsample(array,fitCount,scalar=1){if(array.length>fitCount){let output=new Array(fitCount);let incr=array.length/fitCount;let lastIdx=array.length-1;let last=0;let counter=0;for(let i=incr;i<array.length;i+=incr){let rounded=Math.round(i);if(rounded>lastIdx)rounded=lastIdx;for(let j=last;j<rounded;j++){output[counter]+=array[j]}output[counter]/=(rounded-last)*scalar;counter++;last=rounded}return output}else return array}static interpolateArray(data,fitCount,scalar=1){var linearInterpolate=function(before2,after2,atPoint2){return(before2+(after2-before2)*atPoint2)*scalar};var newData=new Array;var springFactor=new Number((data.length-1)/(fitCount-1));newData[0]=data[0];for(var i=1;i<fitCount-1;i++){var tmp=i*springFactor;var before=new Number(Math.floor(tmp)).toFixed();var after=new Number(Math.ceil(tmp)).toFixed();var atPoint=tmp-before;newData[i]=linearInterpolate(data[before],data[after],atPoint)}newData[fitCount-1]=data[data.length-1];return newData}static isExtrema(arr,critical="peak"){let ref=[...arr];if(ref.length%2===0)ref.pop();if(arr.length>1){let pass=true;for(let i=0;i<ref.length;i++){let val=ref[i];if(critical==="peak"){if(i<Math.floor(ref.length*.5)&&val>=ref[Math.floor(ref.length*.5)]){pass=false;break}else if(i>Math.floor(ref.length*.5)&&val>=ref[Math.floor(ref.length*.5)]){pass=false;break}}else if(critical==="valley"){if(i<Math.floor(ref.length*.5)&&val<=ref[Math.floor(ref.length*.5)]){pass=false;break}else if(i>Math.floor(ref.length*.5)&&val<=ref[Math.floor(ref.length*.5)]){pass=false;break}}else{if(i<Math.floor(ref.length*.5)&&val<=ref[Math.floor(ref.length*.5)]){pass=false;break}else if(i>Math.floor(ref.length*.5)&&val<=ref[Math.floor(ref.length*.5)]){pass=false;break}}}if(critical!=="peak"&&critical!=="valley"&&pass===false){pass=true;for(let i=0;i<ref.length;i++){let val=ref[i];if(i<Math.floor(ref.length*.5)&&val>=ref[Math.floor(ref.length*.5)]){pass=false;break}else if(i>Math.floor(ref.length*.5)&&val>=ref[Math.floor(ref.length*.5)]){pass=false;break}}}return pass}else return void 0}static isCriticalPoint(arr,critical="peak"){let ref=[...arr];if(ref.length%2===0)ref.pop();if(arr.length>1){let pass=true;for(let i=0;i<ref.length;i++){let val=ref[i];if(critical==="peak"){if(i<ref.length*.5&&val<=0){pass=false;break}else if(i>ref.length*.5&&val>0){pass=false;break}}else if(critical==="valley"){if(i<ref.length*.5&&val>=0){pass=false;break}else if(i>ref.length*.5&&val<0){pass=false;break}}else{if(i<ref.length*.5&&val>=0){pass=false;break}else if(i>ref.length*.5&&val<0){pass=false;break}}}if(critical!=="peak"&&critical!=="valley"&&pass===false){pass=true;for(let i=0;i<ref.length;i++){let val=ref[i];if(i<ref.length*.5&&val<=0){pass=false;break}else if(i>ref.length*.5&&val>0){pass=false;break}}}return pass}else return void 0}static getPeakThreshold(arr,peakIndices,thresholdVar){let threshold;let filtered=arr.filter((o,i)=>{if(peakIndices.indexOf(i)>-1)return true});if(thresholdVar===0){threshold=this.mean(filtered)}else threshold=(thresholdVar+this.mean(filtered))*.5;return threshold}static column(mat,x2){let col=new Array(mat.length).fill(0).map(()=>new Array(1).fill(0));for(let i=0;i<mat.length;i++){col[i][0]=mat[i][x2]}return col}static flatten_vector(v){let v_new=[];for(let i=0;i<v.length;i++){v_new[i]=v[i][0]}return v_new}static squared_difference(v1,v2){let sum=0;for(let i=0;i<v1.length;i++){sum=sum+Math.pow(v1[i]-v2[i],2)}return sum}static shift_deflate(mat,eigenvalue,eigenvector){let len=Math.sqrt(this.matmul(this.transpose(eigenvector),eigenvector));let U=this.matscale(eigenvector,1/len);let delta=this.matscale(this.matmul(U,this.transpose(U)),eigenvalue);let M_new=this.matsub(mat,delta);return M_new}static eigenvalue_of_vector(mat,eigenvector){ev=this.matmul(this.matmul(this.transpose(eigenvector),mat),eigenvector);return ev}static power_iteration(mat,tolerance=1e-5,max_iterations=1e3){let rank=mat.length;let eigenvector=new Array(rank).fill(0).map(()=>new Array(1).fill(Math.sqrt(rank)));let eigenvalue=this.eigenvalue_of_vector(mat,eigenvector);let epsilon=1;let iter=0;while(epsilon>tolerance&&iter<max_iterations){let old_eigenvalue=JSON.parse(JSON.stringify(eigenvalue));let Mv=this.matmul(mat,eigenvector);eigenvector=this.normalize(Mv);eigenvalue=this.eigenvalue_of_vector(mat,eigenvector);epsilon=Math.abs(eigenvalue-old_eigenvalue);iter++};return[eigenvalue,eigenvector]}static eigens(mat,tolerance=1e-4,max_iterations=1e3){let eigenvalues=[];let eigenvectors=[];for(let i=0;i<mat.length;i++){let result=this.power_iteration(mat,tolerance,max_iterations);let eigenvalue=result[0];let eigenvector=result[1];eigenvalues[i]=eigenvalue;eigenvectors[i]=this.flatten_vector(eigenvector);mat=this.shift_deflate(mat,eigenvalue,eigenvector)}return[eigenvalues,eigenvectors]}static pca(mat,tolerance=1e-5){let dims=mat.length;let t=new Array(dims);let p=new Array(dims);let mat_t=this.transpose(mat);t[0]=this.column(mat,0);let epsilon=1;let iter=0;while(espilon>tolerance){iter++;p[0]=this.matmul(mat_t,t[0]);let tp=this.matmul(this.transpose(t[0]),t[0]);p[0]=this.matscale(p[0],1/tp);let p_length=Math.sqrt(this.matmul(this.transpose(p[0]),p[0]));p[0]=this.matscale(p[0],1/p_length);let t_new=this.matmul(mat,p[0]);let pp=this.matmul(this.transpose(p[0]),p[0]);t_new=this.matscale(t_new,1/pp);epsilon=this.squared_difference(t[0],t_new);t[0]=JSON.parse(JSON.stringify(t_new))}let components=this.matmul(this.transpose(t[0]),t[0]);return components}static p300(event_timestamps=[],raw_signal=[],signal_timestamps=[],sps11=256){let smoothingstep=Math.floor(sps11/10);let smoothed=this.sma(raw_signal,smoothingstep);let peaks=this.peakDetect(smoothed,"peak",smoothingstep);let mean=this.mean(smoothed);let std=this.std(smoothed,mean);let p_idx=0;let candidates=[];if(peaks.length>0){event_timestamps.forEach((t,j)=>{while(signal_timestamps[peaks[p_idx]]<t+200){p_idx++;if(!peaks[p_idx])break}let tempi=0;let tempcandidates=[];while(signal_timestamps[peaks[p_idx+tempi]]<t+600){tempcandidates.push(p_idx+tempi);tempi++;if(!peaks[p_idx+tempi])break}if(tempcandidates.length>1){let peakvals=[];tempcandidates.forEach(tc=>{peakvals.push(smoothed[peaks[tc]])});let max=Math.max(...peakvals);let maxi=tempcandidates[peakvals.indexOf(max)];candidates.push({event_timestamp:t,event_index:j,peak_timestamp:signal_timestamps[[peaks[maxi]]],signal_index:[peaks[maxi]],signal_amplitude:raw_signal[[peaks[maxi]]],zscore:(smoothed[peaks[maxi]]-mean)/std})}else if(tempcandidates.length===1)candidates.push({event_timestamp:t,event_index:j,peak_timestamp:signal_timestamps[peaks[tempcandidates[0]]],signal_index:peaks[tempcandidates[0]],signal_amplitude:raw_signal[[peaks[tempcandidates[0]]]],zscore:(smoothed[peaks[tempcandidates[0]]]-mean)/std})})}return candidates}};var Math2=_Math2;__publicField(Math2,"TWO_PI",Math.PI*2);__publicField(Math2,"C",299792458);__publicField(Math2,"G",66743e-15);__publicField(Math2,"h",662607015e-42);__publicField(Math2,"R",8314.32);__publicField(Math2,"Ra",287);__publicField(Math2,"H",69.3);__publicField(Math2,"kbar",1054571817e-43);__publicField(Math2,"kB",1380649e-29);__publicField(Math2,"ke",89875517923e-1);__publicField(Math2,"me",91093837015e-41);__publicField(Math2,"mp",167262192369e-38);__publicField(Math2,"mn",167492749804e-38);__publicField(Math2,"P0",101325);__publicField(Math2,"T0",288.15);__publicField(Math2,"p0",1.225);__publicField(Math2,"Na",60220978e16);__publicField(Math2,"y",1.405);__publicField(Math2,"M0",28.96643);__publicField(Math2,"g0",9.80665);__publicField(Math2,"Re",6378100);__publicField(Math2,"B",1458e-9);__publicField(Math2,"S",110.4);__publicField(Math2,"Sigma",365e-12);__publicField(Math2,"imgkernels",{edgeDetection:[[-1,-1,-1],[-1,8,-1],[-1,-1,-1]],boxBlur:[[1/9,1/9,1/9],[1/9,1/9,1/9],[1/9,1/9,1/9]],sobelLeft:[[1,0,-1],[2,0,-2],[1,0,-1]],sobelRight:[[-1,0,1],[-2,0,2],[-1,0,1]],sobelTop:[[1,2,1],[0,0,0],[-1,-2,-1]],sobelBottom:[[-1,2,1],[0,0,0],[1,2,1]],identity:[[0,0,0],[0,1,0],[0,0,0]],gaussian3x3:[[1,2,1],[2,4,2],[1,2,1]],guassian7x7:[[0,0,0,5,0,0,0],[0,5,18,32,18,5,0],[0,18,64,100,64,18,0],[5,32,100,100,100,32,5],[0,18,64,100,64,18,0],[0,5,18,32,18,5,0],[0,0,0,5,0,0,0]],emboss:[[-2,-1,0],[-1,1,1],[0,1,2]],sharpen:[[0,-1,0],[-1,5,-1],[0,-1,0]]});__publicField(Math2,"integral",(func=x2=>{let y=x2;return y},range=[],stepx=.01)=>{let area=0;for(let i=range[0];i<range[1];i+=stepx){let y=func(i);area+=y*stepx}return area});__publicField(Math2,"dintegral",(func=(x2,y)=>{let z=x2+y;return z},range=[[],[]],stepx=.01,stepy=stepx)=>{let volume=0;for(let i=range[0][0]+stepx;i<range[0][1];i+=stepx){for(let j=range[1][0]+stepy;j<range[1][1];j+=stepy){let z=func(i,j);volume+=z*stepx*stepy}}return volume});__publicField(Math2,"tintegral",(func=(x2,y,z)=>{let w=x2+y+z;return w},range=[[],[],[]],stepx=.01,stepy=stepx,stepz=stepx)=>{let volume=0;for(let i=range[0][0]+stepx;i<range[0][1];i+=stepx){for(let j=range[1][0]+stepy;j<range[1][1];j+=stepy){for(let k=range[2][0]+stepz;k<range[2][1];k+=stepz){let w=func(i,j,k);volume+=w*stepx*stepy*stepz}}}return volume});__publicField(Math2,"pintegral",(func=x2=>{let y=x2;return y},range=[],stepx=.01)=>{let length=0;let y0=void 0;let yi=void 0;for(let i=range[0];i<range[1];i+=stepx){y0=yi;yi=func(i);if(y0)length+=_Math2.distance([0,y0],[stepx,yi])}return length});__publicField(Math2,"meshgrid",_Math2.generateCoordinateSpace);__publicField(Math2,"autocorrelation2d",mat2d2=>{let result=[];for(let y=0;y<mat2d2.length;y++){result.push([]);for(let x2=0;x2<mat2d2[y].length;x2++){let G=0;for(let b=0;b<mat2d2.length;b++){for(let a=0;a<mat2d2[b].length;a++){G+=mat2d2[y][x2]*mat2d2[mat2d2.length-1-b][mat2d2[y].length-1-a]}}result[y][x2]=G}}return result});__publicField(Math2,"upsample",_Math2.interpolateArray);__publicField(Math2,"peakDetect",(smoothedArray,type="peak",window2=49)=>{let mid=Math.floor(window2*.5);let peaks=[];for(let i=0;i<smoothedArray.length-window2;i++){let isPeak=_Math2.isExtrema(smoothedArray.slice(i,i+window2),type);if(isPeak){peaks.push(i+mid-1)}}return peaks});Object.assign(Math,Math2);var beat_detect={structs:{summed:[],smoothed:[],timestamp:[],peaks:[],valleys:[],peak_distances:[],valley_distances:[],beats:[],sps:100,maxFreq:4,limit:10},ondata:(context,data)=>{if(!("red"in data)||!("ir"in data))return void 0;let smoothFactor=context.sps/context.maxFreq;let smawindow=Math.floor(smoothFactor);let peakFinderWindow=smawindow;if(peakFinderWindow%2===0)peakFinderWindow+=1;let midpoint=Math.round(peakFinderWindow*.5);if(!("timestamp"in data)){if(Array.isArray(data.red)){let now=Date.now();let toInterp=[now-data.red.length*context.sps*1e3,now];data.timestamp=Math2.upsample(toInterp,data.red.length)}else{data.timestamp=Date.now()}}let pass=(red,ir,timestamp)=>{context.summed.push(red+ir);context.timestamp.push(timestamp);let beat;if(context.summed.length>peakFinderWindow){context.summed.shift();context.timestamp.shift()}context.smoothed.push(Math2.mean(context.smoothed));if(context.smoothed.length>peakFinderWindow){context.smoothed.shift()}if(context.summed.length>1){if(Math2.isExtrema(context.summed,"valley")){context.valleys.push({value:context.summed[context.summed.length-midpoint],timestamp:context.timestamp[context.timestamp.length-midpoint]})}else if(Math2.isExtrema(context.summed,"peak")){context.peaks.push({value:context.summed[context.summed.length-midpoint],timestamp:context.timestamp[context.timestamp.length-midpoint]})}if(context.valleys.length>1&&context.peaks.length>1){let l1=context.valleys.length;let l2=context.peaks.length;if(context.valleys>context.peaks.length+2){while(context.valleys.length>context.peaks.length+2)context.valleys.splice(context.valleys.length-2,1)}else if(context.peaks.length>context.valleys.length+2){while(context.peaks.length>context.valleys.length+2){context.peaks.splice(context.valleys.length-2,1)}}if(l1<context.valleys.length){context.valley_distances.push({distance:context.valleys[context.valleys.length-1].timestamp-context.valleys[context.valleys.length-2].timestamp,timestamp:context.valleys[context.valleys.length-1].timestamp,peak0:context.valleys[context.valleys.length-1].value,peak1:context.valleys[context.valleys.length-2].value})}if(l2<context.peaks.length){context.peak_distances.push({distance:context.peaks[context.peaks.length-1].timestamp-context.peaks[context.peaks.length-2].timestamp,timestamp:context.peaks[context.peaks.length-1].timestamp,peak0:context.peaks[context.peaks.length-1].value,peak1:context.peaks[context.peaks.length-2].value})}if(context.peak_distances.length>1&&context.valley_distances.length>1){if(context.valley_distances[context.valley_distances.length-1].timestamp>context.peak_distances[context.peak_distances.length-1].timestamp){let bpm,hrv=0;if(context.beats.length<1){bpm=60/(5e-4*(context.peak_distances[context.peak_distances.length-1].distance+context.valley_distances[context.valley_distances.length-1].distance))}else if(context.beats[context.beats.length-1].timestamp!==context.peak_distances[context.peak_distances.length-1].timestamp){bpm=60/(5e-4*(context.peak_distances[context.peak_distances.length-1].dt+context.valley_distances[context.valley_distances.length-1].dt));hrv=Math.abs(bpm-context.beats[context.beats.length-1].bpm)}beat={timestamp:context.peak_distances[context.peak_distances.length-1].timestamp,hrv,bpm,height0:context.peak_distances[context.peak_distances.length-1].peak0-context.valley_distances[context.valley_distances.length-1].peak0,height1:context.peak_distances[context.peak_distances.length-1].peak1-context.valley_distances[context.valley_distances.length-1].peak1};context.beats.push(beat)}else{let bpm,hrv=0;if(context.beats.length<2){bpm=60/(5e-4*(context.peak_distances[context.peak_distances.length-2].distance+context.valley_distances[context.valley_distances.length-2].distance))}else if(context.beats[context.beats.length-1].timestamp!==context.peak_distances[context.peak_distances.length-2].timestamp){bpm=60/(5e-4*(context.peak_distances[context.peak_distances.length-2].distance+context.valley_distances[context.valley_distances.length-2].distance));hrv=Math.abs(bpm-context.beats[context.beats.length-2].bpm)}beat={timestamp:context.peak_distances[context.peak_distances.length-2].timestamp,hrv,bpm,height0:context.peak_distances[context.peak_distances.length-2].peak0-context.valley_distances[context.valley_distances.length-2].peak0,height1:context.peak_distances[context.peak_distances.length-2].peak1-context.valley_distances[context.valley_distances.length-2].peak1};context.beats.push(beat)}}if(context.peaks.length>context.limit){context.peaks.shift()}if(context.valleys.length>context.limit){context.valleys.shift()}if(context.peak_distances.length>context.limit){context.peak_distances.shift()}if(context.valley_distances.length>context.limit){context.valley_distances.shift()}if(context.beats.length>context.limit){context.beats.shift()}}}return beat};if(Array.isArray(data.red)){let result=data.red.map((v,i)=>{return pass(v,data.ir[i],data.timestamp[i])});return result}else return pass(data.red,data.ir,data.timestamp)}};var accel_gyro={structs:{accelConstant:1/8192,gyroConstant:1/65.5,gyroXAngle:0,gyroYAngle:0,gyroZAngle:0,px:0,py:0,pz:0,sps:100,lastAccelTime:Date.now(),lastGyroTime:Date.now()},ondata:(ctx,data)=>{if(!("ax"in data)&&!("gx"in data))return void 0;if(!data.timestamp){if(data.ax&&Array.isArray(data.ax)||data.gx&&Array.isArray(data.gx)){let len=data.ax?data.ax.length:data.gx.length;let now=Date.now();let toInterp=[now-len*ctx.sps*1e3,now];data.timestamp=Math2.upsample(toInterp,len)}else{data.timestamp=Date.now()}}let result;if(data.ax){let apass=(timestamp,ax,ay,az)=>{ax=ax*ctx.accelConstant;ay=ay*ctx.accelConstant;az=az*ctx.accelConstant;const accelXAngle=Math.atan(ay/Math.sqrt(ax*ax)+az*az*180/Math.PI)+ctx.accelXError;const accelYAngle=Math.atan(-ax/Math.sqrt(ay*ay)+az*az*180/Math.PI)+ctx.accelYError;return{ax,ay,az,roll:accelXAngle,pitch:accelYAngle}};if(Array.isArray(data.timestamp)){result=data.timestamp.map((v,i)=>{return apass(v,data.ax[i],data.ay[i],data.az[i])})}else result=apass(data.timestamp,data.ax,data.ay,data.az)}if(data.gx){let gpass=(timestamp,gx,gy,gz)=>{const elapsed=timestamp-ctx.lastGyroTime;ctx.lastGyroTime=timestamp;gx=gx*ctx.gyroConstant+ctx.gyroXError;gy=gy*ctx.gyroConstant+ctx.gyroYError;gz=gz*ctx.gyroConstant+ctx.gyroZError;ctx.gyroXAngle+=gx*elapsed;ctx.gyroYAngle+=gy*elapsed;ctx.gyroZAngle+=gz*elapsed;return{gx,gy,gz,roll:ctx.gyroXAngle,pitch:ctx.gyroYAngle,yaw:ctx.gyroZAngle}};let res;if(Array.isArray(data.timestamp)){res=data.timestamp.map((v,i)=>{if(result){let r=gpass(v,data.gx[i],data.gy[i],data.gz[i]);result.roll=result.roll*.04+r.roll*.96;result.pitch=result.pitch*.04+r.pitch*.96;result.yaw=res.yaw}else return gpass(v,data.gx[i],data.gy[i],data.gz[i])});if(!result)result=res}else{res=gpass(data.timestamp,data.gx,data.gy,data.gz);if(result){result.roll=result.roll*.04+res.roll*.96;result.pitch=result.pitch*.04+res.pitch*.96;result.yaw=res.yaw}else result=res}}else if(ctx.gyroXAngle||ctx.gyroYAngle||ctx.gyroZAngle){result.roll=result.roll*.04+ctx.gyroXAngle*.96;result.pitch=result.pitch*.04+ctx.gyroYAngle*.96;result.yaw=ctx.gyroXAngle}if(result.ax){const setPositionOffset=(timestamp,result2)=>{const elapsed=timestamp-ctx.lastAccelTime;ctx.lastAccelTime=timestamp;ctx.px+=result2.ax*elapsed*elapsed*Math.cos(ctx.pitch*Math.PI*.005555555555);ctx.py+=result2.ay*elapsed*elapsed*Math.cos(ctx.roll*Math.PI*.005555555555);ctx.pz+=result2.az*elapsed*elapsed*Math.sin(ctx.pitch*Math.PI*.005555555555);result2.px=ctx.px;result2.py=ctx.py;result2.pz=ctx.pz;return result2};if(Array.isArray(data.timestamp)){data.timestamp.map((timestamp,i)=>{setPositionOffset(timestamp,result)})}else{setPositionOffset(data.timestamp,result)}}return result}};var algorithms={beat_detect,accel_gyro,heartrate:beat_detect,breath:beat_detect};algorithms["breath"].structs=Object.assign({},algorithms["breath"].structs);algorithms["breath"].structs.maqFreq=1/3;function createAlgorithmContext(options,inputs){let ctx={_id:options._id?options._id:`algorithm${Math.floor(Math.random()*1e15)}`,ondata:options.ondata,run:data=>{return ctx.ondata(ctx,data)}};if(options.structs)recursivelyAssign(ctx,JSON.parse(JSON.stringify(options.structs)));if(inputs)recursivelyAssign(ctx,JSON.parse(JSON.stringify(options.structs)));return ctx}var recursivelyAssign=(target,obj)=>{for(const key in obj){if(typeof obj[key]==="object"){if(typeof target[key]==="object")recursivelyAssign(target[key],obj[key]);else target[key]=recursivelyAssign({},obj[key])}else target[key]=obj[key]}return target};if(typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope){globalThis.WebSerial=WebSerial;globalThis.decoders=decoders;globalThis.decoder="raw";globalThis.bitflippin=bitflippin;globalThis.devices=Devices;globalThis.filtering=true;globalThis.filters={};globalThis.BiquadChannelFilterer=BiquadChannelFilterer;globalThis.ArrayManip=ArrayManip;const worker=new WorkerService({routes:[workerCanvasRoutes,unsafeRoutes,{"receiveDecoder":function receiveDecoder(decoder,decoderName){globalThis.decoders[decoderName]=(0,eval)("("+decoder+")")},"receiveCodec":function receiveDeviceCodec(decoder,deviceType,device,service,characteristic){let codec=parseFunctionFromText(decoder);if(codec){if(deviceType==="BLE"&&service&&characteristic){if(Devices[deviceType][device]){if(Devices[deviceType][device][service]){if(Devices[deviceType][device][characteristic]){Devices[deviceType][device][characteristic].codec=codec}else{Devices[deviceType][device][characteristic]={codec}}}else{Devices[deviceType][device]={[characteristic]:{codec}}}}}else if(Devices[deviceType][device]?.codec){if(Devices[deviceType][device])Devices[deviceType][device].codec=codec;else{Devices[deviceType][device]={codec}}}}},"decode":function decode(data){return globalThis.decoder(data)},"decodeAndParse":function decodeAndParse(data){let decoded=this.graph.run("decode",data);if(decoded){let parsed=globalThis.ArrayManip.reformatData(decoded);if(parsed){if(globalThis.filtering){for(const prop in parsed){if(globalThis.filters[prop]){let filter=globalThis.filters[prop];if(Array.isArray(parsed[prop])){parsed[prop]=parsed[prop].map(v=>filter.apply(v))}else if(parsed[prop]?.values){parsed[prop].values=parsed[prop].values.map(v=>filter.apply(v))}}}}return parsed}}return decoded},"setActiveDecoder":function setActiveDecoder(deviceType,device,service,characteristic){if(Devices[deviceType][device]?.codec)globalThis.decoder=Devices[deviceType][device]?.codec;else if(deviceType==="BLE"&&service&&characteristic&&Devices[deviceType][device]?.[service]?.[characteristic]?.codec)globalThis.decoder=Devices[deviceType][device][service][characteristic].codec;return true},"decodeDevice":function decodeDevice(data,deviceType,device,service,characteristic){if(Devices[deviceType][device]?.codec)return Devices[deviceType][device].codec(data);else if(deviceType==="BLE"&&service&&characteristic&&Devices[deviceType][device]?.[service]?.[characteristic]?.codec)return Devices[deviceType][device][service][characteristic].codec(data)},"decodeAndParseDevice":function decodeAndParseDevice(data,deviceType,deviceName,service,characteristic){let decoded;if(deviceType==="BLE"&&service&&characteristic&&Devices[deviceType][deviceName]?.services[service]?.[characteristic]?.codec)decoded=Devices[deviceType][deviceName].services[service][characteristic].codec(data);else if(Devices[deviceType][deviceName]?.codec)decoded=Devices[deviceType][deviceName].codec(data);else decoded=data;if(decoded){let parsed=globalThis.ArrayManip.reformatData(decoded);if(parsed){if(globalThis.filtering){for(const prop in parsed){if(globalThis.filters[prop]){let filter=globalThis.filters[prop];if(Array.isArray(parsed[prop])){parsed[prop]=parsed[prop].map(v=>filter.apply(v))}else if(parsed[prop]?.values){parsed[prop].values=parsed[prop].values.map(v=>filter.apply(v))}}}}return parsed}}return decoded},"toggleAnim":function toggleAnim(){globalThis.runningAnim=!globalThis.runningAnim;return globalThis.runningAnim},"setFilter":function setFilters(filters,clearFilters=false){if(!globalThis.filters||clearFilters)globalThis.filters={};for(const key in filters){globalThis.filters[key]=new BiquadChannelFilterer(filters[key])}return true},"getFilterSettings":function getFilterSettings(){if(globalThis.filters){let filters={};for(const key in globalThis.filters){filters[key]={sps:globalThis.filters[key].sps,useScaling:globalThis.filters[key].useScaling,scalar:globalThis.filters[key].scalar,useNotch50:globalThis.filters[key].useNotch50,useNotch60:globalThis.filters[key].useNotch60,useDCBlock:globalThis.filters[key].useDCBlock,useLowpass:globalThis.filters[key].useLowpass,lowpassHz:globalThis.filters[key].lowpassHz,useBandpass:globalThis.filters[key].useBandpass,bandpassLower:globalThis.filters[key].bandpassLower,bandpassUpper:globalThis.filters[key].bandpassUpper}}return filters}return void 0},"setupSerial":function setupSerial(){globalThis.Serial=new globalThis.WebSerial;globalThis.decoder="raw";console.log("worker: Setting up Serial",globalThis.Serial);return true},"openPort":function openPort(settings){const WorkerService2=this.graph;if(!globalThis.Serial)WorkerService2.run("setupSerial");return new Promise((res,rej)=>{globalThis.Serial.getPorts().then(ports=>{const Serial=globalThis.Serial;let port=ports.find(port2=>{return port2.getInfo().usbVendorId===settings.usbVendorId&&port2.getInfo().usbProductId===settings.usbProductId});if(port){Serial.openPort(port,settings).then(()=>{const stream=Serial.createStream({port,frequency:settings.frequency?settings.frequency:10,buffering:settings.buffering,ondata:value=>{if(stream.settings.pipeTo){if(typeof stream.settings.pipeTo==="string")WorkerService2.transmit(value,stream.settings.pipeTo,[value.buffer]);else if(stream.settings.pipeTo?.route){let args=value;if(stream.settings.pipeTo.extraArgs)args=[value,...stream.settings.pipeTo.extraArgs];WorkerService2.transmit({route:stream.settings.pipeTo.route,args},stream.settings.pipeTo._id,[value.buffer])}}else{WorkerService2.transmit(value,void 0,[value.buffer])}}});stream.settings=settings;Serial.readStream(stream);port.ondisconnect=()=>{postMessage(`${stream._id} disconnected`)};res({_id:stream._id,settings,info:stream.info})})}else{rej(false)}})})},"closeStream":function closeStream(streamId){return new Promise((res,rej)=>{const Serial=globalThis.Serial;Serial.closeStream(Serial.streams[streamId]).then(resolved=>{res(resolved)}).catch(rej)})},"writeStream":function writeStream(streamId,message){globalThis.Serial.writeStream(globalThis.Serial.streams[streamId],message);return true},"updateStreamSettings":function updateStreamSettings(streamId,settings){if(globalThis.Serial?.streams[streamId]){for(const key in settings){if(typeof settings[key]==="object"){Object.assign(globalThis.Serial.streams[streamId].settings[key],settings[key])}else globalThis.Serial.streams[streamId][key]=settings[key]}}},"createAlgorithmContext":function creatalg(options,inputs){if(!this.graph.ALGORITHMS)this.graph.ALGORITHMS={};if(typeof options==="string"){options=algorithms[options]}if(typeof options.ondata==="string")options.ondata=parseFunctionFromText(options.ondata);let ctx;if(typeof options?.ondata==="function")ctx=createAlgorithmContext(options,inputs);if(ctx)this.graph.ALGORITHMS[ctx._id]=ctx;return ctx?._id},"runAlgorithm":function runAlgorithm(data,_id){if(!this.graph.ALGORITHMS)this.graph.ALGORITHMS={};if(!_id)_id=Object.keys(this.graph.ALGORITHMS)[0];let res=this.graph.ALGORITHMS[_id].run(data);if(res!==void 0)this.graph.setState({[_id]:res});return res}}],includeClassName:false})}var stream_worker_default=self;})();\n')],{type:"text/javascript"}));var stream_worker_default=url;var rechk=/^([<>])?(([1-9]\d*)?([xcbB?hHiIfdsp]))*$/;var refmt=/([1-9]\d*)?([xcbB?hHiIfdsp])/g;var str=(v,o,c)=>String.fromCharCode(...new Uint8Array(v.buffer,v.byteOffset+o,c));var rts=(v,o,c,s)=>new Uint8Array(v.buffer,v.byteOffset+o,c).set(s.split("").map(str2=>str2.charCodeAt(0)));var pst=(v,o,c)=>str(v,o+1,Math.min(v.getUint8(o),c-1));var tsp=(v,o,c,s)=>{v.setUint8(o,s.length);rts(v,o+1,c-1,s)};var lut=le=>({x:c=>[1,c,0],c:c=>[c,1,o=>({u:v=>str(v,o,1),p:(v,c2)=>rts(v,o,1,c2)})],"?":c=>[c,1,o=>({u:v=>Boolean(v.getUint8(o)),p:(v,B)=>v.setUint8(o,B)})],b:c=>[c,1,o=>({u:v=>v.getInt8(o),p:(v,b)=>v.setInt8(o,b)})],B:c=>[c,1,o=>({u:v=>v.getUint8(o),p:(v,B)=>v.setUint8(o,B)})],h:c=>[c,2,o=>({u:v=>v.getInt16(o,le),p:(v,h)=>v.setInt16(o,h,le)})],H:c=>[c,2,o=>({u:v=>v.getUint16(o,le),p:(v,H)=>v.setUint16(o,H,le)})],i:c=>[c,4,o=>({u:v=>v.getInt32(o,le),p:(v,i)=>v.setInt32(o,i,le)})],I:c=>[c,4,o=>({u:v=>v.getUint32(o,le),p:(v,I)=>v.setUint32(o,I,le)})],f:c=>[c,4,o=>({u:v=>v.getFloat32(o,le),p:(v,f)=>v.setFloat32(o,f,le)})],d:c=>[c,8,o=>({u:v=>v.getFloat64(o,le),p:(v,d)=>v.setFloat64(o,d,le)})],s:c=>[1,c,o=>({u:v=>str(v,o,c),p:(v,s)=>rts(v,o,c,s.slice(0,c))})],p:c=>[1,c,o=>({u:v=>pst(v,o,c),p:(v,s)=>tsp(v,o,c,s.slice(0,c-1))})]});var errbuf=new RangeError("Structure larger than remaining buffer");var errval=new RangeError("Not enough values for structure");var _bitflippin=class{static toDataView(value){if(!(value instanceof DataView)){if(typeof value==="string"&&parseInt(value))value=parseInt(value);if(typeof value==="string"){let enc=new TextEncoder;let hascodes={};for(const code in _bitflippin.codes){while(value.indexOf(code)>-1){let idx=value.indexOf(code);value=value.replace(code,"");hascodes[idx]=code}}let encoded=Array.from(enc.encode(value));for(const key in hascodes){encoded.splice(parseInt(key),0,_bitflippin.codes[hascodes[key]])}value=new DataView(new Uint8Array(encoded).buffer)}else if(typeof value==="number"){let tmp=value;if(value<256){value=new DataView(new ArrayBuffer(1));value.setUint8(0,tmp)}else if(value<65536){value=new DataView(new ArrayBuffer(2));value.setInt16(0,tmp)}else{value=new DataView(new ArrayBuffer(4));value.setUint32(0,tmp)}}else if(value instanceof ArrayBuffer||typeof SharedArrayBuffer!=="undefined"&&value instanceof SharedArrayBuffer){value=new DataView(value)}else if(Array.isArray(value)){value=new DataView(Uint8Array.from(value).buffer)}else if(typeof value==="object"){value=new TextEncoder().encode(JSON.stringify(value))}}return value}static searchBuffer(buffer,searchString,limit){var needle=searchString;var haystack=buffer;var search=_bitflippin.boyerMoore(needle);var skip=search.byteLength;var indices=[];for(var i=search(haystack);i!==-1;i=search(haystack,i+skip)){indices.push(i);if(limit){if(indices.length>=limit)break}}return indices}static genTimestamps(ct,sps11){let now=Date.now();let toInterp=[now-ct*1e3/sps11,now];return _bitflippin.upsample(toInterp,ct)}static absmax(array){return Math.max(Math.abs(Math.min(...array)),Math.max(...array))}static downsample(array,fitCount,scalar=1){if(array.length>fitCount){let output=new Array(fitCount);let incr=array.length/fitCount;let lastIdx=array.length-1;let last=0;let counter=0;for(let i=incr;i<array.length;i+=incr){let rounded=Math.round(i);if(rounded>lastIdx)rounded=lastIdx;for(let j=last;j<rounded;j++){output[counter]+=array[j]}output[counter]/=(rounded-last)*scalar;counter++;last=rounded}return output}else return array}static upsample(array,fitCount,scalar=1){var linearInterpolate=function(before2,after2,atPoint2){return(before2+(after2-before2)*atPoint2)*scalar};var newData=new Array(fitCount);var springFactor=(array.length-1)/(fitCount-1);newData[0]=array[0];for(var i=1;i<fitCount-1;i++){var tmp=i*springFactor;var before=Math.floor(tmp);var after=Math.ceil(tmp);var atPoint=tmp-before;newData[i]=linearInterpolate(array[before],array[after],atPoint)}newData[fitCount-1]=array[array.length-1];return newData}static interpolate(array,fitCount,scalar=1){if(array.length>fitCount){return _bitflippin.downsample(array,fitCount,scalar)}else if(array.length<fitCount){return _bitflippin.upsample(array,fitCount,scalar)}return array}static bytesToInt16(x0,x1){let int16=(255&x0)<<8|255&x1;if((int16&32768)>0){int16|=4294901760}else{int16&=65535}return int16}static bytesToUInt16(x0,x1){return x0*256+x1}static Uint16ToBytes(y){return[y&255,y>>8&255]}static bytesToInt24(x0,x1,x2){let int24=(255&x0)<<16|(255&x1)<<8|255&x2;if((int24&8388608)>0){int24|=4278190080}else{int24&=16777215}return int24}static bytesToUInt24(x0,x1,x2){return x0*65536+x1*256+x2}static Uint24ToBytes(y){return[y&255,y>>8&255,y>>16&255]}static bytesToInt32(x0,x1,x2,x3){let int32=(255&x0)<<24|(255&x1)<<16|(255&x2)<<8|255&x3;if((int32&2147483648)>0){int32|=0}else{int32&=4294967295}return int32}static bytesToUInt32(x0,x1,x2,x3){return x0*16777216+x1*65536+x2*256+x3}static Uint32ToBytes(y){return[y&255,y>>8&255,y>>16&255,y>>24&255]}static get2sCompliment(val,nbits2){if(val>4294967296)return null;return val<<32-nbits2>>32-nbits2}static getSignedInt(...args){let pos=0;function getInt(size){var value=0;var first=true;while(size--){if(first){let byte=args[pos++];value+=byte&127;if(byte&128){value-=128}first=false}else{value*=256;value+=args[pos++]}}return value}return getInt(args.length)}static asUint8Array(input){if(input instanceof Uint8Array){return input}else if(typeof input==="string"){var arr=new Uint8Array(input.length);for(var i=0;i<input.length;i++){var c=input.charCodeAt(i);if(c>127){throw new TypeError("Only ASCII patterns are supported")}arr[i]=c}return arr}else{return new Uint8Array(input)}}static boyerMoore(patternBuffer){var pattern=_bitflippin.asUint8Array(patternBuffer);var M=pattern.length;if(M===0){throw new TypeError("patternBuffer must be at least 1 byte long")}var R=256;var rightmost_positions=new Int32Array(R);for(var c=0;c<R;c++){rightmost_positions[c]=-1}for(var j=0;j<M;j++){rightmost_positions[pattern[j]]=j}var boyerMooreSearch=(txtBuffer,start,end)=>{var txt=_bitflippin.asUint8Array(txtBuffer);if(start===void 0)start=0;if(end===void 0)end=txt.length;var pat=pattern;var right=rightmost_positions;var lastIndex=end-pat.length;var lastPatIndex=pat.length-1;var skip;for(var i=start;i<=lastIndex;i+=skip){skip=0;for(var j2=lastPatIndex;j2>=0;j2--){var c2=txt[i+j2];if(pat[j2]!==c2){skip=Math.max(1,j2-right[c2]);break}}if(skip===0){return i}}return-1};boyerMooreSearch.byteLength=pattern.byteLength;return boyerMooreSearch}static struct(format){let fns=[],size=0,m=rechk.exec(format);if(!m){throw new RangeError("Invalid format string")}const t=lut("<"===m[1]),lu=(n,c)=>t[c](n?parseInt(n,10):1);while(m=refmt.exec(format)){((r,s,f)=>{for(let i=0;i<r;++i,size+=s){if(f){fns.push(f(size))}}})(...lu(...m.slice(1)))}const unpack_from=(arrb,offs)=>{if(arrb.byteLength<(offs|0)+size){throw errbuf}let v=new DataView(arrb,offs|0);return fns.map(f=>f.u(v))};const pack_into=(arrb,offs,...values)=>{if(values.length<fns.length){throw errval}if(arrb.byteLength<offs+size){throw errbuf}const v=new DataView(arrb,offs);new Uint8Array(arrb,offs,size).fill(0);fns.forEach((f,i)=>f.p(v,values[i]))};const pack=(...values)=>{let b=new ArrayBuffer(size);pack_into(b,0,...values);return b};const unpack=arrb=>unpack_from(arrb,0);function*iter_unpack(arrb){for(let offs=0;offs+size<=arrb.byteLength;offs+=size){yield unpack_from(arrb,offs)}}return Object.freeze({unpack,pack,unpack_from,pack_into,iter_unpack,format,size})}};var bitflippin=_bitflippin;bitflippin.codes={"\\n":10,"\\r":13,"\\t":9,"\\s":32,"\\b":8,"\\f":12,"\\":92};var ScanMode;(function(ScanMode2){ScanMode2[ScanMode2["SCAN_MODE_LOW_POWER"]=0]="SCAN_MODE_LOW_POWER";ScanMode2[ScanMode2["SCAN_MODE_BALANCED"]=1]="SCAN_MODE_BALANCED";ScanMode2[ScanMode2["SCAN_MODE_LOW_LATENCY"]=2]="SCAN_MODE_LOW_LATENCY"})(ScanMode||(ScanMode={}));init_dist();init_conversion();init_dist();var BluetoothLe=registerPlugin("BluetoothLe",{web:()=>Promise.resolve().then(()=>(init_web(),web_exports)).then(m=>new m.BluetoothLeWeb)});var import_throat=__toESM(require_throat());function getQueue(enabled){if(enabled){return(0,import_throat.default)(1)}else{return fn=>fn()}}function validateUUID(uuid){if(typeof uuid!=="string"){throw new Error(`Invalid UUID type ${typeof uuid}. Expected string.`)}uuid=uuid.toLowerCase();const is128BitUuid=uuid.search(/^[0-9a-f]{8}\b-[0-9a-f]{4}\b-[0-9a-f]{4}\b-[0-9a-f]{4}\b-[0-9a-f]{12}$/)>=0;if(!is128BitUuid){throw new Error(`Invalid UUID format ${uuid}. Expected 128 bit string (e.g. "0000180d-0000-1000-8000-00805f9b34fb").`)}return uuid}var BleClientClass=class{constructor(){this.scanListener=null;this.eventListeners=new Map;this.queue=getQueue(true)}enableQueue(){this.queue=getQueue(true)}disableQueue(){this.queue=getQueue(false)}async initialize(options){await this.queue(async()=>{await BluetoothLe.initialize(options)})}async getEnabled(){return this.isEnabled()}async isEnabled(){const enabled=await this.queue(async()=>{const result=await BluetoothLe.isEnabled();return result.value});return enabled}async enable(){await this.queue(async()=>{await BluetoothLe.enable()})}async disable(){await this.queue(async()=>{await BluetoothLe.disable()})}async startEnabledNotifications(callback){await this.queue(async()=>{var _a;const key=`onEnabledChanged`;await((_a=this.eventListeners.get(key))===null||_a===void 0?void 0:_a.remove());const listener=await BluetoothLe.addListener(key,result=>{callback(result.value)});this.eventListeners.set(key,listener);await BluetoothLe.startEnabledNotifications()})}async stopEnabledNotifications(){await this.queue(async()=>{var _a;const key=`onEnabledChanged`;await((_a=this.eventListeners.get(key))===null||_a===void 0?void 0:_a.remove());this.eventListeners.delete(key);await BluetoothLe.stopEnabledNotifications()})}async isLocationEnabled(){const enabled=await this.queue(async()=>{const result=await BluetoothLe.isLocationEnabled();return result.value});return enabled}async openLocationSettings(){await this.queue(async()=>{await BluetoothLe.openLocationSettings()})}async openBluetoothSettings(){await this.queue(async()=>{await BluetoothLe.openBluetoothSettings()})}async openAppSettings(){await this.queue(async()=>{await BluetoothLe.openAppSettings()})}async setDisplayStrings(displayStrings){await this.queue(async()=>{await BluetoothLe.setDisplayStrings(displayStrings)})}async requestDevice(options){const result=await this.queue(async()=>{const device=await BluetoothLe.requestDevice(options);return device});return result}async requestLEScan(options,callback){await this.queue(async()=>{var _a;await((_a=this.scanListener)===null||_a===void 0?void 0:_a.remove());this.scanListener=await BluetoothLe.addListener("onScanResult",resultInternal=>{const result=Object.assign(Object.assign({},resultInternal),{manufacturerData:this.convertObject(resultInternal.manufacturerData),serviceData:this.convertObject(resultInternal.serviceData),rawAdvertisement:resultInternal.rawAdvertisement?this.convertValue(resultInternal.rawAdvertisement):void 0});callback(result)});await BluetoothLe.requestLEScan(options)})}async stopLEScan(){await this.queue(async()=>{var _a;await((_a=this.scanListener)===null||_a===void 0?void 0:_a.remove());this.scanListener=null;await BluetoothLe.stopLEScan()})}async getDevices(deviceIds){return this.queue(async()=>{const result=await BluetoothLe.getDevices({deviceIds});return result.devices})}async getConnectedDevices(services){return this.queue(async()=>{const result=await BluetoothLe.getConnectedDevices({services});return result.devices})}async connect(deviceId,onDisconnect,options){await this.queue(async()=>{var _a;if(onDisconnect){const key=`disconnected|${deviceId}`;await((_a=this.eventListeners.get(key))===null||_a===void 0?void 0:_a.remove());const listener=await BluetoothLe.addListener(key,()=>{onDisconnect(deviceId)});this.eventListeners.set(key,listener)}await BluetoothLe.connect(Object.assign({deviceId},options))})}async createBond(deviceId){await this.queue(async()=>{await BluetoothLe.createBond({deviceId})})}async isBonded(deviceId){const isBonded=await this.queue(async()=>{const result=await BluetoothLe.isBonded({deviceId});return result.value});return isBonded}async disconnect(deviceId){await this.queue(async()=>{await BluetoothLe.disconnect({deviceId})})}async getServices(deviceId){const services=await this.queue(async()=>{const result=await BluetoothLe.getServices({deviceId});return result.services});return services}async readRssi(deviceId){const value=await this.queue(async()=>{const result=await BluetoothLe.readRssi({deviceId});return parseFloat(result.value)});return value}async read(deviceId,service,characteristic,options){service=validateUUID(service);characteristic=validateUUID(characteristic);const value=await this.queue(async()=>{const result=await BluetoothLe.read(Object.assign({deviceId,service,characteristic},options));return this.convertValue(result.value)});return value}async write(deviceId,service,characteristic,value,options){service=validateUUID(service);characteristic=validateUUID(characteristic);return this.queue(async()=>{if(!(value===null||value===void 0?void 0:value.buffer)){throw new Error("Invalid data.")}let writeValue=value;if(Capacitor.getPlatform()!=="web"){writeValue=dataViewToHexString(value)}await BluetoothLe.write(Object.assign({deviceId,service,characteristic,value:writeValue},options))})}async writeWithoutResponse(deviceId,service,characteristic,value,options){service=validateUUID(service);characteristic=validateUUID(characteristic);await this.queue(async()=>{if(!(value===null||value===void 0?void 0:value.buffer)){throw new Error("Invalid data.")}let writeValue=value;if(Capacitor.getPlatform()!=="web"){writeValue=dataViewToHexString(value)}await BluetoothLe.writeWithoutResponse(Object.assign({deviceId,service,characteristic,value:writeValue},options))})}async readDescriptor(deviceId,service,characteristic,descriptor,options){service=validateUUID(service);characteristic=validateUUID(characteristic);descriptor=validateUUID(descriptor);const value=await this.queue(async()=>{const result=await BluetoothLe.readDescriptor(Object.assign({deviceId,service,characteristic,descriptor},options));return this.convertValue(result.value)});return value}async writeDescriptor(deviceId,service,characteristic,descriptor,value,options){service=validateUUID(service);characteristic=validateUUID(characteristic);descriptor=validateUUID(descriptor);return this.queue(async()=>{if(!(value===null||value===void 0?void 0:value.buffer)){throw new Error("Invalid data.")}let writeValue=value;if(Capacitor.getPlatform()!=="web"){writeValue=dataViewToHexString(value)}await BluetoothLe.writeDescriptor(Object.assign({deviceId,service,characteristic,descriptor,value:writeValue},options))})}async startNotifications(deviceId,service,characteristic,callback){service=validateUUID(service);characteristic=validateUUID(characteristic);await this.queue(async()=>{var _a;const key=`notification|${deviceId}|${service}|${characteristic}`;await((_a=this.eventListeners.get(key))===null||_a===void 0?void 0:_a.remove());const listener=await BluetoothLe.addListener(key,event=>{callback(this.convertValue(event===null||event===void 0?void 0:event.value))});this.eventListeners.set(key,listener);await BluetoothLe.startNotifications({deviceId,service,characteristic})})}async stopNotifications(deviceId,service,characteristic){service=validateUUID(service);characteristic=validateUUID(characteristic);await this.queue(async()=>{var _a;const key=`notification|${deviceId}|${service}|${characteristic}`;await((_a=this.eventListeners.get(key))===null||_a===void 0?void 0:_a.remove());this.eventListeners.delete(key);await BluetoothLe.stopNotifications({deviceId,service,characteristic})})}convertValue(value){if(typeof value==="string"){return hexStringToDataView(value)}else if(value===void 0){return new DataView(new ArrayBuffer(0))}return value}convertObject(obj){if(obj===void 0){return void 0}const result={};for(const key of Object.keys(obj)){result[key]=this.convertValue(obj[key])}return result}};var BleClient=new BleClientClass;init_conversion();var BLEClient=class extends bitflippin{constructor(options,location){super();this.client=BleClient;this.devices={};this.location=false;this.initialized=false;this.setupDevice=(device,options)=>{return new Promise(async(res,rej)=>{this.devices[device.deviceId]={device,deviceId:device.deviceId,...options};this.client.connect(device.deviceId,deviceId=>{if(this.devices[device.deviceId]?.ondisconnect)this.devices[device.deviceId].ondisconnect(deviceId)},options?.connectOptions).then(async()=>{let services=await this.getServices(device.deviceId);for(const service in options?.services){let svc=services.find(o=>{if(o.uuid===service)return true});if(svc)for(const characteristic in options.services[service]){if(!svc.characteristics.find(o=>{if(o.uuid===characteristic)return true}))continue;let opt=options.services[service][characteristic];if(opt.write){await this.write(device,service,characteristic,opt.write,opt.writeCallback,opt.writeOptions)}if(opt.read){await this.read(device,service,characteristic,opt.readCallback,opt.readOptions)}if(opt.notify&&opt.notifyCallback){await this.subscribe(device,service,characteristic,opt.notifyCallback);opt.notifying=true}}}}).catch(rej);res(this.devices[device.deviceId])})};this.triangulate=(device,duration=1500,sampleRate=60)=>{return new Promise((res,rej)=>{if("Accelerometer"in globalThis){if(typeof globalThis.Accelerometer==="function"){let acl=new globalThis.Accelerometer({frequency:sampleRate});let start=performance.now();let now=start;let result={samples:[],vector:{}};let onread=()=>{if(now-start<duration){this.readRssi(device).then(rssi=>{let x=acl.x;let y=acl.y;let z=acl.z;now=performance.now();result.samples.push({x,y,z,rssi,timestamp:now})})}else{let vector={x:0,y:0,z:0,rssiAvg:0};result.samples.forEach(s=>{});acl.removeEventListener("reading",onread)}};acl.addEventListener("reading",onread)}}else rej(new Error("No Accelerometer API detected"))})};if(location)this.location=location;if(options){this.setup(options)}}setup(options,location=this.location){let services=[];if(options){for(const serviceuuid in options.services){services.push(serviceuuid)}}let opts={};if(!location)opts.androidNeverForLocation=false;return new Promise(async(res,rej)=>{if(!this.initialized){await this.client.initialize(opts);this.initialized=true}if(options?.deviceId){this.reconnect(options.deviceId).then(device=>{res(this.setupDevice(device,options))}).catch(rej)}else{if(options){let deviceRequest={filters:[{services}],optionalServices:services};if(options?.namePrefix)deviceRequest.filters.push({namePrefix:options.namePrefix});this.client.requestDevice(deviceRequest).then(device=>{res(this.setupDevice(device,options))}).catch(rej)}else{this.client.requestDevice().then(device=>{res(this.setupDevice(device,options))}).catch(rej)}}})}initialize(options){return new Promise((res,rej)=>{this.client.initialize(options).then(()=>{res(true)}).catch(rej)})}requestDevice(request,options){return new Promise((res,rej)=>{this.client.requestDevice(request).then(device=>{this.devices[device.deviceId]={device,deviceId:device.deviceId,...options};res(device)}).catch(rej)})}getServices(deviceId){return this.client.getServices(deviceId)}connect(device,options){return new Promise((res,rej)=>{this.client.connect(device.deviceId,deviceId=>{if(options?.ondisconnect)options.ondisconnect(deviceId)},options?.connectOptions).then(connected=>{res(device)}).catch(rej)})}reconnect(deviceId){return new Promise((res,rej)=>{this.client.getDevices([deviceId]).then(devices=>{res(devices[0])}).catch(rej)})}disconnect(device){if(typeof device==="object")device=device.deviceId;delete this.devices[device];return this.client.disconnect(device)}write(device,service,characteristic,value,callback,options){if(typeof device==="object")device=device.deviceId;if(callback){return this.client.write(device,service,characteristic,BLEClient.toDataView(value)).then(callback)}else return this.client.writeWithoutResponse(device,service,characteristic,BLEClient.toDataView(value),options)}read(device,service,characteristic,ondata,options){if(typeof device==="object")device=device.deviceId;if(ondata)return this.client.read(device,service,characteristic,options).then(ondata);else return this.client.read(device,service,characteristic,options)}subscribe(device,service,characteristic,ondata){if(typeof device==="object")device=device.deviceId;return this.client.startNotifications(device,service,characteristic,ondata)}unsubscribe(device,service,characteristic){if(typeof device==="object")device=device.deviceId;return this.client.stopNotifications(device,service,characteristic)}scan(options,callback){return this.client.requestLEScan(options,callback)}stopScanning(){return this.client.stopLEScan()}readDescriptor(device,service,characteristic,descriptor,options){return this.client.readDescriptor(device.deviceId,service,characteristic,descriptor,options)}writeDescriptor(device,service,characteristic,descriptor,value,options){return this.client.writeDescriptor(device.deviceId,service,characteristic,descriptor,BLEClient.toDataView(value),options)}readRssi(device){return this.client.readRssi(device.deviceId)}async distance(device,txPower,x,exp,c){let rssi=await this.readRssi(device);if(rssi==0)return void 0;let ratio=rssi/txPower;if(ratio<1){return Math.pow(ratio,10)}else{return x*Math.pow(ratio,exp)+c}}async distanceFromPhone(device,txPower,model){let x,exp,c;if(model){if(model==="nexus5"){x=.42093;exp=6.9476;c=.54992}else if(model==="motoX"){x=.9401940951;exp=6.170094565;c=0}else if(model==="iphone5"){x=.89976;exp=7.7095;c=.111}}return await this.distance(device,txPower,x,exp,c)}};var WebSerial=class extends bitflippin{constructor(){super(...arguments);this.streams={};this.createStream=options=>{let stream={_id:options._id?options._id:`stream${Math.floor(Math.random()*1e15)}`,info:options.port.getInfo(),running:false,...options};if(options.port?.readable){if(options.transforms){stream.reader=WebSerial.setStreamTransforms(options.port.readable,options.transforms).getReader()}else{stream.reader=options.port.readable.getReader()}}this.streams[stream._id]=stream;return stream}}getPorts(){return navigator.serial.getPorts()}requestPort(usbVendorId,usbProductId){let options={};if(usbVendorId){options.usbVendorId=usbVendorId}if(usbProductId){options.usbProductId=usbProductId}if(options.usbVendorId)return navigator.serial.requestPort({filters:[options]});else return navigator.serial.requestPort()}openPort(port,options){if(options)options=Object.assign({},options);if(options?.ondisconnect){port.ondisconnect=options.ondisconnect;delete options.ondisconnect}return port.open(options).then(()=>{if(options?.onconnect)options.onconnect(port)})}async readWithTimeout(port,timeout){const reader=port.readable.getReader();const timer=setTimeout(()=>{reader.releaseLock()},timeout);const result=await reader.read();clearTimeout(timer);reader.releaseLock();return result}async writePort(port,message){const writer=port.writable.getWriter();await writer.write(WebSerial.toDataView(message));writer.releaseLock();return true}getSignals(port){return port.getSignals()}setSignals(port,signals){return port.setSignals(signals)}readStream(stream){if(stream.reader&&!stream.running){let reader=stream.reader;if(stream.buffering){if(typeof stream.buffering!=="object")stream.buffering={};if(!stream.buffering.buffer){stream.buffering.buffer=[]}if(!stream.buffering.searchBytes)stream.buffering.searchBytes=new Uint8Array([13,10])}let readLoop=()=>{if(stream.port.readable&&stream.running){reader.read().then(result=>{if(result.done)reader.releaseLock();else{if(stream.buffering){stream.buffering.buffer.push(...result.value);const needle=stream.buffering.searchBytes;const haystack=stream.buffering.buffer;const search=WebSerial.boyerMoore(needle);const skip=search.byteLength;let nextIndex=-1;for(var i=search(haystack);i!==-1;i=search(haystack,i+skip)){if(!stream.buffering.locked&&!("lockIdx"in stream.buffering))stream.buffering.lockIdx=i;else{nextIndex=i;if(nextIndex>=0){if(!stream.buffering.locked){stream.ondata(new Uint8Array(stream.buffering.buffer.splice(stream.buffering.lockIdx+stream.buffering.searchBytes.length,nextIndex+stream.buffering.searchBytes.length)));stream.buffering.buffer.splice(0,stream.buffering.searchBytes.length);stream.buffering.locked=true}else if(nextIndex>0){stream.ondata(new Uint8Array(stream.buffering.buffer.splice(stream.buffering.searchBytes.length,nextIndex)))}}}}}else stream.ondata(result.value);setTimeout(()=>{readLoop()},stream.frequency)}})}else if(!stream.running&&stream.port.readable){try{reader.releaseLock()}catch(er){console.error(er)}}};stream.running=true;readLoop();return stream}return void 0}writeStream(stream,message){if(typeof stream==="string")stream=this.streams[stream];if(stream.port.writable){let writer=stream.port.writable.getWriter();writer.write(WebSerial.toDataView(message));writer.releaseLock();return true}return void 0}closeStream(stream,onclose){if(typeof stream==="string")stream=this.streams[stream];stream.running=false;return new Promise((res,rej)=>{setTimeout(async()=>{if(stream.port.readable&&stream.reader){try{stream.reader.releaseLock();try{await stream.reader.cancel()}catch(err){}}catch(er){console.error(er)}}try{await stream.port.close().then(()=>{if(onclose)onclose(this.streams[stream._id])})}catch(er){rej(er)}delete this.streams[stream._id];res(true)},300)})}static setStreamTransforms(stream,transforms){let transform=[];Object.keys(transforms).forEach(t=>{let opt=transforms[t];if(opt instanceof TransformStream){transform.push(opt)}else{if(!opt.start)opt.start=function start(){};if(!opt.flush)opt.flush=function flush(){};let transformer=new TransformStream({start:opt.start,transform:opt.transform,flush:opt.flush},opt.writableStrategy,opt.readableStrategy);transform.push(transformer)}});let str2=stream;transform.forEach(transform2=>{str2=str2.pipeThrough(transform2)});return str2}};function ads131m08codec(data){let arr;if(data.getInt8)arr=new Uint8Array(data.buffer);else if(!data.buffer)arr=new Uint8Array(data);else arr=data;let output={0:new Array(9),1:new Array(9),2:new Array(9),3:new Array(9),4:new Array(9),5:new Array(9),6:new Array(9),7:new Array(9),timestamp:Date.now()};for(let i=0;i<9;i++){let j=i*25;output[0][i]=bitflippin.bytesToUInt24(arr[j],arr[j+1],arr[j+2]);output[1][i]=bitflippin.bytesToUInt24(arr[j+3],arr[j+4],arr[j+5]);output[2][i]=bitflippin.bytesToUInt24(arr[j+6],arr[j+7],arr[j+8]);output[3][i]=bitflippin.bytesToUInt24(arr[j+9],arr[j+10],arr[j+11]);output[4][i]=bitflippin.bytesToUInt24(arr[j+12],arr[j+13],arr[j+14]);output[5][i]=bitflippin.bytesToUInt24(arr[j+15],arr[j+16],arr[j+17]);output[6][i]=bitflippin.bytesToUInt24(arr[j+18],arr[j+19],arr[j+20]);output[7][i]=bitflippin.bytesToUInt24(arr[j+21],arr[j+22],arr[j+23])}return output}var sps=250;var defaultChartSetting={nSec:10,sps,units:"mV"};var ads131m08ChartSettings={lines:{"0":JSON.parse(JSON.stringify(defaultChartSetting)),"1":JSON.parse(JSON.stringify(defaultChartSetting)),"2":JSON.parse(JSON.stringify(defaultChartSetting)),"3":JSON.parse(JSON.stringify(defaultChartSetting)),"4":JSON.parse(JSON.stringify(defaultChartSetting)),"5":JSON.parse(JSON.stringify(defaultChartSetting)),"6":JSON.parse(JSON.stringify(defaultChartSetting)),"7":JSON.parse(JSON.stringify(defaultChartSetting))}};var gain=32;var nbits=24;var vref=1.2;var defaultsetting={sps,useDCBlock:false,useBandpass:false,bandpassLower:3,bandpassUpper:45,useScaling:true,scalar:.96*1e3*vref/(gain*(Math.pow(2,nbits)-1))};var ads131m08FilterSettings={"0":JSON.parse(JSON.stringify(defaultsetting)),"1":JSON.parse(JSON.stringify(defaultsetting)),"2":JSON.parse(JSON.stringify(defaultsetting)),"3":JSON.parse(JSON.stringify(defaultsetting)),"4":JSON.parse(JSON.stringify(defaultsetting)),"5":JSON.parse(JSON.stringify(defaultsetting)),"6":JSON.parse(JSON.stringify(defaultsetting)),"7":JSON.parse(JSON.stringify(defaultsetting))};function cytoncodec(data){let arr;if(!data.buffer)arr=new Uint8Array(data);else arr=data;let output={};for(let i=0;i<8;i++){let idx=1+3*i;output[i]=bitflippin.bytesToInt24(arr[idx],arr[idx+1],arr[idx+2])}let accIdx=25;output.ax=bitflippin.bytesToInt16(arr[accIdx],arr[accIdx+1]);output.ay=bitflippin.bytesToInt16(arr[accIdx+2],arr[accIdx+3]);output.az=bitflippin.bytesToInt16(arr[accIdx+4],arr[accIdx+5]);output.gx=bitflippin.bytesToInt16(arr[accIdx+6],arr[accIdx+7]);output.gy=bitflippin.bytesToInt16(arr[accIdx+8],arr[accIdx+9]);output.gz=bitflippin.bytesToInt16(arr[accIdx+10],arr[accIdx+11]);output.timestamp=Date.now();return output}var sps2=250;var cytonSerialSettings={baudRate:115200,codec:cytoncodec,sps:sps2};var defaultsetting2={sps:sps2,useDCBlock:true,useBandpass:true,bandpassLower:3,bandpassUpper:45,useScaling:true,scalar:1e3*4.5/(24*(Math.pow(2,23)-1))};var cytonFilterSettings={"0":JSON.parse(JSON.stringify(defaultsetting2)),"1":JSON.parse(JSON.stringify(defaultsetting2)),"2":JSON.parse(JSON.stringify(defaultsetting2)),"3":JSON.parse(JSON.stringify(defaultsetting2)),"4":JSON.parse(JSON.stringify(defaultsetting2)),"5":JSON.parse(JSON.stringify(defaultsetting2)),"6":JSON.parse(JSON.stringify(defaultsetting2)),"7":JSON.parse(JSON.stringify(defaultsetting2)),"8":JSON.parse(JSON.stringify(defaultsetting2)),"9":JSON.parse(JSON.stringify(defaultsetting2)),"10":JSON.parse(JSON.stringify(defaultsetting2)),"11":JSON.parse(JSON.stringify(defaultsetting2)),"12":JSON.parse(JSON.stringify(defaultsetting2)),"13":JSON.parse(JSON.stringify(defaultsetting2)),"14":JSON.parse(JSON.stringify(defaultsetting2)),"15":JSON.parse(JSON.stringify(defaultsetting2))};function freeeeg128codec(data){let arr;if(data.getInt8)arr=new Uint8Array(data.buffer);else if(!data.buffer)arr=new Uint8Array(data);else arr=data;let output={};for(let i=0;i<128;i++){let idx=i*3+1;output[i]=bitflippin.bytesToUInt24(arr[idx],arr[idx+1],arr[idx+2])}let accIdx=385;output["ax"]=bitflippin.bytesToInt16(arr[accIdx],arr[accIdx+1]);output["ay"]=bitflippin.bytesToInt16(arr[accIdx+2],arr[accIdx+3]);output["az"]=bitflippin.bytesToInt16(arr[accIdx+4],arr[accIdx+5]);output["gx"]=bitflippin.bytesToInt16(arr[accIdx+6],arr[accIdx+7]);output["gy"]=bitflippin.bytesToInt16(arr[accIdx+8],arr[accIdx+9]);output["gz"]=bitflippin.bytesToInt16(arr[accIdx+10],arr[accIdx+11]);output.timestamp=Date.now();return output}var sps3=250;var freeeeg128SerialSettings={baudRate:921600,bufferSize:2e3,frequency:1.9,codec:freeeeg128codec,sps:sps3};var freeeeg128ChartSettings={lines:{"ax":{nSec:10,sps:sps3},"ay":{nSec:10,sps:sps3},"az":{nSec:10,sps:sps3},"gx":{nSec:10,sps:sps3},"gy":{nSec:10,sps:sps3},"gz":{nSec:10,sps:sps3}}};var freeeeg128FilterSettings={};for(let i=0;i<128;i++){freeeeg128ChartSettings.lines[i]={sps:250,nSec:10};freeeeg128FilterSettings[i]={sps:250,useDCBlock:true,useBandpass:true,bandpassLower:3,bandpassUpper:45,scalar:1e3*2.5/(32*(Math.pow(2,24)-1))}}function freeeeg32codec(data){let arr;if(data.getInt8)arr=new Uint8Array(data.buffer);else if(!data.buffer)arr=new Uint8Array(data);else arr=data;let output={};for(let i=0;i<32;i++){let idx=i*3+1;output[i]=bitflippin.bytesToUInt24(arr[idx],arr[idx+1],arr[idx+2])}let accIdx=97;output["ax"]=bitflippin.bytesToInt16(arr[accIdx],arr[accIdx+1]);output["ay"]=bitflippin.bytesToInt16(arr[accIdx+2],arr[accIdx+3]);output["az"]=bitflippin.bytesToInt16(arr[accIdx+4],arr[accIdx+5]);output["gx"]=bitflippin.bytesToInt16(arr[accIdx+6],arr[accIdx+7]);output["gy"]=bitflippin.bytesToInt16(arr[accIdx+8],arr[accIdx+9]);output["gz"]=bitflippin.bytesToInt16(arr[accIdx+10],arr[accIdx+11]);output.timestamp=Date.now();return output}var sps4=512;var freeeeg32SerialSettings={baudRate:921600,bufferSize:2e3,frequency:1.9,codec:freeeeg32codec,sps:sps4};var freeeeg32_optical_SerialSettings={baudRate:1e6,bufferSize:2e3,frequency:1.9,codec:freeeeg32codec,sps:sps4};var freeeeg32ChartSettings={lines:{"ax":{nSec:10,sps:sps4},"ay":{nSec:10,sps:sps4},"az":{nSec:10,sps:sps4},"gx":{nSec:10,sps:sps4},"gy":{nSec:10,sps:sps4},"gz":{nSec:10,sps:sps4}}};var freeeeg32FilterSettings={};for(let i=0;i<32;i++){freeeeg32ChartSettings.lines[i]={sps:sps4,nSec:10};freeeeg32FilterSettings[i]={sps:sps4,useDCBlock:true,useBandpass:true,bandpassLower:3,bandpassUpper:45,useScaling:true,scalar:1e3*2.5/(8*(Math.pow(2,24)-1))}}var textdecoder=new TextDecoder;function hegduinocodec(value){let output={timestamp:0,red:0,infrared:0,heg:0,ambient:0,temperature:0};let txt=textdecoder.decode(value);let line=txt.split("|");if(line.length===3){output.timestamp=Date.now();output.red=parseInt(line[0]);output.infrared=parseInt(line[1]);output.heg=parseFloat(line[2])}else if(line.length>=5){output.timestamp=Date.now();output.red=parseInt(line[1]);output.infrared=parseInt(line[2]);output.heg=parseFloat(line[3]);output.ambient=parseFloat(line[4]);output.temperature=parseFloat(line[5]);return output}else return txt}var sps5=40;var hegduinoSerialSettings={baudRate:115200,write:"t\n",codec:hegduinocodec,sps:sps5};var hegduinoBLESettings={sps:sps5,services:{["6E400001-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{"6e400002-b5a3-f393-e0a9-e50e24dcca9e":{write:"t"},"6e400003-b5a3-f393-e0a9-e50e24dcca9e":{notify:true,notifyCallback:void 0,codec:hegduinocodec,sps:sps5}},["6E400004-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{["6E400005-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{read:true},["6E400006-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{write:void 0,notify:true,notifyCallback:void 0},["6E400007-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{read:true}}},androidWebBLE:"o"};function max3010xcodec(data){let arr;if(data.getInt8)arr=new Uint8Array(data.buffer);else if(!data.buffer)arr=new Uint8Array(data);else arr=data;const output={"red":new Array(32),"ir":new Array(32),"max_dietemp":bitflippin.get2sCompliment(arr[193],8)+.0625*arr[194],"timestamp":Date.now()};let i=0;while(i<32){let idx=i*6;if(i%2===0){output["ir"][i]=(arr[idx+1]<<16|arr[idx+2]<<8|arr[idx+3])&524287;output["ir"][i+1]=(arr[idx+4]<<16|arr[idx+5]<<8|arr[idx+6])&524287}else{output["red"][i-1]=(arr[idx+1]<<16|arr[idx+2]<<8|arr[idx+3])&524287;output["red"][i]=(arr[idx+4]<<16|arr[idx+5]<<8|arr[idx+6])&524287}i++}return output}function mpu6050codec(data){let arr;if(data.getInt8)arr=new Uint8Array(data.buffer);else if(!data.buffer)arr=new Uint8Array(data);else arr=data;let output={"ax":new Array(20),"ay":new Array(20),"az":new Array(20),"gx":new Array(20),"gy":new Array(20),"gz":new Array(20),"mpu_dietemp":(bitflippin.bytesToInt16(arr[241],arr[242])+521)/340+35,timestamp:Date.now()};for(let i=0;i<20;i++){let idx=i*12;output.ax[i]=bitflippin.bytesToInt16(arr[idx+1],arr[idx+2]);output.ay[i]=bitflippin.bytesToInt16(arr[idx+3],arr[idx+4]);output.az[i]=bitflippin.bytesToInt16(arr[idx+5],arr[idx+6]);output.gx[i]=bitflippin.bytesToInt16(arr[idx+7],arr[idx+8]);output.gy[i]=bitflippin.bytesToInt16(arr[idx+9],arr[idx+10]);output.gz[i]=bitflippin.bytesToInt16(arr[idx+11],arr[idx+12])}return output}function cognixionONE_EEG_codec(data){let arr;if(data.getInt8)arr=new Uint8Array(data.buffer);else if(!data.buffer)arr=new Uint8Array(data);else arr=data;let output={0:new Array,1:new Array,2:new Array,3:new Array,4:new Array,5:new Array,6:new Array,7:new Array,timestamp:Date.now()};for(let i=0;i<7;i++){let j=i*26+1;if(!arr[j+23])break;output[0][i]=bitflippin.bytesToUInt24(arr[j],arr[j+1],arr[j+2]);output[1][i]=bitflippin.bytesToUInt24(arr[j+3],arr[j+4],arr[j+5]);output[2][i]=bitflippin.bytesToUInt24(arr[j+6],arr[j+7],arr[j+8]);output[3][i]=bitflippin.bytesToUInt24(arr[j+9],arr[j+10],arr[j+11]);output[4][i]=bitflippin.bytesToUInt24(arr[j+12],arr[j+13],arr[j+14]);output[5][i]=bitflippin.bytesToUInt24(arr[j+15],arr[j+16],arr[j+17]);output[6][i]=bitflippin.bytesToUInt24(arr[j+18],arr[j+19],arr[j+20]);output[7][i]=bitflippin.bytesToUInt24(arr[j+21],arr[j+22],arr[j+23])}return output}var sps6=250;var cognixionONEBLESettings={services:{["82046698-6313-4BB1-9645-6BA28BF86DF5".toLowerCase()]:{["8204669A-6313-4BB1-9645-6BA28BF86DF5".toLowerCase()]:{notify:true,notifyCallback:void 0,codec:cognixionONE_EEG_codec,sps:sps6}},["82E12914-9AFA-4648-BD1B-8E2B3DC6DAAF".toLowerCase()]:{["82E12915-9AFA-4648-BD1B-8E2B3DC6DAAF".toLowerCase()]:{write:void 0},["82E12916-9AFA-4648-BD1B-8E2B3DC6DAAF".toLowerCase()]:{read:true}}},sps:sps6};var PeanutCodes={2:{type:"POOR_SIGNAL",format:"<B",byteLength:1},144:{type:"unfilteredHEG",format:"<i",byteLength:4},145:{type:"heg",format:"<i",byteLength:4},147:{type:"rawdata4",format:"<iiii",byteLength:4*4},148:{type:"rawdata6",format:"<iiiiii",byteLength:4*6},160:{type:"sampleNumber",format:"<i",byteLength:4},176:{type:"debug0",format:"<i",byteLength:4},177:{type:"debug1",format:"<i",byteLength:4},178:{type:"debug2",format:"<i",byteLength:4},179:{type:"debug3",format:"<i",byteLength:4},180:{type:"debug4",format:"<iiiiii",byteLength:4*6},181:{type:"debug4",format:"<iiiiii",byteLength:4*6},182:{type:"rawdata27",format:"<B"+"i".repeat(26),byteLength:1+4*26}};function peanutcodec(data){let result={};let i=0;while(i<data.length){if(PeanutCodes[data[i]]&&i+1+PeanutCodes[data[i]].byteLength<=data.length){let slice=data.slice(i+1,i+1+PeanutCodes[data[i]].byteLength).buffer;let unpacked=bitflippin.struct(PeanutCodes[data[i]].format).unpack(slice);let code=PeanutCodes[data[i]].type;if(code==="unfilteredHEG"||code==="heg")unpacked=unpacked[0]/256;else if(code==="POOR_SIGNAL"||code==="sampleNumber"||code==="debug0"||code==="debug1"||code==="debug2"||code==="debug3")unpacked=unpacked[0];if(!result[PeanutCodes[data[i]].type]){if(Array.isArray(unpacked))result[PeanutCodes[data[i]].type]=unpacked;else result[PeanutCodes[data[i]].type]=[unpacked]}else{if(Array.isArray(unpacked))result[PeanutCodes[data[i]].type].push(...unpacked);else result[PeanutCodes[data[i]].type].push(unpacked)}i+=PeanutCodes[data[i]].byteLength+1}else i++}result.timestamp=Date.now();return result}var peanutSerialSettings={baudRate:38400,bufferSize:500,write:"protocol 3\n",buffering:{searchBytes:new Uint8Array([170,170])},codec:peanutcodec,sps:10.101};var sealevel_hpa=1013.25;var bme280codec=data=>{let arr;if(data.getInt8)arr=new Uint8Array(data.buffer);else if(!data.buffer)arr=new Uint8Array(data);else arr=data;let output={temp:[],pressure:[],humidity:[],altitude:[]};for(let j=0;j<3;j++){let i=j*24;let tint=bitflippin.bytesToUInt32(arr[0+i],arr[1+i],arr[2+i],arr[3+i]);let tfrac=bitflippin.bytesToUInt32(arr[4+i],arr[5+i],arr[6+i],arr[7+i]);output.temp.push(tint+tfrac/Math.pow(10,Math.ceil(Math.log10(tfrac))));let pint=bitflippin.bytesToUInt32(arr[8+i],arr[9+i],arr[10+i],arr[11+i]);let pfrac=bitflippin.bytesToUInt32(arr[12+i],arr[13+i],arr[14+i],arr[15+i]);output.pressure.push(pint+pfrac/Math.pow(10,Math.ceil(Math.log10(pfrac))));let hint=bitflippin.bytesToUInt32(arr[16+i],arr[17+i],arr[18+i],arr[19+i]);let hfrac=bitflippin.bytesToUInt32(arr[20+i],arr[21+i],arr[22+i],arr[23+i]);output.humidity.push(hint+hfrac/Math.pow(10,Math.ceil(Math.log10(hfrac))));output.altitude.push(altitude(output.pressure[j],output.temp[j]))}return output};var exponent=1/5.257;var denom=1/.0065;function altitude(pressure,temperature){return(Math.pow(sealevel_hpa/pressure,exponent)-1)*(temperature+273.15)*denom}function nrf5x_usbcodec(data){let arr;if(data.getInt8)arr=new Uint8Array(data.buffer);else if(!data.buffer)arr=new Uint8Array(data);else arr=data;const output={};if(arr[0]===2){Object.assign(output,ads131m08codec(arr.subarray(2)))}else if(arr[0]===3){let result=ads131m08codec(arr.subarray(2));Object.keys(result).forEach((key,i)=>{output[i+8]=result[key]})}else if(arr[0]===4){Object.assign(output,mpu6050codec(arr.subarray(2)))}else if(arr[0]===5){Object.assign(output,max3010xcodec(arr.subarray(2)))}else if(arr[0]===6){Object.assign(output,bme280codec(arr.subarray(2)))}else{Object.assign(output,ads131m08codec(arr))}return output}var nrf5xSerialSettings={baudRate:115200,buffering:{searchBytes:new Uint8Array([240,240])},codec:nrf5x_usbcodec,sps:250};var nrf5xBLESettings={sps:250,services:{"0000cafe-b0ba-8bad-f00d-deadbeef0000":{"0001cafe-b0ba-8bad-f00d-deadbeef0000":{write:void 0},"0002cafe-b0ba-8bad-f00d-deadbeef0000":{notify:true,notifyCallback:void 0,codec:ads131m08codec,sps:250},"0003cafe-b0ba-8bad-f00d-deadbeef0000":{notify:true,notifyCallback:void 0,codec:max3010xcodec,sps:100},"0004cafe-b0ba-8bad-f00d-deadbeef0000":{notify:true,notifyCallback:void 0,codec:mpu6050codec,sps:100},"0005cafe-b0ba-8bad-f00d-deadbeef0000":{notify:true,notifyCallback:void 0,codec:ads131m08codec,sps:250},"0006cafe-b0ba-8bad-f00d-deadbeef0000":{notify:true,notifyCallback:void 0,codec:bme280codec,sps:3.33}}}};var defaultsetting3={sps:250,useDCBlock:false,useBandpass:false,bandpassLower:3,bandpassUpper:45,useScaling:true,scalar:1e3*1.2/(32*(Math.pow(2,24)-1))};var nrf5x_usbFilterSettings={"0":JSON.parse(JSON.stringify(defaultsetting3)),"1":JSON.parse(JSON.stringify(defaultsetting3)),"2":JSON.parse(JSON.stringify(defaultsetting3)),"3":JSON.parse(JSON.stringify(defaultsetting3)),"4":JSON.parse(JSON.stringify(defaultsetting3)),"5":JSON.parse(JSON.stringify(defaultsetting3)),"6":JSON.parse(JSON.stringify(defaultsetting3)),"7":JSON.parse(JSON.stringify(defaultsetting3)),"8":JSON.parse(JSON.stringify(defaultsetting3)),"9":JSON.parse(JSON.stringify(defaultsetting3)),"10":JSON.parse(JSON.stringify(defaultsetting3)),"11":JSON.parse(JSON.stringify(defaultsetting3)),"12":JSON.parse(JSON.stringify(defaultsetting3)),"13":JSON.parse(JSON.stringify(defaultsetting3)),"14":JSON.parse(JSON.stringify(defaultsetting3)),"15":JSON.parse(JSON.stringify(defaultsetting3))};var textdecoder2=new TextDecoder;function statechangercodec(value){let output={timestamp:0,left_red:0,left_infrared:0,left_heg:0,center_red:0,center_infrared:0,center_heg:0,right_red:0,right_infrared:0,right_heg:0};let txt=textdecoder2.decode(value);let line=txt.split("|");if(line.length>=5){output.timestamp=Date.now();output.left_red=parseInt(line[1]);output.left_infrared=parseInt(line[2]);output.left_heg=parseFloat(line[3]);output.center_red=parseInt(line[4]);output.center_infrared=parseInt(line[5]);output.center_heg=parseFloat(line[6]);output.right_red=parseInt(line[7]);output.right_infrared=parseInt(line[8]);output.right_heg=parseFloat(line[9]);return output}else return txt}var statechangerSerialSettings={baudRate:115200,codec:statechangercodec};var statechangerBLESettings={services:{["6E400001-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{"6e400002-b5a3-f393-e0a9-e50e24dcca9e":{write:"t"},"6e400003-b5a3-f393-e0a9-e50e24dcca9e":{notify:true,notifyCallback:void 0,codec:statechangercodec}},["6E400004-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{["6E400005-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{read:true},["6E400006-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{write:void 0,notify:true,notifyCallback:void 0},["6E400007-B5A3-F393-E0A9-E50E24DCCA9E".toLowerCase()]:{read:true}}},androidWebBLE:"o"};var sps7=250;var museSettings={sps:sps7,connect:(settings={})=>{return new Promise(async(res,rej)=>{let _id=`muse${Math.floor(Math.random()*1e15)}`;if(typeof MuseClient==="undefined"){document.head.insertAdjacentHTML("beforeend",`<script src="https://cdn.jsdelivr.net/npm/muse-js-tinybuild@1.0.0/dist/muse.min.js"><\/script>`)}let client=new MuseClient;let info={_id,client,settings:Object.assign(Object.assign({},museSettings),settings)};await client.connect();await client.start();let eegts;client.eegReadings.subscribe(reading=>{reading.origin="eeg";if(reading.electrode===0){eegts=bitflippin.genTimestamps(12,250)}if(!eegts)eegts=bitflippin.genTimestamps(12,250);reading.timestamp=eegts;info.settings.ondata(reading)});client.telemetryData.subscribe(reading=>{reading.origin="telemetry";info.settings.ondata(reading)});client.gyroscopeData.subscribe(reading=>{reading.origin="gyro";info.settings.ondata(reading)});client.accelerometerData.subscribe(reading=>{reading.origin="accelerometer";info.settings.ondata(reading)});if(client.enablePPG){client.ppgData.subscribe(reading=>{reading.origin="ppg";info.settings.ondata(reading)})}info.settings.onconnect(info);res(info)})},codec:reading=>{let origin=reading.origin;if(origin==="eeg"){return{[reading.electrode]:reading.samples,timestamp:Date.now()}}else if(origin==="gyro"){let transformed={gx:[],gy:[],gz:[],timestamp:Date.now()};reading.samples.forEach(s=>{transformed.gx.push(s.x);transformed.gy.push(s.y);transformed.gz.push(s.z)});return transformed}else if(origin==="accelerometer"){let transformed={ax:[],ay:[],az:[],timestamp:Date.now()};reading.samples.forEach(s=>{transformed.ax.push(s.x);transformed.ay.push(s.y);transformed.az.push(s.z)});return transformed}else if(origin==="ppg"){return{[`ppg${reading.ppgChannel}`]:reading.samples,timestamp:Date.now()}}else if(origin==="telemetry"){return reading}},disconnect:info=>{info.client.disconnect();info.settings.ondisconnect(info)},onconnect:info=>{console.log("muse connected!",info)},ondisconnect:info=>{console.log("muse disconnected!",info)},ondata:parsed=>{console.log(parsed)}};var defaultsetting4={sps:sps7,useDCBlock:true,useBandpass:true,bandpassLower:3,bandpassUpper:45};var museFilterSettings={"0":JSON.parse(JSON.stringify(defaultsetting4)),"1":JSON.parse(JSON.stringify(defaultsetting4)),"2":JSON.parse(JSON.stringify(defaultsetting4)),"3":JSON.parse(JSON.stringify(defaultsetting4)),"4":JSON.parse(JSON.stringify(defaultsetting4))};function blueberrycodec(value){let output={red:value.getInt32(2),ir:value.getInt32(6),ir2:value.getInt32(10),timestamp:Date.now()};output.heg=output.red/(.5*(output.ir+output.ir2));return output}var sps8=40;var blueberryBLESettings={namePrefix:"blueberry",services:{"0f0e0d0c-0b0a-0908-0706-050403020100":{"1f1e1d1c-1b1a-1918-1716-151413121110":{write:void 0},"3f3e3d3c-3b3a-3938-3736-353433323130":{notify:true,notifyCallback:void 0,codec:blueberrycodec,sps:sps8}}},sps:sps8};function blueberryshortcodec(value){let output={sred:value.getInt32(2),sir:value.getInt32(6),sir2:value.getInt32(10),timestamp:Date.now()};output.sheg=output.sred/(.5*(output.sir+output.sir2));return output}function blueberrylongcodec(value){let output={red:value.getInt32(2),ir:value.getInt32(6),ir2:value.getInt32(10),timestamp:Date.now()};output.heg=output.sred/(.5*(output.ir+output.ir2));return output}var sps9=40;var blueberry2BLESettings={namePrefix:"blueberry",services:{"0f0e0d0c-0b0a-0908-0706-050403020100":{"1f1e1d1c-1b1a-1918-1716-151413121110":{write:void 0},"4f4e4d4c-4b6a-6968-6766-656463426160":{notify:true,notifyCallback:void 0,codec:blueberrylongcodec,sps:sps9},"4f4e4d4c-4b5a-5958-5756-555453425150":{notify:true,notifyCallback:void 0,codec:blueberryshortcodec,sps:sps9}}},sps:sps9};var sps10=250;var ganglionSettings={sps:sps10,connect:(settings={})=>{return new Promise(async(res,rej)=>{let _id=`ganglion${Math.floor(Math.random()*1e15)}`;if(typeof Ganglion==="undefined"){document.head.insertAdjacentHTML("beforeend",`<script src="https://cdn.jsdelivr.net/npm/ganglion-browser-min@1.0.2/dist/index.js"><\/script>`)}let client=new Ganglion;let info={_id,client,settings:Object.assign(Object.assign({},ganglionSettings),settings)};await client.connect();await client.start();client.stream.subscribe(reading=>{reading.origin="eeg";info.settings.ondata(reading)});client.accelData.subscribe(reading=>{reading.origin="accelerometer";info.settings.ondata(reading)});info.settings.onconnect(info);res(info)})},codec:reading=>{let origin=reading.origin;if(origin==="eeg"){return{0:reading.data[0],1:reading.data[1],2:reading.data[2],3:reading.data[3],timestamp:Date.now()}}else if(origin==="accelerometer"){return{ax:reading.data[0],ay:reading.data[1],az:reading.data[2],timestamp:Date.now()}}},disconnect:info=>{info.client.disconnect();info.settings.ondisconnect(info)},onconnect:info=>{console.log("ganglion connected!",info)},ondisconnect:info=>{console.log("ganglion disconnected!",info)},ondata:parsed=>{console.log(parsed)}};var defaultsetting5={sps:sps10,useDCBlock:true,useBandpass:true,bandpassLower:3,bandpassUpper:45};var ganglionFilterSettings={"0":JSON.parse(JSON.stringify(defaultsetting5)),"1":JSON.parse(JSON.stringify(defaultsetting5)),"2":JSON.parse(JSON.stringify(defaultsetting5)),"3":JSON.parse(JSON.stringify(defaultsetting5))};function hrcodec(data){return{hr:data.getInt8(1),timestamp:Date.now()}}var heartRateBLESettings={services:{"heart_rate":{"heart_rate_measurement":{notify:true,notifyCallback:void 0,codec:hrcodec}}}};var Devices={BLE:{"nrf5x":nrf5xBLESettings,"hegduino":hegduinoBLESettings,"cognixionONE":cognixionONEBLESettings,"statechanger":statechangerBLESettings,"blueberry":blueberryBLESettings,"blueberry2":blueberry2BLESettings,"heart_rate":heartRateBLESettings},USB:{"nrf5x":nrf5xSerialSettings,"freeEEG32":freeeeg32SerialSettings,"freeEEG32_optical":freeeeg32_optical_SerialSettings,"freeEEG128":freeeeg128SerialSettings,"hegduino":hegduinoSerialSettings,"cyton":cytonSerialSettings,"cyton_daisy":cytonSerialSettings,"peanut":peanutSerialSettings,"statechanger":statechangerSerialSettings,"cognixionONE":cytonSerialSettings},BLE_OTHER:{"muse":museSettings,"ganglion":ganglionSettings},USB_OTHER:{},OTHER:{}};var textdecoder3=new TextDecoder;function isMobile(){let check=false;(function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))check=true})(navigator.userAgent||navigator.vendor||window.opera);return check}var BLE=new BLEClient;var workers=new WorkerService({routes:workerCanvasRoutes});function initDevice(deviceType,deviceName,options){let settings=Devices[deviceType][deviceName];if(!settings)return void 0;let renderworker;let streamworker=workers.addWorker({url:stream_worker_default});if(options.subprocesses){for(const key in options.subprocesses){let s=options.subprocesses[key];if(!s.worker)s.worker=workers.addWorker({url:stream_worker_default});let w=s.worker;let wpId=workers.establishMessageChannel(w.worker,streamworker.worker);if(s.init){w.run(s.init,s.initArgs).then(r=>{w.run("setValue",["otherArgsProxy",r])})}if(s.otherArgs){w.run("setValue",["otherArgsProxy",s.otherArgs])}if(s.pipeTo){w.run("setValue",["routeProxy",s.route]);w.run("setValue",["pipeRoute",s.pipeTo.route]);if(s.pipeTo.portId)w.run("setValue",["pipePort",s.pipeTo.portId]);if(s.pipeTo.otherArgs)w.run("setValue",["otherPipeArgs",s.pipeTo.otherArgs]);workers.transferFunction(w,function pipeResults(data){let inp=data;if(this.graph.otherArgsProxy)inp=[data,...this.graph.otherArgsProxy];let r=this.graph.run(this.graph.routeProxy,inp);if(r instanceof Promise){r.then(rr=>{let args=rr;if(this.graph.otherPipeArgs)args=[rr,...this.graph.otherPipeArgs];this.transmit({route:this.graph.pipeRoute,args},this.graph.pipePort)})}else{let args=r;if(this.graph.otherPipeArgs)args=[r,...this.graph.otherPipeArgs];this.transmit({route:this.graph.pipeRoute,args},this.graph.pipePort)}},"pipeResults");w.run("subscribeToWorker",["decodeAndParseDevice",wpId,"pipeResults"])}else{if(s.otherArgs){w.run("setValue",["routeProxy",s.route]);workers.transferFunction(w,function routeProxy(data){let inp=data;if(this.graph.otherArgsProxy)inp=[data,...this.graph.otherArgsProxy];let r=this.graph.nodes.get(this.graph.routeProxy).operator(inp);if(r instanceof Promise){r.then(rr=>{this.setState({[this.graph.routeProxy]:rr})})}else this.setState({[this.graph.routeProxy]:r})},"routeProxy");w.run("subscribeToWorker",["decodeAndParseDevice",wpId,"routeProxy"])}else w.run("subscribeToWorker",["decodeAndParseDevice",wpId,s.route])}if(s.callback)w.subscribe(s.route,s.callback)}}if(options.renderer){if(!options.renderer.renderworker){renderworker=workers.addWorker({url:stream_worker_default});workers.transferFunction(renderworker,function receiveParsedData(parsed){this.run("updateCanvas",parsed)},"receiveParsedData")}else{renderworker=options.renderer.renderworker;delete options.renderer.renderworker}if(options.renderer.canvas||options.renderer._id)workers.run("transferCanvas",renderworker.worker,options.renderer);let portId=workers.establishMessageChannel(streamworker.worker,renderworker.worker);renderworker.post("subscribeToWorker",["decodeAndParseDevice",portId,"receiveParsedData"])}if(deviceType.includes("OTHER")){if(typeof options.ondecoded==="function"){settings.ondata=data=>{streamworker.run("decodeAndParseDevice",[data,deviceType,deviceName]).then(options.ondecoded)}}return new Promise((res,rej)=>{let init=settings.connect(settings);let info={workers:{streamworker,renderworker},disconnect:()=>{settings.disconnect(settings);if(options.ondisconnect)options.ondisconnect(info)},device:init,read:command=>{if(settings.read)return new Promise((res2,rej2)=>{res2(settings.read(settings,command))})},write:command=>{if(settings.write)return new Promise((res2,rej2)=>{res2(settings.write(settings,command))})}};if(options.onconnect)options.onconnect(info);res(info)}).catch(er=>{console.error(er);workers.terminate(streamworker._id)})}else if(deviceType==="BLE"){for(const primaryUUID in settings.services){for(const characteristic in settings.services[primaryUUID]){if(typeof options.ondecoded==="function"){if(settings.services?.[primaryUUID]?.[characteristic]?.notify){settings.services[primaryUUID][characteristic].notifyCallback=data=>{streamworker.run("decodeAndParseDevice",[data,deviceType,deviceName,primaryUUID,characteristic],[data.buffer]).then(options.ondecoded)};break}}else if(typeof options.ondecoded==="object"){if(options.ondecoded[characteristic]){if(settings.services?.[primaryUUID]?.[characteristic]?.notify){settings.services[primaryUUID][characteristic].notifyCallback=data=>{streamworker.run("decodeAndParseDevice",[data,deviceType,deviceName,primaryUUID,characteristic],[data.buffer]).then(options.ondecoded[characteristic])}}if(settings.services?.[primaryUUID]?.[characteristic]?.read){settings.services[characteristic].readCallback=data=>{streamworker.run("decodeAndParseDevice",[data,deviceType,deviceName,primaryUUID,characteristic],[data.buffer]).then(options.ondecoded[characteristic])}}}}}}settings.ondisconnect=()=>{workers.terminate(streamworker._id);if(renderworker)workers.terminate(renderworker._id);if(options.subprocesses){for(const key in options.subprocesses){if(options.subprocesses[key].worker){options.subprocesses[key].worker.terminate()}}}};return new Promise((res,rej)=>{BLE.setup(settings).then(result=>{let info={workers:{streamworker,renderworker},options,device:result,disconnect:async()=>{await BLE.disconnect(result.deviceId);if(options.ondisconnect)options.ondisconnect(info)},read:command=>{return BLE.read(result.device,command.service,command.characteristic,command.ondata,command.timeout)},write:command=>{return BLE.write(result.device,command.service,command.characteristic,command.data,command.callback,command.timeout)}};if(options.onconnect)options.onconnect(info);res(info)}).catch(er=>{console.error(er);streamworker.terminate();if(renderworker)renderworker.terminate();if(options.subprocesses){for(const key in options.subprocesses){if(options.subprocesses[key].worker){options.subprocesses[key].worker.terminate()}}}rej(er)})})}else if(deviceType==="USB"){let serialworker=workers.addWorker({url:stream_worker_default});serialworker.worker.addEventListener("message",ev=>{if(typeof ev.data==="string"){if(ev.data.includes("disconnected")){workers.terminate(serialworker._id);workers.terminate(streamworker._id);if(renderworker)workers.terminate(renderworker._id);if(options.subprocesses){for(const key in options.subprocesses){if(options.subprocesses[key].worker){options.subprocesses[key].worker.terminate()}}}}}});serialworker.post("setupSerial");let portId=workers.establishMessageChannel(streamworker.worker,serialworker.worker);const WS=new WebSerial;return new Promise((res,rej)=>{WS.requestPort(settings.usbVendorId,settings.usbProductId).then(port=>{let info=port.getInfo();serialworker.run("openPort",{baudRate:settings.baudRate,usbVendorId:info.usbVendorId,usbProductId:info.usbProductId,bufferSize:settings.bufferSize,buffering:settings.buffering?settings.buffering:void 0,frequency:settings.frequency?settings.frequency:void 0,pipeTo:{route:"decodeAndParseDevice",_id:portId,extraArgs:[deviceType,deviceName]}}).then(result=>{if(settings.write)serialworker.post("writeStream",[result._id,settings.write]);if(typeof options.ondecoded==="function")streamworker.subscribe("decodeAndParseDevice",options.ondecoded);let info2={workers:{streamworker,renderworker,serialworker},device:result,options,disconnect:()=>{serialworker.post("closeStream",result._id);if(options.ondisconnect)options.ondisconnect(info2)},read:()=>{return new Promise((res2,rej2)=>{let sub;sub=streamworker.subscribe("decodeAndParseDevice",result2=>{serialworker.unsubscribe("decodeAndParseDevice",sub);res2(result2)})})},write:command=>{return serialworker.run("writeStream",[result._id,command])}};if(options.onconnect)options.onconnect(info2);res(info2)})}).catch(er=>{console.error(er);rej(er)})})}else return void 0}function createStreamPipeline(dedicatedSerialWorker=false,dedicatedRenderWorker=false,renderer){let streamworker=workers.addWorker({url:stream_worker_default});let renderworker,renderPort;let serialworker,decoderPort;if(dedicatedSerialWorker){serialworker=workers.addWorker({url:stream_worker_default});decoderPort=workers.establishMessageChannel(serialworker.worker,streamworker.worker);serialworker.post("setupSerial")}if(dedicatedRenderWorker){renderworker=workers.addWorker({url:stream_worker_default});renderPort=workers.establishMessageChannel(streamworker.worker,renderworker.worker);if(renderer){workers.run("transferCanvas",renderworker.worker,renderer);workers.transferFunction(renderworker,function receiveParsedData(parsed){this.run("runUpdate",void 0,parsed)},"receiveParsedData");renderworker.post("subscribeToWorker",["decodeAndParseDevice",renderPort,"receiveParsedData"])}}let result={streamworker};if(serialworker){result.serialworker=serialworker;result.decoderPort=decoderPort}if(renderworker){result.renderworker=renderworker;result.renderPort=renderPort}return result}export{BLE,Devices,createStreamPipeline,stream_worker_default as gsworker,initDevice,isMobile,workers};
/*! Capacitor: https://capacitorjs.com/ - MIT License */
